/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/**
 * @ngdoc component
 * @name tcSharedStateService
 *
 * @description
 *
 * tcSharedStateService provides services for managing stored client config using the Tibco Live Apps shared state service.
 *
 * Although this is a live apps service rather than a Tibco Subscriber Cloud Service it is inside the core project since it will
 * be used for all applications to store configuration information.
 *
 * By hosting this service in the core we can avoid a circular dependency to the live apps library.
 *
 * Note: This service will use the http caching interceptor for 'GET' calls based on passed parameters.
 *
 *
 */
import { Injectable } from '@angular/core';
import { SharedStateContent, SharedStateEntry, SharedStateList } from '../models/tc-shared-state';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { map, tap } from 'rxjs/operators';
import { Location } from '@angular/common';
import { UiAppConfig } from '../models/tc-app-config';
import { TcCoreCommonFunctions } from '../common/tc-core-common-functions';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "@angular/common";
export class TcSharedStateService {
    /**
     * @param {?} http
     * @param {?} location
     */
    constructor(http, location) {
        this.http = http;
        this.location = location;
    }
    /**
     * @param {?} name
     * @param {?} type
     * @param {?} description
     * @param {?} sandboxId
     * @param {?} attributes
     * @param {?} roles
     * @param {?} links
     * @param {?} content
     * @return {?}
     */
    createSharedState(name, type, description, sandboxId, attributes, roles, links, content) {
        /** @type {?} */
        const url = '/clientstate/v1/states';
        /** @type {?} */
        const body = {
            'name': name,
            'type': type,
            'description': description,
            'sandboxId': sandboxId,
            'attributes': attributes,
            'roles': roles,
            'links': links,
            content: content
        };
        /** @type {?} */
        const bodyStr = JSON.stringify(body);
        /** @type {?} */
        const headers = new HttpHeaders()
            .set('Content-Type', 'application/json');
        return this.http.post(url, bodyStr, { headers })
            .pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        val => sessionStorage.setItem('tcsTimestamp', Date.now().toString()))), map((/**
         * @param {?} result
         * @return {?}
         */
        result => {
            return result.toString();
        })));
    }
    /**
     * @param {?} sharedStateList
     * @return {?}
     */
    updateSharedState(sharedStateList) {
        /** @type {?} */
        const url = '/clientstate/v1/states';
        /** @type {?} */
        const body = sharedStateList;
        /** @type {?} */
        const bodyStr = JSON.stringify(body);
        /** @type {?} */
        const headers = new HttpHeaders()
            .set('Content-Type', 'application/json');
        return this.http.put(url, bodyStr, { headers })
            .pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        val => sessionStorage.setItem('tcsTimestamp', Date.now().toString()))), map((/**
         * @param {?} updatedSharedStateList
         * @return {?}
         */
        updatedSharedStateList => new SharedStateList().deserialize(updatedSharedStateList))));
    }
    /**
     * @param {?} name
     * @param {?} type
     * @param {?} useCache
     * @param {?} flushCache
     * @return {?}
     */
    getSharedState(name, type, useCache, flushCache) {
        /** @type {?} */
        const url = '/clientstate/v1/states?$filter=type=' + type
            + ' and name=\'' + name + '\'';
        /** @type {?} */
        let options = {}
        // set headers when caching required
        ;
        // set headers when caching required
        /** @type {?} */
        let headers = new HttpHeaders();
        if (useCache) {
            headers = headers.set('cacheResponse', 'true');
        }
        if (flushCache) {
            headers = headers.set('flushCache', 'true');
        }
        options = { headers: headers };
        return this.http.get(url, options)
            .pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        val => sessionStorage.setItem('tcsTimestamp', Date.now().toString()))), map((/**
         * @param {?} sharedStateList
         * @return {?}
         */
        sharedStateList => new SharedStateList().deserialize(sharedStateList))));
    }
    /* Ui App Config */
    /**
     * @param {?} uiAppId
     * @param {?} useCache
     * @param {?} flushCache
     * @return {?}
     */
    getUiAppConfig(uiAppId, useCache, flushCache) {
        // if useCache is false this will trigger the service to update the cached version with latest
        /** @type {?} */
        const ssName = uiAppId + '.config.tibcolabs.client.context.PUBLIC';
        return this.getSharedState(ssName, 'PUBLIC', useCache, flushCache)
            .pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            if (value.sharedStateEntries.length > 0) {
                /** @type {?} */
                const ssresult = new UiAppConfig().deserialize(JSON.parse(value.sharedStateEntries[0].content.json));
                ssresult.id = value.sharedStateEntries[0].id;
                return ssresult;
            }
            else {
                return undefined;
            }
        })));
    }
    /**
     * @param {?} sandboxId
     * @param {?} uiAppConfig
     * @param {?} uiAppId
     * @return {?}
     */
    createUiAppConfig(sandboxId, uiAppConfig, uiAppId) {
        /** @type {?} */
        const ssName = uiAppId + '.config.tibcolabs.client.context.PUBLIC';
        /** @type {?} */
        const content = new SharedStateContent();
        content.json = TcCoreCommonFunctions.escapeString(JSON.stringify(uiAppConfig));
        return this.createSharedState(ssName, 'PUBLIC', '', sandboxId, undefined, undefined, undefined, content)
            .pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        value => value)));
    }
    /**
     * @param {?} sandboxId
     * @param {?} uiAppConfig
     * @param {?} uiAppId
     * @param {?} id
     * @return {?}
     */
    updateUiAppConfig(sandboxId, uiAppConfig, uiAppId, id) {
        /** @type {?} */
        const ssName = uiAppId + '.config.tibcolabs.client.context.PUBLIC';
        /** @type {?} */
        const content = new SharedStateContent();
        content.json = TcCoreCommonFunctions.escapeString(JSON.stringify(uiAppConfig));
        /** @type {?} */
        const entry = new SharedStateEntry();
        entry.content = content;
        entry.sandboxId = sandboxId;
        entry.name = ssName;
        entry.type = 'PUBLIC';
        entry.id = id;
        /** @type {?} */
        const ssList = new SharedStateList();
        ssList.sharedStateEntries = [];
        ssList.sharedStateEntries.push(entry);
        return this.updateSharedState(ssList.sharedStateEntries)
            .pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            return new UiAppConfig().deserialize((JSON.parse(value.sharedStateEntries[0].content.json)));
        })));
    }
    /**
     * @param {?} id
     * @return {?}
     */
    deleteSharedState(id) {
        /** @type {?} */
        const url = '/clientstate/v1/states/' + id;
        return this.http.delete(url)
            .pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        val => sessionStorage.setItem('tcsTimestamp', Date.now().toString()))), map((/**
         * @param {?} result
         * @return {?}
         */
        result => 'success')));
    }
}
TcSharedStateService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
TcSharedStateService.ctorParameters = () => [
    { type: HttpClient },
    { type: Location }
];
/** @nocollapse */ TcSharedStateService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function TcSharedStateService_Factory() { return new TcSharedStateService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.Location)); }, token: TcSharedStateService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    TcSharedStateService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    TcSharedStateService.prototype.location;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGMtc2hhcmVkLXN0YXRlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGliY28tdGNzdGsvdGMtY29yZS1saWIvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvdGMtc2hhcmVkLXN0YXRlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBa0JBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFDLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLGVBQWUsRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBRWhHLE9BQU8sRUFBQyxVQUFVLEVBQUUsV0FBVyxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDN0QsT0FBTyxFQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QyxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLHlCQUF5QixDQUFDO0FBQ3BELE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLG9DQUFvQyxDQUFDOzs7O0FBS3pFLE1BQU0sT0FBTyxvQkFBb0I7Ozs7O0lBRS9CLFlBQW9CLElBQWdCLEVBQVUsUUFBa0I7UUFBNUMsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUFVLGFBQVEsR0FBUixRQUFRLENBQVU7SUFDaEUsQ0FBQzs7Ozs7Ozs7Ozs7O0lBRU0saUJBQWlCLENBQUMsSUFBWSxFQUNaLElBQVksRUFDWixXQUFtQixFQUNuQixTQUFpQixFQUNqQixVQUFvQixFQUNwQixLQUFlLEVBQ2YsS0FBZSxFQUNmLE9BQTJCOztjQUM1QyxHQUFHLEdBQUcsd0JBQXdCOztjQUU5QixJQUFJLEdBQUc7WUFDWCxNQUFNLEVBQUUsSUFBSTtZQUNaLE1BQU0sRUFBRSxJQUFJO1lBQ1osYUFBYSxFQUFFLFdBQVc7WUFDMUIsV0FBVyxFQUFFLFNBQVM7WUFDdEIsWUFB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YUFDekIsSUFBSSxDQUNILEdBQUc7Ozs7UUFBQyxHQUFHLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFDLEVBQ3pFLEdBQUc7Ozs7UUFBQyxNQUFNLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBQyxDQUN6QixDQUFDO0lBQ04sQ0FBQzs7O1lBcklGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OztZQVJPLFVBQVU7WUFFVixRQUFROzs7Ozs7OztJQVNGLG9DQUF3Qjs7Ozs7SUFBRSx3Q0FBMEIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBuZ2RvYyBjb21wb25lbnRcbiAqIEBuYW1lIHRjU2hhcmVkU3RhdGVTZXJ2aWNlXG4gKlxuICogQGRlc2NyaXB0aW9uXG4gKlxuICogdGNTaGFyZWRTdGF0ZVNlcnZpY2UgcHJvdmlkZXMgc2VydmljZXMgZm9yIG1hbmFnaW5nIHN0b3JlZCBjbGllbnQgY29uZmlnIHVzaW5nIHRoZSBUaWJjbyBMaXZlIEFwcHMgc2hhcmVkIHN0YXRlIHNlcnZpY2UuXG4gKlxuICogQWx0aG91Z2ggdGhpcyBpcyBhIGxpdmUgYXBwcyBzZXJ2aWNlIHJhdGhlciB0aGFuIGEgVGliY28gU3Vic2NyaWJlciBDbG91ZCBTZXJ2aWNlIGl0IGlzIGluc2lkZSB0aGUgY29yZSBwcm9qZWN0IHNpbmNlIGl0IHdpbGxcbiAqIGJlIHVzZWQgZm9yIGFsbCBhcHBsaWNhdGlvbnMgdG8gc3RvcmUgY29uZmlndXJhdGlvbiBpbmZvcm1hdGlvbi5cbiAqXG4gKiBCeSBob3N0aW5nIHRoaXMgc2VydmljZSBpbiB0aGUgY29yZSB3ZSBjYW4gYXZvaWQgYSBjaXJjdWxhciBkZXBlbmRlbmN5IHRvIHRoZSBsaXZlIGFwcHMgbGlicmFyeS5cbiAqXG4gKiBOb3RlOiBUaGlzIHNlcnZpY2Ugd2lsbCB1c2UgdGhlIGh0dHAgY2FjaGluZyBpbnRlcmNlcHRvciBmb3IgJ0dFVCcgY2FsbHMgYmFzZWQgb24gcGFzc2VkIHBhcmFtZXRlcnMuXG4gKlxuICpcbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1NoYXJlZFN0YXRlQ29udGVudCwgU2hhcmVkU3RhdGVFbnRyeSwgU2hhcmVkU3RhdGVMaXN0fSBmcm9tICcuLi9tb2RlbHMvdGMtc2hhcmVkLXN0YXRlJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgb2Z9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtIdHRwQ2xpZW50LCBIdHRwSGVhZGVyc30gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHttYXAsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtMb2NhdGlvbn0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7VWlBcHBDb25maWd9IGZyb20gJy4uL21vZGVscy90Yy1hcHAtY29uZmlnJztcbmltcG9ydCB7VGNDb3JlQ29tbW9uRnVuY3Rpb25zfSBmcm9tICcuLi9jb21tb24vdGMtY29yZS1jb21tb24tZnVuY3Rpb25zJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgVGNTaGFyZWRTdGF0ZVNlcnZpY2Uge1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cENsaWVudCwgcHJpdmF0ZSBsb2NhdGlvbjogTG9jYXRpb24pIHtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVTaGFyZWRTdGF0ZShuYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FuZGJveElkOiBudW1iZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzOiBzdHJpbmdbXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvbGVzOiBzdHJpbmdbXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtzOiBzdHJpbmdbXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IFNoYXJlZFN0YXRlQ29udGVudCk6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gICAgY29uc3QgdXJsID0gJy9jbGllbnRzdGF0ZS92MS9zdGF0ZXMnO1xuXG4gICAgY29uc3QgYm9keSA9IHtcbiAgICAgICduYW1lJzogbmFtZSxcbiAgICAgICd0eXBlJzogdHlwZSxcbiAgICAgICdkZXNjcmlwdGlvbic6IGRlc2NyaXB0aW9uLFxuICAgICAgJ3NhbmRib3hJZCc6IHNhbmRib3hJZCxcbiAgICAgICdhdHRyaWJ1dGVzJzogYXR0cmlidXRlcyxcbiAgICAgICdyb2xlcyc6IHJvbGVzLFxuICAgICAgJ2xpbmtzJzogbGlua3MsXG4gICAgICBjb250ZW50OiBjb250ZW50XG4gICAgfTtcbiAgICBjb25zdCBib2R5U3RyID0gSlNPTi5zdHJpbmdpZnkoYm9keSk7XG4gICAgY29uc3QgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpXG4gICAgICAuc2V0KCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdCh1cmwsIGJvZHlTdHIsIHtoZWFkZXJzfSlcbiAgICAgIC5waXBlKFxuICAgICAgICB0YXAodmFsID0+IHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ3Rjc1RpbWVzdGFtcCcsIERhdGUubm93KCkudG9TdHJpbmcoKSkpLFxuICAgICAgICBtYXAocmVzdWx0ID0+IHtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0LnRvU3RyaW5nKCk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgcHVibGljIHVwZGF0ZVNoYXJlZFN0YXRlKHNoYXJlZFN0YXRlTGlzdCk6IE9ic2VydmFibGU8U2hhcmVkU3RhdGVMaXN0PiB7XG4gICAgY29uc3QgdXJsID0gJy9jbGllbnRzdGF0ZS92MS9zdGF0ZXMnO1xuXG4gICAgY29uc3QgYm9keSA9IHNoYXJlZFN0YXRlTGlzdDtcbiAgICBjb25zdCBib2R5U3RyID0gSlNPTi5zdHJpbmdpZnkoYm9keSk7XG4gICAgY29uc3QgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpXG4gICAgICAuc2V0KCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgIHJldHVybiB0aGlzLmh0dHAucHV0KHVybCwgYm9keVN0ciwge2hlYWRlcnN9KVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcCh2YWwgPT4gc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgndGNzVGltZXN0YW1wJywgRGF0ZS5ub3coKS50b1N0cmluZygpKSksXG4gICAgICAgIG1hcCh1cGRhdGVkU2hhcmVkU3RhdGVMaXN0ID0+IG5ldyBTaGFyZWRTdGF0ZUxpc3QoKS5kZXNlcmlhbGl6ZSh1cGRhdGVkU2hhcmVkU3RhdGVMaXN0KSlcbiAgICAgICk7XG4gIH1cblxuICBwdWJsaWMgZ2V0U2hhcmVkU3RhdGUobmFtZTogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIHVzZUNhY2hlOiBib29sZWFuLCBmbHVzaENhY2hlOiBib29sZWFuKTogT2JzZXJ2YWJsZTxTaGFyZWRTdGF0ZUxpc3Q+IHtcbiAgICBjb25zdCB1cmwgPSAnL2NsaWVudHN0YXRlL3YxL3N0YXRlcz8kZmlsdGVyPXR5cGU9JyArIHR5cGVcbiAgICAgICsgJyBhbmQgbmFtZT1cXCcnICsgbmFtZSArICdcXCcnO1xuICAgIGxldCBvcHRpb25zID0ge31cbiAgICAvLyBzZXQgaGVhZGVycyB3aGVuIGNhY2hpbmcgcmVxdWlyZWRcbiAgICBsZXQgaGVhZGVyczogSHR0cEhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoKTtcbiAgICBpZiAodXNlQ2FjaGUpIHtcbiAgICAgIGhlYWRlcnMgPSBoZWFkZXJzLnNldCgnY2FjaGVSZXNwb25zZScsICd0cnVlJyk7XG4gICAgfVxuICAgIGlmIChmbHVzaENhY2hlKSB7XG4gICAgICBoZWFkZXJzID0gaGVhZGVycy5zZXQoJ2ZsdXNoQ2FjaGUnLCAndHJ1ZScpO1xuICAgIH1cbiAgICBvcHRpb25zID0ge2hlYWRlcnM6IGhlYWRlcnN9O1xuXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsLCBvcHRpb25zKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcCh2YWwgPT4gc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgndGNzVGltZXN0YW1wJywgRGF0ZS5ub3coKS50b1N0cmluZygpKSksXG4gICAgICAgIG1hcChzaGFyZWRTdGF0ZUxpc3QgPT4gbmV3IFNoYXJlZFN0YXRlTGlzdCgpLmRlc2VyaWFsaXplKHNoYXJlZFN0YXRlTGlzdCkpKTtcbiAgfVxuXG4gIC8qIFVpIEFwcCBDb25maWcgKi9cblxuICBwdWJsaWMgZ2V0VWlBcHBDb25maWcodWlBcHBJZDogc3RyaW5nLCB1c2VDYWNoZTogYm9vbGVhbiwgZmx1c2hDYWNoZTogYm9vbGVhbik6IE9ic2VydmFibGU8VWlBcHBDb25maWc+IHtcbiAgICAvLyBpZiB1c2VDYWNoZSBpcyBmYWxzZSB0aGlzIHdpbGwgdHJpZ2dlciB0aGUgc2VydmljZSB0byB1cGRhdGUgdGhlIGNhY2hlZCB2ZXJzaW9uIHdpdGggbGF0ZXN0XG4gICAgY29uc3Qgc3NOYW1lID0gdWlBcHBJZCArICcuY29uZmlnLnRpYmNvbGFicy5jbGllbnQuY29udGV4dC5QVUJMSUMnO1xuXG4gICAgcmV0dXJuIHRoaXMuZ2V0U2hhcmVkU3RhdGUoc3NOYW1lLCAnUFVCTElDJywgdXNlQ2FjaGUsIGZsdXNoQ2FjaGUpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKHZhbHVlID0+IHtcbiAgICAgICAgICAgIGlmICh2YWx1ZS5zaGFyZWRTdGF0ZUVudHJpZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICBjb25zdCBzc3Jlc3VsdCA9IG5ldyBVaUFwcENvbmZpZygpLmRlc2VyaWFsaXplKEpTT04ucGFyc2UodmFsdWUuc2hhcmVkU3RhdGVFbnRyaWVzWzBdLmNvbnRlbnQuanNvbikpO1xuICAgICAgICAgICAgICBzc3Jlc3VsdC5pZCA9IHZhbHVlLnNoYXJlZFN0YXRlRW50cmllc1swXS5pZDtcbiAgICAgICAgICAgICAgcmV0dXJuIHNzcmVzdWx0O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgICk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlVWlBcHBDb25maWcoc2FuZGJveElkOiBudW1iZXIsIHVpQXBwQ29uZmlnOiBVaUFwcENvbmZpZywgdWlBcHBJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICBjb25zdCBzc05hbWUgPSB1aUFwcElkICsgJy5jb25maWcudGliY29sYWJzLmNsaWVudC5jb250ZXh0LlBVQkxJQyc7XG4gICAgY29uc3QgY29udGVudDogU2hhcmVkU3RhdGVDb250ZW50ID0gbmV3IFNoYXJlZFN0YXRlQ29udGVudCgpO1xuICAgIGNvbnRlbnQuanNvbiA9IFRjQ29yZUNvbW1vbkZ1bmN0aW9ucy5lc2NhcGVTdHJpbmcoSlNPTi5zdHJpbmdpZnkodWlBcHBDb25maWcpKTtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVTaGFyZWRTdGF0ZShzc05hbWUsICdQVUJMSUMnLCAnJywgc2FuZGJveElkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBjb250ZW50KVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCh2YWx1ZSA9PiB2YWx1ZSlcbiAgICAgICk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlVWlBcHBDb25maWcoc2FuZGJveElkOiBudW1iZXIsIHVpQXBwQ29uZmlnOiBVaUFwcENvbmZpZywgdWlBcHBJZDogc3RyaW5nLCBpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxVaUFwcENvbmZpZz4ge1xuICAgIGNvbnN0IHNzTmFtZSA9IHVpQXBwSWQgKyAnLmNvbmZpZy50aWJjb2xhYnMuY2xpZW50LmNvbnRleHQuUFVCTElDJztcbiAgICBjb25zdCBjb250ZW50OiBTaGFyZWRTdGF0ZUNvbnRlbnQgPSBuZXcgU2hhcmVkU3RhdGVDb250ZW50KCk7XG4gICAgY29udGVudC5qc29uID0gVGNDb3JlQ29tbW9uRnVuY3Rpb25zLmVzY2FwZVN0cmluZyhKU09OLnN0cmluZ2lmeSh1aUFwcENvbmZpZykpO1xuICAgIGNvbnN0IGVudHJ5OiBTaGFyZWRTdGF0ZUVudHJ5ID0gbmV3IFNoYXJlZFN0YXRlRW50cnkoKTtcbiAgICBlbnRyeS5jb250ZW50ID0gY29udGVudDtcbiAgICBlbnRyeS5zYW5kYm94SWQgPSBzYW5kYm94SWQ7XG4gICAgZW50cnkubmFtZSA9IHNzTmFtZTtcbiAgICBlbnRyeS50eXBlID0gJ1BVQkxJQyc7XG4gICAgZW50cnkuaWQgPSBpZDtcbiAgICBjb25zdCBzc0xpc3Q6IFNoYXJlZFN0YXRlTGlzdCA9IG5ldyBTaGFyZWRTdGF0ZUxpc3QoKTtcbiAgICBzc0xpc3Quc2hhcmVkU3RhdGVFbnRyaWVzID0gW107XG4gICAgc3NMaXN0LnNoYXJlZFN0YXRlRW50cmllcy5wdXNoKGVudHJ5KTtcbiAgICByZXR1cm4gdGhpcy51cGRhdGVTaGFyZWRTdGF0ZShzc0xpc3Quc2hhcmVkU3RhdGVFbnRyaWVzKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCh2YWx1ZSA9PiB7XG4gICAgICAgICAgcmV0dXJuIG5ldyBVaUFwcENvbmZpZygpLmRlc2VyaWFsaXplKChKU09OLnBhcnNlKHZhbHVlLnNoYXJlZFN0YXRlRW50cmllc1swXS5jb250ZW50Lmpzb24pKSk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgcHVibGljIGRlbGV0ZVNoYXJlZFN0YXRlKGlkOiBudW1iZXIpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIGNvbnN0IHVybCA9ICcvY2xpZW50c3RhdGUvdjEvc3RhdGVzLycgKyBpZDtcbiAgICByZXR1cm4gdGhpcy5odHRwLmRlbGV0ZSh1cmwpXG4gICAgICAucGlwZShcbiAgICAgICAgdGFwKHZhbCA9PiBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCd0Y3NUaW1lc3RhbXAnLCBEYXRlLm5vdygpLnRvU3RyaW5nKCkpKSxcbiAgICAgICAgbWFwKHJlc3VsdCA9PiAnc3VjY2VzcycpXG4gICAgICApO1xuICB9XG5cbn1cbiJdfQ==