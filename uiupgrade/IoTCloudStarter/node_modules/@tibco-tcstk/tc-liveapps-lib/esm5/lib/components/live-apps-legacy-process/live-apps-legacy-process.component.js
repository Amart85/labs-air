/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, Input, Output } from '@angular/core';
import { LiveAppsComponent } from '../live-apps-component/live-apps-component.component';
import { LegacyIframeService } from '@tibco-tcstk/tc-core-lib';
import { TcVisibilityService } from '@tibco-tcstk/tc-core-lib';
import { LaProcessSelection } from '../../models/tc-case-processes';
/**
 * Wraps legacy angularjs form renderer
 *
 * \@example <tcla-live-apps-legacy-form></tcla-live-apps-legacy-form>
 */
var LiveAppsLegacyProcessComponent = /** @class */ (function (_super) {
    tslib_1.__extends(LiveAppsLegacyProcessComponent, _super);
    function LiveAppsLegacyProcessComponent(visibilityService, host, legacyIframeService) {
        var _this = _super.call(this) || this;
        _this.visibilityService = visibilityService;
        _this.host = host;
        _this.legacyIframeService = legacyIframeService;
        _this.legacyIframeId = _this.legacyIframeId ? _this.legacyIframeId : 'legacyProcessFrame';
        _this.processComplete = new EventEmitter();
        _this.processCancelled = new EventEmitter();
        _this.processActive = false;
        _this.changeProcess = (/**
         * @param {?} process
         * @return {?}
         */
        function (process) {
            // process has changed
            _this.renderProcess(process);
        });
        _this.renderProcess = (/**
         * @param {?} process
         * @return {?}
         */
        function (process) {
            if (_this.processActive && _this.openProcessId) {
                // opening a new process so cancel old one
                _this.cancelProcess(false);
            }
            // send message to external form app
            _this.formDiv.contentWindow.postMessage({
                action: _this.type === 'creator' ? 'runCreator' : 'runAction',
                processId: process.process.id,
                caseRef: process.caseReference,
                caseState: _this.caseState,
                applicationId: _this.applicationId,
                typeId: _this.typeId
            }, window.location.origin);
            // position the form iframe over the processDiv placeholder
            _this.processActive = true;
            _this.openProcessId = process.process.id;
            _this.resizeProcess();
        });
        _this.receiveMessage = (/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            if (event.data.action === 'processComplete') {
                _this.processActive = false;
                _this.openProcessId = undefined;
                _this.hideProcess();
                _this.processComplete.emit();
            }
            else if (event.data.action === 'processCancelled') {
                _this.processActive = false;
                _this.openProcessId = undefined;
                _this.hideProcess();
                _this.processCancelled.emit();
            }
        });
        _this.cancelProcess = (/**
         * @param {?=} emit
         * @return {?}
         */
        function (emit) {
            _this.formDiv.contentWindow.postMessage({ 'action': 'cancelProcess' }, window.location.origin);
            _this.processActive = false;
            _this.openProcessId = undefined;
            _this.hideProcess();
            if (emit) {
                _this.processCancelled.emit();
            }
        });
        _this.hideProcess = (/**
         * @return {?}
         */
        function () {
            // hide the iframe!
            _this.formDiv.style.top = '-1000px';
            _this.formDiv.style.left = '-1000px';
            _this.formDiv.style.zIndex = '1';
        });
        _this.resizeProcess = (/**
         * @return {?}
         */
        function () {
            // position the form iframe over the processDiv placeholder
            setTimeout((/**
             * @param {?} handler
             * @return {?}
             */
            function (handler) {
                /** @type {?} */
                var rect = _this.target.getBoundingClientRect();
                _this.formDiv.style.top = rect.top.toString() + 'px';
                _this.formDiv.style.left = rect.left.toString() + 'px';
                _this.formDiv.style.height = rect.height.toString() + 'px';
                _this.formDiv.style.width = rect.width.toString() + 'px';
                _this.formDiv.style.position = 'absolute';
                // creator needs 1001 so it is over the dialog box
                _this.formDiv.style.zIndex = (_this.type === 'creator') ? '1001' : '1000';
            }), 1000);
        });
        _this.initialize = (/**
         * @return {?}
         */
        function () {
            // listen for messages from the iframe
            window.addEventListener('message', _this.receiveMessage, false);
            // we only want to render the process when the element is visible
            /** @type {?} */
            var inSight$ = _this.visibilityService.elementInSight(_this.host);
            inSight$.subscribe((/**
             * @param {?} next
             * @return {?}
             */
            function (next) {
                if (!next) {
                    // element not visible so hide the process if it is showing
                    if (_this.processActive && _this.target) {
                        _this.hideProcess();
                    }
                }
                else {
                    // element is visible
                    if (!_this.processActive) {
                        // if process not already showing - show it
                        // first get a handle on the target div and the legacy iframe
                        _this.target = document.getElementById('processDiv');
                        _this.formDiv = document.getElementById(_this.legacyIframeId);
                        if (_this.openProcessId) {
                            // trigger display of the process
                            _this.renderProcess(_this.process);
                        }
                    }
                    else {
                        _this.resizeProcess();
                    }
                }
            }));
        });
        return _this;
    }
    /**
     * @return {?}
     */
    LiveAppsLegacyProcessComponent.prototype.isFormActive = /**
     * @return {?}
     */
    function () {
        return this.processActive;
    };
    /**
     * @return {?}
     */
    LiveAppsLegacyProcessComponent.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        _super.prototype.ngAfterViewInit.call(this);
        this.openProcessId = this.process.process.id;
        this.containerChanges$.subscribe((/**
         * @param {?} widget
         * @return {?}
         */
        function (widget) {
            if (_this.processActive && _this.target) {
                _this.resizeProcess();
            }
        }));
        // wait for iframe to load before doing anything else
        // this observable will emit true once the iFrame is loaded
        this.legacyIframeService.processStatus.subscribe((/**
         * @param {?} loaded
         * @return {?}
         */
        function (loaded) {
            if (loaded) {
                // iframe is loaded
                _this.initialize();
            }
        }));
    };
    /**
     * @return {?}
     */
    LiveAppsLegacyProcessComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.openProcessId) {
            this.cancelProcess();
        }
    };
    LiveAppsLegacyProcessComponent.decorators = [
        { type: Component, args: [{
                    selector: 'tcla-live-apps-legacy-process',
                    template: "<div #componentDiv fxFill id=\"processDiv\" style=\"border: none;\"></div>\n",
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    LiveAppsLegacyProcessComponent.ctorParameters = function () { return [
        { type: TcVisibilityService },
        { type: ElementRef },
        { type: LegacyIframeService }
    ]; };
    LiveAppsLegacyProcessComponent.propDecorators = {
        legacyIframeId: [{ type: Input }],
        process: [{ type: Input }],
        type: [{ type: Input }],
        applicationId: [{ type: Input }],
        typeId: [{ type: Input }],
        caseRef: [{ type: Input }],
        caseState: [{ type: Input }],
        processComplete: [{ type: Output }],
        processCancelled: [{ type: Output }]
    };
    return LiveAppsLegacyProcessComponent;
}(LiveAppsComponent));
export { LiveAppsLegacyProcessComponent };
if (false) {
    /** @type {?} */
    LiveAppsLegacyProcessComponent.prototype.legacyIframeId;
    /** @type {?} */
    LiveAppsLegacyProcessComponent.prototype.process;
    /** @type {?} */
    LiveAppsLegacyProcessComponent.prototype.type;
    /** @type {?} */
    LiveAppsLegacyProcessComponent.prototype.applicationId;
    /** @type {?} */
    LiveAppsLegacyProcessComponent.prototype.typeId;
    /** @type {?} */
    LiveAppsLegacyProcessComponent.prototype.caseRef;
    /** @type {?} */
    LiveAppsLegacyProcessComponent.prototype.caseState;
    /** @type {?} */
    LiveAppsLegacyProcessComponent.prototype.processComplete;
    /** @type {?} */
    LiveAppsLegacyProcessComponent.prototype.processCancelled;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyProcessComponent.prototype.target;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyProcessComponent.prototype.formDiv;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyProcessComponent.prototype.processActive;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyProcessComponent.prototype.openProcessId;
    /** @type {?} */
    LiveAppsLegacyProcessComponent.prototype.changeProcess;
    /** @type {?} */
    LiveAppsLegacyProcessComponent.prototype.renderProcess;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyProcessComponent.prototype.receiveMessage;
    /** @type {?} */
    LiveAppsLegacyProcessComponent.prototype.cancelProcess;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyProcessComponent.prototype.hideProcess;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyProcessComponent.prototype.resizeProcess;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyProcessComponent.prototype.initialize;
    /**
     * @type {?}
     * @protected
     */
    LiveAppsLegacyProcessComponent.prototype.visibilityService;
    /**
     * @type {?}
     * @protected
     */
    LiveAppsLegacyProcessComponent.prototype.host;
    /**
     * @type {?}
     * @protected
     */
    LiveAppsLegacyProcessComponent.prototype.legacyIframeService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS1hcHBzLWxlZ2FjeS1wcm9jZXNzLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0aWJjby10Y3N0ay90Yy1saXZlYXBwcy1saWIvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9saXZlLWFwcHMtbGVnYWN5LXByb2Nlc3MvbGl2ZS1hcHBzLWxlZ2FjeS1wcm9jZXNzLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFFTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixLQUFLLEVBR0wsTUFBTSxFQUNQLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLHNEQUFzRCxDQUFDO0FBQ3ZGLE9BQU8sRUFBQyxtQkFBbUIsRUFBcUMsTUFBTSwwQkFBMEIsQ0FBQztBQUNqRyxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUM3RCxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSxnQ0FBZ0MsQ0FBQzs7Ozs7O0FBUWxFO0lBS29ELDBEQUFpQjtJQWlCbkUsd0NBQXVCLGlCQUFzQyxFQUFZLElBQWdCLEVBQVksbUJBQXdDO1FBQTdJLFlBQ0UsaUJBQU8sU0FDUjtRQUZzQix1QkFBaUIsR0FBakIsaUJBQWlCLENBQXFCO1FBQVksVUFBSSxHQUFKLElBQUksQ0FBWTtRQUFZLHlCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFmcEksb0JBQWMsR0FBRyxLQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBRSxLQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQztRQU9sRixxQkFBZSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDckMsc0JBQWdCLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUl4QyxtQkFBYSxHQUFHLEtBQUssQ0FBQztRQVd2QixtQkFBYTs7OztRQUFHLFVBQUMsT0FBMkI7WUFDakQsc0JB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biAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIElucHV0LFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT3V0cHV0XG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtMaXZlQXBwc0NvbXBvbmVudH0gZnJvbSAnLi4vbGl2ZS1hcHBzLWNvbXBvbmVudC9saXZlLWFwcHMtY29tcG9uZW50LmNvbXBvbmVudCc7XG5pbXBvcnQge0xlZ2FjeUlmcmFtZVNlcnZpY2UsIFRjQ29tcG9uZW50LCBUY0NvcmVDb21tb25GdW5jdGlvbnN9IGZyb20gJ0B0aWJjby10Y3N0ay90Yy1jb3JlLWxpYic7XG5pbXBvcnQge1RjVmlzaWJpbGl0eVNlcnZpY2V9IGZyb20gJ0B0aWJjby10Y3N0ay90Yy1jb3JlLWxpYic7XG5pbXBvcnQge0xhUHJvY2Vzc1NlbGVjdGlvbn0gZnJvbSAnLi4vLi4vbW9kZWxzL3RjLWNhc2UtcHJvY2Vzc2VzJztcblxuLyoqXG4gKiBXcmFwcyBsZWdhY3kgYW5ndWxhcmpzIGZvcm0gcmVuZGVyZXJcbiAqXG4gKkBleGFtcGxlIDx0Y2xhLWxpdmUtYXBwcy1sZWdhY3ktZm9ybT48L3RjbGEtbGl2ZS1hcHBzLWxlZ2FjeS1mb3JtPlxuICovXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3RjbGEtbGl2ZS1hcHBzLWxlZ2FjeS1wcm9jZXNzJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2xpdmUtYXBwcy1sZWdhY3ktcHJvY2Vzcy5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2xpdmUtYXBwcy1sZWdhY3ktcHJvY2Vzcy5jb21wb25lbnQuY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgTGl2ZUFwcHNMZWdhY3lQcm9jZXNzQ29tcG9uZW50IGV4dGVuZHMgTGl2ZUFwcHNDb21wb25lbnQgaW1wbGVtZW50cyBPbkRlc3Ryb3ksIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdCB7XG5cbiAgQElucHV0KCkgbGVnYWN5SWZyYW1lSWQgPSB0aGlzLmxlZ2FjeUlmcmFtZUlkID8gIHRoaXMubGVnYWN5SWZyYW1lSWQgOiAnbGVnYWN5UHJvY2Vzc0ZyYW1lJztcbiAgQElucHV0KCkgcHJvY2VzczogTGFQcm9jZXNzU2VsZWN0aW9uO1xuICBASW5wdXQoKSB0eXBlOiBzdHJpbmc7IC8vIGNyZWF0b3IvcHJvY2Vzc1xuICBASW5wdXQoKSBhcHBsaWNhdGlvbklkOiBzdHJpbmc7XG4gIEBJbnB1dCgpIHR5cGVJZDogc3RyaW5nO1xuICBASW5wdXQoKSBjYXNlUmVmOiBzdHJpbmc7XG4gIEBJbnB1dCgpIGNhc2VTdGF0ZTogc3RyaW5nO1xuICBAT3V0cHV0KCkgcHJvY2Vzc0NvbXBsZXRlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KCkgcHJvY2Vzc0NhbmNlbGxlZCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBwcml2YXRlIHRhcmdldDtcbiAgcHJpdmF0ZSBmb3JtRGl2O1xuICBwcml2YXRlIHByb2Nlc3NBY3RpdmUgPSBmYWxzZTtcbiAgcHJpdmF0ZSBvcGVuUHJvY2Vzc0lkO1xuXG4gIGNvbnN0cnVjdG9yIChwcm90ZWN0ZWQgdmlzaWJpbGl0eVNlcnZpY2U6IFRjVmlzaWJpbGl0eVNlcnZpY2UsIHByb3RlY3RlZCBob3N0OiBFbGVtZW50UmVmLCBwcm90ZWN0ZWQgbGVnYWN5SWZyYW1lU2VydmljZTogTGVnYWN5SWZyYW1lU2VydmljZSkge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBwdWJsaWMgaXNGb3JtQWN0aXZlKCkge1xuICAgIHJldHVybiB0aGlzLnByb2Nlc3NBY3RpdmU7XG4gIH1cblxuICBwdWJsaWMgY2hhbmdlUHJvY2VzcyA9IChwcm9jZXNzOiBMYVByb2Nlc3NTZWxlY3Rpb24pID0+IHtcbiAgICAvLyBwcm9jZXNzIGhhcyBjaGFuZ2VkXG4gICAgdGhpcy5yZW5kZXJQcm9jZXNzKHByb2Nlc3MpO1xuICB9XG5cbiAgcHVibGljIHJlbmRlclByb2Nlc3MgPSAocHJvY2VzczogTGFQcm9jZXNzU2VsZWN0aW9uKSA9PiB7XG4gICAgaWYgKHRoaXMucHJvY2Vzc0FjdGl2ZSAmJiB0aGlzLm9wZW5Qcm9jZXNzSWQpIHtcbiAgICAgIC8vIG9wZW5pbmcgYSBuZXcgcHJvY2VzcyBzbyBjYW5jZWwgb2xkIG9uZVxuICAgICAgdGhpcy5jYW5jZWxQcm9jZXNzKGZhbHNlKTtcbiAgICB9XG5cbiAgICAvLyBzZW5kIG1lc3NhZ2UgdG8gZXh0ZXJuYWwgZm9ybSBhcHBcbiAgICB0aGlzLmZvcm1EaXYuY29udGVudFdpbmRvdy5wb3N0TWVzc2FnZSh7XG4gICAgICBhY3Rpb246IHRoaXMudHlwZSA9PT0gJ2NyZWF0b3InID8gJ3J1bkNyZWF0b3InIDogJ3J1bkFjdGlvbicsXG4gICAgICBwcm9jZXNzSWQ6IHByb2Nlc3MucHJvY2Vzcy5pZCxcbiAgICAgIGNhc2VSZWY6IHByb2Nlc3MuY2FzZVJlZmVyZW5jZSxcbiAgICAgIGNhc2VTdGF0ZTogdGhpcy5jYXNlU3RhdGUsXG4gICAgICBhcHBsaWNhdGlvbklkOiB0aGlzLmFwcGxpY2F0aW9uSWQsXG4gICAgICB0eXBlSWQ6IHRoaXMudHlwZUlkXG4gICAgfSwgd2luZG93LmxvY2F0aW9uLm9yaWdpbik7XG5cbiAgICAvLyBwb3NpdGlvbiB0aGUgZm9ybSBpZnJhbWUgb3ZlciB0aGUgcHJvY2Vzc0RpdiBwbGFjZWhvbGRlclxuICAgIHRoaXMucHJvY2Vzc0FjdGl2ZSA9IHRydWU7XG4gICAgdGhpcy5vcGVuUHJvY2Vzc0lkID0gcHJvY2Vzcy5wcm9jZXNzLmlkO1xuICAgIHRoaXMucmVzaXplUHJvY2VzcygpO1xuICB9XG5cbiAgcHJpdmF0ZSByZWNlaXZlTWVzc2FnZSA9IChldmVudCkgPT4ge1xuICAgIGlmIChldmVudC5kYXRhLmFjdGlvbiA9PT0gJ3Byb2Nlc3NDb21wbGV0ZScpIHtcbiAgICAgIHRoaXMucHJvY2Vzc0FjdGl2ZSA9IGZhbHNlO1xuICAgICAgdGhpcy5vcGVuUHJvY2Vzc0lkID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5oaWRlUHJvY2VzcygpO1xuICAgICAgdGhpcy5wcm9jZXNzQ29tcGxldGUuZW1pdCgpO1xuICAgIH0gZWxzZSBpZiAoZXZlbnQuZGF0YS5hY3Rpb24gPT09ICdwcm9jZXNzQ2FuY2VsbGVkJykge1xuICAgICAgdGhpcy5wcm9jZXNzQWN0aXZlID0gZmFsc2U7XG4gICAgICB0aGlzLm9wZW5Qcm9jZXNzSWQgPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLmhpZGVQcm9jZXNzKCk7XG4gICAgICB0aGlzLnByb2Nlc3NDYW5jZWxsZWQuZW1pdCgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjYW5jZWxQcm9jZXNzID0gKGVtaXQ/OiBib29sZWFuKSA9PiB7XG4gICAgdGhpcy5mb3JtRGl2LmNvbnRlbnRXaW5kb3cucG9zdE1lc3NhZ2UoeyAnYWN0aW9uJzogJ2NhbmNlbFByb2Nlc3MnIH0sIHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4pO1xuICAgIHRoaXMucHJvY2Vzc0FjdGl2ZSA9IGZhbHNlO1xuICAgIHRoaXMub3BlblByb2Nlc3NJZCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmhpZGVQcm9jZXNzKCk7XG4gICAgaWYgKGVtaXQpIHtcbiAgICAgIHRoaXMucHJvY2Vzc0NhbmNlbGxlZC5lbWl0KCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoaWRlUHJvY2VzcyA9ICgpID0+IHtcbiAgLy8gaGlkZSB0aGUgaWZyYW1lIVxuICAgICAgdGhpcy5mb3JtRGl2LnN0eWxlLnRvcCA9ICctMTAwMHB4JztcbiAgICAgIHRoaXMuZm9ybURpdi5zdHlsZS5sZWZ0ID0gJy0xMDAwcHgnO1xuICAgICAgdGhpcy5mb3JtRGl2LnN0eWxlLnpJbmRleCA9ICcxJztcbiAgfVxuXG4gIHByaXZhdGUgcmVzaXplUHJvY2VzcyA9ICgpID0+IHtcbiAgICAvLyBwb3NpdGlvbiB0aGUgZm9ybSBpZnJhbWUgb3ZlciB0aGUgcHJvY2Vzc0RpdiBwbGFjZWhvbGRlclxuICAgIHNldFRpbWVvdXQoaGFuZGxlciA9PiB7XG4gICAgICBjb25zdCByZWN0ID0gdGhpcy50YXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICB0aGlzLmZvcm1EaXYuc3R5bGUudG9wID0gcmVjdC50b3AudG9TdHJpbmcoKSArICdweCc7XG4gICAgICB0aGlzLmZvcm1EaXYuc3R5bGUubGVmdCA9IHJlY3QubGVmdC50b1N0cmluZygpICsgJ3B4JztcbiAgICAgIHRoaXMuZm9ybURpdi5zdHlsZS5oZWlnaHQgPSByZWN0LmhlaWdodC50b1N0cmluZygpICsgJ3B4JztcbiAgICAgIHRoaXMuZm9ybURpdi5zdHlsZS53aWR0aCA9IHJlY3Qud2lkdGgudG9TdHJpbmcoKSArICdweCc7XG4gICAgICB0aGlzLmZvcm1EaXYuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnO1xuICAgICAgLy8gY3JlYXRvciBuZWVkcyAxMDAxIHNvIGl0IGlzIG92ZXIgdGhlIGRpYWxvZyBib3hcbiAgICAgIHRoaXMuZm9ybURpdi5zdHlsZS56SW5kZXggPSAodGhpcy50eXBlID09PSAnY3JlYXRvcicpID8gJzEwMDEnIDogJzEwMDAnO1xuICAgIH0sIDEwMDApO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0aWFsaXplID0gKCkgPT4ge1xuICAgIC8vIGxpc3RlbiBmb3IgbWVzc2FnZXMgZnJvbSB0aGUgaWZyYW1lXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCB0aGlzLnJlY2VpdmVNZXNzYWdlLCBmYWxzZSk7XG5cbiAgICAvLyB3ZSBvbmx5IHdhbnQgdG8gcmVuZGVyIHRoZSBwcm9jZXNzIHdoZW4gdGhlIGVsZW1lbnQgaXMgdmlzaWJsZVxuICAgIGNvbnN0IGluU2lnaHQkID0gdGhpcy52aXNpYmlsaXR5U2VydmljZS5lbGVtZW50SW5TaWdodCh0aGlzLmhvc3QpO1xuICAgIGluU2lnaHQkLnN1YnNjcmliZShuZXh0ID0+IHtcbiAgICAgIGlmICghbmV4dCkge1xuICAgICAgICAvLyBlbGVtZW50IG5vdCB2aXNpYmxlIHNvIGhpZGUgdGhlIHByb2Nlc3MgaWYgaXQgaXMgc2hvd2luZ1xuICAgICAgICBpZiAodGhpcy5wcm9jZXNzQWN0aXZlICYmIHRoaXMudGFyZ2V0KSB7XG4gICAgICAgICAgdGhpcy5oaWRlUHJvY2VzcygpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBlbGVtZW50IGlzIHZpc2libGVcbiAgICAgICAgaWYgKCF0aGlzLnByb2Nlc3NBY3RpdmUpIHtcbiAgICAgICAgICAvLyBpZiBwcm9jZXNzIG5vdCBhbHJlYWR5IHNob3dpbmcgLSBzaG93IGl0XG4gICAgICAgICAgLy8gZmlyc3QgZ2V0IGEgaGFuZGxlIG9uIHRoZSB0YXJnZXQgZGl2IGFuZCB0aGUgbGVnYWN5IGlmcmFtZVxuICAgICAgICAgIHRoaXMudGFyZ2V0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2Nlc3NEaXYnKTtcbiAgICAgICAgICB0aGlzLmZvcm1EaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLmxlZ2FjeUlmcmFtZUlkKTtcbiAgICAgICAgICBpZiAodGhpcy5vcGVuUHJvY2Vzc0lkKSB7XG4gICAgICAgICAgICAvLyB0cmlnZ2VyIGRpc3BsYXkgb2YgdGhlIHByb2Nlc3NcbiAgICAgICAgICAgIHRoaXMucmVuZGVyUHJvY2Vzcyh0aGlzLnByb2Nlc3MpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLnJlc2l6ZVByb2Nlc3MoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIHN1cGVyLm5nQWZ0ZXJWaWV3SW5pdCgpO1xuICAgIHRoaXMub3BlblByb2Nlc3NJZCA9IHRoaXMucHJvY2Vzcy5wcm9jZXNzLmlkO1xuICAgIHRoaXMuY29udGFpbmVyQ2hhbmdlcyQuc3Vic2NyaWJlKHdpZGdldCA9PiB7XG4gICAgICBpZiAodGhpcy5wcm9jZXNzQWN0aXZlICYmIHRoaXMudGFyZ2V0KSB7XG4gICAgICAgIHRoaXMucmVzaXplUHJvY2VzcygpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gd2FpdCBmb3IgaWZyYW1lIHRvIGxvYWQgYmVmb3JlIGRvaW5nIGFueXRoaW5nIGVsc2VcbiAgICAvLyB0aGlzIG9ic2VydmFibGUgd2lsbCBlbWl0IHRydWUgb25jZSB0aGUgaUZyYW1lIGlzIGxvYWRlZFxuICAgIHRoaXMubGVnYWN5SWZyYW1lU2VydmljZS5wcm9jZXNzU3RhdHVzLnN1YnNjcmliZShsb2FkZWQgPT4ge1xuICAgICAgaWYgKGxvYWRlZCkge1xuICAgICAgICAvLyBpZnJhbWUgaXMgbG9hZGVkXG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgaWYgKHRoaXMub3BlblByb2Nlc3NJZCkge1xuICAgICAgdGhpcy5jYW5jZWxQcm9jZXNzKCk7XG4gICAgfVxuICB9XG59XG4iXX0=