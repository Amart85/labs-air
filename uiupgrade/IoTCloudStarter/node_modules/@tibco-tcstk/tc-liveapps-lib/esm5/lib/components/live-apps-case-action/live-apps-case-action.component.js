/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, Input, ViewChild } from '@angular/core';
import { LiveAppsCaseCreatorComponent } from '../live-apps-case-creator/live-apps-case-creator.component';
import { LiveAppsService } from '../../services/live-apps.service';
import { take, takeUntil } from 'rxjs/operators';
import { LiveAppsLegacyProcessComponent } from '../live-apps-legacy-process/live-apps-legacy-process.component';
/**
 * Wraps rendering an execution of an action
 *
 * \@example <tcla-live-apps-case-action></tcla-live-apps-case-action>
 */
var LiveAppsCaseActionComponent = /** @class */ (function (_super) {
    tslib_1.__extends(LiveAppsCaseActionComponent, _super);
    function LiveAppsCaseActionComponent(lasvc) {
        var _this = _super.call(this, lasvc) || this;
        _this.lasvc = lasvc;
        /**
         * Enable legacy actions
         */
        _this.legacyActions = _this.legacyActions ? _this.legacyActions : false;
        /**
         * Allow override of forms framework
         * Options: bootstrap-4 or material-design
         */
        _this.formsFramework = _this.formsFramework ? _this.formsFramework : 'material-design';
        _this.getCaseData = (/**
         * @param {?} caseRef
         * @return {?}
         */
        function (caseRef) {
            // retrieve the case data for this case reference
            _this.liveapps.getCase(_this.caseRef, _this.sandboxId, _this.applicationId, _this.typeId)
                .pipe(take(1), takeUntil(_this._destroyed$))
                .subscribe((/**
             * @param {?} result
             * @return {?}
             */
            function (result) {
                var _a, _b;
                if (result.metadata.applicationId === _this.applicationId.toString()) {
                    /** @type {?} */
                    var casedata = result.untaggedCasedataObj;
                    _this.caseState = casedata.state;
                    _this.originalData = (_a = {},
                        _a[_this.process.process.name] = casedata,
                        _a);
                    // JS: use name rather than internalObjectName to handle appliction name change
                    /** @type {?} */
                    var caseTypeName = _this.getMainCaseTypeFromSchema(_this.typeId, _this.process).name;
                    _this.data = (_b = {},
                        _b[caseTypeName] = casedata,
                        _b);
                }
                else {
                    console.error('The selected case is not the right case type for this action');
                }
            }), (/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                // Emit any error retrieving case data to the parent
                console.error('Unable to retrieve case data');
                console.error(error);
            }));
        });
        _this.cancelAction = (/**
         * @return {?}
         */
        function () {
            if (_this.legacyProcessComponent) {
                _this.legacyProcessComponent.cancelProcess();
            }
        });
        return _this;
    }
    /**
     * @private
     * @param {?} typeId
     * @param {?} process
     * @return {?}
     */
    LiveAppsCaseActionComponent.prototype.getMainCaseTypeFromSchema = /**
     * @private
     * @param {?} typeId
     * @param {?} process
     * @return {?}
     */
    function (typeId, process) {
        /** @type {?} */
        var requestedType;
        process.appSchema.casetypes.forEach((/**
         * @param {?} cType
         * @return {?}
         */
        function (cType) {
            if (cType.id === typeId) {
                requestedType = cType;
            }
        }));
        return requestedType;
    };
    /**
     * @return {?}
     */
    LiveAppsCaseActionComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        // set default layout
        // this.layout = [];
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    LiveAppsCaseActionComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        // the extended class will detect change in the process and layout passed
        _super.prototype.ngOnChanges.call(this, changes);
        // handle input param changes
        if ((changes.caseRef && changes.caseRef.currentValue && (changes.caseRef.currentValue !== changes.caseRef.previousValue))
            || (changes.process && changes.process.currentValue && (changes.process.currentValue !== changes.process.previousValue))) {
            // get case data if anything changes
            if (changes.process.currentValue) {
                this.getCaseData(this.caseRef);
            }
        }
        // handle process change for legacy action process
        if (changes.process && changes.process.currentValue && (changes.process.currentValue !== changes.process.previousValue)) {
            if (this.legacyProcessComponent) {
                this.legacyProcessComponent.changeProcess(changes.process.currentValue);
            }
        }
    };
    LiveAppsCaseActionComponent.decorators = [
        { type: Component, args: [{
                    selector: 'tcla-live-apps-case-action',
                    template: "<div class=\"tcs-case-action-pane\" fxLayout=\"column\" fxFill>\n  <tc-tibco-cloud-widget-header *ngIf=\"showHeader\" fxFlex=\"nogrow\" [headerText]=\"'Action'\" [icon]=\"'tcs-case-action-item'\"></tc-tibco-cloud-widget-header>\n  <tcfrm-rendered-form *ngIf=\"data && process && (!legacyActions || isCustomForm)\" [schema]=\"schema\" [layout]=\"layout\" [data]=\"data\" [caseRef]=\"caseRef\" [appId]=\"applicationId\" [customFormDefs]=\"customFormDefs\" [formsFramework]=\"formsFramework\" [formRef]=\"process.ref\" (formSubmit)=\"handleSubmit($event, caseRef)\"></tcfrm-rendered-form>\n  <tcla-live-apps-legacy-process *ngIf=\"data && process && legacyActions && !isCustomForm\" [process]=\"process\" [caseState]=\"caseState\" [type]=\"'action'\" [applicationId]=\"applicationId\" [typeId]=\"typeId\" [caseRef]=\"caseRef\" (processCancelled)=\"handleLegacyProcessCancelled()\" (processComplete)=\"handleLegacyProcessComplete()\" class=\"live-apps-widget\" fxFill></tcla-live-apps-legacy-process>\n</div>\n",
                    styles: [".tcs-case-action-pane{border-radius:3px;box-shadow:0 2px 4px 0 rgba(0,0,0,.33);background-color:#fff}.tcs-case-action-header{height:40px;border-radius:3px 3px 0 0;box-shadow:0 1px 2px 0 #dedede;padding-left:20px;padding-right:20px}.tcs-case-action-header-text{margin-left:10px;font-family:Source Sans Pro;font-size:18px;font-weight:600;font-style:normal;font-stretch:normal;line-height:1.5;letter-spacing:.3px}"]
                }] }
    ];
    /** @nocollapse */
    LiveAppsCaseActionComponent.ctorParameters = function () { return [
        { type: LiveAppsService }
    ]; };
    LiveAppsCaseActionComponent.propDecorators = {
        caseRef: [{ type: Input }],
        showHeader: [{ type: Input }],
        legacyActions: [{ type: Input }],
        formsFramework: [{ type: Input }],
        legacyProcessComponent: [{ type: ViewChild, args: [LiveAppsLegacyProcessComponent, { static: false },] }]
    };
    return LiveAppsCaseActionComponent;
}(LiveAppsCaseCreatorComponent));
export { LiveAppsCaseActionComponent };
if (false) {
    /**
     * The case reference
     * @type {?}
     */
    LiveAppsCaseActionComponent.prototype.caseRef;
    /**
     * Whether to show the header bar in the widget - eg. favorites on home page (contains icon etc) - if off icons still appear without bar
     * @type {?}
     */
    LiveAppsCaseActionComponent.prototype.showHeader;
    /**
     * Enable legacy actions
     * @type {?}
     */
    LiveAppsCaseActionComponent.prototype.legacyActions;
    /**
     * Allow override of forms framework
     * Options: bootstrap-4 or material-design
     * @type {?}
     */
    LiveAppsCaseActionComponent.prototype.formsFramework;
    /** @type {?} */
    LiveAppsCaseActionComponent.prototype.legacyProcessComponent;
    /** @type {?} */
    LiveAppsCaseActionComponent.prototype.originalData;
    /** @type {?} */
    LiveAppsCaseActionComponent.prototype.caseState;
    /**
     * @type {?}
     * @private
     */
    LiveAppsCaseActionComponent.prototype.getCaseData;
    /** @type {?} */
    LiveAppsCaseActionComponent.prototype.cancelAction;
    /**
     * @type {?}
     * @protected
     */
    LiveAppsCaseActionComponent.prototype.lasvc;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS1hcHBzLWNhc2UtYWN0aW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0aWJjby10Y3N0ay90Yy1saXZlYXBwcy1saWIvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9saXZlLWFwcHMtY2FzZS1hY3Rpb24vbGl2ZS1hcHBzLWNhc2UtYWN0aW9uLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBQyxTQUFTLEVBQWdCLEtBQUssRUFBNEMsU0FBUyxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ2xILE9BQU8sRUFBQyw0QkFBNEIsRUFBQyxNQUFNLDREQUE0RCxDQUFDO0FBQ3hHLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxrQ0FBa0MsQ0FBQztBQUNqRSxPQUFPLEVBQU0sSUFBSSxFQUFFLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBR3BELE9BQU8sRUFBQyw4QkFBOEIsRUFBQyxNQUFNLGdFQUFnRSxDQUFDOzs7Ozs7QUFTOUc7SUFLaUQsdURBQTRCO0lBeUUzRSxxQ0FBc0IsS0FBc0I7UUFBNUMsWUFDRSxrQkFBTSxLQUFLLENBQUMsU0FDYjtRQUZxQixXQUFLLEdBQUwsS0FBSyxDQUFpQjs7OztRQTNEbkMsbUJBQWEsR0FBWSxLQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxLQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7Ozs7O1FBTXpFLG9CQUFjLEdBQVcsS0FBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsS0FBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsaUJBQWlCLENBQUM7UUFrQnhGLGlCQUFXOzs7O1FBQUcsVUFBQyxPQUFPO1lBQzVCLGlEQUFpRDtZQUNqRCxLQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFJLENBQUMsT0FBTyxFQUFFLEtBQUksQ0FBQyxTQUFTLEVBQUUsS0FBSSxDQUFDLGFBQWEsRUFBRSxLQUFJ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Q0FBQyxFQUFFO1lBQ3ZILElBQUksSUFBSSxDQUFDLHNCQUFzQixFQUFFO2dCQUMvQixJQUFJLENBQUMsc0JBQXNCLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDekU7U0FDRjtJQUNILENBQUM7O2dCQXhHRixTQUFTLFNBQUM7b0JBQ1QsUUFBUSxFQUFFLDRCQUE0QjtvQkFDdEMsMC9CQUFxRDs7aUJBRXREOzs7O2dCQWpCTyxlQUFlOzs7MEJBc0JwQixLQUFLOzZCQUtMLEtBQUs7Z0NBS0wsS0FBSztpQ0FNTCxLQUFLO3lDQUdMLFNBQVMsU0FBQyw4QkFBOEIsRUFBRSxFQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUM7O0lBOEU1RCxrQ0FBQztDQUFBLEFBMUdELENBS2lELDRCQUE0QixHQXFHNUU7U0FyR1ksMkJBQTJCOzs7Ozs7SUFJdEMsOENBQXlCOzs7OztJQUt6QixpREFBNkI7Ozs7O0lBSzdCLG9EQUFrRjs7Ozs7O0lBTWxGLHFEQUFnRzs7SUFHaEcsNkRBQW1IOztJQUVuSCxtREFBa0I7O0lBQ2xCLGdEQUFrQjs7Ozs7SUFZbEIsa0RBMkJDOztJQUVELG1EQUlDOzs7OztJQUVXLDRDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkNoYW5nZXMsIE9uSW5pdCwgT3V0cHV0LCBTaW1wbGVDaGFuZ2VzLCBWaWV3Q2hpbGR9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtMaXZlQXBwc0Nhc2VDcmVhdG9yQ29tcG9uZW50fSBmcm9tICcuLi9saXZlLWFwcHMtY2FzZS1jcmVhdG9yL2xpdmUtYXBwcy1jYXNlLWNyZWF0b3IuY29tcG9uZW50JztcbmltcG9ydCB7TGl2ZUFwcHNTZXJ2aWNlfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9saXZlLWFwcHMuc2VydmljZSc7XG5pbXBvcnQge21hcCwgdGFrZSwgdGFrZVVudGlsfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge0Nhc2VUeXBlLCBQcm9jZXNzSWR9IGZyb20gJy4uLy4uL21vZGVscy9saXZlYXBwc2RhdGEnO1xuaW1wb3J0IHtMYVByb2Nlc3NTZWxlY3Rpb259IGZyb20gJy4uLy4uL21vZGVscy90Yy1jYXNlLXByb2Nlc3Nlcyc7XG5pbXBvcnQge0xpdmVBcHBzTGVnYWN5UHJvY2Vzc0NvbXBvbmVudH0gZnJvbSAnLi4vbGl2ZS1hcHBzLWxlZ2FjeS1wcm9jZXNzL2xpdmUtYXBwcy1sZWdhY3ktcHJvY2Vzcy5jb21wb25lbnQnO1xuXG5cbi8qKlxuICogV3JhcHMgcmVuZGVyaW5nIGFuIGV4ZWN1dGlvbiBvZiBhbiBhY3Rpb25cbiAqXG4gKkBleGFtcGxlIDx0Y2xhLWxpdmUtYXBwcy1jYXNlLWFjdGlvbj48L3RjbGEtbGl2ZS1hcHBzLWNhc2UtYWN0aW9uPlxuICovXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3RjbGEtbGl2ZS1hcHBzLWNhc2UtYWN0aW9uJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2xpdmUtYXBwcy1jYXNlLWFjdGlvbi5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2xpdmUtYXBwcy1jYXNlLWFjdGlvbi5jb21wb25lbnQuY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgTGl2ZUFwcHNDYXNlQWN0aW9uQ29tcG9uZW50IGV4dGVuZHMgTGl2ZUFwcHNDYXNlQ3JlYXRvckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcbiAgLyoqXG4gICAqIFRoZSBjYXNlIHJlZmVyZW5jZVxuICAgKi9cbiAgQElucHV0KCkgY2FzZVJlZjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIHNob3cgdGhlIGhlYWRlciBiYXIgaW4gdGhlIHdpZGdldCAtIGVnLiBmYXZvcml0ZXMgb24gaG9tZSBwYWdlIChjb250YWlucyBpY29uIGV0YykgLSBpZiBvZmYgaWNvbnMgc3RpbGwgYXBwZWFyIHdpdGhvdXQgYmFyXG4gICAqL1xuICBASW5wdXQoKSBzaG93SGVhZGVyOiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBFbmFibGUgbGVnYWN5IGFjdGlvbnNcbiAgICovXG4gIEBJbnB1dCgpIGxlZ2FjeUFjdGlvbnM6IGJvb2xlYW4gPSB0aGlzLmxlZ2FjeUFjdGlvbnMgPyB0aGlzLmxlZ2FjeUFjdGlvbnMgOiBmYWxzZTtcblxuICAvKipcbiAgICogQWxsb3cgb3ZlcnJpZGUgb2YgZm9ybXMgZnJhbWV3b3JrXG4gICAqIE9wdGlvbnM6IGJvb3RzdHJhcC00IG9yIG1hdGVyaWFsLWRlc2lnblxuICAgKi9cbiAgQElucHV0KCkgZm9ybXNGcmFtZXdvcms6IHN0cmluZyA9IHRoaXMuZm9ybXNGcmFtZXdvcmsgPyB0aGlzLmZvcm1zRnJhbWV3b3JrIDogJ21hdGVyaWFsLWRlc2lnbic7XG5cblxuICBAVmlld0NoaWxkKExpdmVBcHBzTGVnYWN5UHJvY2Vzc0NvbXBvbmVudCwge3N0YXRpYzogZmFsc2V9KSBsZWdhY3lQcm9jZXNzQ29tcG9uZW50OiBMaXZlQXBwc0xlZ2FjeVByb2Nlc3NDb21wb25lbnQ7XG5cbiAgb3JpZ2luYWxEYXRhOiBhbnk7XG4gIGNhc2VTdGF0ZTogc3RyaW5nO1xuXG4gIHByaXZhdGUgZ2V0TWFpbkNhc2VUeXBlRnJvbVNjaGVtYSh0eXBlSWQ6IHN0cmluZywgcHJvY2VzczogTGFQcm9jZXNzU2VsZWN0aW9uKTogQ2FzZVR5cGUge1xuICAgIGxldCByZXF1ZXN0ZWRUeXBlOiBDYXNlVHlwZTtcbiAgICBwcm9jZXNzLmFwcFNjaGVtYS5jYXNldHlwZXMuZm9yRWFjaCgoY1R5cGUpID0+IHtcbiAgICAgIGlmIChjVHlwZS5pZCA9PT0gdHlwZUlkKSB7XG4gICAgICAgIHJlcXVlc3RlZFR5cGUgPSBjVHlwZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcmVxdWVzdGVkVHlwZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q2FzZURhdGEgPSAoY2FzZVJlZikgPT4ge1xuICAgIC8vIHJldHJpZXZlIHRoZSBjYXNlIGRhdGEgZm9yIHRoaXMgY2FzZSByZWZlcmVuY2VcbiAgICB0aGlzLmxpdmVhcHBzLmdldENhc2UodGhpcy5jYXNlUmVmLCB0aGlzLnNhbmRib3hJZCwgdGhpcy5hcHBsaWNhdGlvbklkLCB0aGlzLnR5cGVJZCApXG4gICAgICAucGlwZShcbiAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3llZCQpXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKHJlc3VsdCA9PiB7XG4gICAgICAgIGlmIChyZXN1bHQubWV0YWRhdGEuYXBwbGljYXRpb25JZCA9PT0gdGhpcy5hcHBsaWNhdGlvbklkLnRvU3RyaW5nKCkpIHtcbiAgICAgICAgICBjb25zdCBjYXNlZGF0YSA9IHJlc3VsdC51bnRhZ2dlZENhc2VkYXRhT2JqO1xuICAgICAgICAgIHRoaXMuY2FzZVN0YXRlID0gY2FzZWRhdGEuc3RhdGU7XG4gICAgICAgICAgdGhpcy5vcmlnaW5hbERhdGEgPSB7XG4gICAgICAgICAgICBbdGhpcy5wcm9jZXNzLnByb2Nlc3MubmFtZV06IGNhc2VkYXRhXG4gICAgICAgICAgfTtcbiAgICAgICAgICAvLyBKUzogdXNlIG5hbWUgcmF0aGVyIHRoYW4gaW50ZXJuYWxPYmplY3ROYW1lIHRvIGhhbmRsZSBhcHBsaWN0aW9uIG5hbWUgY2hhbmdlXG4gICAgICAgICAgY29uc3QgY2FzZVR5cGVOYW1lID0gdGhpcy5nZXRNYWluQ2FzZVR5cGVGcm9tU2NoZW1hKHRoaXMudHlwZUlkLCB0aGlzLnByb2Nlc3MpLm5hbWU7XG4gICAgICAgICAgdGhpcy5kYXRhID0ge1xuICAgICAgICAgICAgW2Nhc2VUeXBlTmFtZV06IGNhc2VkYXRhXG4gICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdUaGUgc2VsZWN0ZWQgY2FzZSBpcyBub3QgdGhlIHJpZ2h0IGNhc2UgdHlwZSBmb3IgdGhpcyBhY3Rpb24nKTtcbiAgICAgICAgfVxuICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAvLyBFbWl0IGFueSBlcnJvciByZXRyaWV2aW5nIGNhc2UgZGF0YSB0byB0aGUgcGFyZW50XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ1VuYWJsZSB0byByZXRyaWV2ZSBjYXNlIGRhdGEnKTtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBjYW5jZWxBY3Rpb24gPSAoKSA9PiB7XG4gICAgaWYgKHRoaXMubGVnYWN5UHJvY2Vzc0NvbXBvbmVudCkge1xuICAgICAgdGhpcy5sZWdhY3lQcm9jZXNzQ29tcG9uZW50LmNhbmNlbFByb2Nlc3MoKTtcbiAgICB9XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgbGFzdmM6IExpdmVBcHBzU2VydmljZSkge1xuICAgIHN1cGVyKGxhc3ZjKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIC8vIHNldCBkZWZhdWx0IGxheW91dFxuICAgIC8vIHRoaXMubGF5b3V0ID0gW107XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgLy8gdGhlIGV4dGVuZGVkIGNsYXNzIHdpbGwgZGV0ZWN0IGNoYW5nZSBpbiB0aGUgcHJvY2VzcyBhbmQgbGF5b3V0IHBhc3NlZFxuICAgIHN1cGVyLm5nT25DaGFuZ2VzKGNoYW5nZXMpO1xuICAgIC8vIGhhbmRsZSBpbnB1dCBwYXJhbSBjaGFuZ2VzXG4gICAgaWYgKChjaGFuZ2VzLmNhc2VSZWYgJiYgY2hhbmdlcy5jYXNlUmVmLmN1cnJlbnRWYWx1ZSAmJiAoY2hhbmdlcy5jYXNlUmVmLmN1cnJlbnRWYWx1ZSAhPT0gY2hhbmdlcy5jYXNlUmVmLnByZXZpb3VzVmFsdWUpKVxuICAgICAgfHwgKGNoYW5nZXMucHJvY2VzcyAmJiBjaGFuZ2VzLnByb2Nlc3MuY3VycmVudFZhbHVlICYmIChjaGFuZ2VzLnByb2Nlc3MuY3VycmVudFZhbHVlICE9PSBjaGFuZ2VzLnByb2Nlc3MucHJldmlvdXNWYWx1ZSkpKSB7XG4gICAgICAvLyBnZXQgY2FzZSBkYXRhIGlmIGFueXRoaW5nIGNoYW5nZXNcbiAgICAgIGlmIChjaGFuZ2VzLnByb2Nlc3MuY3VycmVudFZhbHVlKSB7XG4gICAgICAgIHRoaXMuZ2V0Q2FzZURhdGEodGhpcy5jYXNlUmVmKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gaGFuZGxlIHByb2Nlc3MgY2hhbmdlIGZvciBsZWdhY3kgYWN0aW9uIHByb2Nlc3NcbiAgICBpZiAoY2hhbmdlcy5wcm9jZXNzICYmIGNoYW5nZXMucHJvY2Vzcy5jdXJyZW50VmFsdWUgJiYgKGNoYW5nZXMucHJvY2Vzcy5jdXJyZW50VmFsdWUgIT09IGNoYW5nZXMucHJvY2Vzcy5wcmV2aW91c1ZhbHVlKSkge1xuICAgICAgaWYgKHRoaXMubGVnYWN5UHJvY2Vzc0NvbXBvbmVudCkge1xuICAgICAgICB0aGlzLmxlZ2FjeVByb2Nlc3NDb21wb25lbnQuY2hhbmdlUHJvY2VzcyhjaGFuZ2VzLnByb2Nlc3MuY3VycmVudFZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxufVxuIl19