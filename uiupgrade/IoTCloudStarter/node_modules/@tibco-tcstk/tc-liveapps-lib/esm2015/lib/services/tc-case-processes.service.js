/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { CaseActionsList, CaseCreatorsList, JsonSchema, Process } from '../models/liveappsdata';
import { LaProcessSelection } from '../models/tc-case-processes';
import { LiveAppsService } from './live-apps.service';
import { throwError } from 'rxjs';
import { flatMap, map, tap } from 'rxjs/operators';
import { TcCaseDataService } from './tc-case-data.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./live-apps.service";
import * as i3 from "./tc-case-data.service";
export class TcCaseProcessesService {
    /**
     * @param {?} http
     * @param {?} liveAppsService
     * @param {?} caseDataService
     */
    constructor(http, liveAppsService, caseDataService) {
        this.http = http;
        this.liveAppsService = liveAppsService;
        this.caseDataService = caseDataService;
        this.getCaseIDAttributeName = (/**
         * @param {?} caseType
         * @return {?}
         */
        (caseType) => {
            /** @type {?} */
            let caseIdAttrib;
            caseType.attributes.forEach((/**
             * @param {?} attribute
             * @return {?}
             */
            (attribute) => {
                if (attribute.isIdentifier) {
                    caseIdAttrib = attribute;
                }
            }));
            return caseIdAttrib;
        });
        // this is a helper function that given a case type 'schema' for the whole application will create an LaProcessSelection object
        // containing both the appSchema and particular details for this action
        // this object is required to submit the process later.
        this.createLaProcessSelection = (/**
         * @param {?} schema
         * @param {?} appId
         * @param {?} typeId
         * @param {?} action
         * @param {?} creator
         * @param {?} caseRef
         * @return {?}
         */
        (schema, appId, typeId, action, creator, caseRef) => {
            /** @type {?} */
            let processSelection;
            schema.casetypes.forEach((/**
             * @param {?} casetype
             * @return {?}
             */
            (casetype) => {
                // the schema will contain definitions for both the 'case' and any defined types in that case.
                // We want the schema for this 'case'.
                if (casetype.applicationId === appId && casetype.id === typeId) {
                    // if ( casetype.jsonSchema !== undefined) {
                    if (action) {
                        /** @type {?} */
                        const caseActionList = casetype.actions ? casetype.actions : [];
                        // now find the selected action
                        caseActionList.forEach((/**
                         * @param {?} actionDef
                         * @return {?}
                         */
                        (actionDef) => {
                            if (action.id === actionDef.id) {
                                if (!actionDef.jsonSchema) {
                                    // create blank form schema
                                    actionDef.jsonSchema = new JsonSchema();
                                    actionDef.jsonSchema.type = 'object';
                                    actionDef.jsonSchema.properties = [];
                                }
                                processSelection = new LaProcessSelection('action', schema, this.getCaseIDAttributeName(casetype), actionDef, 
                                // Format of ref is <applicationName>.<applicationInternalName>.<processType>.<processName>
                                (casetype.applicationName + '.' + casetype.applicationInternalName + '.' + 'action' + '.' + actionDef.name), caseRef);
                            }
                        }));
                        if (!processSelection) {
                            // no schema for this process
                            /** @type {?} */
                            const process = new Process().deserialize({ jsonSchema: { $schema: 'NOSCHEMA' }, name: action.name, id: action.id });
                            processSelection = new LaProcessSelection('action', schema, this.getCaseIDAttributeName(casetype), process, 
                            // Format of ref is <applicationName>.<applicationInternalName>.<processType>.<processName>
                            (casetype.applicationName + '.' + casetype.applicationInternalName + '.' + 'action' + '.' + action.name), caseRef);
                        }
                    }
                    else if (creator) {
                        /** @type {?} */
                        const caseCreatorList = casetype.creators ? casetype.creators : [];
                        // now find the selected action
                        caseCreatorList.forEach((/**
                         * @param {?} creatorDef
                         * @return {?}
                         */
                        (creatorDef) => {
                            if (creator.id === creatorDef.id) {
                                if (!creatorDef.jsonSchema) {
                                    // create blank form schema
                                    creatorDef.jsonSchema = new JsonSchema();
                                    creatorDef.jsonSchema.type = 'object';
                                    creatorDef.jsonSchema.properties = [];
                                }
                                processSelection = new LaProcessSelection('creator', schema, this.getCaseIDAttributeName(casetype), creatorDef, 
                                // Format of ref is <applicationName>.<applicationInternalName>.<processType>.<processName>
                                (casetype.applicationName + '.' + casetype.applicationInternalName + '.' + 'creator' + '.' + creatorDef.name), null);
                            }
                        }));
                        if (!processSelection) {
                            // no schema for this process
                            /** @type {?} */
                            const process = new Process().deserialize({ jsonSchema: { $schema: 'NOSCHEMA' }, name: creator.name, id: creator.id });
                            processSelection = new LaProcessSelection('creator', schema, this.getCaseIDAttributeName(casetype), process, 
                            // Format of ref is <applicationName>.<applicationInternalName>.<processType>.<processName>
                            (casetype.applicationName + '.' + casetype.applicationInternalName + '.' + 'creator' + '.' + creator.name), null);
                        }
                    }
                }
                // }
            }));
            return processSelection;
        });
    }
    //  This service gets the case state then uses that and the caseRef to get the available actions.
    /**
     * @param {?} caseRef
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} typeId
     * @return {?}
     */
    getCaseActionsForCaseRef(caseRef, sandboxId, appId, typeId) {
        /** @type {?} */
        const caseState$ = this.caseDataService.getCaseState(caseRef, sandboxId);
        /** @type {?} */
        const caseActions$ = caseState$.pipe(flatMap((/**
         * @param {?} caseState
         * @return {?}
         */
        caseState => {
            return this.getCaseActions(caseRef, sandboxId, appId, typeId, caseState);
        })));
        return caseActions$;
    }
    // todo: Note this is not a public API - update when Public API available
    /**
     * @param {?} caseRef
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} typeId
     * @param {?} caseState
     * @return {?}
     */
    getCaseActions(caseRef, sandboxId, appId, typeId, caseState) {
        // https://eu.liveapps.cloud.tibco.com/pageflow/caseActions?$sandbox=31&
        // $filter=applicationId%20eq%201742%20and%20caseType%20eq%201%20and%20caseState%20eq%20Responded%20and%20caseRef%20eq%20150491
        /** @type {?} */
        const url = '/pageflow/v1/caseActions?$sandbox=' + sandboxId
            + '&$filter=applicationId eq ' + appId
            + ' and caseType eq ' + typeId
            + ' and caseState eq ' + caseState
            + ' and caseRef eq ' + caseRef;
        return this.http.get(url)
            .pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        val => sessionStorage.setItem('tcsTimestamp', Date.now().toString()))), map((/**
         * @param {?} caseactions
         * @return {?}
         */
        caseactions => {
            /** @type {?} */
            const caList = new CaseActionsList().deserialize(caseactions);
            // non public API returns action Id as number, switch to string to match other APIs
            caList.actions.forEach((/**
             * @param {?} action
             * @return {?}
             */
            action => {
                if (typeof action.id === 'number') {
                    action.id = String(action.id);
                }
            }));
            return caList;
        })));
    }
    // todo: Note this is not a public API - update when Public API available
    /**
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} typeId
     * @return {?}
     */
    getCaseCreators(sandboxId, appId, typeId) {
        /** @type {?} */
        const url = '/pageflow/v1/caseCreators?$sandbox=' + sandboxId
            + '&$filter=applicationId eq ' + appId
            + ' and caseType eq ' + typeId;
        return this.http.get(url)
            .pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        val => sessionStorage.setItem('tcsTimestamp', Date.now().toString()))), map((/**
         * @param {?} casecreators
         * @return {?}
         */
        casecreators => {
            /** @type {?} */
            const ccList = new CaseCreatorsList().deserialize(casecreators);
            // non public API returns creator Id as number, switch to string to match other APIs
            ccList.creators.forEach((/**
             * @param {?} creator
             * @return {?}
             */
            creator => {
                if (typeof creator.id === 'number') {
                    creator.id = String(creator.id);
                }
            }));
            return ccList;
        })));
    }
    /**
     * @param {?} caseRef
     * @param {?} appId
     * @param {?} typeId
     * @param {?} sandboxId
     * @param {?} action
     * @param {?} creator
     * @param {?} top
     * @return {?}
     */
    getProcessDetails(caseRef, appId, typeId, sandboxId, action, creator, top) {
        return this.liveAppsService.getCaseTypeSchema(sandboxId, appId, top).pipe(map((/**
         * @param {?} schema
         * @return {?}
         */
        schema => {
            return this.createLaProcessSelection(schema, appId, typeId, action ? action : null, creator ? creator : null, caseRef);
        })));
    }
    /**
     * @param {?} caseRef
     * @param {?} appId
     * @param {?} typeId
     * @param {?} sandboxId
     * @param {?} updateActionLabel
     * @param {?} data
     * @return {?}
     */
    caseDataFormUpdate(caseRef, appId, typeId, sandboxId, updateActionLabel, data) {
        // get the creator details
        /** @type {?} */
        const creators$ = this.getCaseActionsForCaseRef(caseRef, sandboxId, appId, typeId);
        return creators$.pipe(flatMap((/**
         * @param {?} actions
         * @return {?}
         */
        (actions) => {
            /** @type {?} */
            const updateAction = actions.actions.find((/**
             * @param {?} act
             * @return {?}
             */
            act => {
                return act.label === updateActionLabel;
            }));
            if (updateAction) {
                return this.liveAppsService.runProcess(sandboxId, appId, updateAction.id, caseRef, data);
            }
            else {
                console.error('No update action found with label:', updateActionLabel);
                throwError('No update action found with label: ' + updateActionLabel);
            }
        })));
    }
}
TcCaseProcessesService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
TcCaseProcessesService.ctorParameters = () => [
    { type: HttpClient },
    { type: LiveAppsService },
    { type: TcCaseDataService }
];
/** @nocollapse */ TcCaseProcessesService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function TcCaseProcessesService_Factory() { return new TcCaseProcessesService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.LiveAppsService), i0.ɵɵinject(i3.TcCaseDataService)); }, token: TcCaseProcessesService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    TcCaseProcessesService.prototype.getCaseIDAttributeName;
    /**
     * @type {?}
     * @private
     */
    TcCaseProcessesService.prototype.createLaProcessSelection;
    /**
     * @type {?}
     * @private
     */
    TcCaseProcessesService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    TcCaseProcessesService.prototype.liveAppsService;
    /**
     * @type {?}
     * @private
     */
    TcCaseProcessesService.prototype.caseDataService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGMtY2FzZS1wcm9jZXNzZXMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0aWJjby10Y3N0ay90Yy1saXZlYXBwcy1saWIvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvdGMtY2FzZS1wcm9jZXNzZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDaEQsT0FBTyxFQUVMLGVBQWUsRUFFZixnQkFBZ0IsRUFHaEIsVUFBVSxFQUNWLE9BQU8sRUFDUixNQUFNLHdCQUF3QixDQUFDO0FBQ2hDLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLDZCQUE2QixDQUFDO0FBQy9ELE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUNwRCxPQUFPLEVBQWEsVUFBVSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQzVDLE9BQU8sRUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ2pELE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLHdCQUF3QixDQUFDOzs7OztBQUt6RCxNQUFNLE9BQU8sc0JBQXNCOzs7Ozs7SUFFakMsWUFBb0IsSUFBZ0IsRUFBVSxlQUFnQyxFQUFVLGVBQWtDO1FBQXRHLFNBQUksR0FBSixJQUFJLENBQVk7UUFBVSxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFBVSxvQkFBZSxHQUFmLGVBQWUsQ0FBbUI7UUE4RGxILDJCQUFzQjs7OztRQUFHLENBQUMsUUFBa0IsRUFBRSxFQUFFOztnQkFDbEQsWUFBaUI7WUFDckIsUUFBUSxDQUFDLFVBQVUsQ0FBQyxPQUFPOzs7O1lBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRTtnQkFDeEMsSUFBSSxTQUFTLENBQUMsWUFBWSxFQUFFO29CQUMxQixZQUFZLEdBQUcsU0FBUyxDQUFDO2lCQUMxQjtZQUNILENBQUMsRUFBQyxDQUFDO1lBQ0gsT0FBTyxZQUFZLENBQUM7UUFDdEIsQ0FBQyxFQUFBOzs7O1FBS08sNkJBQXdCOzs7Ozs7Ozs7UUFBRyxDQUNqQyxNQUFxQixFQUNyQixLQUFhLEVBQ2IsTUFBYyxFQUNkLE1BQWtCLEVBQ2xCLE9BQW9CLEVBQ3BCLE9BQWUsRUFBc0IsRUFBRTs7Z0JBQ2pDLGdCQUFvQztZQUN4QyxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU87Ozs7WUFBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO2dCQUNsQyw4RkFBOEY7Z0JBQzlGLHNDQUFzQztnQkFDdEMsSUFBSSxRQUFRLENBQUMsYUFBYSxLQUFLLEtBQUssSUFBSSxRQUFRLENBQUMsRUFBRSxLQUFLLE1BQU0sRUFBRTtvQkFDOUQsNENBQTRDO29CQUMxQyxJQUFJLE1BQU0sRUFBRTs7OEJBQ0osY0FBYyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7d0JBQy9ELCtCQUErQjt3QkFDL0IsY0FBYyxDQUFDLE9BQU87Ozs7d0JBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRTs0QkFDbkMsSUFBSSxNQUFNLENBQUMsRUFBRSxLQUFLLFNBQVMsQ0FBQyxFQUFFLEVBQUU7Z0NBQzlCLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxFQUFFO29DQUN6QiwyQkFBMkI7b0NBQzNCLFNBQVMsQ0FBQyxVQUFVLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQztvQ0FDeEMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDO29DQUNyQyxTQUFTLENBQUMsVUFBVSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7aUNBQ3RDO2dDQUNELGdCQUFnQixHQUFHLElBQUksa0JBQWtCLENBQ3ZDLFFBQVEsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFFBQVEsQ0FBQyxFQUFFLFNBQVM7Z0NBQ2xFLDJGQUEyRjtnQ0FDM0YsQ0FBQyxRQUFRLENBQUMsZUFBZSxHQUFHLEdBQUcsR0FBRyxRQUFRLENBQUMsdUJBQXVCLEdBQUcsR0FBRyxHQUFHLFFBQVEsR0FBRyxHQUFHLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUMzRyxPQUFPLENBQ1IsQ0FBQzs2QkFDSDt3QkFDSCxDQUFDLEVBQUMsQ0FBQzt3QkFDSCxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7OztrQ0FFZixPQUFPLEdBQVksSUFBSSxPQUFPLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxVQUFVLEVBQUUsRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLE1BQU0sQ0FBQyxFQUFFLEVBQUUsQ0FBQzs0QkFDN0gsZ0JBQWdCLEdBQUcsSUFBSSxrQkFBa0IsQ0FDdkMsUUFBUSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsc0JBQXNCLENBQUMsUUFBUSxDQUFDLEVBQUUsT0FBTzs0QkFDaEUsMkZBQTJGOzRCQUMzRixDQUFDLFFBQVEsQ0FBQyxlQUFlLEdBQUcsR0FBRyxHQUFHLFFBQVEsQ0FBQyx1QkFBdUIsR0FBRyxHQUFHLEdBQUcsUUFBUSxHQUFHLEdBQUcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQ3hHLE9BQU8sQ0FDUixDQUFDO3lCQUNIO3FCQUNGO3lCQUFNLElBQUksT0FBTyxFQUFFOzs4QkFDWixlQUFlLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRTt3QkFDbEUsK0JBQStCO3dCQUMvQixlQUFlLENBQUMsT0FBTzs7Ozt3QkFBQyxDQUFDLFVBQVUsRUFBRSxFQUFFOzRCQUNyQyxJQUFJLE9BQU8sQ0FBQyxFQUFFLEtBQUssVUFBVSxDQUFDLEVBQUUsRUFBRTtnQ0FDaEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUU7b0NBQzFCLDJCQUEyQjtvQ0FDM0IsVUFBVSxDQUFDLFVBQVUsR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO29DQUN6QyxVQUFVLENBQUMsVUFBVSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUM7b0NBQ3RDLFVBQVUsQ0FBQyxVQUFVLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztpQ0FDdkM7Z0NBQ0QsZ0JBQWdCLEdBQUcsSUFBSSxrQkFBa0IsQ0FDdkMsU0FBUyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsc0JBQXNCLENBQUMsUUFBUSxDQUFDLEVBQUUsVUFBVTtnQ0FDcEUsMkZBQTJGO2dDQUMzRixDQUFDLFFBQVEsQ0FBQyxlQUFlLEdBQUcsR0FBRyxHQUFHLFFBQVEsQ0FBQyx1QkFBdUIsR0FBRyxHQUFHLEdBQUcsU0FBUyxHQUFHLEdBQUcsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQzdHLElBQUksQ0FDTCxDQUFDOzZCQUNIO3dCQUNILENBQUMsRUFBQyxDQUFDO3dCQUNILElBQUksQ0FBQyxnQkFBZ0IsRUFBRTs7O2tDQUVmLE9BQU8sR0FBWSxJQUFJLE9BQU8sRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLFVBQVUsRUFBRSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsT0FBTyxDQUFDLEVBQUUsRUFBRSxDQUFDOzRCQUMvSCxnQkFBZ0IsR0FBRyxJQUFJLGtCQUFrQixDQUN2QyxTQUFTLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxRQUFRLENBQUMsRUFBRSxPQUFPOzRCQUNqRSwyRkFBMkY7NEJBQzNGLENBQUMsUUFBUSxDQUFDLGVBQWUsR0FBRyxHQUFHLEdBQUcsUUFBUSxDQUFDLHVCQUF1QixHQUFHLEdBQUcsR0FBRyxTQUFTLEdBQUcsR0FBRyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFDMUcsSUFBSSxDQUNMLENBQUM7eUJBQ0g7cUJBQ0Y7aUJBQ0Y7Z0JBQ0gsSUFBSTtZQUNOLENBQUMsRUFDRixDQUFDO1lBQ0YsT0FBTyxnQkFBZ0IsQ0FBQztRQUM1QixDQUFDLEVBQUE7SUF4SjZILENBQUM7Ozs7Ozs7OztJQUd4SCx3QkFBd0IsQ0FBQyxPQUFlLEVBQUUsU0FBaUIsRUFBRSxLQUFhLEVBQUUsTUFBYzs7Y0FDekYsVUFBVSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUM7O2NBQ2xFLFlBQVksR0FBRyxVQUFVLENBQUMsSUFBSSxDQUNsQyxPQUFPOzs7O1FBQUMsU0FBUyxDQUFDLEVBQUU7WUFDbEIsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztRQUMzRSxDQUFDLEVBQUMsQ0FDSDtRQUNELE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUM7Ozs7Ozs7Ozs7SUFJTSxjQUFjLENBQUMsT0FBZSxFQUFFLFNBQWlCLEVBQUUsS0FBYSxFQUFFLE1BQWMsRUFBRSxTQUFpQjs7OztjQUdsRyxHQUFHLEdBQUcsb0NBQW9DLEdBQUcsU0FBUztjQUN4RCw0QkFBNEIsR0FBRyxLQUFLO2NBQ3BDLG1CQUFtQixHQUFHLE1BQU07Y0FDNUIsb0JBQW9CLEdBQUcsU0FBUztjQUNoQyxrQkFBa0IsR0FBRyxPQUFPO1FBRWhDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO2FBQ3RCLElBQUksQ0FDSCxHQUFHOzs7O1FBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsRUFBQyxFQUMxRSxHQUFHOzs7O1FBQUMsV0FBVyxDQUFDLEVBQUU7O2tCQUNWLE1BQU0sR0FBRyxJQUFJLGVBQWUsRUFBRSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUM7WUFDN0QsbUZBQW1GO1lBQ25GLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTzs7OztZQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUM5QixJQUFJLE9BQU8sTUFBTSxDQUFDLEVBQUUsS0FBSyxRQUFRLEVBQUU7b0JBQ2pDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDL0I7WUFDSCxDQUFDLEVBQUMsQ0FBQTtZQUNGLE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsRUFBQyxDQUNILENBQUM7SUFDSixDQUFDOzs7Ozs7OztJQUdJLGVBQWUsQ0FBQyxTQUFpQixFQUFFLEtBQWEsRUFBRSxNQUFjOztjQUMvRCxHQUFHLEdBQUcscUNBQXFDLEdBQUcsU0FBUztjQUN6RCw0QkFBNEIsR0FBRyxLQUFLO2NBQ3BDLG1CQUFtQixHQUFHLE1BQU07UUFFaEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7YUFDdEIsSUFBSSxDQUNILEdBQUc7Ozs7UUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFDLEVBQzFFLEdBQUc7Ozs7UUFBQyxZQUFZLENBQUMsRUFBRTs7a0JBQ1gsTUFBTSxHQUFHLElBQUksZ0JBQWdCLEVBQUUsQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDO1lBQy9ELG9GQUFvRjtZQUNwRixNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU87Ozs7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDaEMsSUFBSSxPQUFPLE9BQU8sQ0FBQyxFQUFFLEtBQUssUUFBUSxFQUFFO29CQUNsQyxPQUFPLENBQUMsRUFBRSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQ2pDO1lBQ0gsQ0FBQyxFQUFDLENBQUE7WUFDRixPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDLEVBQUMsQ0FDSCxDQUFDO0lBQ04sQ0FBQzs7Ozs7Ozs7Ozs7SUE4RlEsaUJBQWlCLENBQ3RCLE9BQWUsRUFDZixLQUFhLEVBQ2IsTUFBYyxFQUNkLFNBQWlCLEVBQ2pCLE1BQWtCLEVBQ2xCLE9BQW9CLEVBQ3BCLEdBQVc7UUFDVCxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQ3ZFLEdBQUc7Ozs7UUFBQyxNQUFNLENBQUMsRUFBRTtZQUNYLE9BQU8sSUFBSSxDQUFDLHdCQUF3QixDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUEsQ0FBQyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN0SCxDQUFDLEVBQ0YsQ0FDRixDQUFDO0lBQ04sQ0FBQzs7Ozs7Ozs7OztJQUVNLGtCQUFrQixDQUN2QixPQUFlLEVBQ2YsS0FBYSxFQUNiLE1BQWMsRUFDZCxTQUFpQixFQUNqQixpQkFBeUIsRUFDekIsSUFBUzs7O2NBSUgsU0FBUyxHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUM7UUFDbEYsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUNuQixPQUFPOzs7O1FBQUMsQ0FBQyxPQUF3QixFQUFFLEVBQUU7O2tCQUM3QixZQUFZLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJOzs7O1lBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQzlDLE9BQU8sR0FBRyxDQUFDLEtBQUssS0FBSyxpQkFBaUIsQ0FBQztZQUN6QyxDQUFDLEVBQUM7WUFDRixJQUFJLFlBQVksRUFBRTtnQkFDaEIsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLFlBQVksQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO2FBQzFGO2lCQUFNO2dCQUNMLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLEVBQUUsaUJBQWlCLENBQUMsQ0FBQTtnQkFDdEUsVUFBVSxDQUFDLHFDQUFxQyxHQUFHLGlCQUFpQixDQUFDLENBQUM7YUFDdkU7UUFDSCxDQUFDLEVBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQzs7O1lBdk1KLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OztZQW5CTyxVQUFVO1lBWVYsZUFBZTtZQUdmLGlCQUFpQjs7Ozs7Ozs7SUFxRXZCLHdEQVFDOzs7OztJQUtELDBEQTZFQzs7Ozs7SUF4Slcsc0NBQXdCOzs7OztJQUFFLGlEQUF3Qzs7Ozs7SUFBRSxpREFBMEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0h0dHBDbGllbnR9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7XG4gIENhc2VBY3Rpb24sXG4gIENhc2VBY3Rpb25zTGlzdCxcbiAgQ2FzZUNyZWF0b3IsXG4gIENhc2VDcmVhdG9yc0xpc3QsXG4gIENhc2VUeXBlLFxuICBDYXNlVHlwZXNMaXN0LFxuICBKc29uU2NoZW1hLFxuICBQcm9jZXNzXG59IGZyb20gJy4uL21vZGVscy9saXZlYXBwc2RhdGEnO1xuaW1wb3J0IHtMYVByb2Nlc3NTZWxlY3Rpb259IGZyb20gJy4uL21vZGVscy90Yy1jYXNlLXByb2Nlc3Nlcyc7XG5pbXBvcnQge0xpdmVBcHBzU2VydmljZX0gZnJvbSAnLi9saXZlLWFwcHMuc2VydmljZSc7XG5pbXBvcnQge09ic2VydmFibGUsIHRocm93RXJyb3J9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtmbGF0TWFwLCBtYXAsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtUY0Nhc2VEYXRhU2VydmljZX0gZnJvbSAnLi90Yy1jYXNlLWRhdGEuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFRjQ2FzZVByb2Nlc3Nlc1NlcnZpY2Uge1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cENsaWVudCwgcHJpdmF0ZSBsaXZlQXBwc1NlcnZpY2U6IExpdmVBcHBzU2VydmljZSwgcHJpdmF0ZSBjYXNlRGF0YVNlcnZpY2U6IFRjQ2FzZURhdGFTZXJ2aWNlKSB7IH1cblxuICAvLyAgVGhpcyBzZXJ2aWNlIGdldHMgdGhlIGNhc2Ugc3RhdGUgdGhlbiB1c2VzIHRoYXQgYW5kIHRoZSBjYXNlUmVmIHRvIGdldCB0aGUgYXZhaWxhYmxlIGFjdGlvbnMuXG4gIHB1YmxpYyBnZXRDYXNlQWN0aW9uc0ZvckNhc2VSZWYoY2FzZVJlZjogc3RyaW5nLCBzYW5kYm94SWQ6IG51bWJlciwgYXBwSWQ6IHN0cmluZywgdHlwZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPENhc2VBY3Rpb25zTGlzdD4ge1xuICAgIGNvbnN0IGNhc2VTdGF0ZSQgPSB0aGlzLmNhc2VEYXRhU2VydmljZS5nZXRDYXNlU3RhdGUoY2FzZVJlZiwgc2FuZGJveElkKTtcbiAgICBjb25zdCBjYXNlQWN0aW9ucyQgPSBjYXNlU3RhdGUkLnBpcGUoXG4gICAgICBmbGF0TWFwKGNhc2VTdGF0ZSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldENhc2VBY3Rpb25zKGNhc2VSZWYsIHNhbmRib3hJZCwgYXBwSWQsIHR5cGVJZCwgY2FzZVN0YXRlKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgICByZXR1cm4gY2FzZUFjdGlvbnMkO1xuICB9XG5cblxuLy8gdG9kbzogTm90ZSB0aGlzIGlzIG5vdCBhIHB1YmxpYyBBUEkgLSB1cGRhdGUgd2hlbiBQdWJsaWMgQVBJIGF2YWlsYWJsZVxuICBwdWJsaWMgZ2V0Q2FzZUFjdGlvbnMoY2FzZVJlZjogc3RyaW5nLCBzYW5kYm94SWQ6IG51bWJlciwgYXBwSWQ6IHN0cmluZywgdHlwZUlkOiBzdHJpbmcsIGNhc2VTdGF0ZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxDYXNlQWN0aW9uc0xpc3Q+IHtcbiAgICAvLyBodHRwczovL2V1LmxpdmVhcHBzLmNsb3VkLnRpYmNvLmNvbS9wYWdlZmxvdy9jYXNlQWN0aW9ucz8kc2FuZGJveD0zMSZcbiAgICAvLyAkZmlsdGVyPWFwcGxpY2F0aW9uSWQlMjBlcSUyMDE3NDIlMjBhbmQlMjBjYXNlVHlwZSUyMGVxJTIwMSUyMGFuZCUyMGNhc2VTdGF0ZSUyMGVxJTIwUmVzcG9uZGVkJTIwYW5kJTIwY2FzZVJlZiUyMGVxJTIwMTUwNDkxXG4gICAgY29uc3QgdXJsID0gJy9wYWdlZmxvdy92MS9jYXNlQWN0aW9ucz8kc2FuZGJveD0nICsgc2FuZGJveElkXG4gICAgICArICcmJGZpbHRlcj1hcHBsaWNhdGlvbklkIGVxICcgKyBhcHBJZFxuICAgICAgKyAnIGFuZCBjYXNlVHlwZSBlcSAnICsgdHlwZUlkXG4gICAgICArICcgYW5kIGNhc2VTdGF0ZSBlcSAnICsgY2FzZVN0YXRlXG4gICAgICArICcgYW5kIGNhc2VSZWYgZXEgJyArIGNhc2VSZWY7XG5cbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh1cmwpXG4gICAgICAucGlwZShcbiAgICAgICAgdGFwKCB2YWwgPT4gc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgndGNzVGltZXN0YW1wJywgRGF0ZS5ub3coKS50b1N0cmluZygpKSksXG4gICAgICAgIG1hcChjYXNlYWN0aW9ucyA9PiB7XG4gICAgICAgICAgY29uc3QgY2FMaXN0ID0gbmV3IENhc2VBY3Rpb25zTGlzdCgpLmRlc2VyaWFsaXplKGNhc2VhY3Rpb25zKTtcbiAgICAgICAgICAvLyBub24gcHVibGljIEFQSSByZXR1cm5zIGFjdGlvbiBJZCBhcyBudW1iZXIsIHN3aXRjaCB0byBzdHJpbmcgdG8gbWF0Y2ggb3RoZXIgQVBJc1xuICAgICAgICAgIGNhTGlzdC5hY3Rpb25zLmZvckVhY2goYWN0aW9uID0+IHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgYWN0aW9uLmlkID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgICBhY3Rpb24uaWQgPSBTdHJpbmcoYWN0aW9uLmlkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIHJldHVybiBjYUxpc3Q7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cblxuICAvLyB0b2RvOiBOb3RlIHRoaXMgaXMgbm90IGEgcHVibGljIEFQSSAtIHVwZGF0ZSB3aGVuIFB1YmxpYyBBUEkgYXZhaWxhYmxlXG4gIHB1YmxpYyBnZXRDYXNlQ3JlYXRvcnMoc2FuZGJveElkOiBudW1iZXIsIGFwcElkOiBzdHJpbmcsIHR5cGVJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxDYXNlQ3JlYXRvcnNMaXN0PiB7XG4gICAgY29uc3QgdXJsID0gJy9wYWdlZmxvdy92MS9jYXNlQ3JlYXRvcnM/JHNhbmRib3g9JyArIHNhbmRib3hJZFxuICAgICAgKyAnJiRmaWx0ZXI9YXBwbGljYXRpb25JZCBlcSAnICsgYXBwSWRcbiAgICAgICsgJyBhbmQgY2FzZVR5cGUgZXEgJyArIHR5cGVJZFxuXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcCggdmFsID0+IHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ3Rjc1RpbWVzdGFtcCcsIERhdGUubm93KCkudG9TdHJpbmcoKSkpLFxuICAgICAgICBtYXAoY2FzZWNyZWF0b3JzID0+IHtcbiAgICAgICAgICBjb25zdCBjY0xpc3QgPSBuZXcgQ2FzZUNyZWF0b3JzTGlzdCgpLmRlc2VyaWFsaXplKGNhc2VjcmVhdG9ycyk7XG4gICAgICAgICAgLy8gbm9uIHB1YmxpYyBBUEkgcmV0dXJucyBjcmVhdG9yIElkIGFzIG51bWJlciwgc3dpdGNoIHRvIHN0cmluZyB0byBtYXRjaCBvdGhlciBBUElzXG4gICAgICAgICAgY2NMaXN0LmNyZWF0b3JzLmZvckVhY2goY3JlYXRvciA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGNyZWF0b3IuaWQgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICAgIGNyZWF0b3IuaWQgPSBTdHJpbmcoY3JlYXRvci5pZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgICByZXR1cm4gY2NMaXN0O1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q2FzZUlEQXR0cmlidXRlTmFtZSA9IChjYXNlVHlwZTogQ2FzZVR5cGUpID0+IHtcbiAgICBsZXQgY2FzZUlkQXR0cmliOiBhbnk7XG4gICAgY2FzZVR5cGUuYXR0cmlidXRlcy5mb3JFYWNoKChhdHRyaWJ1dGUpID0+IHtcbiAgICAgIGlmIChhdHRyaWJ1dGUuaXNJZGVudGlmaWVyKSB7XG4gICAgICAgIGNhc2VJZEF0dHJpYiA9IGF0dHJpYnV0ZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gY2FzZUlkQXR0cmliO1xuICB9XG5cbiAgLy8gdGhpcyBpcyBhIGhlbHBlciBmdW5jdGlvbiB0aGF0IGdpdmVuIGEgY2FzZSB0eXBlICdzY2hlbWEnIGZvciB0aGUgd2hvbGUgYXBwbGljYXRpb24gd2lsbCBjcmVhdGUgYW4gTGFQcm9jZXNzU2VsZWN0aW9uIG9iamVjdFxuICAvLyBjb250YWluaW5nIGJvdGggdGhlIGFwcFNjaGVtYSBhbmQgcGFydGljdWxhciBkZXRhaWxzIGZvciB0aGlzIGFjdGlvblxuICAvLyB0aGlzIG9iamVjdCBpcyByZXF1aXJlZCB0byBzdWJtaXQgdGhlIHByb2Nlc3MgbGF0ZXIuXG4gIHByaXZhdGUgY3JlYXRlTGFQcm9jZXNzU2VsZWN0aW9uID0gKFxuICAgIHNjaGVtYTogQ2FzZVR5cGVzTGlzdCxcbiAgICBhcHBJZDogc3RyaW5nLFxuICAgIHR5cGVJZDogc3RyaW5nLFxuICAgIGFjdGlvbjogQ2FzZUFjdGlvbixcbiAgICBjcmVhdG9yOiBDYXNlQ3JlYXRvcixcbiAgICBjYXNlUmVmOiBzdHJpbmcpOiBMYVByb2Nlc3NTZWxlY3Rpb24gPT4ge1xuICAgICAgbGV0IHByb2Nlc3NTZWxlY3Rpb246IExhUHJvY2Vzc1NlbGVjdGlvbjtcbiAgICAgIHNjaGVtYS5jYXNldHlwZXMuZm9yRWFjaCgoY2FzZXR5cGUpID0+IHtcbiAgICAgICAgICAvLyB0aGUgc2NoZW1hIHdpbGwgY29udGFpbiBkZWZpbml0aW9ucyBmb3IgYm90aCB0aGUgJ2Nhc2UnIGFuZCBhbnkgZGVmaW5lZCB0eXBlcyBpbiB0aGF0IGNhc2UuXG4gICAgICAgICAgLy8gV2Ugd2FudCB0aGUgc2NoZW1hIGZvciB0aGlzICdjYXNlJy5cbiAgICAgICAgICBpZiAoY2FzZXR5cGUuYXBwbGljYXRpb25JZCA9PT0gYXBwSWQgJiYgY2FzZXR5cGUuaWQgPT09IHR5cGVJZCkge1xuICAgICAgICAgICAgLy8gaWYgKCBjYXNldHlwZS5qc29uU2NoZW1hICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgaWYgKGFjdGlvbikge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNhc2VBY3Rpb25MaXN0ID0gY2FzZXR5cGUuYWN0aW9ucyA/IGNhc2V0eXBlLmFjdGlvbnMgOiBbXTtcbiAgICAgICAgICAgICAgICAvLyBub3cgZmluZCB0aGUgc2VsZWN0ZWQgYWN0aW9uXG4gICAgICAgICAgICAgICAgY2FzZUFjdGlvbkxpc3QuZm9yRWFjaCgoYWN0aW9uRGVmKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoYWN0aW9uLmlkID09PSBhY3Rpb25EZWYuaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFhY3Rpb25EZWYuanNvblNjaGVtYSkge1xuICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBibGFuayBmb3JtIHNjaGVtYVxuICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkRlZi5qc29uU2NoZW1hID0gbmV3IEpzb25TY2hlbWEoKTtcbiAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25EZWYuanNvblNjaGVtYS50eXBlID0gJ29iamVjdCc7XG4gICAgICAgICAgICAgICAgICAgICAgYWN0aW9uRGVmLmpzb25TY2hlbWEucHJvcGVydGllcyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHByb2Nlc3NTZWxlY3Rpb24gPSBuZXcgTGFQcm9jZXNzU2VsZWN0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICdhY3Rpb24nLCBzY2hlbWEsIHRoaXMuZ2V0Q2FzZUlEQXR0cmlidXRlTmFtZShjYXNldHlwZSksIGFjdGlvbkRlZixcbiAgICAgICAgICAgICAgICAgICAgICAvLyBGb3JtYXQgb2YgcmVmIGlzIDxhcHBsaWNhdGlvbk5hbWU+LjxhcHBsaWNhdGlvbkludGVybmFsTmFtZT4uPHByb2Nlc3NUeXBlPi48cHJvY2Vzc05hbWU+XG4gICAgICAgICAgICAgICAgICAgICAgKGNhc2V0eXBlLmFwcGxpY2F0aW9uTmFtZSArICcuJyArIGNhc2V0eXBlLmFwcGxpY2F0aW9uSW50ZXJuYWxOYW1lICsgJy4nICsgJ2FjdGlvbicgKyAnLicgKyBhY3Rpb25EZWYubmFtZSksXG4gICAgICAgICAgICAgICAgICAgICAgY2FzZVJlZlxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGlmICghcHJvY2Vzc1NlbGVjdGlvbikge1xuICAgICAgICAgICAgICAgICAgLy8gbm8gc2NoZW1hIGZvciB0aGlzIHByb2Nlc3NcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHByb2Nlc3M6IFByb2Nlc3MgPSBuZXcgUHJvY2VzcygpLmRlc2VyaWFsaXplKHsganNvblNjaGVtYTogeyAkc2NoZW1hOiAnTk9TQ0hFTUEnIH0sIG5hbWU6IGFjdGlvbi5uYW1lLCBpZDogYWN0aW9uLmlkIH0pO1xuICAgICAgICAgICAgICAgICAgcHJvY2Vzc1NlbGVjdGlvbiA9IG5ldyBMYVByb2Nlc3NTZWxlY3Rpb24oXG4gICAgICAgICAgICAgICAgICAgICdhY3Rpb24nLCBzY2hlbWEsIHRoaXMuZ2V0Q2FzZUlEQXR0cmlidXRlTmFtZShjYXNldHlwZSksIHByb2Nlc3MsXG4gICAgICAgICAgICAgICAgICAgIC8vIEZvcm1hdCBvZiByZWYgaXMgPGFwcGxpY2F0aW9uTmFtZT4uPGFwcGxpY2F0aW9uSW50ZXJuYWxOYW1lPi48cHJvY2Vzc1R5cGU+Ljxwcm9jZXNzTmFtZT5cbiAgICAgICAgICAgICAgICAgICAgKGNhc2V0eXBlLmFwcGxpY2F0aW9uTmFtZSArICcuJyArIGNhc2V0eXBlLmFwcGxpY2F0aW9uSW50ZXJuYWxOYW1lICsgJy4nICsgJ2FjdGlvbicgKyAnLicgKyBhY3Rpb24ubmFtZSksXG4gICAgICAgICAgICAgICAgICAgIGNhc2VSZWZcbiAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNyZWF0b3IpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjYXNlQ3JlYXRvckxpc3QgPSBjYXNldHlwZS5jcmVhdG9ycyA/IGNhc2V0eXBlLmNyZWF0b3JzIDogW107XG4gICAgICAgICAgICAgICAgLy8gbm93IGZpbmQgdGhlIHNlbGVjdGVkIGFjdGlvblxuICAgICAgICAgICAgICAgIGNhc2VDcmVhdG9yTGlzdC5mb3JFYWNoKChjcmVhdG9yRGVmKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoY3JlYXRvci5pZCA9PT0gY3JlYXRvckRlZi5pZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWNyZWF0b3JEZWYuanNvblNjaGVtYSkge1xuICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBibGFuayBmb3JtIHNjaGVtYVxuICAgICAgICAgICAgICAgICAgICAgIGNyZWF0b3JEZWYuanNvblNjaGVtYSA9IG5ldyBKc29uU2NoZW1hKCk7XG4gICAgICAgICAgICAgICAgICAgICAgY3JlYXRvckRlZi5qc29uU2NoZW1hLnR5cGUgPSAnb2JqZWN0JztcbiAgICAgICAgICAgICAgICAgICAgICBjcmVhdG9yRGVmLmpzb25TY2hlbWEucHJvcGVydGllcyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHByb2Nlc3NTZWxlY3Rpb24gPSBuZXcgTGFQcm9jZXNzU2VsZWN0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICdjcmVhdG9yJywgc2NoZW1hLCB0aGlzLmdldENhc2VJREF0dHJpYnV0ZU5hbWUoY2FzZXR5cGUpLCBjcmVhdG9yRGVmLFxuICAgICAgICAgICAgICAgICAgICAgIC8vIEZvcm1hdCBvZiByZWYgaXMgPGFwcGxpY2F0aW9uTmFtZT4uPGFwcGxpY2F0aW9uSW50ZXJuYWxOYW1lPi48cHJvY2Vzc1R5cGU+Ljxwcm9jZXNzTmFtZT5cbiAgICAgICAgICAgICAgICAgICAgICAoY2FzZXR5cGUuYXBwbGljYXRpb25OYW1lICsgJy4nICsgY2FzZXR5cGUuYXBwbGljYXRpb25JbnRlcm5hbE5hbWUgKyAnLicgKyAnY3JlYXRvcicgKyAnLicgKyBjcmVhdG9yRGVmLm5hbWUpLFxuICAgICAgICAgICAgICAgICAgICAgIG51bGxcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAoIXByb2Nlc3NTZWxlY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgIC8vIG5vIHNjaGVtYSBmb3IgdGhpcyBwcm9jZXNzXG4gICAgICAgICAgICAgICAgICBjb25zdCBwcm9jZXNzOiBQcm9jZXNzID0gbmV3IFByb2Nlc3MoKS5kZXNlcmlhbGl6ZSh7IGpzb25TY2hlbWE6IHsgJHNjaGVtYTogJ05PU0NIRU1BJyB9LCBuYW1lOiBjcmVhdG9yLm5hbWUsIGlkOiBjcmVhdG9yLmlkIH0pO1xuICAgICAgICAgICAgICAgICAgcHJvY2Vzc1NlbGVjdGlvbiA9IG5ldyBMYVByb2Nlc3NTZWxlY3Rpb24oXG4gICAgICAgICAgICAgICAgICAgICdjcmVhdG9yJywgc2NoZW1hLCB0aGlzLmdldENhc2VJREF0dHJpYnV0ZU5hbWUoY2FzZXR5cGUpLCBwcm9jZXNzLFxuICAgICAgICAgICAgICAgICAgICAvLyBGb3JtYXQgb2YgcmVmIGlzIDxhcHBsaWNhdGlvbk5hbWU+LjxhcHBsaWNhdGlvbkludGVybmFsTmFtZT4uPHByb2Nlc3NUeXBlPi48cHJvY2Vzc05hbWU+XG4gICAgICAgICAgICAgICAgICAgIChjYXNldHlwZS5hcHBsaWNhdGlvbk5hbWUgKyAnLicgKyBjYXNldHlwZS5hcHBsaWNhdGlvbkludGVybmFsTmFtZSArICcuJyArICdjcmVhdG9yJyArICcuJyArIGNyZWF0b3IubmFtZSksXG4gICAgICAgICAgICAgICAgICAgIG51bGxcbiAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgLy8gfVxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgcmV0dXJuIHByb2Nlc3NTZWxlY3Rpb247XG4gIH1cblxuICAgIHB1YmxpYyBnZXRQcm9jZXNzRGV0YWlscyhcbiAgICAgIGNhc2VSZWY6IHN0cmluZyxcbiAgICAgIGFwcElkOiBzdHJpbmcsXG4gICAgICB0eXBlSWQ6IHN0cmluZyxcbiAgICAgIHNhbmRib3hJZDogbnVtYmVyLFxuICAgICAgYWN0aW9uOiBDYXNlQWN0aW9uLFxuICAgICAgY3JlYXRvcjogQ2FzZUNyZWF0b3IsXG4gICAgICB0b3A6IG51bWJlcik6IE9ic2VydmFibGU8TGFQcm9jZXNzU2VsZWN0aW9uPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmxpdmVBcHBzU2VydmljZS5nZXRDYXNlVHlwZVNjaGVtYShzYW5kYm94SWQsIGFwcElkLCB0b3ApLnBpcGUoXG4gICAgICAgICAgbWFwKHNjaGVtYSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVMYVByb2Nlc3NTZWxlY3Rpb24oc2NoZW1hLCBhcHBJZCwgdHlwZUlkLCBhY3Rpb24gPyBhY3Rpb24gOiBudWxsLCBjcmVhdG9yID8gY3JlYXRvcjogbnVsbCwgY2FzZVJlZik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHB1YmxpYyBjYXNlRGF0YUZvcm1VcGRhdGUoXG4gICAgICBjYXNlUmVmOiBzdHJpbmcsXG4gICAgICBhcHBJZDogc3RyaW5nLFxuICAgICAgdHlwZUlkOiBzdHJpbmcsXG4gICAgICBzYW5kYm94SWQ6IG51bWJlcixcbiAgICAgIHVwZGF0ZUFjdGlvbkxhYmVsOiBzdHJpbmcsXG4gICAgICBkYXRhOiBhbnlcbiAgICApOiBPYnNlcnZhYmxlPGFueT4ge1xuXG4gICAgLy8gZ2V0IHRoZSBjcmVhdG9yIGRldGFpbHNcbiAgICAgIGNvbnN0IGNyZWF0b3JzJCA9IHRoaXMuZ2V0Q2FzZUFjdGlvbnNGb3JDYXNlUmVmKGNhc2VSZWYsIHNhbmRib3hJZCwgYXBwSWQsIHR5cGVJZCk7XG4gICAgICByZXR1cm4gY3JlYXRvcnMkLnBpcGUoXG4gICAgICAgIGZsYXRNYXAoKGFjdGlvbnM6IENhc2VBY3Rpb25zTGlzdCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHVwZGF0ZUFjdGlvbiA9IGFjdGlvbnMuYWN0aW9ucy5maW5kKGFjdCA9PiB7XG4gICAgICAgICAgICByZXR1cm4gYWN0LmxhYmVsID09PSB1cGRhdGVBY3Rpb25MYWJlbDtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBpZiAodXBkYXRlQWN0aW9uKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5saXZlQXBwc1NlcnZpY2UucnVuUHJvY2VzcyhzYW5kYm94SWQsIGFwcElkLCB1cGRhdGVBY3Rpb24uaWQsIGNhc2VSZWYsIGRhdGEpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdObyB1cGRhdGUgYWN0aW9uIGZvdW5kIHdpdGggbGFiZWw6JywgdXBkYXRlQWN0aW9uTGFiZWwpXG4gICAgICAgICAgICB0aHJvd0Vycm9yKCdObyB1cGRhdGUgYWN0aW9uIGZvdW5kIHdpdGggbGFiZWw6ICcgKyB1cGRhdGVBY3Rpb25MYWJlbCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG59XG4iXX0=