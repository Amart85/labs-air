/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { throwError } from 'rxjs';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { ApiResponseError, ApiResponseText } from '../models/liveappsdata';
import { LiveAppsService } from './live-apps.service';
import { DocumentList, OrgFolder } from '../models/tc-document';
import { catchError, flatMap, map, tap } from 'rxjs/operators';
import { TcCoreCommonFunctions } from '@tibco-tcstk/tc-core-lib';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./live-apps.service";
export class TcDocumentService {
    /**
     * @param {?} http
     * @param {?} liveapps
     */
    constructor(http, liveapps) {
        this.http = http;
        this.liveapps = liveapps;
    }
    /**
     * @param {?} name
     * @return {?}
     */
    createOrgFolder(name) {
        /** @type {?} */
        const url = '/webresource/v1/orgFolders/';
        /** @type {?} */
        const body = new OrgFolder().deserialize({ name: name });
        /** @type {?} */
        const bodyStr = JSON.stringify(body);
        /** @type {?} */
        const headers = new HttpHeaders()
            .set('Content-Type', 'application/json');
        return this.http.post(url, bodyStr, { headers }).pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        val => sessionStorage.setItem('tcsTimestamp', Date.now().toString()))), map((/**
         * @param {?} response
         * @return {?}
         */
        response => new ApiResponseText().deserialize(response))));
    }
    /**
     * @param {?} name
     * @param {?} useCache
     * @param {?} flushCache
     * @return {?}
     */
    getOrgFolder(name, useCache, flushCache) {
        /** @type {?} */
        const url = '/webresource/v1/orgFolders/' + name + '/';
        /** @type {?} */
        let headers = new HttpHeaders();
        if (useCache) {
            headers = headers.set('cacheResponse', 'true');
        }
        if (flushCache) {
            headers = headers.set('flushCache', 'true');
        }
        /** @type {?} */
        const options = { headers: headers };
        return this.http.get(url, options).pipe(map((/**
         * @param {?} response
         * @return {?}
         */
        response => {
            return new OrgFolder().deserialize(response);
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => {
            /** @type {?} */
            const apiError = new ApiResponseError().deserialize(error.error);
            if (apiError.errorCode === 'WR_FOLDER_DOES_NOT_EXIST') {
                return this.createOrgFolder(name).pipe(flatMap((/**
                 * @param {?} newOrgFolder
                 * @return {?}
                 */
                newOrgFolder => {
                    // trigger cache flush
                    return this.getOrgFolder(name, true, true);
                })));
            }
            else {
                throwError(error);
            }
        })));
    }
    /**
     * @param {?} name
     * @return {?}
     */
    initOrgFolder(name) {
        /** @type {?} */
        const orgFolder$ = this.getOrgFolder(name, true, false).pipe(map((/**
         * @param {?} orgFolderResp
         * @return {?}
         */
        orgFolderResp => {
            return new ApiResponseText().deserialize({ message: 'orgFolder ok' });
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => {
            /** @type {?} */
            const apiError = new ApiResponseError().deserialize(error.error);
            if (apiError.errorCode === 'WR_FOLDER_DOES_NOT_EXIST') {
                return this.createOrgFolder(name).pipe(map((/**
                 * @param {?} newOrgFolder
                 * @return {?}
                 */
                newOrgFolder => {
                    // trigger cache flush
                    this.getOrgFolder(name, true, true).subscribe();
                    return newOrgFolder;
                })));
            }
            else {
                throwError(error);
            }
        })));
        return orgFolder$;
    }
    /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} sandboxId
     * @param {?} filter
     * @return {?}
     */
    listDocuments(folderType, folderId, sandboxId, filter) {
        /** @type {?} */
        let url;
        url = '/webresource/v1/' + folderType + '/' + folderId + '/artifacts/';
        if (sandboxId) {
            url = url + '?$sandbox=' + sandboxId;
        }
        if (filter) {
            url = url + '&$filter=contains(name,\'' + filter + '\')';
        }
        return this.http.get(url)
            .pipe(map((/**
         * @param {?} docs
         * @return {?}
         */
        docs => {
            /** @type {?} */
            const docList = new DocumentList().deserialize(docs);
            for (let x = 0; x < docList.documents.length; x++) {
                docList.documents[x] = this.parseDocument(docList.documents[x]);
            }
            return docList;
        })));
    }
    /**
     * @private
     * @param {?} document
     * @return {?}
     */
    parseDocument(document) {
        /** @type {?} */
        const splitDocName = document.name.split('.');
        if (splitDocName.length > 1) {
            document.extension = splitDocName[splitDocName.length - 1];
        }
        else {
            document.extension = '';
        }
        document.fileIcon = this.getIcon(document.extension);
        document.fileSize = TcCoreCommonFunctions.fileSizeToHuman(Number(document.size));
        this.liveapps.getUserInfo(document.author).subscribe((/**
         * @param {?} val
         * @return {?}
         */
        val => {
            document.authorDetails = val;
            return document;
        }), (/**
         * @param {?} error
         * @return {?}
         */
        error => { console.log('Unable to retrieve user details for user: ' + error.errorMsg); }));
        this.liveapps.getUserInfo(document.lastModifiedBy).subscribe((/**
         * @param {?} val
         * @return {?}
         */
        val => {
            document.lastModifiedByDetails = val;
            return document;
        }), (/**
         * @param {?} error
         * @return {?}
         */
        error => { console.log('Unable to retrieve user details for user: ' + error.errorMsg); }));
        return document;
    }
    /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} documentName
     * @param {?} sandboxId
     * @return {?}
     */
    deleteDocument(folderType, folderId, documentName, sandboxId) {
        /** @type {?} */
        const url = '/webresource/v1/' + folderType + '/' + folderId + '/artifacts/' + documentName + '?$sandbox=' + sandboxId;
        return this.http.delete(url)
            .pipe(map((/**
         * @param {?} val
         * @return {?}
         */
        val => new ApiResponseText().deserialize(val))));
    }
    /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} docId
     * @param {?} docVersion
     * @param {?} sandboxId
     * @return {?}
     */
    getUrlForDocument(folderType, folderId, docId, docVersion, sandboxId) {
        /** @type {?} */
        let url = '/webresource/';
        if (folderType === 'orgFolders') {
            url = url + 'orgFolders/' + folderId;
        }
        else {
            url = url + 'folders/' + folderId;
        }
        if (sandboxId && folderType !== 'orgFolders') {
            url = url + '/' + sandboxId;
        }
        url = url + '/' + docId;
        if (docVersion) {
            url = url + '?$version=' + docVersion;
        }
        return url;
    }
    /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} docId
     * @param {?} docVersion
     * @param {?} sandboxId
     * @return {?}
     */
    downloadDocument(folderType, folderId, docId, docVersion, sandboxId) {
        /** @type {?} */
        let url = '/webresource/';
        if (folderType === 'orgFolders') {
            url = url + 'orgFolders/' + folderId;
        }
        else {
            url = url + 'folders/' + folderId;
        }
        if (sandboxId && folderType !== 'orgFolders') {
            url = url + '/' + sandboxId;
        }
        url = url + '/' + docId + '?$download=true';
        if (docVersion) {
            url = url + '&$version=' + docVersion;
        }
        // todo: Check whether application/octet-stream is ok or whether we should change it
        /** @type {?} */
        const headers = new HttpHeaders({
            'Content-Type': 'application/octet-stream',
        });
        return this.http.get(url, { headers, responseType: (/** @type {?} */ ('blob')) });
    }
    /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} sandboxId
     * @param {?} fileToUpload
     * @param {?} fileName
     * @param {?} description
     * @return {?}
     */
    uploadDocument(folderType, folderId, sandboxId, fileToUpload, fileName, description) {
        /** @type {?} */
        let url = '/webresource/v1/' + folderType
            + '/' + folderId
            + '/artifacts/' + fileName + '/upload/';
        if (sandboxId) {
            url = url + '?$sandbox=' + sandboxId;
        }
        if (description) {
            url = url + '&description=' + description;
        }
        /** @type {?} */
        const headers = new HttpHeaders({
            'accept': 'application/json',
            'Content-Type': 'multipart/form-data',
            'filename': fileName,
            'enctype': 'multipart/form-data'
        });
        /** @type {?} */
        const formData = new FormData();
        formData.append('artifactContents', fileToUpload);
        return this.http.post(url, formData, { headers: headers, reportProgress: true, observe: 'events' });
    }
    /**
     * @private
     * @param {?} extension
     * @return {?}
     */
    getIcon(extension) {
        if (extension === 'txt') {
            return ('doc');
        }
        else if (extension === 'css') {
            return ('doc');
        }
        else if (extension === 'js') {
            return ('doc');
        }
        else if (extension === 'pdf') {
            return ('doc');
        }
        else if (extension === 'xml') {
            return ('doc');
        }
        else if (extension === 'doc') {
            return ('doc');
        }
        else if (extension === 'zip') {
            return ('zip');
        }
        else if (extension === 'ppt') {
            return ('doc');
        }
        else if (extension === 'png') {
            return ('image');
        }
        else {
            return ('doc');
        }
    }
}
TcDocumentService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
TcDocumentService.ctorParameters = () => [
    { type: HttpClient },
    { type: LiveAppsService }
];
/** @nocollapse */ TcDocumentService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function TcDocumentService_Factory() { return new TcDocumentService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.LiveAppsService)); }, token: TcDocumentService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    TcDocumentService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    TcDocumentService.prototype.liveapps;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGMtZG9jdW1lbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0aWJjby10Y3N0ay90Yy1saXZlYXBwcy1saWIvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvdGMtZG9jdW1lbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWEsVUFBVSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQzVDLE9BQU8sRUFBQyxVQUFVLEVBQUUsV0FBVyxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDN0QsT0FBTyxFQUFDLGdCQUFnQixFQUFFLGVBQWUsRUFBQyxNQUFNLHdCQUF3QixDQUFDO0FBQ3pFLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUNwRCxPQUFPLEVBQVcsWUFBWSxFQUFFLFNBQVMsRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBQ3hFLE9BQU8sRUFBQyxVQUFVLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3RCxPQUFPLEVBQUMscUJBQXFCLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQzs7OztBQUsvRCxNQUFNLE9BQU8saUJBQWlCOzs7OztJQUU1QixZQUFvQixJQUFnQixFQUFVLFFBQXlCO1FBQW5ELFNBQUksR0FBSixJQUFJLENBQVk7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFpQjtJQUN2RSxDQUFDOzs7OztJQUVNLGVBQWUsQ0FBQyxJQUFZOztjQUMzQixHQUFHLEdBQUcsNkJBQTZCOztjQUNuQyxJQUFJLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUM7O2NBQ2xELE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQzs7Y0FDOUIsT0FBTyxHQUFHLElBQUksV0FBVyxFQUFF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QUMsQ0FBQztTQUNmO2FBQU0sSUFBSSxTQUFTLEtBQUssS0FBSyxFQUFFO1lBQzlCLE9BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUNqQjthQUFNO1lBQ0wsT0FBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ2Y7SUFDSCxDQUFDOzs7WUEvTUYsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7O1lBVE8sVUFBVTtZQUVWLGVBQWU7Ozs7Ozs7O0lBVVQsaUNBQXdCOzs7OztJQUFFLHFDQUFpQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgdGhyb3dFcnJvcn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge0h0dHBDbGllbnQsIEh0dHBIZWFkZXJzfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge0FwaVJlc3BvbnNlRXJyb3IsIEFwaVJlc3BvbnNlVGV4dH0gZnJvbSAnLi4vbW9kZWxzL2xpdmVhcHBzZGF0YSc7XG5pbXBvcnQge0xpdmVBcHBzU2VydmljZX0gZnJvbSAnLi9saXZlLWFwcHMuc2VydmljZSc7XG5pbXBvcnQge0RvY3VtZW50LCBEb2N1bWVudExpc3QsIE9yZ0ZvbGRlcn0gZnJvbSAnLi4vbW9kZWxzL3RjLWRvY3VtZW50JztcbmltcG9ydCB7Y2F0Y2hFcnJvciwgZmxhdE1hcCwgbWFwLCB0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7VGNDb3JlQ29tbW9uRnVuY3Rpb25zfSBmcm9tICdAdGliY28tdGNzdGsvdGMtY29yZS1saWInO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBUY0RvY3VtZW50U2VydmljZSB7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LCBwcml2YXRlIGxpdmVhcHBzOiBMaXZlQXBwc1NlcnZpY2UpIHtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVPcmdGb2xkZXIobmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxBcGlSZXNwb25zZVRleHQ+IHtcbiAgICBjb25zdCB1cmwgPSAnL3dlYnJlc291cmNlL3YxL29yZ0ZvbGRlcnMvJztcbiAgICBjb25zdCBib2R5ID0gbmV3IE9yZ0ZvbGRlcigpLmRlc2VyaWFsaXplKHsgbmFtZTogbmFtZSB9KTtcbiAgICBjb25zdCBib2R5U3RyID0gSlNPTi5zdHJpbmdpZnkoYm9keSk7XG4gICAgY29uc3QgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpXG4gICAgICAuc2V0KCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdCh1cmwsIGJvZHlTdHIsIHsgaGVhZGVycyB9KS5waXBlKFxuICAgICAgdGFwKCB2YWwgPT4gc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgndGNzVGltZXN0YW1wJywgRGF0ZS5ub3coKS50b1N0cmluZygpKSksXG4gICAgICBtYXAocmVzcG9uc2UgPT4gbmV3IEFwaVJlc3BvbnNlVGV4dCgpLmRlc2VyaWFsaXplKHJlc3BvbnNlKSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGdldE9yZ0ZvbGRlcihuYW1lOiBzdHJpbmcsIHVzZUNhY2hlOiBib29sZWFuLCBmbHVzaENhY2hlOiBib29sZWFuKTogT2JzZXJ2YWJsZTxPcmdGb2xkZXI+IHtcbiAgICBjb25zdCB1cmwgPSAnL3dlYnJlc291cmNlL3YxL29yZ0ZvbGRlcnMvJyArIG5hbWUgKyAnLyc7XG4gICAgbGV0IGhlYWRlcnM6IEh0dHBIZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKCk7XG4gICAgaWYgKHVzZUNhY2hlKSB7XG4gICAgICBoZWFkZXJzID0gaGVhZGVycy5zZXQoJ2NhY2hlUmVzcG9uc2UnLCAndHJ1ZScpO1xuICAgIH1cbiAgICBpZiAoZmx1c2hDYWNoZSkge1xuICAgICAgaGVhZGVycyA9IGhlYWRlcnMuc2V0KCdmbHVzaENhY2hlJywgJ3RydWUnKTtcbiAgICB9XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtoZWFkZXJzOiBoZWFkZXJzfTtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh1cmwsIG9wdGlvbnMpLnBpcGUoXG4gICAgICBtYXAocmVzcG9uc2UgPT4ge1xuICAgICAgICByZXR1cm4gbmV3IE9yZ0ZvbGRlcigpLmRlc2VyaWFsaXplKHJlc3BvbnNlKTtcbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XG4gICAgICAgIGNvbnN0IGFwaUVycm9yID0gbmV3IEFwaVJlc3BvbnNlRXJyb3IoKS5kZXNlcmlhbGl6ZShlcnJvci5lcnJvcik7XG4gICAgICAgIGlmIChhcGlFcnJvci5lcnJvckNvZGUgPT09ICdXUl9GT0xERVJfRE9FU19OT1RfRVhJU1QnKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlT3JnRm9sZGVyKG5hbWUpLnBpcGUoXG4gICAgICAgICAgICBmbGF0TWFwKG5ld09yZ0ZvbGRlciA9PiB7XG4gICAgICAgICAgICAgIC8vIHRyaWdnZXIgY2FjaGUgZmx1c2hcbiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0T3JnRm9sZGVyKG5hbWUsIHRydWUsIHRydWUpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93RXJyb3IoZXJyb3IpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgaW5pdE9yZ0ZvbGRlcihuYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEFwaVJlc3BvbnNlVGV4dD4ge1xuICAgIGNvbnN0IG9yZ0ZvbGRlciQgPSB0aGlzLmdldE9yZ0ZvbGRlcihuYW1lLCB0cnVlLCBmYWxzZSkucGlwZShcbiAgICAgIG1hcChvcmdGb2xkZXJSZXNwID0+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBBcGlSZXNwb25zZVRleHQoKS5kZXNlcmlhbGl6ZSh7IG1lc3NhZ2U6ICdvcmdGb2xkZXIgb2snfSk7XG4gICAgICB9KSxcbiAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xuICAgICAgICBjb25zdCBhcGlFcnJvciA9IG5ldyBBcGlSZXNwb25zZUVycm9yKCkuZGVzZXJpYWxpemUoZXJyb3IuZXJyb3IpO1xuICAgICAgICBpZiAoYXBpRXJyb3IuZXJyb3JDb2RlID09PSAnV1JfRk9MREVSX0RPRVNfTk9UX0VYSVNUJykge1xuICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZU9yZ0ZvbGRlcihuYW1lKS5waXBlKFxuICAgICAgICAgICAgbWFwKG5ld09yZ0ZvbGRlciA9PiB7XG4gICAgICAgICAgICAgIC8vIHRyaWdnZXIgY2FjaGUgZmx1c2hcbiAgICAgICAgICAgICAgdGhpcy5nZXRPcmdGb2xkZXIobmFtZSwgdHJ1ZSwgdHJ1ZSkuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICAgIHJldHVybiBuZXdPcmdGb2xkZXI7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3dFcnJvcihlcnJvcik7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgICByZXR1cm4gb3JnRm9sZGVyJDtcbiAgfVxuXG4gIHB1YmxpYyBsaXN0RG9jdW1lbnRzKGZvbGRlclR5cGU6IHN0cmluZywgZm9sZGVySWQ6IHN0cmluZywgc2FuZGJveElkOiBudW1iZXIsIGZpbHRlcjogc3RyaW5nKTogT2JzZXJ2YWJsZTxEb2N1bWVudExpc3Q+IHtcbiAgICBsZXQgdXJsOiBzdHJpbmc7XG4gICAgdXJsID0gJy93ZWJyZXNvdXJjZS92MS8nICsgZm9sZGVyVHlwZSArICcvJyArIGZvbGRlcklkICsgJy9hcnRpZmFjdHMvJztcbiAgICBpZiAoc2FuZGJveElkKSB7XG4gICAgICB1cmwgPSB1cmwgKyAnPyRzYW5kYm94PScgKyBzYW5kYm94SWQ7XG4gICAgfVxuICAgIGlmIChmaWx0ZXIpIHtcbiAgICAgIHVybCA9IHVybCArICcmJGZpbHRlcj1jb250YWlucyhuYW1lLFxcJycgKyBmaWx0ZXIgKyAnXFwnKSc7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHVybClcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoZG9jcyA9PiB7XG4gICAgICAgICAgICBjb25zdCBkb2NMaXN0ID0gbmV3IERvY3VtZW50TGlzdCgpLmRlc2VyaWFsaXplKGRvY3MpO1xuICAgICAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCBkb2NMaXN0LmRvY3VtZW50cy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgICAgICBkb2NMaXN0LmRvY3VtZW50c1t4XSA9IHRoaXMucGFyc2VEb2N1bWVudChkb2NMaXN0LmRvY3VtZW50c1t4XSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZG9jTGlzdDtcbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgICk7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlRG9jdW1lbnQoZG9jdW1lbnQpOiBEb2N1bWVudCB7XG4gICAgY29uc3Qgc3BsaXREb2NOYW1lID0gZG9jdW1lbnQubmFtZS5zcGxpdCgnLicpO1xuICAgIGlmIChzcGxpdERvY05hbWUubGVuZ3RoID4gMSkge1xuICAgICAgZG9jdW1lbnQuZXh0ZW5zaW9uID0gc3BsaXREb2NOYW1lW3NwbGl0RG9jTmFtZS5sZW5ndGggLSAxXTtcbiAgICB9IGVsc2Uge1xuICAgICAgZG9jdW1lbnQuZXh0ZW5zaW9uID0gJyc7XG4gICAgfVxuICAgIGRvY3VtZW50LmZpbGVJY29uID0gdGhpcy5nZXRJY29uKGRvY3VtZW50LmV4dGVuc2lvbik7XG4gICAgZG9jdW1lbnQuZmlsZVNpemUgPSBUY0NvcmVDb21tb25GdW5jdGlvbnMuZmlsZVNpemVUb0h1bWFuKE51bWJlcihkb2N1bWVudC5zaXplKSk7XG4gICAgdGhpcy5saXZlYXBwcy5nZXRVc2VySW5mbyhkb2N1bWVudC5hdXRob3IpLnN1YnNjcmliZSh2YWwgPT4ge1xuICAgICAgZG9jdW1lbnQuYXV0aG9yRGV0YWlscyA9IHZhbDtcbiAgICAgIHJldHVybiBkb2N1bWVudDtcbiAgICB9LCBlcnJvciA9PiB7IGNvbnNvbGUubG9nKCdVbmFibGUgdG8gcmV0cmlldmUgdXNlciBkZXRhaWxzIGZvciB1c2VyOiAnICsgZXJyb3IuZXJyb3JNc2cpOyB9KTtcbiAgICB0aGlzLmxpdmVhcHBzLmdldFVzZXJJbmZvKGRvY3VtZW50Lmxhc3RNb2RpZmllZEJ5KS5zdWJzY3JpYmUodmFsID0+IHtcbiAgICAgIGRvY3VtZW50Lmxhc3RNb2RpZmllZEJ5RGV0YWlscyA9IHZhbDtcbiAgICAgIHJldHVybiBkb2N1bWVudDtcbiAgICB9LCBlcnJvciA9PiB7IGNvbnNvbGUubG9nKCdVbmFibGUgdG8gcmV0cmlldmUgdXNlciBkZXRhaWxzIGZvciB1c2VyOiAnICsgZXJyb3IuZXJyb3JNc2cpOyB9KTtcbiAgICByZXR1cm4gZG9jdW1lbnQ7XG4gIH1cblxuICBwdWJsaWMgZGVsZXRlRG9jdW1lbnQoZm9sZGVyVHlwZTogc3RyaW5nLCBmb2xkZXJJZDogc3RyaW5nLCBkb2N1bWVudE5hbWU6IHN0cmluZywgc2FuZGJveElkOiBudW1iZXIpOiBPYnNlcnZhYmxlPEFwaVJlc3BvbnNlVGV4dD4ge1xuICAgIGNvbnN0IHVybCA9ICcvd2VicmVzb3VyY2UvdjEvJyArIGZvbGRlclR5cGUgKyAnLycgKyBmb2xkZXJJZCArICcvYXJ0aWZhY3RzLycgKyBkb2N1bWVudE5hbWUgKyAnPyRzYW5kYm94PScgKyBzYW5kYm94SWQ7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5kZWxldGUodXJsKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCggdmFsID0+IG5ldyBBcGlSZXNwb25zZVRleHQoKS5kZXNlcmlhbGl6ZSh2YWwpKVxuICAgICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRVcmxGb3JEb2N1bWVudChmb2xkZXJUeXBlOiBzdHJpbmcsIGZvbGRlcklkOiBzdHJpbmcsIGRvY0lkOiBzdHJpbmcsIGRvY1ZlcnNpb246IHN0cmluZywgc2FuZGJveElkOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIGxldCB1cmwgPSAnL3dlYnJlc291cmNlLyc7XG4gICAgaWYgKGZvbGRlclR5cGUgPT09ICdvcmdGb2xkZXJzJykge1xuICAgICAgdXJsID0gdXJsICsgJ29yZ0ZvbGRlcnMvJyArIGZvbGRlcklkO1xuICAgIH0gZWxzZSB7XG4gICAgICB1cmwgPSB1cmwgKyAnZm9sZGVycy8nICsgZm9sZGVySWQ7XG4gICAgfVxuICAgIGlmIChzYW5kYm94SWQgJiYgZm9sZGVyVHlwZSAhPT0gJ29yZ0ZvbGRlcnMnKSB7XG4gICAgICB1cmwgPSB1cmwgKyAnLycgKyBzYW5kYm94SWQ7XG4gICAgfVxuICAgIHVybCA9IHVybCArICcvJyArIGRvY0lkO1xuICAgIGlmIChkb2NWZXJzaW9uKSB7XG4gICAgICB1cmwgPSB1cmwgKyAnPyR2ZXJzaW9uPScgKyBkb2NWZXJzaW9uO1xuICAgIH1cbiAgICByZXR1cm4gdXJsO1xuICB9XG5cbiAgcHVibGljIGRvd25sb2FkRG9jdW1lbnQoZm9sZGVyVHlwZTogc3RyaW5nLCBmb2xkZXJJZDogc3RyaW5nLCBkb2NJZDogc3RyaW5nLCBkb2NWZXJzaW9uOiBzdHJpbmcsIHNhbmRib3hJZDogbnVtYmVyKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBsZXQgdXJsID0gJy93ZWJyZXNvdXJjZS8nO1xuICAgIGlmIChmb2xkZXJUeXBlID09PSAnb3JnRm9sZGVycycpIHtcbiAgICAgIHVybCA9IHVybCArICdvcmdGb2xkZXJzLycgKyBmb2xkZXJJZDtcbiAgICB9IGVsc2Uge1xuICAgICAgdXJsID0gdXJsICsgJ2ZvbGRlcnMvJyArIGZvbGRlcklkO1xuICAgIH1cbiAgICBpZiAoc2FuZGJveElkICYmIGZvbGRlclR5cGUgIT09ICdvcmdGb2xkZXJzJykge1xuICAgICAgdXJsID0gdXJsICsgJy8nICsgc2FuZGJveElkO1xuICAgIH1cbiAgICB1cmwgPSB1cmwgKyAnLycgKyBkb2NJZCArICc/JGRvd25sb2FkPXRydWUnO1xuICAgIGlmIChkb2NWZXJzaW9uKSB7XG4gICAgICB1cmwgPSB1cmwgKyAnJiR2ZXJzaW9uPScgKyBkb2NWZXJzaW9uO1xuICAgIH1cbiAgICAvLyB0b2RvOiBDaGVjayB3aGV0aGVyIGFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSBpcyBvayBvciB3aGV0aGVyIHdlIHNob3VsZCBjaGFuZ2UgaXRcbiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHtcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyxcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh1cmwsIHsgaGVhZGVycywgcmVzcG9uc2VUeXBlOiAnYmxvYicgYXMgJ2pzb24nIH0pO1xuICB9XG5cbiAgcHVibGljIHVwbG9hZERvY3VtZW50KGZvbGRlclR5cGU6IHN0cmluZywgZm9sZGVySWQ6IHN0cmluZywgc2FuZGJveElkOiBudW1iZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxlVG9VcGxvYWQ6IEZpbGUsIGZpbGVOYW1lOiBzdHJpbmcsIGRlc2NyaXB0aW9uOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGxldCB1cmwgPSAnL3dlYnJlc291cmNlL3YxLycgKyBmb2xkZXJUeXBlXG4gICAgICArICcvJyArIGZvbGRlcklkXG4gICAgICArICcvYXJ0aWZhY3RzLycgKyBmaWxlTmFtZSArICcvdXBsb2FkLyc7XG5cbiAgICBpZiAoc2FuZGJveElkKSB7XG4gICAgICB1cmwgPSB1cmwgKyAnPyRzYW5kYm94PScgKyBzYW5kYm94SWQ7XG4gICAgfVxuXG4gICAgaWYgKGRlc2NyaXB0aW9uKSB7XG4gICAgICB1cmwgPSB1cmwgKyAnJmRlc2NyaXB0aW9uPScgKyBkZXNjcmlwdGlvbjtcbiAgICB9XG4gICAgY29uc3QgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycyh7XG4gICAgICAnYWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdtdWx0aXBhcnQvZm9ybS1kYXRhJyxcbiAgICAgICdmaWxlbmFtZSc6IGZpbGVOYW1lLFxuICAgICAgJ2VuY3R5cGUnOiAnbXVsdGlwYXJ0L2Zvcm0tZGF0YSdcbiAgICB9KTtcbiAgICBjb25zdCBmb3JtRGF0YTogRm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICBmb3JtRGF0YS5hcHBlbmQoJ2FydGlmYWN0Q29udGVudHMnLCBmaWxlVG9VcGxvYWQpO1xuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdCh1cmwsIGZvcm1EYXRhLCB7IGhlYWRlcnM6IGhlYWRlcnMsIHJlcG9ydFByb2dyZXNzOiB0cnVlLCBvYnNlcnZlOiAnZXZlbnRzJyB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SWNvbihleHRlbnNpb246IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKGV4dGVuc2lvbiA9PT0gJ3R4dCcpIHtcbiAgICAgIHJldHVybignZG9jJyk7XG4gICAgfSBlbHNlIGlmIChleHRlbnNpb24gPT09ICdjc3MnKSB7XG4gICAgICByZXR1cm4oJ2RvYycpO1xuICAgIH0gZWxzZSBpZiAoZXh0ZW5zaW9uID09PSAnanMnKSB7XG4gICAgICByZXR1cm4oJ2RvYycpO1xuICAgIH0gZWxzZSBpZiAoZXh0ZW5zaW9uID09PSAncGRmJykge1xuICAgICAgcmV0dXJuKCdkb2MnKTtcbiAgICB9IGVsc2UgaWYgKGV4dGVuc2lvbiA9PT0gJ3htbCcpIHtcbiAgICAgIHJldHVybignZG9jJyk7XG4gICAgfSBlbHNlIGlmIChleHRlbnNpb24gPT09ICdkb2MnKSB7XG4gICAgICByZXR1cm4oJ2RvYycpO1xuICAgIH0gZWxzZSBpZiAoZXh0ZW5zaW9uID09PSAnemlwJykge1xuICAgICAgcmV0dXJuKCd6aXAnKTtcbiAgICB9IGVsc2UgaWYgKGV4dGVuc2lvbiA9PT0gJ3BwdCcpIHtcbiAgICAgIHJldHVybignZG9jJyk7XG4gICAgfSBlbHNlIGlmIChleHRlbnNpb24gPT09ICdwbmcnKSB7XG4gICAgICByZXR1cm4oJ2ltYWdlJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybignZG9jJyk7XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==