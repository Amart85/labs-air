/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { SharedStateContent, SharedStateEntry, SharedStateList, TcCoreCommonFunctions, TcSharedStateService } from '@tibco-tcstk/tc-core-lib';
import { forkJoin, of, throwError } from 'rxjs';
import { CardConfig, CaseInfo, IconMap, UserInfo } from '../models/liveappsdata';
import { LiveAppsService } from './live-apps.service';
import { CaseCardConfig, StateColorMap, StateColorMapRec } from '../models/tc-case-card-config';
import { catchError, map, mergeMap, tap } from 'rxjs/operators';
import { HttpClient } from '@angular/common/http';
import { Location } from '@angular/common';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./live-apps.service";
import * as i3 from "@tibco-tcstk/tc-core-lib";
import * as i4 from "@angular/common";
/** @type {?} */
export const DEFAULT_COLORS = [
    '#3E94C0', '#49B3D3', '#76C6CF', '#A9DACD', '#DCECC9',
    '#FFAB40', '#FFD180', '#FFE0B2', '#FFF3E0', '#81D4FA',
    '#B3E5FC', '#8AF2F2', '#91A3AE', '#CED8DD', '#EBEFF1',
    '#6A1B9A', '#AD1457', '#EC407A', '#C4469E', '#BA68C8',
    '#8C9EFF', '#FF8A80', '#546F7A', '#263237'
];
/** @type {?} */
export const DEFAULT_TYPE_COLOR = '#8197c0';
/** @type {?} */
export const DEFAULT_STATE_COLOR = '#8197c0';
/** @type {?} */
export const GENERIC_STATE_ICON_SVG = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14">\n' +
    '    <path fill="<DYNAMICFILL>" fill-rule="nonzero" d="M.045 1.154h13.91v2.133H.045V1.154zM.8 4.75h12.364v8.19c0 .596-.487 1.083-1.082 1.083h-10.2A1.085 1.085 0 0 1 .8 12.94V4.75zm7.978 2.447V5.776H5.222v1.421h3.556z"/>\n' +
    '</svg>\n';
/** @type {?} */
export const GENERIC_CASETYPE_ICON_SVG = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 48 48">\n' +
    '    <path fill="<DYNAMICFILL>" fill-rule="evenodd" d="M42 42H6c-1.103 0-2-.898-2-2V26.61c4.43 2.623 10.208 3.96 15.729 4.422v1.504c0 1.326.948 2.4 2.118 2.4h4.764c1.17 0 2.118-1.074 2.118-2.4V31.04c6.16-.503 11.505-2.008 15.271-4.264v13.223c0 1.103-.897 2-2 2zM6 15.995h36c1.103 0 2 .898 2 2v3.583c-2.798 2.727-8.447 4.664-15.271 5.268v-1.511c0-1.326-.948-2.4-2.117-2.4h-4.765c-1.17 0-2.118 1.074-2.118 2.4v1.51c-6.651-.6-12.41-2.518-15.729-5.348v-3.501c0-1.103.897-2 2-2zm10.655-8.89c0-.063.023-.098.016-.106l14.944-.011s.04.033.04.117v4.89h-15v-4.89zM42 11.996h-6.345v-4.89C35.655 4.842 33.861 3 31.657 3H16.653c-2.204 0-3.998 1.842-3.998 4.106v4.89H6c-3.308 0-6 2.692-6 6V40c0 3.31 2.692 6 6 6h36c3.309 0 6-2.69 6-6V17.997c0-3.31-2.691-6.001-6-6.001z"/>\n' +
    '</svg>\n';
export class TcCaseCardConfigService {
    /**
     * @param {?} http
     * @param {?} liveAppsService
     * @param {?} sharedStateService
     * @param {?} location
     */
    constructor(http, liveAppsService, sharedStateService, location) {
        this.http = http;
        this.liveAppsService = liveAppsService;
        this.sharedStateService = sharedStateService;
        this.location = location;
    }
    /**
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} uiAppId
     * @return {?}
     */
    createCardConfig(sandboxId, appId, uiAppId) {
        /** @type {?} */
        const ssName = uiAppId + '.' + appId + '.stateconfig.tibcolabs.client.context.PUBLIC';
        /** @type {?} */
        const content = new SharedStateContent();
        content.json = TcCoreCommonFunctions.escapeString(JSON.stringify({}));
        return this.sharedStateService.createSharedState(ssName, 'PUBLIC', '', sandboxId, undefined, undefined, undefined, content)
            .pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            return value;
        })));
    }
    /**
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} uiAppId
     * @param {?} config
     * @param {?} id
     * @return {?}
     */
    updateCardConfig(sandboxId, appId, uiAppId, config, id) {
        /** @type {?} */
        const ssName = uiAppId + '.' + appId + '.stateconfig.tibcolabs.client.context.PUBLIC';
        /** @type {?} */
        const content = new SharedStateContent();
        content.json = TcCoreCommonFunctions.escapeString(JSON.stringify(config));
        /** @type {?} */
        const entry = new SharedStateEntry();
        entry.content = content;
        entry.sandboxId = sandboxId;
        entry.name = ssName;
        entry.type = 'PUBLIC';
        entry.id = id;
        /** @type {?} */
        const ssList = new SharedStateList();
        ssList.sharedStateEntries = [];
        ssList.sharedStateEntries.push(entry);
        return this.sharedStateService.updateSharedState(ssList.sharedStateEntries)
            .pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            return new CardConfig().deserialize((JSON.parse(value.sharedStateEntries[0].content.json)));
        })));
    }
    /**
     * @param {?} states
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} uiAppId
     * @param {?} caseTypeId
     * @param {?} defaultCaseTypeColor
     * @param {?} defaultCaseTypeIcon
     * @param {?} defaultStateColor
     * @param {?} defaultStateIcon
     * @return {?}
     */
    createNewCardConfig(states, sandboxId, appId, uiAppId, caseTypeId, defaultCaseTypeColor, defaultCaseTypeIcon, defaultStateColor, defaultStateIcon) {
        // create new config and return it
        /** @type {?} */
        const newConfig$ = this.createCardConfig(sandboxId, appId, uiAppId);
        /** @type {?} */
        const updatedConfig$ = newConfig$.pipe(mergeMap((/**
         * @param {?} id
         * @return {?}
         */
        id => {
            /** @type {?} */
            const stateMap = [];
            // one record for the case type icon config
            stateMap.push(new IconMap(true, caseTypeId, defaultCaseTypeColor, defaultCaseTypeIcon));
            states.forEach((/**
             * @param {?} state
             * @return {?}
             */
            state => {
                stateMap.push(new IconMap(false, state.value, defaultStateColor, defaultStateIcon));
            }));
            /** @type {?} */
            const newCardConfig = new CardConfig().deserialize({ id: id, useCaseTypeColor: true, stateMap: stateMap });
            return this.updateCardConfig(sandboxId, appId, uiAppId, newCardConfig, id).pipe(tap((/**
             * @param {?} config
             * @return {?}
             */
            config => {
                // trigger update of the cache
                this.getCardConfig(uiAppId, appId, true, true);
            })), map((/**
             * @param {?} newcard
             * @return {?}
             */
            newcard => {
                return new CaseCardConfig().deserialize({ states: states, cardConfig: newcard });
            })));
        })));
        return updatedConfig$;
    }
    /**
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} uiAppId
     * @param {?} caseTypeId
     * @param {?} defaultCaseTypeColor
     * @param {?} defaultCaseTypeIcon
     * @param {?} defaultStateColor
     * @param {?} defaultStateIcon
     * @return {?}
     */
    getCaseCardConfig(sandboxId, appId, uiAppId, caseTypeId, defaultCaseTypeColor, defaultCaseTypeIcon, defaultStateColor, defaultStateIcon) {
        /** @type {?} */
        const states$ = this.liveAppsService.getCaseTypeStates(sandboxId, appId, 100);
        /** @type {?} */
        const cardConfig$ = this.getCardConfig(uiAppId, appId, true, false).pipe(map((/**
         * @param {?} config
         * @return {?}
         */
        config => {
            return config;
        })));
        return states$.pipe(mergeMap((/**
         * @param {?} states
         * @return {?}
         */
        states => {
            return cardConfig$.pipe(mergeMap((/**
             * @param {?} config
             * @return {?}
             */
            config => {
                if (config) {
                    /** @type {?} */
                    const cardConfig = new CaseCardConfig().deserialize({ states: states.states, cardConfig: config });
                    return of(cardConfig);
                }
                else {
                    return this.createNewCardConfig(states.states, sandboxId, appId, uiAppId, caseTypeId, defaultCaseTypeColor, defaultCaseTypeIcon, defaultStateColor, defaultStateIcon).pipe(map((/**
                     * @param {?} newCardConfig
                     * @return {?}
                     */
                    newCardConfig => {
                        return newCardConfig;
                    })));
                }
            })));
        })));
    }
    /**
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} uiAppId
     * @param {?} updatedConfig
     * @return {?}
     */
    updateCaseCardConfig(sandboxId, appId, uiAppId, updatedConfig) {
        return this.updateCardConfig(sandboxId, appId, uiAppId, updatedConfig.cardConfig, updatedConfig.cardConfig.id).pipe(map((/**
         * @param {?} cardconfig
         * @return {?}
         */
        cardconfig => {
            updatedConfig.cardConfig = cardconfig;
            // remember to flush cache
            this.getCardConfig(uiAppId, appId, true, true).subscribe();
            return updatedConfig;
        })));
    }
    /**
     * @param {?} uiAppId
     * @param {?} appId
     * @param {?} useCache
     * @param {?} flushCache
     * @return {?}
     */
    getCardConfig(uiAppId, appId, useCache, flushCache) {
        /** @type {?} */
        const ssName = uiAppId + '.' + appId + '.stateconfig.tibcolabs.client.context.PUBLIC';
        return this.sharedStateService.getSharedState(ssName, 'PUBLIC', useCache, flushCache).pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            if (value.sharedStateEntries.length > 0) {
                /** @type {?} */
                const ssresult = new CardConfig().deserialize(JSON.parse(value.sharedStateEntries[0].content.json));
                ssresult.id = value.sharedStateEntries[0].id;
                return ssresult;
            }
            else {
                return undefined;
            }
        })));
    }
    /**
     * @param {?} appId
     * @param {?} uiAppId
     * @return {?}
     */
    getStateColorInfo(appId, uiAppId) {
        return this.getCardConfig(uiAppId, appId, true, false).pipe(map((/**
         * @param {?} val
         * @return {?}
         */
        val => {
            if (val) {
                /** @type {?} */
                const config = val;
                /** @type {?} */
                const stateColorMap = new StateColorMap();
                stateColorMap.stateColorRecs = [];
                config.stateMap.forEach((/**
                 * @param {?} stateMapRec
                 * @return {?}
                 */
                (stateMapRec) => {
                    /** @type {?} */
                    const stateColorMapRec = new StateColorMapRec().deserialize({ state: stateMapRec.state, color: stateMapRec.fill });
                    if (stateMapRec.isCaseType) {
                        stateColorMap.caseTypeColor = stateMapRec.fill;
                    }
                    stateColorMap.stateColorRecs.push(stateColorMapRec);
                }));
                return stateColorMap;
            }
            else {
                return new StateColorMap();
            }
        })));
    }
    /**
     * @param {?} appId
     * @param {?} uiAppId
     * @param {?} state
     * @return {?}
     */
    getColorForState(appId, uiAppId, state) {
        return this.getCardConfig(uiAppId, appId, true, false).pipe(map((/**
         * @param {?} val
         * @return {?}
         */
        val => {
            /** @type {?} */
            const stateMap = val.stateMap.find((/**
             * @param {?} stateRec
             * @return {?}
             */
            (stateRec) => {
                return stateRec.state === state;
            }));
            return (stateMap ? stateMap.fill : undefined);
        })));
    }
    /**
     * @param {?} caseinfo
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} typeId
     * @param {?} uiAppId
     * @return {?}
     */
    parseCaseInfo(caseinfo, sandboxId, appId, typeId, uiAppId) {
        // in order to get all the info we need we actually need to call up to 4 observables in parallel
        /** @type {?} */
        const caseInfo$ = this.liveAppsService.getCaseTypeBasicInfo(sandboxId, appId, typeId, 100).pipe(map((/**
         * @param {?} val
         * @return {?}
         */
        val => caseinfo.metadata.applicationLabel = val.label)));
        /** @type {?} */
        const cardConfig$ = this.getCardConfig(uiAppId, appId, true, false).pipe(map((/**
         * @param {?} val
         * @return {?}
         */
        val => {
            /** @type {?} */
            const stateId = caseinfo.summaryObj.state;
            /** @type {?} */
            let stateConfig;
            if (val !== undefined && val.stateMap) {
                val.stateMap.forEach((/**
                 * @param {?} state
                 * @return {?}
                 */
                (state) => {
                    if (state.state === stateId) {
                        stateConfig = state;
                        caseinfo.metadata.stateColor = stateConfig.fill;
                        caseinfo.metadata.stateIcon = stateConfig.icon;
                    }
                    if (state.isCaseType) {
                        stateConfig = state;
                        caseinfo.metadata.caseTypeColor = stateConfig.fill;
                        caseinfo.metadata.caseTypeIcon = stateConfig.icon;
                    }
                    caseinfo.metadata.useCaseTypeColor = val.useCaseTypeColor ? val.useCaseTypeColor : false;
                }));
            }
            // defaults
            if (!caseinfo.metadata.stateColor) {
                caseinfo.metadata.stateColor = DEFAULT_STATE_COLOR;
            }
            if (!caseinfo.metadata.stateIcon) {
                caseinfo.metadata.stateIcon = 'assets/icons/ic-generic-state.svg';
            }
            if (!caseinfo.metadata.caseTypeColor) {
                caseinfo.metadata.caseTypeColor = DEFAULT_TYPE_COLOR;
            }
            if (!caseinfo.metadata.caseTypeIcon) {
                caseinfo.metadata.caseTypeIcon = 'assets/icons/ic-generic-casetype.svg';
            }
        })));
        /** @type {?} */
        const forkJoinArray = [caseInfo$, cardConfig$];
        /** @type {?} */
        let creatorInfo$;
        /** @type {?} */
        let modifiedInfo$;
        if (caseinfo.metadata.createdBy) {
            creatorInfo$ = this.liveAppsService.getUserInfo(caseinfo.metadata.createdBy).pipe(map((/**
             * @param {?} val
             * @return {?}
             */
            val => caseinfo.metadata.createdByDetails = val ? val : new UserInfo())));
            forkJoinArray.push(creatorInfo$);
        }
        else {
            caseinfo.metadata.createdByDetails = new UserInfo();
        }
        if (caseinfo.metadata.modifiedBy) {
            modifiedInfo$ = this.liveAppsService.getUserInfo(caseinfo.metadata.modifiedBy).pipe(map((/**
             * @param {?} val
             * @return {?}
             */
            val => caseinfo.metadata.modifiedByDetails = val ? val : new UserInfo())));
            forkJoinArray.push(modifiedInfo$);
        }
        else {
            caseinfo.metadata.modifiedByDetails = new UserInfo();
        }
        // call all the observables at once and return the Observable to the parsed CaseInfo
        return forkJoin(forkJoinArray).pipe(map((/**
         * @param {?} resultArr
         * @return {?}
         */
        resultArr => {
            return caseinfo;
        })));
    }
    /**
     * @param {?} caseRef
     * @param {?} sandboxId
     * @param {?} uiAppId
     * @return {?}
     */
    getCaseWithSummary(caseRef, sandboxId, uiAppId) {
        // get the base caseinfo from the API, then call parseCaseInfo to create an Observable with all the extra data we need
        /** @type {?} */
        const url = '/case/v1/cases/' + caseRef + '/' + '?$sandbox=' + sandboxId + '&$select=cr, uc, m, s';
        return this.http.get(url).pipe(mergeMap((/**
         * @param {?} caseinfo
         * @return {?}
         */
        caseinfo => {
            /** @type {?} */
            const caseinf = new CaseInfo().deserialize(caseinfo);
            if (caseinf.caseReference === undefined) {
                // case is likely no longer visible to this user so handle as deleted
                return of(new CaseInfo().deserialize({ deleted: true }));
            }
            return this.parseCaseInfo(caseinf, sandboxId, caseinf.metadata.applicationId, caseinf.metadata.typeId, uiAppId);
        })), catchError((/**
         * @param {?} err
         * @return {?}
         */
        err => {
            if (err.error.errorCode === 'CM_CASEREF_NOTEXIST') {
                // case deleted
                return of(new CaseInfo().deserialize({ deleted: true }));
            }
            return throwError(err);
        })));
    }
}
TcCaseCardConfigService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
TcCaseCardConfigService.ctorParameters = () => [
    { type: HttpClient },
    { type: LiveAppsService },
    { type: TcSharedStateService },
    { type: Location }
];
/** @nocollapse */ TcCaseCardConfigService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function TcCaseCardConfigService_Factory() { return new TcCaseCardConfigService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.LiveAppsService), i0.ɵɵinject(i3.TcSharedStateService), i0.ɵɵinject(i4.Location)); }, token: TcCaseCardConfigService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    TcCaseCardConfigService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    TcCaseCardConfigService.prototype.liveAppsService;
    /**
     * @type {?}
     * @private
     */
    TcCaseCardConfigService.prototype.sharedStateService;
    /**
     * @type {?}
     * @private
     */
    TcCaseCardConfigService.prototype.location;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGMtY2FzZS1jYXJkLWNvbmZpZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRpYmNvLXRjc3RrL3RjLWxpdmVhcHBzLWxpYi8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy90Yy1jYXNlLWNhcmQtY29uZmlnLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxFQUFDLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLGVBQWUsRUFBRSxxQkFBcUIsRUFBRSxvQkFBb0IsRUFBYyxNQUFNLDBCQUEwQixDQUFDO0FBQ3pKLE9BQU8sRUFBQyxRQUFRLEVBQWMsRUFBRSxFQUFFLFVBQVUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUMxRCxPQUFPLEVBQW1CLFVBQVUsRUFBRSxRQUFRLEVBQXFDLE9BQU8sRUFBRSxRQUFRLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUNwSSxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0scUJBQXFCLENBQUM7QUFDcEQsT0FBTyxFQUFDLGNBQWMsRUFBRSxhQUFhLEVBQUUsZ0JBQWdCLEVBQUMsTUFBTSwrQkFBK0IsQ0FBQztBQUM5RixPQUFPLEVBQUMsVUFBVSxFQUFXLEdBQUcsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFFdkUsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ2hELE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQzs7Ozs7OztBQUV6QyxNQUFNLE9BQU8sY0FBYyxHQUFhO0lBQ3RDLFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxTQUFTO0lBQ3JELFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxTQUFTO0lBQ3JELFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFB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QyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDbEgsQ0FBQyxFQUNGLEVBQ0QsVUFBVTs7OztRQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2YsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLFNBQVMsS0FBSyxxQkFBcUIsRUFBRTtnQkFDakQsZUFBZTtnQkFDZixPQUFPLEVBQUUsQ0FBQyxJQUFJLFFBQVEsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBRSxDQUFDLENBQUM7YUFDM0Q7WUFDRCxPQUFPLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6QixDQUFDLEVBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQzs7O1lBeFBGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OztZQXpCTyxVQUFVO1lBSlYsZUFBZTtZQUgrRCxvQkFBb0I7WUFRbEcsUUFBUTs7Ozs7Ozs7SUEyQkYsdUNBQXdCOzs7OztJQUFFLGtEQUF3Qzs7Ozs7SUFBRSxxREFBZ0Q7Ozs7O0lBQUUsMkNBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7U2hhcmVkU3RhdGVDb250ZW50LCBTaGFyZWRTdGF0ZUVudHJ5LCBTaGFyZWRTdGF0ZUxpc3QsIFRjQ29yZUNvbW1vbkZ1bmN0aW9ucywgVGNTaGFyZWRTdGF0ZVNlcnZpY2UsIFVpQXBwQ29uZmlnfSBmcm9tICdAdGliY28tdGNzdGsvdGMtY29yZS1saWInO1xuaW1wb3J0IHtmb3JrSm9pbiwgT2JzZXJ2YWJsZSwgb2YsIHRocm93RXJyb3J9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtBcGlSZXNwb25zZUVycm9yLCBDYXJkQ29uZmlnLCBDYXNlSW5mbywgQ2FzZVR5cGVTdGF0ZSwgQ2FzZVR5cGVTdGF0ZXNMaXN0LCBJY29uTWFwLCBVc2VySW5mb30gZnJvbSAnLi4vbW9kZWxzL2xpdmVhcHBzZGF0YSc7XG5pbXBvcnQge0xpdmVBcHBzU2VydmljZX0gZnJvbSAnLi9saXZlLWFwcHMuc2VydmljZSc7XG5pbXBvcnQge0Nhc2VDYXJkQ29uZmlnLCBTdGF0ZUNvbG9yTWFwLCBTdGF0ZUNvbG9yTWFwUmVjfSBmcm9tICcuLi9tb2RlbHMvdGMtY2FzZS1jYXJkLWNvbmZpZyc7XG5pbXBvcnQge2NhdGNoRXJyb3IsIGZsYXRNYXAsIG1hcCwgbWVyZ2VNYXAsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtmbHVzaH0gZnJvbSAnQGFuZ3VsYXIvY29yZS90ZXN0aW5nJztcbmltcG9ydCB7SHR0cENsaWVudH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtMb2NhdGlvbn0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfQ09MT1JTOiBzdHJpbmdbXSA9IFtcbiAgJyMzRTk0QzAnLCAnIzQ5QjNEMycsICcjNzZDNkNGJywgJyNBOURBQ0QnLCAnI0RDRUNDOScsXG4gICcjRkZBQjQwJywgJyNGRkQxODAnLCAnI0ZGRTBCMicsICcjRkZGM0UwJywgJyM4MUQ0RkEnLFxuICAnI0IzRTVGQycsICcjOEFGMkYyJywgJyM5MUEzQUUnLCAnI0NFRDhERCcsICcjRUJFRkYxJyxcbiAgJyM2QTFCOUEnLCAnI0FEMTQ1NycsICcjRUM0MDdBJywgJyNDNDQ2OUUnLCAnI0JBNjhDOCcsXG4gICcjOEM5RUZGJywgJyNGRjhBODAnLCAnIzU0NkY3QScsICcjMjYzMjM3J1xuXTtcblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfVFlQRV9DT0xPUiA9ICcjODE5N2MwJztcblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfU1RBVEVfQ09MT1IgPSAnIzgxOTdjMCc7XG5cbmV4cG9ydCBjb25zdCBHRU5FUklDX1NUQVRFX0lDT05fU1ZHID0gJzxzdmcgeG1sbnM9XCJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z1wiIHdpZHRoPVwiMTRcIiBoZWlnaHQ9XCIxNFwiIHZpZXdCb3g9XCIwIDAgMTQgMTRcIj5cXG4nICtcbiAgJyAgICA8cGF0aCBmaWxsPVwiPERZTkFNSUNGSUxMPlwiIGZpbGwtcnVsZT1cIm5vbnplcm9cIiBkPVwiTS4wNDUgMS4xNTRoMTMuOTF2Mi4xMzNILjA0NVYxLjE1NHpNLjggNC43NWgxMi4zNjR2OC4xOWMwIC41OTYtLjQ4NyAxLjA4My0xLjA4MiAxLjA4M2gtMTAuMkExLjA4NSAxLjA4NSAwIDAgMSAuOCAxMi45NFY0Ljc1em03Ljk3OCAyLjQ0N1Y1Ljc3Nkg1LjIyMnYxLjQyMWgzLjU1NnpcIi8+XFxuJyArXG4gICc8L3N2Zz5cXG4nO1xuXG5leHBvcnQgY29uc3QgR0VORVJJQ19DQVNFVFlQRV9JQ09OX1NWRyA9ICc8c3ZnIHhtbG5zPVwiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmdcIiB3aWR0aD1cIjE0XCIgaGVpZ2h0PVwiMTRcIiB2aWV3Qm94PVwiMCAwIDQ4IDQ4XCI+XFxuJyArXG4gICcgICAgPHBhdGggZmlsbD1cIjxEWU5BTUlDRklMTD5cIiBmaWxsLXJ1bGU9XCJldmVub2RkXCIgZD1cIk00MiA0Mkg2Yy0xLjEwMyAwLTItLjg5OC0yLTJWMjYuNjFjNC40MyAyLjYyMyAxMC4yMDggMy45NiAxNS43MjkgNC40MjJ2MS41MDRjMCAxLjMyNi45NDggMi40IDIuMTE4IDIuNGg0Ljc2NGMxLjE3IDAgMi4xMTgtMS4wNzQgMi4xMTgtMi40VjMxLjA0YzYuMTYtLjUwMyAxMS41MDUtMi4wMDggMTUuMjcxLTQuMjY0djEzLjIyM2MwIDEuMTAzLS44OTcgMi0yIDJ6TTYgMTUuOTk1aDM2YzEuMTAzIDAgMiAuODk4IDIgMnYzLjU4M2MtMi43OTggMi43MjctOC40NDcgNC42NjQtMTUuMjcxIDUuMjY4di0xLjUxMWMwLTEuMzI2LS45NDgtMi40LTIuMTE3LTIuNGgtNC43NjVjLTEuMTcgMC0yLjExOCAxLjA3NC0yLjExOCAyLjR2MS41MWMtNi42NTEtLjYtMTIuNDEtMi41MTgtMTUuNzI5LTUuMzQ4di0zLjUwMWMwLTEuMTAzLjg5Ny0yIDItMnptMTAuNjU1LTguODljMC0uMDYzLjAyMy0uMDk4LjAxNi0uMTA2bDE0Ljk0NC0uMDExcy4wNC4wMzMuMDQuMTE3djQuODloLTE1di00Ljg5ek00MiAxMS45OTZoLTYuMzQ1di00Ljg5QzM1LjY1NSA0Ljg0MiAzMy44NjEgMyAzMS42NTcgM0gxNi42NTNjLTIuMjA0IDAtMy45OTggMS44NDItMy45OTggNC4xMDZ2NC44OUg2Yy0zLjMwOCAwLTYgMi42OTItNiA2VjQwYzAgMy4zMSAyLjY5MiA2IDYgNmgzNmMzLjMwOSAwIDYtMi42OSA2LTZWMTcuOTk3YzAtMy4zMS0yLjY5MS02LjAwMS02LTYuMDAxelwiLz5cXG4nICtcbiAgJzwvc3ZnPlxcbic7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFRjQ2FzZUNhcmRDb25maWdTZXJ2aWNlIHtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsIHByaXZhdGUgbGl2ZUFwcHNTZXJ2aWNlOiBMaXZlQXBwc1NlcnZpY2UsIHByaXZhdGUgc2hhcmVkU3RhdGVTZXJ2aWNlOiBUY1NoYXJlZFN0YXRlU2VydmljZSwgcHJpdmF0ZSBsb2NhdGlvbjogTG9jYXRpb24pIHtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVDYXJkQ29uZmlnKHNhbmRib3hJZDogbnVtYmVyLCBhcHBJZDogc3RyaW5nLCB1aUFwcElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIGNvbnN0IHNzTmFtZSA9IHVpQXBwSWQgKyAnLicgKyBhcHBJZCArICcuc3RhdGVjb25maWcudGliY29sYWJzLmNsaWVudC5jb250ZXh0LlBVQkxJQyc7XG4gICAgY29uc3QgY29udGVudDogU2hhcmVkU3RhdGVDb250ZW50ID0gbmV3IFNoYXJlZFN0YXRlQ29udGVudCgpO1xuICAgIGNvbnRlbnQuanNvbiA9IFRjQ29yZUNvbW1vbkZ1bmN0aW9ucy5lc2NhcGVTdHJpbmcoSlNPTi5zdHJpbmdpZnkoe30pKTtcbiAgICByZXR1cm4gdGhpcy5zaGFyZWRTdGF0ZVNlcnZpY2UuY3JlYXRlU2hhcmVkU3RhdGUoc3NOYW1lLCAnUFVCTElDJywgJycsIHNhbmRib3hJZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgY29udGVudClcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAodmFsdWUgPT4ge1xuICAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlQ2FyZENvbmZpZyhzYW5kYm94SWQ6IG51bWJlciwgYXBwSWQ6IHN0cmluZywgdWlBcHBJZDogc3RyaW5nLCBjb25maWc6IENhcmRDb25maWcsIGlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPENhcmRDb25maWc+IHtcbiAgICBjb25zdCBzc05hbWUgPSB1aUFwcElkICsgJy4nICsgYXBwSWQgKyAnLnN0YXRlY29uZmlnLnRpYmNvbGFicy5jbGllbnQuY29udGV4dC5QVUJMSUMnO1xuICAgIGNvbnN0IGNvbnRlbnQ6IFNoYXJlZFN0YXRlQ29udGVudCA9IG5ldyBTaGFyZWRTdGF0ZUNvbnRlbnQoKTtcbiAgICBjb250ZW50Lmpzb24gPSBUY0NvcmVDb21tb25GdW5jdGlvbnMuZXNjYXBlU3RyaW5nKEpTT04uc3RyaW5naWZ5KGNvbmZpZykpO1xuICAgIGNvbnN0IGVudHJ5OiBTaGFyZWRTdGF0ZUVudHJ5ID0gbmV3IFNoYXJlZFN0YXRlRW50cnkoKTtcbiAgICBlbnRyeS5jb250ZW50ID0gY29udGVudDtcbiAgICBlbnRyeS5zYW5kYm94SWQgPSBzYW5kYm94SWQ7XG4gICAgZW50cnkubmFtZSA9IHNzTmFtZTtcbiAgICBlbnRyeS50eXBlID0gJ1BVQkxJQyc7XG4gICAgZW50cnkuaWQgPSBpZDtcbiAgICBjb25zdCBzc0xpc3Q6IFNoYXJlZFN0YXRlTGlzdCA9IG5ldyBTaGFyZWRTdGF0ZUxpc3QoKTtcbiAgICBzc0xpc3Quc2hhcmVkU3RhdGVFbnRyaWVzID0gW107XG4gICAgc3NMaXN0LnNoYXJlZFN0YXRlRW50cmllcy5wdXNoKGVudHJ5KTtcbiAgICByZXR1cm4gdGhpcy5zaGFyZWRTdGF0ZVNlcnZpY2UudXBkYXRlU2hhcmVkU3RhdGUoc3NMaXN0LnNoYXJlZFN0YXRlRW50cmllcylcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAodmFsdWUgPT4ge1xuICAgICAgICAgIHJldHVybiBuZXcgQ2FyZENvbmZpZygpLmRlc2VyaWFsaXplKChKU09OLnBhcnNlKHZhbHVlLnNoYXJlZFN0YXRlRW50cmllc1swXS5jb250ZW50Lmpzb24pKSk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZU5ld0NhcmRDb25maWcoc3RhdGVzOiBDYXNlVHlwZVN0YXRlW10sIHNhbmRib3hJZDogbnVtYmVyLCBhcHBJZDogc3RyaW5nLCB1aUFwcElkOiBzdHJpbmcsIGNhc2VUeXBlSWQ6IHN0cmluZywgZGVmYXVsdENhc2VUeXBlQ29sb3I6IHN0cmluZywgZGVmYXVsdENhc2VUeXBlSWNvbjogc3RyaW5nLCBkZWZhdWx0U3RhdGVDb2xvcjogc3RyaW5nLCBkZWZhdWx0U3RhdGVJY29uOiBzdHJpbmcpOiBPYnNlcnZhYmxlPENhc2VDYXJkQ29uZmlnPiB7XG4gICAgLy8gY3JlYXRlIG5ldyBjb25maWcgYW5kIHJldHVybiBpdFxuICAgIGNvbnN0IG5ld0NvbmZpZyQgPSB0aGlzLmNyZWF0ZUNhcmRDb25maWcoc2FuZGJveElkLCBhcHBJZCwgdWlBcHBJZCk7XG4gICAgY29uc3QgdXBkYXRlZENvbmZpZyQgPSBuZXdDb25maWckLnBpcGUoXG4gICAgICBtZXJnZU1hcChpZCA9PiB7XG4gICAgICAgIGNvbnN0IHN0YXRlTWFwOiBJY29uTWFwW10gPSBbXTtcbiAgICAgICAgLy8gb25lIHJlY29yZCBmb3IgdGhlIGNhc2UgdHlwZSBpY29uIGNvbmZpZ1xuICAgICAgICBzdGF0ZU1hcC5wdXNoKG5ldyBJY29uTWFwKHRydWUsIGNhc2VUeXBlSWQsIGRlZmF1bHRDYXNlVHlwZUNvbG9yLCBkZWZhdWx0Q2FzZVR5cGVJY29uKSk7XG4gICAgICAgIHN0YXRlcy5mb3JFYWNoKHN0YXRlID0+IHtcbiAgICAgICAgICBzdGF0ZU1hcC5wdXNoKG5ldyBJY29uTWFwKGZhbHNlLCBzdGF0ZS52YWx1ZSwgZGVmYXVsdFN0YXRlQ29sb3IsIGRlZmF1bHRTdGF0ZUljb24pKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IG5ld0NhcmRDb25maWcgPSBuZXcgQ2FyZENvbmZpZygpLmRlc2VyaWFsaXplKHsgaWQ6IGlkLCB1c2VDYXNlVHlwZUNvbG9yOiB0cnVlLCBzdGF0ZU1hcDogc3RhdGVNYXAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZUNhcmRDb25maWcoc2FuZGJveElkLCBhcHBJZCwgdWlBcHBJZCwgbmV3Q2FyZENvbmZpZywgaWQpLnBpcGUoXG4gICAgICAgICAgdGFwKGNvbmZpZyA9PiB7XG4gICAgICAgICAgICAvLyB0cmlnZ2VyIHVwZGF0ZSBvZiB0aGUgY2FjaGVcbiAgICAgICAgICAgIHRoaXMuZ2V0Q2FyZENvbmZpZyh1aUFwcElkLCBhcHBJZCwgdHJ1ZSwgdHJ1ZSk7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgbWFwKG5ld2NhcmQgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gbmV3IENhc2VDYXJkQ29uZmlnKCkuZGVzZXJpYWxpemUoXG4gICAgICAgICAgICAgICAgeyBzdGF0ZXM6IHN0YXRlcywgY2FyZENvbmZpZzogbmV3Y2FyZCB9XG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgICByZXR1cm4gdXBkYXRlZENvbmZpZyQ7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q2FzZUNhcmRDb25maWcoc2FuZGJveElkOiBudW1iZXIsIGFwcElkOiBzdHJpbmcsIHVpQXBwSWQ6IHN0cmluZywgY2FzZVR5cGVJZDogc3RyaW5nLCBkZWZhdWx0Q2FzZVR5cGVDb2xvcjogc3RyaW5nLCBkZWZhdWx0Q2FzZVR5cGVJY29uOiBzdHJpbmcsIGRlZmF1bHRTdGF0ZUNvbG9yOiBzdHJpbmcsIGRlZmF1bHRTdGF0ZUljb246IHN0cmluZyk6IE9ic2VydmFibGU8Q2FzZUNhcmRDb25maWc+IHtcbiAgICBjb25zdCBzdGF0ZXMkID0gdGhpcy5saXZlQXBwc1NlcnZpY2UuZ2V0Q2FzZVR5cGVTdGF0ZXMoc2FuZGJveElkLCBhcHBJZCwgMTAwKTtcbiAgICBjb25zdCBjYXJkQ29uZmlnJCA9IHRoaXMuZ2V0Q2FyZENvbmZpZyh1aUFwcElkLCBhcHBJZCwgdHJ1ZSwgZmFsc2UpLnBpcGUoXG4gICAgICBtYXAoY29uZmlnID0+IHtcbiAgICAgICAgICByZXR1cm4gY29uZmlnO1xuICAgICAgfSlcbiAgICApO1xuICAgIHJldHVybiBzdGF0ZXMkLnBpcGUoXG4gICAgICBtZXJnZU1hcChzdGF0ZXMgPT4ge1xuICAgICAgICByZXR1cm4gY2FyZENvbmZpZyQucGlwZShcbiAgICAgICAgICBtZXJnZU1hcChjb25maWcgPT4ge1xuICAgICAgICAgICAgaWYgKGNvbmZpZykge1xuICAgICAgICAgICAgICBjb25zdCBjYXJkQ29uZmlnID0gbmV3IENhc2VDYXJkQ29uZmlnKCkuZGVzZXJpYWxpemUoXG4gICAgICAgICAgICAgICAge3N0YXRlczogc3RhdGVzLnN0YXRlcywgY2FyZENvbmZpZzogY29uZmlnfVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICByZXR1cm4gb2YoY2FyZENvbmZpZyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVOZXdDYXJkQ29uZmlnKHN0YXRlcy5zdGF0ZXMsIHNhbmRib3hJZCwgYXBwSWQsIHVpQXBwSWQsIGNhc2VUeXBlSWQsIGRlZmF1bHRDYXNlVHlwZUNvbG9yLCBkZWZhdWx0Q2FzZVR5cGVJY29uLCBkZWZhdWx0U3RhdGVDb2xvciwgZGVmYXVsdFN0YXRlSWNvbikucGlwZShcbiAgICAgICAgICAgICAgICBtYXAobmV3Q2FyZENvbmZpZyA9PiB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gbmV3Q2FyZENvbmZpZztcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlQ2FzZUNhcmRDb25maWcoc2FuZGJveElkOiBudW1iZXIsIGFwcElkOiBzdHJpbmcsIHVpQXBwSWQ6IHN0cmluZywgdXBkYXRlZENvbmZpZzogQ2FzZUNhcmRDb25maWcpOiBPYnNlcnZhYmxlIDwgQ2FzZUNhcmRDb25maWcgPiB7XG4gICAgcmV0dXJuIHRoaXMudXBkYXRlQ2FyZENvbmZpZyhzYW5kYm94SWQsIGFwcElkLCB1aUFwcElkLCB1cGRhdGVkQ29uZmlnLmNhcmRDb25maWcsIHVwZGF0ZWRDb25maWcuY2FyZENvbmZpZy5pZCkucGlwZShcbiAgICAgIG1hcChjYXJkY29uZmlnID0+IHtcbiAgICAgICAgdXBkYXRlZENvbmZpZy5jYXJkQ29uZmlnID0gY2FyZGNvbmZpZztcbiAgICAgICAgLy8gcmVtZW1iZXIgdG8gZmx1c2ggY2FjaGVcbiAgICAgICAgdGhpcy5nZXRDYXJkQ29uZmlnKHVpQXBwSWQsIGFwcElkLCB0cnVlLCB0cnVlKS5zdWJzY3JpYmUoKTtcbiAgICAgICAgcmV0dXJuIHVwZGF0ZWRDb25maWc7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q2FyZENvbmZpZyh1aUFwcElkOiBzdHJpbmcsIGFwcElkOiBzdHJpbmcsIHVzZUNhY2hlOiBib29sZWFuLCBmbHVzaENhY2hlOiBib29sZWFuKTogT2JzZXJ2YWJsZTxDYXJkQ29uZmlnPiB7XG4gICAgY29uc3Qgc3NOYW1lID0gdWlBcHBJZCArICcuJyArIGFwcElkICsgJy5zdGF0ZWNvbmZpZy50aWJjb2xhYnMuY2xpZW50LmNvbnRleHQuUFVCTElDJztcbiAgICByZXR1cm4gdGhpcy5zaGFyZWRTdGF0ZVNlcnZpY2UuZ2V0U2hhcmVkU3RhdGUoc3NOYW1lLCAnUFVCTElDJywgdXNlQ2FjaGUsIGZsdXNoQ2FjaGUpLnBpcGUoXG4gICAgICBtYXAodmFsdWUgPT4ge1xuICAgICAgICAgIGlmICh2YWx1ZS5zaGFyZWRTdGF0ZUVudHJpZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3Qgc3NyZXN1bHQgPSBuZXcgQ2FyZENvbmZpZygpLmRlc2VyaWFsaXplKEpTT04ucGFyc2UodmFsdWUuc2hhcmVkU3RhdGVFbnRyaWVzWzBdLmNvbnRlbnQuanNvbikpO1xuICAgICAgICAgICAgc3NyZXN1bHQuaWQgPSB2YWx1ZS5zaGFyZWRTdGF0ZUVudHJpZXNbMF0uaWQ7XG4gICAgICAgICAgICByZXR1cm4gc3NyZXN1bHQ7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRTdGF0ZUNvbG9ySW5mbyAoYXBwSWQ6IHN0cmluZywgdWlBcHBJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxTdGF0ZUNvbG9yTWFwPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0Q2FyZENvbmZpZyh1aUFwcElkLCBhcHBJZCwgdHJ1ZSwgZmFsc2UpLnBpcGUoXG4gICAgICBtYXAodmFsID0+IHtcbiAgICAgICAgaWYgKHZhbCkge1xuICAgICAgICAgIGNvbnN0IGNvbmZpZzogQ2FyZENvbmZpZyA9IHZhbDtcbiAgICAgICAgICBjb25zdCBzdGF0ZUNvbG9yTWFwID0gbmV3IFN0YXRlQ29sb3JNYXAoKTtcbiAgICAgICAgICBzdGF0ZUNvbG9yTWFwLnN0YXRlQ29sb3JSZWNzID0gW107XG4gICAgICAgICAgY29uZmlnLnN0YXRlTWFwLmZvckVhY2goKHN0YXRlTWFwUmVjKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBzdGF0ZUNvbG9yTWFwUmVjID0gbmV3IFN0YXRlQ29sb3JNYXBSZWMoKS5kZXNlcmlhbGl6ZSggeyBzdGF0ZTogc3RhdGVNYXBSZWMuc3RhdGUsIGNvbG9yOiBzdGF0ZU1hcFJlYy5maWxsfSApO1xuICAgICAgICAgICAgaWYgKHN0YXRlTWFwUmVjLmlzQ2FzZVR5cGUpIHtcbiAgICAgICAgICAgICAgc3RhdGVDb2xvck1hcC5jYXNlVHlwZUNvbG9yID0gc3RhdGVNYXBSZWMuZmlsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlQ29sb3JNYXAuc3RhdGVDb2xvclJlY3MucHVzaChzdGF0ZUNvbG9yTWFwUmVjKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXR1cm4gc3RhdGVDb2xvck1hcDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gbmV3IFN0YXRlQ29sb3JNYXAoKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGdldENvbG9yRm9yU3RhdGUgKGFwcElkOiBzdHJpbmcsIHVpQXBwSWQ6IHN0cmluZywgc3RhdGU6IHN0cmluZyk6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0Q2FyZENvbmZpZyh1aUFwcElkLCBhcHBJZCwgdHJ1ZSwgZmFsc2UpLnBpcGUoXG4gICAgICBtYXAodmFsID0+IHtcbiAgICAgICAgY29uc3Qgc3RhdGVNYXAgPSB2YWwuc3RhdGVNYXAuZmluZCgoc3RhdGVSZWMpID0+IHtcbiAgICAgICAgICByZXR1cm4gc3RhdGVSZWMuc3RhdGUgPT09IHN0YXRlO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIChzdGF0ZU1hcCA/IHN0YXRlTWFwLmZpbGwgOiB1bmRlZmluZWQpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHBhcnNlQ2FzZUluZm8oY2FzZWluZm86IENhc2VJbmZvLCBzYW5kYm94SWQ6IG51bWJlciwgYXBwSWQ6IHN0cmluZywgdHlwZUlkOiBzdHJpbmcsIHVpQXBwSWQpOiBPYnNlcnZhYmxlPENhc2VJbmZvPiB7XG4gICAgLy8gaW4gb3JkZXIgdG8gZ2V0IGFsbCB0aGUgaW5mbyB3ZSBuZWVkIHdlIGFjdHVhbGx5IG5lZWQgdG8gY2FsbCB1cCB0byA0IG9ic2VydmFibGVzIGluIHBhcmFsbGVsXG4gICAgY29uc3QgY2FzZUluZm8kID0gdGhpcy5saXZlQXBwc1NlcnZpY2UuZ2V0Q2FzZVR5cGVCYXNpY0luZm8oc2FuZGJveElkLCBhcHBJZCwgdHlwZUlkLCAxMDApLnBpcGUoXG4gICAgICBtYXAodmFsID0+IGNhc2VpbmZvLm1ldGFkYXRhLmFwcGxpY2F0aW9uTGFiZWwgPSB2YWwubGFiZWwpXG4gICAgKTtcbiAgICBjb25zdCBjYXJkQ29uZmlnJCA9IHRoaXMuZ2V0Q2FyZENvbmZpZyh1aUFwcElkLCBhcHBJZCwgdHJ1ZSwgZmFsc2UpLnBpcGUoXG4gICAgICBtYXAodmFsID0+IHtcbiAgICAgICAgICBjb25zdCBzdGF0ZUlkID0gY2FzZWluZm8uc3VtbWFyeU9iai5zdGF0ZTtcbiAgICAgICAgICBsZXQgc3RhdGVDb25maWc6IEljb25NYXA7XG4gICAgICAgICAgaWYgKHZhbCAhPT0gdW5kZWZpbmVkICYmIHZhbC5zdGF0ZU1hcCkge1xuICAgICAgICAgICAgdmFsLnN0YXRlTWFwLmZvckVhY2goKHN0YXRlKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChzdGF0ZS5zdGF0ZSA9PT0gc3RhdGVJZCkge1xuICAgICAgICAgICAgICAgIHN0YXRlQ29uZmlnID0gc3RhdGU7XG4gICAgICAgICAgICAgICAgY2FzZWluZm8ubWV0YWRhdGEuc3RhdGVDb2xvciA9IHN0YXRlQ29uZmlnLmZpbGw7XG4gICAgICAgICAgICAgICAgY2FzZWluZm8ubWV0YWRhdGEuc3RhdGVJY29uID0gc3RhdGVDb25maWcuaWNvbjtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAoc3RhdGUuaXNDYXNlVHlwZSkge1xuICAgICAgICAgICAgICAgIHN0YXRlQ29uZmlnID0gc3RhdGU7XG4gICAgICAgICAgICAgICAgY2FzZWluZm8ubWV0YWRhdGEuY2FzZVR5cGVDb2xvciA9IHN0YXRlQ29uZmlnLmZpbGw7XG4gICAgICAgICAgICAgICAgY2FzZWluZm8ubWV0YWRhdGEuY2FzZVR5cGVJY29uID0gc3RhdGVDb25maWcuaWNvbjtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjYXNlaW5mby5tZXRhZGF0YS51c2VDYXNlVHlwZUNvbG9yID0gdmFsLnVzZUNhc2VUeXBlQ29sb3IgPyB2YWwudXNlQ2FzZVR5cGVDb2xvciA6IGZhbHNlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIGRlZmF1bHRzXG4gICAgICAgICAgaWYgKCFjYXNlaW5mby5tZXRhZGF0YS5zdGF0ZUNvbG9yKSB7XG4gICAgICAgICAgICBjYXNlaW5mby5tZXRhZGF0YS5zdGF0ZUNvbG9yID0gREVGQVVMVF9TVEFURV9DT0xPUjtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCFjYXNlaW5mby5tZXRhZGF0YS5zdGF0ZUljb24pIHtcbiAgICAgICAgICAgIGNhc2VpbmZvLm1ldGFkYXRhLnN0YXRlSWNvbiA9ICdhc3NldHMvaWNvbnMvaWMtZ2VuZXJpYy1zdGF0ZS5zdmcnO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoIWNhc2VpbmZvLm1ldGFkYXRhLmNhc2VUeXBlQ29sb3IpIHtcbiAgICAgICAgICAgIGNhc2VpbmZvLm1ldGFkYXRhLmNhc2VUeXBlQ29sb3IgPSBERUZBVUxUX1RZUEVfQ09MT1I7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghY2FzZWluZm8ubWV0YWRhdGEuY2FzZVR5cGVJY29uKSB7XG4gICAgICAgICAgICBjYXNlaW5mby5tZXRhZGF0YS5jYXNlVHlwZUljb24gPSAnYXNzZXRzL2ljb25zL2ljLWdlbmVyaWMtY2FzZXR5cGUuc3ZnJztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICkpO1xuICAgIGNvbnN0IGZvcmtKb2luQXJyYXkgPSBbY2FzZUluZm8kLCBjYXJkQ29uZmlnJF07XG4gICAgbGV0IGNyZWF0b3JJbmZvJDtcbiAgICBsZXQgbW9kaWZpZWRJbmZvJDtcbiAgICBpZiAoY2FzZWluZm8ubWV0YWRhdGEuY3JlYXRlZEJ5KSB7XG4gICAgICBjcmVhdG9ySW5mbyQgPSB0aGlzLmxpdmVBcHBzU2VydmljZS5nZXRVc2VySW5mbyhjYXNlaW5mby5tZXRhZGF0YS5jcmVhdGVkQnkpLnBpcGUoXG4gICAgICAgIG1hcCh2YWwgPT4gY2FzZWluZm8ubWV0YWRhdGEuY3JlYXRlZEJ5RGV0YWlscyA9IHZhbCA/IHZhbCA6IG5ldyBVc2VySW5mbygpKVxuICAgICAgKTtcbiAgICAgIGZvcmtKb2luQXJyYXkucHVzaChjcmVhdG9ySW5mbyQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjYXNlaW5mby5tZXRhZGF0YS5jcmVhdGVkQnlEZXRhaWxzID0gbmV3IFVzZXJJbmZvKCk7XG4gICAgfVxuICAgIGlmIChjYXNlaW5mby5tZXRhZGF0YS5tb2RpZmllZEJ5KSB7XG4gICAgICBtb2RpZmllZEluZm8kID0gdGhpcy5saXZlQXBwc1NlcnZpY2UuZ2V0VXNlckluZm8oY2FzZWluZm8ubWV0YWRhdGEubW9kaWZpZWRCeSkucGlwZShcbiAgICAgICAgbWFwKHZhbCA9PiBjYXNlaW5mby5tZXRhZGF0YS5tb2RpZmllZEJ5RGV0YWlscyA9IHZhbCA/IHZhbCA6IG5ldyBVc2VySW5mbygpKVxuICAgICAgKTtcbiAgICAgIGZvcmtKb2luQXJyYXkucHVzaChtb2RpZmllZEluZm8kKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2FzZWluZm8ubWV0YWRhdGEubW9kaWZpZWRCeURldGFpbHMgPSBuZXcgVXNlckluZm8oKTtcbiAgICB9XG5cbiAgICAvLyBjYWxsIGFsbCB0aGUgb2JzZXJ2YWJsZXMgYXQgb25jZSBhbmQgcmV0dXJuIHRoZSBPYnNlcnZhYmxlIHRvIHRoZSBwYXJzZWQgQ2FzZUluZm9cbiAgICByZXR1cm4gZm9ya0pvaW4oZm9ya0pvaW5BcnJheSkucGlwZShcbiAgICAgIG1hcChyZXN1bHRBcnIgPT4ge1xuICAgICAgICByZXR1cm4gY2FzZWluZm87XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q2FzZVdpdGhTdW1tYXJ5KGNhc2VSZWY6IHN0cmluZywgc2FuZGJveElkOiBudW1iZXIsIHVpQXBwSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8Q2FzZUluZm8+IHtcbiAgICAvLyBnZXQgdGhlIGJhc2UgY2FzZWluZm8gZnJvbSB0aGUgQVBJLCB0aGVuIGNhbGwgcGFyc2VDYXNlSW5mbyB0byBjcmVhdGUgYW4gT2JzZXJ2YWJsZSB3aXRoIGFsbCB0aGUgZXh0cmEgZGF0YSB3ZSBuZWVkXG4gICAgY29uc3QgdXJsID0gJy9jYXNlL3YxL2Nhc2VzLycgKyBjYXNlUmVmICsgJy8nICsgJz8kc2FuZGJveD0nICsgc2FuZGJveElkICsgJyYkc2VsZWN0PWNyLCB1YywgbSwgcyc7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsKS5waXBlKFxuICAgICAgbWVyZ2VNYXAoY2FzZWluZm8gPT4ge1xuICAgICAgICAgIGNvbnN0IGNhc2VpbmYgPSBuZXcgQ2FzZUluZm8oKS5kZXNlcmlhbGl6ZShjYXNlaW5mbyk7XG4gICAgICAgICAgaWYgKGNhc2VpbmYuY2FzZVJlZmVyZW5jZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAvLyBjYXNlIGlzIGxpa2VseSBubyBsb25nZXIgdmlzaWJsZSB0byB0aGlzIHVzZXIgc28gaGFuZGxlIGFzIGRlbGV0ZWRcbiAgICAgICAgICAgIHJldHVybiBvZihuZXcgQ2FzZUluZm8oKS5kZXNlcmlhbGl6ZSggeyBkZWxldGVkOiB0cnVlIH0pKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VDYXNlSW5mbyhjYXNlaW5mLCBzYW5kYm94SWQsIGNhc2VpbmYubWV0YWRhdGEuYXBwbGljYXRpb25JZCwgY2FzZWluZi5tZXRhZGF0YS50eXBlSWQsIHVpQXBwSWQpO1xuICAgICAgICB9XG4gICAgICApLFxuICAgICAgY2F0Y2hFcnJvcihlcnIgPT4ge1xuICAgICAgICBpZiAoZXJyLmVycm9yLmVycm9yQ29kZSA9PT0gJ0NNX0NBU0VSRUZfTk9URVhJU1QnKSB7XG4gICAgICAgICAgLy8gY2FzZSBkZWxldGVkXG4gICAgICAgICAgcmV0dXJuIG9mKG5ldyBDYXNlSW5mbygpLmRlc2VyaWFsaXplKHsgZGVsZXRlZDogdHJ1ZSB9ICkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycik7XG4gICAgICB9KVxuICAgICk7XG4gIH1cbn1cbiJdfQ==