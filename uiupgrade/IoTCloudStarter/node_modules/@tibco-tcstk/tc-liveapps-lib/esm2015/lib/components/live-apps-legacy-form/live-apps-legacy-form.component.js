/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ElementRef, EventEmitter, Input, Output } from '@angular/core';
import { LiveAppsComponent } from '../live-apps-component/live-apps-component.component';
import { LegacyIframeService } from '@tibco-tcstk/tc-core-lib';
import { TcVisibilityService } from '@tibco-tcstk/tc-core-lib';
/**
 * Wraps legacy angularjs form renderer
 *
 * \@example <tcla-live-apps-legacy-form></tcla-live-apps-legacy-form>
 */
export class LiveAppsLegacyFormComponent extends LiveAppsComponent {
    /**
     * @param {?} visibilityService
     * @param {?} host
     * @param {?} legacyIframeService
     */
    constructor(visibilityService, host, legacyIframeService) {
        super();
        this.visibilityService = visibilityService;
        this.host = host;
        this.legacyIframeService = legacyIframeService;
        this.legacyIframeId = this.legacyIframeId ? this.legacyIframeId : 'legacyWorkitemFrame';
        this.workitemComplete = new EventEmitter();
        this.wiActive = false;
        this.renderWi = (/**
         * @param {?} wiId
         * @return {?}
         */
        (wiId) => {
            if (this.wiActive && this.openWiId) {
                // opening a new workitem so cancel old one
                this.cancelWi(wiId);
            }
            // send message to external form app
            this.formDiv.contentWindow.postMessage({ 'action': 'openWI', 'wiId': wiId }, window.location.origin);
            // position the form iframe over the workitemDiv placeholder
            this.wiActive = true;
            this.openWiId = wiId;
            this.resizeWi();
        });
        this.receiveMessage = (/**
         * @param {?} event
         * @return {?}
         */
        (event) => {
            if (event.data.action === 'wiCompleted') {
                this.wiActive = false;
                /** @type {?} */
                const wiId = this.openWiId;
                this.openWiId = undefined;
                this.hideWi();
                this.workitemComplete.emit(wiId);
            }
        });
        this.cancelWi = (/**
         * @param {?} wiId
         * @return {?}
         */
        (wiId) => {
            this.formDiv.contentWindow.postMessage({ 'action': 'cancelWI', 'wiId': this.openWiId }, window.location.origin);
            this.wiActive = false;
            this.openWiId = undefined;
            this.hideWi();
        });
        this.hideWi = (/**
         * @return {?}
         */
        () => {
            // hide the iframe!
            this.formDiv.style.top = '-1000px';
            this.formDiv.style.left = '-1000px';
            this.formDiv.style.zIndex = '1';
        });
        this.resizeWi = (/**
         * @return {?}
         */
        () => {
            // position the form iframe over the workitemDiv placeholder
            setTimeout((/**
             * @param {?} handler
             * @return {?}
             */
            handler => {
                /** @type {?} */
                const rect = this.target.getBoundingClientRect();
                this.formDiv.style.top = rect.top.toString() + 'px';
                this.formDiv.style.left = rect.left.toString() + 'px';
                this.formDiv.style.height = rect.height.toString() + 'px';
                this.formDiv.style.width = rect.width.toString() + 'px';
                this.formDiv.style.position = 'absolute';
                this.formDiv.style.zIndex = '1000';
            }), 1000);
        });
        this.initialize = (/**
         * @return {?}
         */
        () => {
            // listen for messages from the iframe
            window.addEventListener('message', this.receiveMessage, false);
            // we only want to render the workitem when the element is visible
            /** @type {?} */
            const inSight$ = this.visibilityService.elementInSight(this.host);
            inSight$.subscribe((/**
             * @param {?} next
             * @return {?}
             */
            next => {
                if (!next) {
                    // element not visible so hide the workitem if it is showing
                    if (this.wiActive && this.target) {
                        this.hideWi();
                    }
                }
                else {
                    // element is visible
                    if (!this.wiActive) {
                        // if workitem not already showing - show it
                        // first get a handle on the target div and the legacy iframe
                        this.target = document.getElementById('workitemDiv');
                        this.formDiv = document.getElementById(this.legacyIframeId);
                        if (this.workitemId) {
                            // trigger display of the workitem
                            this.renderWi(this.workitemId);
                        }
                    }
                    else {
                        this.resizeWi();
                    }
                }
            }));
        });
    }
    /**
     * @return {?}
     */
    isFormActive() {
        return this.wiActive;
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        super.ngAfterViewInit();
        this.containerChanges$.subscribe((/**
         * @param {?} widget
         * @return {?}
         */
        widget => {
            if (this.wiActive && this.target) {
                this.resizeWi();
            }
        }));
        // wait for iframe to load before doing anything else
        // this observable will emit true once the iFrame is loaded
        this.legacyIframeService.workitemStatus.subscribe((/**
         * @param {?} loaded
         * @return {?}
         */
        loaded => {
            if (loaded) {
                // iframe is loaded
                this.initialize();
            }
        }));
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        if (this.openWiId) {
            this.cancelWi(this.workitemId);
        }
    }
}
LiveAppsLegacyFormComponent.decorators = [
    { type: Component, args: [{
                selector: 'tcla-live-apps-legacy-form',
                template: "<div #componentDiv fxFill id=\"workitemDiv\" style=\"border: none;\"></div>\n",
                styles: [""]
            }] }
];
/** @nocollapse */
LiveAppsLegacyFormComponent.ctorParameters = () => [
    { type: TcVisibilityService },
    { type: ElementRef },
    { type: LegacyIframeService }
];
LiveAppsLegacyFormComponent.propDecorators = {
    legacyIframeId: [{ type: Input }],
    workitemId: [{ type: Input }],
    workitemComplete: [{ type: Output }]
};
if (false) {
    /** @type {?} */
    LiveAppsLegacyFormComponent.prototype.legacyIframeId;
    /** @type {?} */
    LiveAppsLegacyFormComponent.prototype.workitemId;
    /** @type {?} */
    LiveAppsLegacyFormComponent.prototype.workitemComplete;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyFormComponent.prototype.target;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyFormComponent.prototype.formDiv;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyFormComponent.prototype.wiActive;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyFormComponent.prototype.openWiId;
    /** @type {?} */
    LiveAppsLegacyFormComponent.prototype.renderWi;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyFormComponent.prototype.receiveMessage;
    /** @type {?} */
    LiveAppsLegacyFormComponent.prototype.cancelWi;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyFormComponent.prototype.hideWi;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyFormComponent.prototype.resizeWi;
    /**
     * @type {?}
     * @private
     */
    LiveAppsLegacyFormComponent.prototype.initialize;
    /**
     * @type {?}
     * @protected
     */
    LiveAppsLegacyFormComponent.prototype.visibilityService;
    /**
     * @type {?}
     * @protected
     */
    LiveAppsLegacyFormComponent.prototype.host;
    /**
     * @type {?}
     * @protected
     */
    LiveAppsLegacyFormComponent.prototype.legacyIframeService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS1hcHBzLWxlZ2FjeS1mb3JtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0aWJjby10Y3N0ay90Yy1saXZlYXBwcy1saWIvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9saXZlLWFwcHMtbGVnYWN5LWZvcm0vbGl2ZS1hcHBzLWxlZ2FjeS1mb3JtLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUVMLFNBQVMsRUFDVCxVQUFVLEVBQ1YsWUFBWSxFQUNaLEtBQUssRUFHTCxNQUFNLEVBQ1AsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFDLGlCQUFpQixFQUFDLE1BQU0sc0RBQXNELENBQUM7QUFDdkYsT0FBTyxFQUFDLG1CQUFtQixFQUFxQyxNQUFNLDBCQUEwQixDQUFDO0FBQ2pHLE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLDBCQUEwQixDQUFDOzs7Ozs7QUFhN0QsTUFBTSxPQUFPLDJCQUE0QixTQUFRLGlCQUFpQjs7Ozs7O0lBV2hFLFlBQXVCLGlCQUFzQyxFQUFZLElBQWdCLEVBQVksbUJBQXdDO1FBQzNJLEtBQUssRUFBRSxDQUFDO1FBRGEsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFxQjtRQUFZLFNBQUksR0FBSixJQUFJLENBQVk7UUFBWSx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBVHBJLG1CQUFjLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMscUJBQXFCLENBQUM7UUFFbkYscUJBQWdCLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUl4QyxhQUFRLEdBQUcsS0FBSyxDQUFDO1FBV2xCLGFBQVE7Ozs7UUFBRyxDQUFDLElBQVksRUFBRSxFQUFFO1lBQ2pDLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUNsQywyQ0FBMkM7Z0JBQzNDLElBQUks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QyxTQUFTOzs7O1FBQUMsTUFBTSxDQUFDLEVBQUU7WUFDeEMsSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ2hDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQzthQUNqQjtRQUNILENBQUMsRUFBQyxDQUFDO1FBRUgscURBQXFEO1FBQ3JELDJEQUEyRDtRQUMzRCxJQUFJLENBQUMsbUJBQW1CLENBQUMsY0FBYyxDQUFDLFNBQVM7Ozs7UUFBQyxNQUFNLENBQUMsRUFBRTtZQUN6RCxJQUFJLE1BQU0sRUFBRTtnQkFDVixtQkFBbUI7Z0JBQ25CLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQzthQUNuQjtRQUNILENBQUMsRUFBQyxDQUFDO0lBQ0wsQ0FBQzs7OztJQUVELFdBQVc7UUFDVCxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDakIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDaEM7SUFDSCxDQUFDOzs7WUEvSEYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSw0QkFBNEI7Z0JBQ3RDLHlGQUFxRDs7YUFFdEQ7Ozs7WUFaTyxtQkFBbUI7WUFUekIsVUFBVTtZQVFKLG1CQUFtQjs7OzZCQWdCeEIsS0FBSzt5QkFDTCxLQUFLOytCQUNMLE1BQU07Ozs7SUFGUCxxREFBNkY7O0lBQzdGLGlEQUE0Qjs7SUFDNUIsdURBQWdEOzs7OztJQUVoRCw2Q0FBZTs7Ozs7SUFDZiw4Q0FBZ0I7Ozs7O0lBQ2hCLCtDQUF5Qjs7Ozs7SUFDekIsK0NBQWlCOztJQVVqQiwrQ0FZQzs7Ozs7SUFFRCxxREFRQzs7SUFFRCwrQ0FLQzs7Ozs7SUFFRCw2Q0FLQzs7Ozs7SUFFRCwrQ0FXQzs7Ozs7SUFFRCxpREE0QkM7Ozs7O0lBdkZZLHdEQUFnRDs7Ozs7SUFBRSwyQ0FBMEI7Ozs7O0lBQUUsMERBQWtEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIElucHV0LFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT3V0cHV0XG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtMaXZlQXBwc0NvbXBvbmVudH0gZnJvbSAnLi4vbGl2ZS1hcHBzLWNvbXBvbmVudC9saXZlLWFwcHMtY29tcG9uZW50LmNvbXBvbmVudCc7XG5pbXBvcnQge0xlZ2FjeUlmcmFtZVNlcnZpY2UsIFRjQ29tcG9uZW50LCBUY0NvcmVDb21tb25GdW5jdGlvbnN9IGZyb20gJ0B0aWJjby10Y3N0ay90Yy1jb3JlLWxpYic7XG5pbXBvcnQge1RjVmlzaWJpbGl0eVNlcnZpY2V9IGZyb20gJ0B0aWJjby10Y3N0ay90Yy1jb3JlLWxpYic7XG5cbi8qKlxuICogV3JhcHMgbGVnYWN5IGFuZ3VsYXJqcyBmb3JtIHJlbmRlcmVyXG4gKlxuICpAZXhhbXBsZSA8dGNsYS1saXZlLWFwcHMtbGVnYWN5LWZvcm0+PC90Y2xhLWxpdmUtYXBwcy1sZWdhY3ktZm9ybT5cbiAqL1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd0Y2xhLWxpdmUtYXBwcy1sZWdhY3ktZm9ybScsXG4gIHRlbXBsYXRlVXJsOiAnLi9saXZlLWFwcHMtbGVnYWN5LWZvcm0uY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9saXZlLWFwcHMtbGVnYWN5LWZvcm0uY29tcG9uZW50LmNzcyddXG59KVxuZXhwb3J0IGNsYXNzIExpdmVBcHBzTGVnYWN5Rm9ybUNvbXBvbmVudCBleHRlbmRzIExpdmVBcHBzQ29tcG9uZW50IGltcGxlbWVudHMgT25EZXN0cm95LCBPbkRlc3Ryb3ksIEFmdGVyVmlld0luaXQge1xuXG4gIEBJbnB1dCgpIGxlZ2FjeUlmcmFtZUlkID0gdGhpcy5sZWdhY3lJZnJhbWVJZCA/ICB0aGlzLmxlZ2FjeUlmcmFtZUlkIDogJ2xlZ2FjeVdvcmtpdGVtRnJhbWUnO1xuICBASW5wdXQoKSB3b3JraXRlbUlkOiBudW1iZXI7XG4gIEBPdXRwdXQoKSB3b3JraXRlbUNvbXBsZXRlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIHByaXZhdGUgdGFyZ2V0O1xuICBwcml2YXRlIGZvcm1EaXY7XG4gIHByaXZhdGUgd2lBY3RpdmUgPSBmYWxzZTtcbiAgcHJpdmF0ZSBvcGVuV2lJZDtcblxuICBjb25zdHJ1Y3RvciAocHJvdGVjdGVkIHZpc2liaWxpdHlTZXJ2aWNlOiBUY1Zpc2liaWxpdHlTZXJ2aWNlLCBwcm90ZWN0ZWQgaG9zdDogRWxlbWVudFJlZiwgcHJvdGVjdGVkIGxlZ2FjeUlmcmFtZVNlcnZpY2U6IExlZ2FjeUlmcmFtZVNlcnZpY2UpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcHVibGljIGlzRm9ybUFjdGl2ZSgpIHtcbiAgICByZXR1cm4gdGhpcy53aUFjdGl2ZTtcbiAgfVxuXG4gIHB1YmxpYyByZW5kZXJXaSA9ICh3aUlkOiBudW1iZXIpID0+IHtcbiAgICBpZiAodGhpcy53aUFjdGl2ZSAmJiB0aGlzLm9wZW5XaUlkKSB7XG4gICAgICAvLyBvcGVuaW5nIGEgbmV3IHdvcmtpdGVtIHNvIGNhbmNlbCBvbGQgb25lXG4gICAgICB0aGlzLmNhbmNlbFdpKHdpSWQpO1xuICAgIH1cblxuICAgIC8vIHNlbmQgbWVzc2FnZSB0byBleHRlcm5hbCBmb3JtIGFwcFxuICAgIHRoaXMuZm9ybURpdi5jb250ZW50V2luZG93LnBvc3RNZXNzYWdlKHsgJ2FjdGlvbic6ICdvcGVuV0knLCAnd2lJZCc6IHdpSWR9LCB3aW5kb3cubG9jYXRpb24ub3JpZ2luKTtcbiAgICAvLyBwb3NpdGlvbiB0aGUgZm9ybSBpZnJhbWUgb3ZlciB0aGUgd29ya2l0ZW1EaXYgcGxhY2Vob2xkZXJcbiAgICB0aGlzLndpQWN0aXZlID0gdHJ1ZTtcbiAgICB0aGlzLm9wZW5XaUlkID0gd2lJZDtcbiAgICB0aGlzLnJlc2l6ZVdpKCk7XG4gIH1cblxuICBwcml2YXRlIHJlY2VpdmVNZXNzYWdlID0gKGV2ZW50KSA9PiB7XG4gICAgaWYgKGV2ZW50LmRhdGEuYWN0aW9uID09PSAnd2lDb21wbGV0ZWQnKSB7XG4gICAgICB0aGlzLndpQWN0aXZlID0gZmFsc2U7XG4gICAgICBjb25zdCB3aUlkID0gdGhpcy5vcGVuV2lJZDtcbiAgICAgIHRoaXMub3BlbldpSWQgPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLmhpZGVXaSgpO1xuICAgICAgdGhpcy53b3JraXRlbUNvbXBsZXRlLmVtaXQod2lJZCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNhbmNlbFdpID0gKHdpSWQpID0+IHtcbiAgICB0aGlzLmZvcm1EaXYuY29udGVudFdpbmRvdy5wb3N0TWVzc2FnZSh7ICdhY3Rpb24nOiAnY2FuY2VsV0knLCAnd2lJZCc6IHRoaXMub3BlbldpSWR9LCB3aW5kb3cubG9jYXRpb24ub3JpZ2luKTtcbiAgICB0aGlzLndpQWN0aXZlID0gZmFsc2U7XG4gICAgdGhpcy5vcGVuV2lJZCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmhpZGVXaSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBoaWRlV2kgPSAoKSA9PiB7XG4gIC8vIGhpZGUgdGhlIGlmcmFtZSFcbiAgICAgIHRoaXMuZm9ybURpdi5zdHlsZS50b3AgPSAnLTEwMDBweCc7XG4gICAgICB0aGlzLmZvcm1EaXYuc3R5bGUubGVmdCA9ICctMTAwMHB4JztcbiAgICAgIHRoaXMuZm9ybURpdi5zdHlsZS56SW5kZXggPSAnMSc7XG4gIH1cblxuICBwcml2YXRlIHJlc2l6ZVdpID0gKCkgPT4ge1xuICAgIC8vIHBvc2l0aW9uIHRoZSBmb3JtIGlmcmFtZSBvdmVyIHRoZSB3b3JraXRlbURpdiBwbGFjZWhvbGRlclxuICAgIHNldFRpbWVvdXQoaGFuZGxlciA9PiB7XG4gICAgICBjb25zdCByZWN0ID0gdGhpcy50YXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICB0aGlzLmZvcm1EaXYuc3R5bGUudG9wID0gcmVjdC50b3AudG9TdHJpbmcoKSArICdweCc7XG4gICAgICB0aGlzLmZvcm1EaXYuc3R5bGUubGVmdCA9IHJlY3QubGVmdC50b1N0cmluZygpICsgJ3B4JztcbiAgICAgIHRoaXMuZm9ybURpdi5zdHlsZS5oZWlnaHQgPSByZWN0LmhlaWdodC50b1N0cmluZygpICsgJ3B4JztcbiAgICAgIHRoaXMuZm9ybURpdi5zdHlsZS53aWR0aCA9IHJlY3Qud2lkdGgudG9TdHJpbmcoKSArICdweCc7XG4gICAgICB0aGlzLmZvcm1EaXYuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnO1xuICAgICAgdGhpcy5mb3JtRGl2LnN0eWxlLnpJbmRleCA9ICcxMDAwJztcbiAgICB9LCAxMDAwKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdGlhbGl6ZSA9ICgpID0+IHtcbiAgICAvLyBsaXN0ZW4gZm9yIG1lc3NhZ2VzIGZyb20gdGhlIGlmcmFtZVxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgdGhpcy5yZWNlaXZlTWVzc2FnZSwgZmFsc2UpO1xuXG4gICAgLy8gd2Ugb25seSB3YW50IHRvIHJlbmRlciB0aGUgd29ya2l0ZW0gd2hlbiB0aGUgZWxlbWVudCBpcyB2aXNpYmxlXG4gICAgY29uc3QgaW5TaWdodCQgPSB0aGlzLnZpc2liaWxpdHlTZXJ2aWNlLmVsZW1lbnRJblNpZ2h0KHRoaXMuaG9zdCk7XG4gICAgaW5TaWdodCQuc3Vic2NyaWJlKG5leHQgPT4ge1xuICAgICAgaWYgKCFuZXh0KSB7XG4gICAgICAgIC8vIGVsZW1lbnQgbm90IHZpc2libGUgc28gaGlkZSB0aGUgd29ya2l0ZW0gaWYgaXQgaXMgc2hvd2luZ1xuICAgICAgICBpZiAodGhpcy53aUFjdGl2ZSAmJiB0aGlzLnRhcmdldCkge1xuICAgICAgICAgIHRoaXMuaGlkZVdpKCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGVsZW1lbnQgaXMgdmlzaWJsZVxuICAgICAgICBpZiAoIXRoaXMud2lBY3RpdmUpIHtcbiAgICAgICAgICAvLyBpZiB3b3JraXRlbSBub3QgYWxyZWFkeSBzaG93aW5nIC0gc2hvdyBpdFxuICAgICAgICAgIC8vIGZpcnN0IGdldCBhIGhhbmRsZSBvbiB0aGUgdGFyZ2V0IGRpdiBhbmQgdGhlIGxlZ2FjeSBpZnJhbWVcbiAgICAgICAgICB0aGlzLnRhcmdldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3b3JraXRlbURpdicpO1xuICAgICAgICAgIHRoaXMuZm9ybURpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMubGVnYWN5SWZyYW1lSWQpO1xuICAgICAgICAgIGlmICh0aGlzLndvcmtpdGVtSWQpIHtcbiAgICAgICAgICAgIC8vIHRyaWdnZXIgZGlzcGxheSBvZiB0aGUgd29ya2l0ZW1cbiAgICAgICAgICAgIHRoaXMucmVuZGVyV2kodGhpcy53b3JraXRlbUlkKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5yZXNpemVXaSgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgc3VwZXIubmdBZnRlclZpZXdJbml0KCk7XG4gICAgdGhpcy5jb250YWluZXJDaGFuZ2VzJC5zdWJzY3JpYmUod2lkZ2V0ID0+IHtcbiAgICAgIGlmICh0aGlzLndpQWN0aXZlICYmIHRoaXMudGFyZ2V0KSB7XG4gICAgICAgIHRoaXMucmVzaXplV2koKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIHdhaXQgZm9yIGlmcmFtZSB0byBsb2FkIGJlZm9yZSBkb2luZyBhbnl0aGluZyBlbHNlXG4gICAgLy8gdGhpcyBvYnNlcnZhYmxlIHdpbGwgZW1pdCB0cnVlIG9uY2UgdGhlIGlGcmFtZSBpcyBsb2FkZWRcbiAgICB0aGlzLmxlZ2FjeUlmcmFtZVNlcnZpY2Uud29ya2l0ZW1TdGF0dXMuc3Vic2NyaWJlKGxvYWRlZCA9PiB7XG4gICAgICBpZiAobG9hZGVkKSB7XG4gICAgICAgIC8vIGlmcmFtZSBpcyBsb2FkZWRcbiAgICAgICAgdGhpcy5pbml0aWFsaXplKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5vcGVuV2lJZCkge1xuICAgICAgdGhpcy5jYW5jZWxXaSh0aGlzLndvcmtpdGVtSWQpO1xuICAgIH1cbiAgfVxufVxuIl19