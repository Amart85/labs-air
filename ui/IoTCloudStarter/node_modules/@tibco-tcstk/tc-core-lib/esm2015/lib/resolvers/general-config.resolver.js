/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/* Used to resolve contents of general config file */
/* This resolver will try and read the config from shared state
 * If a shared state entry does NOT exist it will use the defaults from a config file
 * Then update shared state with those contents
 */
// import {GeneralLandingPageConfigResolver} from '@tibco-tcstk/tc-core-lib';
/** @type {?} */
export const DEFAULT_ADMIN_GROUP = new RoleAttribute().deserialize({
    id: 'Administrator',
    'group': 'System: ADMINISTRATOR',
    'display': 'Administrator',
    'priority': 7
});
import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { of } from 'rxjs';
import { UiAppIdConfig } from '../models/tc-app-config';
import { catchError, flatMap, map, mergeMap, switchMap } from 'rxjs/operators';
import { TcSharedStateService } from '../services/tc-shared-state.service';
import { HttpClient } from '@angular/common/http';
import { TcGeneralConfigService } from '../services/tc-general-config.service';
import { GeneralConfig, RoleAttribute } from '../models/tc-general-config';
import { Location } from '@angular/common';
import { TcCoreCommonFunctions } from '../common/tc-core-common-functions';
export class GeneralConfigResolver {
    // tslint:disable-next-line:max-line-length
    /**
     * @param {?} tcSharedState
     * @param {?} generalConfigService
     * @param {?} http
     * @param {?} location
     * @param {?} router
     */
    constructor(tcSharedState, generalConfigService, http, location, router) {
        this.tcSharedState = tcSharedState;
        this.generalConfigService = generalConfigService;
        this.http = http;
        this.location = location;
        this.router = router;
        this.DEFAULT_CONFIG_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/generalAppConfig.json');
        this.APP_ID_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/uiAppId.json');
        // note appConfigResolver will need sandboxId to create app config state record.
        // So we expect this to have been set by caller (done by tc-liveapps-lib/laConfigResolver).
        this.setSandbox = (/**
         * @param {?} sandboxId
         * @return {?}
         */
        (sandboxId) => {
            this.sandboxId = sandboxId;
        });
        // can be used to load defaultAppConfig from a JSON config
        this.getDefaultAppConfig = (/**
         * @return {?}
         */
        () => {
            return this.http.get(this.DEFAULT_CONFIG_URL);
        });
        // loads uiAppId from json file in assets (appId.json)
        this.getAppId = (/**
         * @return {?}
         */
        () => {
            return this.http.get(this.APP_ID_URL).pipe(map((/**
             * @param {?} uiAppId
             * @return {?}
             */
            uiAppId => {
                /** @type {?} */
                const uiAppIdConfig = new UiAppIdConfig().deserialize(uiAppId);
                this.uiAppId = uiAppIdConfig.uiAppId;
                return uiAppIdConfig;
            })));
        });
    }
    /**
     * @return {?}
     */
    resolve() {
        /** @type {?} */
        const appConfig = this.getAppId().pipe(switchMap((/**
         * @param {?} uiAppId
         * @return {?}
         */
        uiAppId => this.generalConfigService.getGeneralConfig(uiAppId.uiAppId, true, false)
            .pipe(mergeMap((/**
         * @param {?} generalConfig
         * @return {?}
         */
        generalConfig => {
            if (generalConfig === undefined) {
                return this.getDefaultAppConfig().pipe(flatMap((/**
                 * @param {?} config
                 * @return {?}
                 */
                config => {
                    this.defaultAppConfig = new GeneralConfig().deserialize(config);
                    // check to see if we have an admin config
                    /** @type {?} */
                    const adminDef = this.defaultAppConfig.roles.find((/**
                     * @param {?} role
                     * @return {?}
                     */
                    role => role.id === 'Administrator'));
                    // if no admin config then use default
                    if (!adminDef) {
                        this.defaultAppConfig.roles.push(DEFAULT_ADMIN_GROUP);
                    }
                    this.defaultAppConfig.uiAppId = this.uiAppId;
                    return this.generalConfigService.createGeneralConfig(this.sandboxId, this.defaultAppConfig.uiAppId, this.defaultAppConfig)
                        .pipe(flatMap((/**
                     * @param {?} result
                     * @return {?}
                     */
                    result => {
                        /** @type {?} */
                        const newAppConfig = this.defaultAppConfig;
                        newAppConfig.id = result;
                        return this.generalConfigService.updateGeneralConfig(this.sandboxId, newAppConfig.uiAppId, newAppConfig, result).pipe(flatMap((
                        // trigger a read to flush the cache since we changed it
                        /**
                         * @param {?} updatedConf
                         * @return {?}
                         */
                        updatedConf => {
                            return this.generalConfigService.getGeneralConfig(this.uiAppId, true, true).pipe(map((/**
                             * @param {?} cachedConfig
                             * @return {?}
                             */
                            cachedConfig => {
                                return cachedConfig;
                            })));
                        })));
                        // return newAppConfig;
                    })), catchError((/**
                     * @param {?} err
                     * @return {?}
                     */
                    err => {
                        console.error(err);
                        // tslint:disable-next-line:max-line-length
                        /** @type {?} */
                        let errMessage;
                        /** @type {?} */
                        const errCode = 'NOT_ADMIN_INIT';
                        if (err.error && err.error.errorMsg) {
                            errMessage = err.error.errorMsg;
                            // tslint:disable-next-line:max-line-length
                            console.error('NOT_ADMIN_INIT: Unable to create new shared state entry. Login as a user with Admin Group access first to initialize shared state: ');
                        }
                        else {
                            errMessage = 'Unknown Error - check console logs';
                            console.error('Unknown error creating shared state');
                        }
                        this.router.navigate(['/errorHandler/' + errCode + '/' + errMessage]);
                        return of(err);
                    })));
                })));
            }
            else {
                return of(generalConfig);
            }
        }))))));
        return appConfig;
    }
}
GeneralConfigResolver.decorators = [
    { type: Injectable }
];
/** @nocollapse */
GeneralConfigResolver.ctorParameters = () => [
    { type: TcSharedStateService },
    { type: TcGeneralConfigService },
    { type: HttpClient },
    { type: Location },
    { type: Router }
];
if (false) {
    /** @type {?} */
    GeneralConfigResolver.prototype.DEFAULT_CONFIG_URL;
    /** @type {?} */
    GeneralConfigResolver.prototype.APP_ID_URL;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.sandboxId;
    /** @type {?} */
    GeneralConfigResolver.prototype.defaultAppConfig;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.uiAppId;
    /** @type {?} */
    GeneralConfigResolver.prototype.setSandbox;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.getDefaultAppConfig;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.getAppId;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.tcSharedState;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.generalConfigService;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.http;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.location;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.router;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhbC1jb25maWcucmVzb2x2ZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGliY28tdGNzdGsvdGMtY29yZS1saWIvIiwic291cmNlcyI6WyJsaWIvcmVzb2x2ZXJzL2dlbmVyYWwtY29uZmlnLnJlc29sdmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBU0EsTUFBTSxPQUFPLG1CQUFtQixHQUFHLElBQUksYUFBYSxFQUFFLENBQUMsV0FBVyxDQUFDO0lBQ2pFLEVBQUUsRUFBRSxlQUFlO0lBQ25CLE9BQU8sRUFBRSx1QkFBdUI7SUFDaEMsU0FBUyxFQUFFLGVBQWU7SUFDMUIsVUFBVSxFQUFFLENBQUM7Q0FDZCxDQUFDO0FBRUYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQVUsTUFBTSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDaEQsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0QyxPQUFPLEVBQWMsYUFBYSxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDbkUsT0FBTyxFQUFDLFVBQVUsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3RSxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUN6RSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDaEQsT0FBTyxFQUFDLHNCQUFzQixFQUFDLE1BQU0sdUNBQXVDLENBQUM7QUFDN0UsT0FBTyxFQUFDLGFBQWEsRUFBRSxhQUFhLEVBQUMsTUFBTSw2QkFBNkIsQ0FBQztBQUN6RSxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFDLHFCQUFxQixFQUFDLE1BQU0sb0NBQW9DLENBQUM7QUFHekUsTUFBTSxPQUFPLHFCQUFxQjs7Ozs7Ozs7O0lBVWhDLFlB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LENBQUM7Z0JBQ04sQ0FBQyxFQUFDLENBQ0gsQ0FBQzthQUNGO2lCQUFNO2dCQUNOLE9BQU8sRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2FBQzFCO1FBQ0gsQ0FBQyxFQUNGLENBQ0YsRUFDQSxDQUNGO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQzs7O1lBL0dGLFVBQVU7Ozs7WUFQSCxvQkFBb0I7WUFFcEIsc0JBQXNCO1lBRHRCLFVBQVU7WUFHVixRQUFRO1lBUkMsTUFBTTs7OztJQWNyQixtREFBNkg7O0lBQzdILDJDQUE0Rzs7Ozs7SUFFNUcsMENBQTBCOztJQUMxQixpREFBdUM7Ozs7O0lBQ3ZDLHdDQUF3Qjs7SUFPeEIsMkNBRUM7Ozs7O0lBR0Qsb0RBRUM7Ozs7O0lBR0QseUNBU0M7Ozs7O0lBdkJXLDhDQUEyQzs7Ozs7SUFBRSxxREFBb0Q7Ozs7O0lBQUUscUNBQXdCOzs7OztJQUFFLHlDQUEwQjs7Ozs7SUFBRSx1Q0FBc0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBVc2VkIHRvIHJlc29sdmUgY29udGVudHMgb2YgZ2VuZXJhbCBjb25maWcgZmlsZSAqL1xuXG4vKiBUaGlzIHJlc29sdmVyIHdpbGwgdHJ5IGFuZCByZWFkIHRoZSBjb25maWcgZnJvbSBzaGFyZWQgc3RhdGVcbiAqIElmIGEgc2hhcmVkIHN0YXRlIGVudHJ5IGRvZXMgTk9UIGV4aXN0IGl0IHdpbGwgdXNlIHRoZSBkZWZhdWx0cyBmcm9tIGEgY29uZmlnIGZpbGVcbiAqIFRoZW4gdXBkYXRlIHNoYXJlZCBzdGF0ZSB3aXRoIHRob3NlIGNvbnRlbnRzXG4gKi9cblxuLy8gaW1wb3J0IHtHZW5lcmFsTGFuZGluZ1BhZ2VDb25maWdSZXNvbHZlcn0gZnJvbSAnQHRpYmNvLXRjc3RrL3RjLWNvcmUtbGliJztcblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfQURNSU5fR1JPVVAgPSBuZXcgUm9sZUF0dHJpYnV0ZSgpLmRlc2VyaWFsaXplKHtcbiAgaWQ6ICdBZG1pbmlzdHJhdG9yJyxcbiAgJ2dyb3VwJzogJ1N5c3RlbTogQURNSU5JU1RSQVRPUicsXG4gICdkaXNwbGF5JzogJ0FkbWluaXN0cmF0b3InLFxuICAncHJpb3JpdHknOiA3XG59KTtcblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtSZXNvbHZlLCBSb3V0ZXJ9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtVaUFwcENvbmZpZywgVWlBcHBJZENvbmZpZ30gZnJvbSAnLi4vbW9kZWxzL3RjLWFwcC1jb25maWcnO1xuaW1wb3J0IHtjYXRjaEVycm9yLCBmbGF0TWFwLCBtYXAsIG1lcmdlTWFwLCBzd2l0Y2hNYXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7VGNTaGFyZWRTdGF0ZVNlcnZpY2V9IGZyb20gJy4uL3NlcnZpY2VzL3RjLXNoYXJlZC1zdGF0ZS5zZXJ2aWNlJztcbmltcG9ydCB7SHR0cENsaWVudH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtUY0dlbmVyYWxDb25maWdTZXJ2aWNlfSBmcm9tICcuLi9zZXJ2aWNlcy90Yy1nZW5lcmFsLWNvbmZpZy5zZXJ2aWNlJztcbmltcG9ydCB7R2VuZXJhbENvbmZpZywgUm9sZUF0dHJpYnV0ZX0gZnJvbSAnLi4vbW9kZWxzL3RjLWdlbmVyYWwtY29uZmlnJztcbmltcG9ydCB7TG9jYXRpb259IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQge1RjQ29yZUNvbW1vbkZ1bmN0aW9uc30gZnJvbSAnLi4vY29tbW9uL3RjLWNvcmUtY29tbW9uLWZ1bmN0aW9ucyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBHZW5lcmFsQ29uZmlnUmVzb2x2ZXIgaW1wbGVtZW50cyBSZXNvbHZlPE9ic2VydmFibGU8R2VuZXJhbENvbmZpZz4+IHtcblxuICBERUZBVUxUX0NPTkZJR19VUkwgPSBUY0NvcmVDb21tb25GdW5jdGlvbnMucHJlcGFyZVVybEZvclN0YXRpY1Jlc291cmNlKHRoaXMubG9jYXRpb24sICdhc3NldHMvY29uZmlnL2dlbmVyYWxBcHBDb25maWcuanNvbicpO1xuICBBUFBfSURfVVJMID0gVGNDb3JlQ29tbW9uRnVuY3Rpb25zLnByZXBhcmVVcmxGb3JTdGF0aWNSZXNvdXJjZSh0aGlzLmxvY2F0aW9uLCAnYXNzZXRzL2NvbmZpZy91aUFwcElkLmpzb24nKTtcblxuICBwcml2YXRlIHNhbmRib3hJZDogbnVtYmVyO1xuICBwdWJsaWMgZGVmYXVsdEFwcENvbmZpZzogR2VuZXJhbENvbmZpZztcbiAgcHJpdmF0ZSB1aUFwcElkOiBzdHJpbmc7XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRjU2hhcmVkU3RhdGU6IFRjU2hhcmVkU3RhdGVTZXJ2aWNlLCBwcml2YXRlIGdlbmVyYWxDb25maWdTZXJ2aWNlOiBUY0dlbmVyYWxDb25maWdTZXJ2aWNlLCBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsIHByaXZhdGUgbG9jYXRpb246IExvY2F0aW9uLCBwcml2YXRlIHJvdXRlcjogUm91dGVyKSB7fVxuICAvLyBub3RlIGFwcENvbmZpZ1Jlc29sdmVyIHdpbGwgbmVlZCBzYW5kYm94SWQgdG8gY3JlYXRlIGFwcCBjb25maWcgc3RhdGUgcmVjb3JkLlxuICAvLyBTbyB3ZSBleHBlY3QgdGhpcyB0byBoYXZlIGJlZW4gc2V0IGJ5IGNhbGxlciAoZG9uZSBieSB0Yy1saXZlYXBwcy1saWIvbGFDb25maWdSZXNvbHZlcikuXG5cbiAgcHVibGljIHNldFNhbmRib3ggPSAoc2FuZGJveElkOiBudW1iZXIpID0+IHtcbiAgICB0aGlzLnNhbmRib3hJZCA9IHNhbmRib3hJZDtcbiAgfVxuXG4gIC8vIGNhbiBiZSB1c2VkIHRvIGxvYWQgZGVmYXVsdEFwcENvbmZpZyBmcm9tIGEgSlNPTiBjb25maWdcbiAgcHJpdmF0ZSBnZXREZWZhdWx0QXBwQ29uZmlnID0gKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHRoaXMuREVGQVVMVF9DT05GSUdfVVJMKTtcbiAgfVxuXG4gIC8vIGxvYWRzIHVpQXBwSWQgZnJvbSBqc29uIGZpbGUgaW4gYXNzZXRzIChhcHBJZC5qc29uKVxuICBwcml2YXRlIGdldEFwcElkID0gKCk6IE9ic2VydmFibGU8VWlBcHBJZENvbmZpZz4gPT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHRoaXMuQVBQX0lEX1VSTCkucGlwZShcbiAgICAgIG1hcCh1aUFwcElkID0+IHtcbiAgICAgICAgY29uc3QgdWlBcHBJZENvbmZpZyA9IG5ldyBVaUFwcElkQ29uZmlnKCkuZGVzZXJpYWxpemUodWlBcHBJZCk7XG4gICAgICAgIHRoaXMudWlBcHBJZCA9IHVpQXBwSWRDb25maWcudWlBcHBJZDtcbiAgICAgICAgcmV0dXJuIHVpQXBwSWRDb25maWc7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcmVzb2x2ZSgpOiBPYnNlcnZhYmxlPEdlbmVyYWxDb25maWc+IHtcbiAgICBjb25zdCBhcHBDb25maWcgPSB0aGlzLmdldEFwcElkKCkucGlwZShcbiAgICAgIHN3aXRjaE1hcCh1aUFwcElkID0+IHRoaXMuZ2VuZXJhbENvbmZpZ1NlcnZpY2UuZ2V0R2VuZXJhbENvbmZpZyh1aUFwcElkLnVpQXBwSWQsIHRydWUsIGZhbHNlKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1lcmdlTWFwKFxuICAgICAgICAgIGdlbmVyYWxDb25maWcgPT4ge1xuICAgICAgICAgICAgaWYgKGdlbmVyYWxDb25maWcgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREZWZhdWx0QXBwQ29uZmlnKCkucGlwZShcbiAgICAgICAgICAgICAgICBmbGF0TWFwKGNvbmZpZyA9PiB7XG4gICAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRBcHBDb25maWcgPSBuZXcgR2VuZXJhbENvbmZpZygpLmRlc2VyaWFsaXplKGNvbmZpZyk7XG4gICAgICAgICAgICAgICAgICAvLyBjaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhbiBhZG1pbiBjb25maWdcbiAgICAgICAgICAgICAgICAgIGNvbnN0IGFkbWluRGVmID0gdGhpcy5kZWZhdWx0QXBwQ29uZmlnLnJvbGVzLmZpbmQocm9sZSA9PiByb2xlLmlkID09PSAnQWRtaW5pc3RyYXRvcicpO1xuICAgICAgICAgICAgICAgICAgLy8gaWYgbm8gYWRtaW4gY29uZmlnIHRoZW4gdXNlIGRlZmF1bHRcbiAgICAgICAgICAgICAgICAgIGlmICghYWRtaW5EZWYpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0QXBwQ29uZmlnLnJvbGVzLnB1c2goREVGQVVMVF9BRE1JTl9HUk9VUCk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRBcHBDb25maWcudWlBcHBJZCA9IHRoaXMudWlBcHBJZDtcbiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdlbmVyYWxDb25maWdTZXJ2aWNlLmNyZWF0ZUdlbmVyYWxDb25maWcoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2FuZGJveElkLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRBcHBDb25maWcudWlBcHBJZCxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0QXBwQ29uZmlnKVxuICAgICAgICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICBmbGF0TWFwKFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3QXBwQ29uZmlnID0gdGhpcy5kZWZhdWx0QXBwQ29uZmlnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdBcHBDb25maWcuaWQgPSByZXN1bHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdlbmVyYWxDb25maWdTZXJ2aWNlLnVwZGF0ZUdlbmVyYWxDb25maWcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYW5kYm94SWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3QXBwQ29uZmlnLnVpQXBwSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3QXBwQ29uZmlnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYXRNYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRyaWdnZXIgYSByZWFkIHRvIGZsdXNoIHRoZSBjYWNoZSBzaW5jZSB3ZSBjaGFuZ2VkIGl0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkQ29uZiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2VuZXJhbENvbmZpZ1NlcnZpY2UuZ2V0R2VuZXJhbENvbmZpZyh0aGlzLnVpQXBwSWQsIHRydWUsIHRydWUpLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlZENvbmZpZyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZENvbmZpZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm4gbmV3QXBwQ29uZmlnO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZXJyTWVzc2FnZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyQ29kZSA9ICdOT1RfQURNSU5fSU5JVCc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIuZXJyb3IgJiYgZXJyLmVycm9yLmVycm9yTXNnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyTWVzc2FnZSA9IGVyci5lcnJvci5lcnJvck1zZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignTk9UX0FETUlOX0lOSVQ6IFVuYWJsZSB0byBjcmVhdGUgbmV3IHNoYXJlZCBzdGF0ZSBlbnRyeS4gTG9naW4gYXMgYSB1c2VyIHdpdGggQWRtaW4gR3JvdXAgYWNjZXNzIGZpcnN0IHRvIGluaXRpYWxpemUgc2hhcmVkIHN0YXRlOiAnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJNZXNzYWdlID0gJ1Vua25vd24gRXJyb3IgLSBjaGVjayBjb25zb2xlIGxvZ3MnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1Vua25vd24gZXJyb3IgY3JlYXRpbmcgc2hhcmVkIHN0YXRlJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWycvZXJyb3JIYW5kbGVyLycgKyBlcnJDb2RlICsgJy8nICsgZXJyTWVzc2FnZV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gb2YoZ2VuZXJhbENvbmZpZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICApXG4gICAgICApXG4gICAgKVxuICAgIHJldHVybiBhcHBDb25maWc7XG4gIH1cblxufVxuIl19