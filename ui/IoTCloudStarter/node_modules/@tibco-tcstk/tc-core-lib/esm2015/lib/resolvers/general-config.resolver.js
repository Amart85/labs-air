/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/* Used to resolve contents of general config file */
/* This resolver will try and read the config from shared state
 * If a shared state entry does NOT exist it will use the defaults from a config file
 * Then update shared state with those contents
 */
import { Injectable } from '@angular/core';
import { of } from 'rxjs';
import { UiAppIdConfig } from '../models/tc-app-config';
import { flatMap, map, mergeMap, switchMap } from 'rxjs/operators';
import { TcSharedStateService } from '../services/tc-shared-state.service';
import { HttpClient } from '@angular/common/http';
import { TcGeneralConfigService } from '../services/tc-general-config.service';
import { GeneralConfig } from '../models/tc-general-config';
import { Location } from '@angular/common';
import { TcCoreCommonFunctions } from '../common/tc-core-common-functions';
export class GeneralConfigResolver {
    /**
     * @param {?} tcSharedState
     * @param {?} generalConfigService
     * @param {?} http
     * @param {?} location
     */
    constructor(tcSharedState, generalConfigService, http, location) {
        this.tcSharedState = tcSharedState;
        this.generalConfigService = generalConfigService;
        this.http = http;
        this.location = location;
        this.DEFAULT_CONFIG_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/generalAppConfig.json');
        this.APP_ID_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/uiAppId.json');
        // note appConfigResolver will need sandboxId to create app config state record.
        // So we expect this to have been set by caller (done by tc-liveapps-lib/laConfigResolver).
        this.setSandbox = (/**
         * @param {?} sandboxId
         * @return {?}
         */
        (sandboxId) => {
            this.sandboxId = sandboxId;
        });
        // can be used to load defaultAppConfig from a JSON config
        this.getDefaultAppConfig = (/**
         * @return {?}
         */
        () => {
            return this.http.get(this.DEFAULT_CONFIG_URL);
        });
        // loads uiAppId from json file in assets (appId.json)
        this.getAppId = (/**
         * @return {?}
         */
        () => {
            return this.http.get(this.APP_ID_URL).pipe(map((/**
             * @param {?} uiAppId
             * @return {?}
             */
            uiAppId => {
                /** @type {?} */
                const uiAppIdConfig = new UiAppIdConfig().deserialize(uiAppId);
                this.uiAppId = uiAppIdConfig.uiAppId;
                return uiAppIdConfig;
            })));
        });
    }
    /**
     * @return {?}
     */
    resolve() {
        /** @type {?} */
        const appConfig = this.getAppId().pipe(switchMap((/**
         * @param {?} uiAppId
         * @return {?}
         */
        uiAppId => this.generalConfigService.getGeneralConfig(uiAppId.uiAppId, true, false)
            .pipe(mergeMap((/**
         * @param {?} generalConfig
         * @return {?}
         */
        generalConfig => {
            if (generalConfig === undefined) {
                return this.getDefaultAppConfig().pipe(flatMap((/**
                 * @param {?} config
                 * @return {?}
                 */
                config => {
                    this.defaultAppConfig = new GeneralConfig().deserialize(config);
                    this.defaultAppConfig.uiAppId = this.uiAppId;
                    return this.generalConfigService.createGeneralConfig(this.sandboxId, this.defaultAppConfig.uiAppId, this.defaultAppConfig)
                        .pipe(flatMap((/**
                     * @param {?} result
                     * @return {?}
                     */
                    result => {
                        /** @type {?} */
                        const newAppConfig = this.defaultAppConfig;
                        newAppConfig.id = result;
                        return this.generalConfigService.updateGeneralConfig(this.sandboxId, newAppConfig.uiAppId, newAppConfig, result).pipe(flatMap((
                        // trigger a read to flush the cache since we changed it
                        /**
                         * @param {?} updatedConf
                         * @return {?}
                         */
                        updatedConf => {
                            return this.generalConfigService.getGeneralConfig(this.uiAppId, true, true).pipe(map((/**
                             * @param {?} cachedConfig
                             * @return {?}
                             */
                            cachedConfig => {
                                return cachedConfig;
                            })));
                        })));
                        // return newAppConfig;
                    })));
                })));
            }
            else {
                return of(generalConfig);
            }
        }))))));
        return appConfig;
    }
}
GeneralConfigResolver.decorators = [
    { type: Injectable }
];
/** @nocollapse */
GeneralConfigResolver.ctorParameters = () => [
    { type: TcSharedStateService },
    { type: TcGeneralConfigService },
    { type: HttpClient },
    { type: Location }
];
if (false) {
    /** @type {?} */
    GeneralConfigResolver.prototype.DEFAULT_CONFIG_URL;
    /** @type {?} */
    GeneralConfigResolver.prototype.APP_ID_URL;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.sandboxId;
    /** @type {?} */
    GeneralConfigResolver.prototype.defaultAppConfig;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.uiAppId;
    /** @type {?} */
    GeneralConfigResolver.prototype.setSandbox;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.getDefaultAppConfig;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.getAppId;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.tcSharedState;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.generalConfigService;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.http;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.location;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhbC1jb25maWcucmVzb2x2ZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGliY28tdGNzdGsvdGMtY29yZS1saWIvIiwic291cmNlcyI6WyJsaWIvcmVzb2x2ZXJzL2dlbmVyYWwtY29uZmlnLnJlc29sdmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQU9BLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0QyxPQUFPLEVBQWMsYUFBYSxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDbkUsT0FBTyxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ2pFLE9BQU8sRUFBQyxvQkFBb0IsRUFBQyxNQUFNLHFDQUFxQyxDQUFDO0FBQ3pFLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUNoRCxPQUFPLEVBQUMsc0JBQXNCLEVBQUMsTUFBTSx1Q0FBdUMsQ0FBQztBQUM3RSxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sNkJBQTZCLENBQUM7QUFDMUQsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLG9DQUFvQyxDQUFDO0FBR3pFLE1BQU0sT0FBTyxxQkFBcUI7Ozs7Ozs7SUFTaEMsWUFBb0IsYUFBbUMsRUFBVSxvQkFBNEMsRUFBVSxJQUFnQixFQUFVLFFBQWtCO1FBQS9JLGtCQUFhLEdBQWIsYUFBYSxDQUFzQjtRQUFVLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBd0I7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQVBuSyx1QkFBa0IsR0FBRyxxQkFBcUIsQ0FBQywyQkFBMkIsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLHFDQUFx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Q0FDRixFQUNBLENBQ0Y7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDOzs7WUF4RkYsVUFBVTs7OztZQVBILG9CQUFvQjtZQUVwQixzQkFBc0I7WUFEdEIsVUFBVTtZQUdWLFFBQVE7Ozs7SUFNZCxtREFBNkg7O0lBQzdILDJDQUE0Rzs7Ozs7SUFFNUcsMENBQTBCOztJQUMxQixpREFBdUM7Ozs7O0lBQ3ZDLHdDQUF3Qjs7SUFNeEIsMkNBRUM7Ozs7O0lBR0Qsb0RBRUM7Ozs7O0lBR0QseUNBU0M7Ozs7O0lBdkJXLDhDQUEyQzs7Ozs7SUFBRSxxREFBb0Q7Ozs7O0lBQUUscUNBQXdCOzs7OztJQUFFLHlDQUEwQiIsInNvdXJjZXNDb250ZW50IjpbIi8qIFVzZWQgdG8gcmVzb2x2ZSBjb250ZW50cyBvZiBnZW5lcmFsIGNvbmZpZyBmaWxlICovXG5cbi8qIFRoaXMgcmVzb2x2ZXIgd2lsbCB0cnkgYW5kIHJlYWQgdGhlIGNvbmZpZyBmcm9tIHNoYXJlZCBzdGF0ZVxuICogSWYgYSBzaGFyZWQgc3RhdGUgZW50cnkgZG9lcyBOT1QgZXhpc3QgaXQgd2lsbCB1c2UgdGhlIGRlZmF1bHRzIGZyb20gYSBjb25maWcgZmlsZVxuICogVGhlbiB1cGRhdGUgc2hhcmVkIHN0YXRlIHdpdGggdGhvc2UgY29udGVudHNcbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1Jlc29sdmV9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtVaUFwcENvbmZpZywgVWlBcHBJZENvbmZpZ30gZnJvbSAnLi4vbW9kZWxzL3RjLWFwcC1jb25maWcnO1xuaW1wb3J0IHtmbGF0TWFwLCBtYXAsIG1lcmdlTWFwLCBzd2l0Y2hNYXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7VGNTaGFyZWRTdGF0ZVNlcnZpY2V9IGZyb20gJy4uL3NlcnZpY2VzL3RjLXNoYXJlZC1zdGF0ZS5zZXJ2aWNlJztcbmltcG9ydCB7SHR0cENsaWVudH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtUY0dlbmVyYWxDb25maWdTZXJ2aWNlfSBmcm9tICcuLi9zZXJ2aWNlcy90Yy1nZW5lcmFsLWNvbmZpZy5zZXJ2aWNlJztcbmltcG9ydCB7R2VuZXJhbENvbmZpZ30gZnJvbSAnLi4vbW9kZWxzL3RjLWdlbmVyYWwtY29uZmlnJztcbmltcG9ydCB7TG9jYXRpb259IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQge1RjQ29yZUNvbW1vbkZ1bmN0aW9uc30gZnJvbSAnLi4vY29tbW9uL3RjLWNvcmUtY29tbW9uLWZ1bmN0aW9ucyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBHZW5lcmFsQ29uZmlnUmVzb2x2ZXIgaW1wbGVtZW50cyBSZXNvbHZlPE9ic2VydmFibGU8R2VuZXJhbENvbmZpZz4+IHtcblxuICBERUZBVUxUX0NPTkZJR19VUkwgPSBUY0NvcmVDb21tb25GdW5jdGlvbnMucHJlcGFyZVVybEZvclN0YXRpY1Jlc291cmNlKHRoaXMubG9jYXRpb24sICdhc3NldHMvY29uZmlnL2dlbmVyYWxBcHBDb25maWcuanNvbicpO1xuICBBUFBfSURfVVJMID0gVGNDb3JlQ29tbW9uRnVuY3Rpb25zLnByZXBhcmVVcmxGb3JTdGF0aWNSZXNvdXJjZSh0aGlzLmxvY2F0aW9uLCAnYXNzZXRzL2NvbmZpZy91aUFwcElkLmpzb24nKTtcblxuICBwcml2YXRlIHNhbmRib3hJZDogbnVtYmVyO1xuICBwdWJsaWMgZGVmYXVsdEFwcENvbmZpZzogR2VuZXJhbENvbmZpZztcbiAgcHJpdmF0ZSB1aUFwcElkOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSB0Y1NoYXJlZFN0YXRlOiBUY1NoYXJlZFN0YXRlU2VydmljZSwgcHJpdmF0ZSBnZW5lcmFsQ29uZmlnU2VydmljZTogVGNHZW5lcmFsQ29uZmlnU2VydmljZSwgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LCBwcml2YXRlIGxvY2F0aW9uOiBMb2NhdGlvbikge31cbiAgLy8gbm90ZSBhcHBDb25maWdSZXNvbHZlciB3aWxsIG5lZWQgc2FuZGJveElkIHRvIGNyZWF0ZSBhcHAgY29uZmlnIHN0YXRlIHJlY29yZC5cbiAgLy8gU28gd2UgZXhwZWN0IHRoaXMgdG8gaGF2ZSBiZWVuIHNldCBieSBjYWxsZXIgKGRvbmUgYnkgdGMtbGl2ZWFwcHMtbGliL2xhQ29uZmlnUmVzb2x2ZXIpLlxuXG4gIHB1YmxpYyBzZXRTYW5kYm94ID0gKHNhbmRib3hJZDogbnVtYmVyKSA9PiB7XG4gICAgdGhpcy5zYW5kYm94SWQgPSBzYW5kYm94SWQ7XG4gIH1cblxuICAvLyBjYW4gYmUgdXNlZCB0byBsb2FkIGRlZmF1bHRBcHBDb25maWcgZnJvbSBhIEpTT04gY29uZmlnXG4gIHByaXZhdGUgZ2V0RGVmYXVsdEFwcENvbmZpZyA9ICgpID0+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh0aGlzLkRFRkFVTFRfQ09ORklHX1VSTCk7XG4gIH1cblxuICAvLyBsb2FkcyB1aUFwcElkIGZyb20ganNvbiBmaWxlIGluIGFzc2V0cyAoYXBwSWQuanNvbilcbiAgcHJpdmF0ZSBnZXRBcHBJZCA9ICgpOiBPYnNlcnZhYmxlPFVpQXBwSWRDb25maWc+ID0+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh0aGlzLkFQUF9JRF9VUkwpLnBpcGUoXG4gICAgICBtYXAodWlBcHBJZCA9PiB7XG4gICAgICAgIGNvbnN0IHVpQXBwSWRDb25maWcgPSBuZXcgVWlBcHBJZENvbmZpZygpLmRlc2VyaWFsaXplKHVpQXBwSWQpO1xuICAgICAgICB0aGlzLnVpQXBwSWQgPSB1aUFwcElkQ29uZmlnLnVpQXBwSWQ7XG4gICAgICAgIHJldHVybiB1aUFwcElkQ29uZmlnO1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHJlc29sdmUoKTogT2JzZXJ2YWJsZTxHZW5lcmFsQ29uZmlnPiB7XG4gICAgY29uc3QgYXBwQ29uZmlnID0gdGhpcy5nZXRBcHBJZCgpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAodWlBcHBJZCA9PiB0aGlzLmdlbmVyYWxDb25maWdTZXJ2aWNlLmdldEdlbmVyYWxDb25maWcodWlBcHBJZC51aUFwcElkLCB0cnVlLCBmYWxzZSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtZXJnZU1hcChcbiAgICAgICAgICBnZW5lcmFsQ29uZmlnID0+IHtcbiAgICAgICAgICAgIGlmIChnZW5lcmFsQ29uZmlnID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGVmYXVsdEFwcENvbmZpZygpLnBpcGUoXG4gICAgICAgICAgICAgICAgZmxhdE1hcChjb25maWcgPT4ge1xuICAgICAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0QXBwQ29uZmlnID0gbmV3IEdlbmVyYWxDb25maWcoKS5kZXNlcmlhbGl6ZShjb25maWcpO1xuICAgICAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0QXBwQ29uZmlnLnVpQXBwSWQgPSB0aGlzLnVpQXBwSWQ7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZW5lcmFsQ29uZmlnU2VydmljZS5jcmVhdGVHZW5lcmFsQ29uZmlnKFxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNhbmRib3hJZCxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0QXBwQ29uZmlnLnVpQXBwSWQsXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVmYXVsdEFwcENvbmZpZylcbiAgICAgICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgZmxhdE1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0FwcENvbmZpZyA9IHRoaXMuZGVmYXVsdEFwcENvbmZpZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3QXBwQ29uZmlnLmlkID0gcmVzdWx0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZW5lcmFsQ29uZmlnU2VydmljZS51cGRhdGVHZW5lcmFsQ29uZmlnKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2FuZGJveElkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0FwcENvbmZpZy51aUFwcElkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0FwcENvbmZpZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQpLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGF0TWFwKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0cmlnZ2VyIGEgcmVhZCB0byBmbHVzaCB0aGUgY2FjaGUgc2luY2Ugd2UgY2hhbmdlZCBpdFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZENvbmYgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdlbmVyYWxDb25maWdTZXJ2aWNlLmdldEdlbmVyYWxDb25maWcodGhpcy51aUFwcElkLCB0cnVlLCB0cnVlKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZWRDb25maWcgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZWRDb25maWc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIG5ld0FwcENvbmZpZztcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gb2YoZ2VuZXJhbENvbmZpZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICApXG4gICAgICApXG4gICAgKVxuICAgIHJldHVybiBhcHBDb25maWc7XG4gIH1cblxufVxuIl19