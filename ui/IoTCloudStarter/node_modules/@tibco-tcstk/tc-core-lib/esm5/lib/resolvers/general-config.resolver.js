/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/* Used to resolve contents of general config file */
/* This resolver will try and read the config from shared state
 * If a shared state entry does NOT exist it will use the defaults from a config file
 * Then update shared state with those contents
 */
import { Injectable } from '@angular/core';
import { of } from 'rxjs';
import { UiAppIdConfig } from '../models/tc-app-config';
import { flatMap, map, mergeMap, switchMap } from 'rxjs/operators';
import { TcSharedStateService } from '../services/tc-shared-state.service';
import { HttpClient } from '@angular/common/http';
import { TcGeneralConfigService } from '../services/tc-general-config.service';
import { GeneralConfig } from '../models/tc-general-config';
import { Location } from '@angular/common';
import { TcCoreCommonFunctions } from '../common/tc-core-common-functions';
var GeneralConfigResolver = /** @class */ (function () {
    function GeneralConfigResolver(tcSharedState, generalConfigService, http, location) {
        var _this = this;
        this.tcSharedState = tcSharedState;
        this.generalConfigService = generalConfigService;
        this.http = http;
        this.location = location;
        this.DEFAULT_CONFIG_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/generalAppConfig.json');
        this.APP_ID_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/uiAppId.json');
        // note appConfigResolver will need sandboxId to create app config state record.
        // So we expect this to have been set by caller (done by tc-liveapps-lib/laConfigResolver).
        this.setSandbox = (/**
         * @param {?} sandboxId
         * @return {?}
         */
        function (sandboxId) {
            _this.sandboxId = sandboxId;
        });
        // can be used to load defaultAppConfig from a JSON config
        this.getDefaultAppConfig = (/**
         * @return {?}
         */
        function () {
            return _this.http.get(_this.DEFAULT_CONFIG_URL);
        });
        // loads uiAppId from json file in assets (appId.json)
        this.getAppId = (/**
         * @return {?}
         */
        function () {
            return _this.http.get(_this.APP_ID_URL).pipe(map((/**
             * @param {?} uiAppId
             * @return {?}
             */
            function (uiAppId) {
                /** @type {?} */
                var uiAppIdConfig = new UiAppIdConfig().deserialize(uiAppId);
                _this.uiAppId = uiAppIdConfig.uiAppId;
                return uiAppIdConfig;
            })));
        });
    }
    /**
     * @return {?}
     */
    GeneralConfigResolver.prototype.resolve = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var appConfig = this.getAppId().pipe(switchMap((/**
         * @param {?} uiAppId
         * @return {?}
         */
        function (uiAppId) { return _this.generalConfigService.getGeneralConfig(uiAppId.uiAppId, true, false)
            .pipe(mergeMap((/**
         * @param {?} generalConfig
         * @return {?}
         */
        function (generalConfig) {
            if (generalConfig === undefined) {
                return _this.getDefaultAppConfig().pipe(flatMap((/**
                 * @param {?} config
                 * @return {?}
                 */
                function (config) {
                    _this.defaultAppConfig = new GeneralConfig().deserialize(config);
                    _this.defaultAppConfig.uiAppId = _this.uiAppId;
                    return _this.generalConfigService.createGeneralConfig(_this.sandboxId, _this.defaultAppConfig.uiAppId, _this.defaultAppConfig)
                        .pipe(flatMap((/**
                     * @param {?} result
                     * @return {?}
                     */
                    function (result) {
                        /** @type {?} */
                        var newAppConfig = _this.defaultAppConfig;
                        newAppConfig.id = result;
                        return _this.generalConfigService.updateGeneralConfig(_this.sandboxId, newAppConfig.uiAppId, newAppConfig, result).pipe(flatMap((
                        // trigger a read to flush the cache since we changed it
                        // trigger a read to flush the cache since we changed it
                        /**
                         * @param {?} updatedConf
                         * @return {?}
                         */
                        function (updatedConf) {
                            return _this.generalConfigService.getGeneralConfig(_this.uiAppId, true, true).pipe(map((/**
                             * @param {?} cachedConfig
                             * @return {?}
                             */
                            function (cachedConfig) {
                                return cachedConfig;
                            })));
                        })));
                        // return newAppConfig;
                    })));
                })));
            }
            else {
                return of(generalConfig);
            }
        }))); })));
        return appConfig;
    };
    GeneralConfigResolver.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    GeneralConfigResolver.ctorParameters = function () { return [
        { type: TcSharedStateService },
        { type: TcGeneralConfigService },
        { type: HttpClient },
        { type: Location }
    ]; };
    return GeneralConfigResolver;
}());
export { GeneralConfigResolver };
if (false) {
    /** @type {?} */
    GeneralConfigResolver.prototype.DEFAULT_CONFIG_URL;
    /** @type {?} */
    GeneralConfigResolver.prototype.APP_ID_URL;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.sandboxId;
    /** @type {?} */
    GeneralConfigResolver.prototype.defaultAppConfig;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.uiAppId;
    /** @type {?} */
    GeneralConfigResolver.prototype.setSandbox;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.getDefaultAppConfig;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.getAppId;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.tcSharedState;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.generalConfigService;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.http;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.location;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhbC1jb25maWcucmVzb2x2ZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGliY28tdGNzdGsvdGMtY29yZS1saWIvIiwic291cmNlcyI6WyJsaWIvcmVzb2x2ZXJzL2dlbmVyYWwtY29uZmlnLnJlc29sdmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQU9BLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0QyxPQUFPLEVBQWMsYUFBYSxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDbkUsT0FBTyxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ2pFLE9BQU8sRUFBQyxvQkFBb0IsRUFBQyxNQUFNLHFDQUFxQyxDQUFDO0FBQ3pFLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUNoRCxPQUFPLEVBQUMsc0JBQXNCLEVBQUMsTUFBTSx1Q0FBdUMsQ0FBQztBQUM3RSxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sNkJBQTZCLENBQUM7QUFDMUQsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLG9DQUFvQyxDQUFDO0FBRXpFO0lBVUUsK0JBQW9CLGFBQW1DLEVBQVUsb0JBQTRDLEVBQVUsSUFBZ0IsRUFBVSxRQUFrQjtRQUFuSyxpQkFBdUs7UUFBbkosa0JBQWEsR0FBYixhQUFhLENBQXNCO1FBQVUseUJBQW9CLEdBQXBCLG9CQUFvQixDQUF3QjtRQUFVLFNBQUksR0FBSixJQUFJLENBQVk7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBUG5LLHVCQUFrQixHQUFHLHFCQUFxQixDQUFDLDJCQUEyQixDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUscUNBQXFDLENBQUMsQ0FB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QU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7O2dCQXhGRixVQUFVOzs7O2dCQVBILG9CQUFvQjtnQkFFcEIsc0JBQXNCO2dCQUR0QixVQUFVO2dCQUdWLFFBQVE7O0lBNkZoQiw0QkFBQztDQUFBLEFBMUZELElBMEZDO1NBekZZLHFCQUFxQjs7O0lBRWhDLG1EQUE2SDs7SUFDN0gsMkNBQTRHOzs7OztJQUU1RywwQ0FBMEI7O0lBQzFCLGlEQUF1Qzs7Ozs7SUFDdkMsd0NBQXdCOztJQU14QiwyQ0FFQzs7Ozs7SUFHRCxvREFFQzs7Ozs7SUFHRCx5Q0FTQzs7Ozs7SUF2QlcsOENBQTJDOzs7OztJQUFFLHFEQUFvRDs7Ozs7SUFBRSxxQ0FBd0I7Ozs7O0lBQUUseUNBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiLyogVXNlZCB0byByZXNvbHZlIGNvbnRlbnRzIG9mIGdlbmVyYWwgY29uZmlnIGZpbGUgKi9cblxuLyogVGhpcyByZXNvbHZlciB3aWxsIHRyeSBhbmQgcmVhZCB0aGUgY29uZmlnIGZyb20gc2hhcmVkIHN0YXRlXG4gKiBJZiBhIHNoYXJlZCBzdGF0ZSBlbnRyeSBkb2VzIE5PVCBleGlzdCBpdCB3aWxsIHVzZSB0aGUgZGVmYXVsdHMgZnJvbSBhIGNvbmZpZyBmaWxlXG4gKiBUaGVuIHVwZGF0ZSBzaGFyZWQgc3RhdGUgd2l0aCB0aG9zZSBjb250ZW50c1xuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7UmVzb2x2ZX0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1VpQXBwQ29uZmlnLCBVaUFwcElkQ29uZmlnfSBmcm9tICcuLi9tb2RlbHMvdGMtYXBwLWNvbmZpZyc7XG5pbXBvcnQge2ZsYXRNYXAsIG1hcCwgbWVyZ2VNYXAsIHN3aXRjaE1hcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtUY1NoYXJlZFN0YXRlU2VydmljZX0gZnJvbSAnLi4vc2VydmljZXMvdGMtc2hhcmVkLXN0YXRlLnNlcnZpY2UnO1xuaW1wb3J0IHtIdHRwQ2xpZW50fSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge1RjR2VuZXJhbENvbmZpZ1NlcnZpY2V9IGZyb20gJy4uL3NlcnZpY2VzL3RjLWdlbmVyYWwtY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHtHZW5lcmFsQ29uZmlnfSBmcm9tICcuLi9tb2RlbHMvdGMtZ2VuZXJhbC1jb25maWcnO1xuaW1wb3J0IHtMb2NhdGlvbn0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7VGNDb3JlQ29tbW9uRnVuY3Rpb25zfSBmcm9tICcuLi9jb21tb24vdGMtY29yZS1jb21tb24tZnVuY3Rpb25zJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEdlbmVyYWxDb25maWdSZXNvbHZlciBpbXBsZW1lbnRzIFJlc29sdmU8T2JzZXJ2YWJsZTxHZW5lcmFsQ29uZmlnPj4ge1xuXG4gIERFRkFVTFRfQ09ORklHX1VSTCA9IFRjQ29yZUNvbW1vbkZ1bmN0aW9ucy5wcmVwYXJlVXJsRm9yU3RhdGljUmVzb3VyY2UodGhpcy5sb2NhdGlvbiwgJ2Fzc2V0cy9jb25maWcvZ2VuZXJhbEFwcENvbmZpZy5qc29uJyk7XG4gIEFQUF9JRF9VUkwgPSBUY0NvcmVDb21tb25GdW5jdGlvbnMucHJlcGFyZVVybEZvclN0YXRpY1Jlc291cmNlKHRoaXMubG9jYXRpb24sICdhc3NldHMvY29uZmlnL3VpQXBwSWQuanNvbicpO1xuXG4gIHByaXZhdGUgc2FuZGJveElkOiBudW1iZXI7XG4gIHB1YmxpYyBkZWZhdWx0QXBwQ29uZmlnOiBHZW5lcmFsQ29uZmlnO1xuICBwcml2YXRlIHVpQXBwSWQ6IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRjU2hhcmVkU3RhdGU6IFRjU2hhcmVkU3RhdGVTZXJ2aWNlLCBwcml2YXRlIGdlbmVyYWxDb25maWdTZXJ2aWNlOiBUY0dlbmVyYWxDb25maWdTZXJ2aWNlLCBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsIHByaXZhdGUgbG9jYXRpb246IExvY2F0aW9uKSB7fVxuICAvLyBub3RlIGFwcENvbmZpZ1Jlc29sdmVyIHdpbGwgbmVlZCBzYW5kYm94SWQgdG8gY3JlYXRlIGFwcCBjb25maWcgc3RhdGUgcmVjb3JkLlxuICAvLyBTbyB3ZSBleHBlY3QgdGhpcyB0byBoYXZlIGJlZW4gc2V0IGJ5IGNhbGxlciAoZG9uZSBieSB0Yy1saXZlYXBwcy1saWIvbGFDb25maWdSZXNvbHZlcikuXG5cbiAgcHVibGljIHNldFNhbmRib3ggPSAoc2FuZGJveElkOiBudW1iZXIpID0+IHtcbiAgICB0aGlzLnNhbmRib3hJZCA9IHNhbmRib3hJZDtcbiAgfVxuXG4gIC8vIGNhbiBiZSB1c2VkIHRvIGxvYWQgZGVmYXVsdEFwcENvbmZpZyBmcm9tIGEgSlNPTiBjb25maWdcbiAgcHJpdmF0ZSBnZXREZWZhdWx0QXBwQ29uZmlnID0gKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHRoaXMuREVGQVVMVF9DT05GSUdfVVJMKTtcbiAgfVxuXG4gIC8vIGxvYWRzIHVpQXBwSWQgZnJvbSBqc29uIGZpbGUgaW4gYXNzZXRzIChhcHBJZC5qc29uKVxuICBwcml2YXRlIGdldEFwcElkID0gKCk6IE9ic2VydmFibGU8VWlBcHBJZENvbmZpZz4gPT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHRoaXMuQVBQX0lEX1VSTCkucGlwZShcbiAgICAgIG1hcCh1aUFwcElkID0+IHtcbiAgICAgICAgY29uc3QgdWlBcHBJZENvbmZpZyA9IG5ldyBVaUFwcElkQ29uZmlnKCkuZGVzZXJpYWxpemUodWlBcHBJZCk7XG4gICAgICAgIHRoaXMudWlBcHBJZCA9IHVpQXBwSWRDb25maWcudWlBcHBJZDtcbiAgICAgICAgcmV0dXJuIHVpQXBwSWRDb25maWc7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcmVzb2x2ZSgpOiBPYnNlcnZhYmxlPEdlbmVyYWxDb25maWc+IHtcbiAgICBjb25zdCBhcHBDb25maWcgPSB0aGlzLmdldEFwcElkKCkucGlwZShcbiAgICAgIHN3aXRjaE1hcCh1aUFwcElkID0+IHRoaXMuZ2VuZXJhbENvbmZpZ1NlcnZpY2UuZ2V0R2VuZXJhbENvbmZpZyh1aUFwcElkLnVpQXBwSWQsIHRydWUsIGZhbHNlKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1lcmdlTWFwKFxuICAgICAgICAgIGdlbmVyYWxDb25maWcgPT4ge1xuICAgICAgICAgICAgaWYgKGdlbmVyYWxDb25maWcgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREZWZhdWx0QXBwQ29uZmlnKCkucGlwZShcbiAgICAgICAgICAgICAgICBmbGF0TWFwKGNvbmZpZyA9PiB7XG4gICAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRBcHBDb25maWcgPSBuZXcgR2VuZXJhbENvbmZpZygpLmRlc2VyaWFsaXplKGNvbmZpZyk7XG4gICAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRBcHBDb25maWcudWlBcHBJZCA9IHRoaXMudWlBcHBJZDtcbiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdlbmVyYWxDb25maWdTZXJ2aWNlLmNyZWF0ZUdlbmVyYWxDb25maWcoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2FuZGJveElkLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRBcHBDb25maWcudWlBcHBJZCxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0QXBwQ29uZmlnKVxuICAgICAgICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICBmbGF0TWFwKFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3QXBwQ29uZmlnID0gdGhpcy5kZWZhdWx0QXBwQ29uZmlnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdBcHBDb25maWcuaWQgPSByZXN1bHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdlbmVyYWxDb25maWdTZXJ2aWNlLnVwZGF0ZUdlbmVyYWxDb25maWcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYW5kYm94SWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3QXBwQ29uZmlnLnVpQXBwSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3QXBwQ29uZmlnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYXRNYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRyaWdnZXIgYSByZWFkIHRvIGZsdXNoIHRoZSBjYWNoZSBzaW5jZSB3ZSBjaGFuZ2VkIGl0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkQ29uZiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2VuZXJhbENvbmZpZ1NlcnZpY2UuZ2V0R2VuZXJhbENvbmZpZyh0aGlzLnVpQXBwSWQsIHRydWUsIHRydWUpLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlZENvbmZpZyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZENvbmZpZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm4gbmV3QXBwQ29uZmlnO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiBvZihnZW5lcmFsQ29uZmlnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgIClcbiAgICAgIClcbiAgICApXG4gICAgcmV0dXJuIGFwcENvbmZpZztcbiAgfVxuXG59XG4iXX0=