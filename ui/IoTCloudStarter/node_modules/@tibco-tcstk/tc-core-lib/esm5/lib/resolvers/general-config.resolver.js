/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/* Used to resolve contents of general config file */
/* This resolver will try and read the config from shared state
 * If a shared state entry does NOT exist it will use the defaults from a config file
 * Then update shared state with those contents
 */
// import {GeneralLandingPageConfigResolver} from '@tibco-tcstk/tc-core-lib';
/** @type {?} */
export var DEFAULT_ADMIN_GROUP = new RoleAttribute().deserialize({
    id: 'Administrator',
    'group': 'System: ADMINISTRATOR',
    'display': 'Administrator',
    'priority': 7
});
import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { of } from 'rxjs';
import { UiAppIdConfig } from '../models/tc-app-config';
import { catchError, flatMap, map, mergeMap, switchMap } from 'rxjs/operators';
import { TcSharedStateService } from '../services/tc-shared-state.service';
import { HttpClient } from '@angular/common/http';
import { TcGeneralConfigService } from '../services/tc-general-config.service';
import { GeneralConfig, RoleAttribute } from '../models/tc-general-config';
import { Location } from '@angular/common';
import { TcCoreCommonFunctions } from '../common/tc-core-common-functions';
var GeneralConfigResolver = /** @class */ (function () {
    // tslint:disable-next-line:max-line-length
    function GeneralConfigResolver(tcSharedState, generalConfigService, http, location, router) {
        var _this = this;
        this.tcSharedState = tcSharedState;
        this.generalConfigService = generalConfigService;
        this.http = http;
        this.location = location;
        this.router = router;
        this.DEFAULT_CONFIG_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/generalAppConfig.json');
        this.APP_ID_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/uiAppId.json');
        // note appConfigResolver will need sandboxId to create app config state record.
        // So we expect this to have been set by caller (done by tc-liveapps-lib/laConfigResolver).
        this.setSandbox = (/**
         * @param {?} sandboxId
         * @return {?}
         */
        function (sandboxId) {
            _this.sandboxId = sandboxId;
        });
        // can be used to load defaultAppConfig from a JSON config
        this.getDefaultAppConfig = (/**
         * @return {?}
         */
        function () {
            return _this.http.get(_this.DEFAULT_CONFIG_URL);
        });
        // loads uiAppId from json file in assets (appId.json)
        this.getAppId = (/**
         * @return {?}
         */
        function () {
            return _this.http.get(_this.APP_ID_URL).pipe(map((/**
             * @param {?} uiAppId
             * @return {?}
             */
            function (uiAppId) {
                /** @type {?} */
                var uiAppIdConfig = new UiAppIdConfig().deserialize(uiAppId);
                _this.uiAppId = uiAppIdConfig.uiAppId;
                return uiAppIdConfig;
            })));
        });
    }
    /**
     * @return {?}
     */
    GeneralConfigResolver.prototype.resolve = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var appConfig = this.getAppId().pipe(switchMap((/**
         * @param {?} uiAppId
         * @return {?}
         */
        function (uiAppId) { return _this.generalConfigService.getGeneralConfig(uiAppId.uiAppId, true, false)
            .pipe(mergeMap((/**
         * @param {?} generalConfig
         * @return {?}
         */
        function (generalConfig) {
            if (generalConfig === undefined) {
                return _this.getDefaultAppConfig().pipe(flatMap((/**
                 * @param {?} config
                 * @return {?}
                 */
                function (config) {
                    _this.defaultAppConfig = new GeneralConfig().deserialize(config);
                    // check to see if we have an admin config
                    /** @type {?} */
                    var adminDef = _this.defaultAppConfig.roles.find((/**
                     * @param {?} role
                     * @return {?}
                     */
                    function (role) { return role.id === 'Administrator'; }));
                    // if no admin config then use default
                    if (!adminDef) {
                        _this.defaultAppConfig.roles.push(DEFAULT_ADMIN_GROUP);
                    }
                    _this.defaultAppConfig.uiAppId = _this.uiAppId;
                    return _this.generalConfigService.createGeneralConfig(_this.sandboxId, _this.defaultAppConfig.uiAppId, _this.defaultAppConfig)
                        .pipe(flatMap((/**
                     * @param {?} result
                     * @return {?}
                     */
                    function (result) {
                        /** @type {?} */
                        var newAppConfig = _this.defaultAppConfig;
                        newAppConfig.id = result;
                        return _this.generalConfigService.updateGeneralConfig(_this.sandboxId, newAppConfig.uiAppId, newAppConfig, result).pipe(flatMap((
                        // trigger a read to flush the cache since we changed it
                        // trigger a read to flush the cache since we changed it
                        /**
                         * @param {?} updatedConf
                         * @return {?}
                         */
                        function (updatedConf) {
                            return _this.generalConfigService.getGeneralConfig(_this.uiAppId, true, true).pipe(map((/**
                             * @param {?} cachedConfig
                             * @return {?}
                             */
                            function (cachedConfig) {
                                return cachedConfig;
                            })));
                        })));
                        // return newAppConfig;
                    })), catchError((/**
                     * @param {?} err
                     * @return {?}
                     */
                    function (err) {
                        console.error(err);
                        // tslint:disable-next-line:max-line-length
                        /** @type {?} */
                        var errMessage;
                        /** @type {?} */
                        var errCode = 'NOT_ADMIN_INIT';
                        if (err.error && err.error.errorMsg) {
                            errMessage = err.error.errorMsg;
                            // tslint:disable-next-line:max-line-length
                            console.error('NOT_ADMIN_INIT: Unable to create new shared state entry. Login as a user with Admin Group access first to initialize shared state: ');
                        }
                        else {
                            errMessage = 'Unknown Error - check console logs';
                            console.error('Unknown error creating shared state');
                        }
                        _this.router.navigate(['/errorHandler/' + errCode + '/' + errMessage]);
                        return of(err);
                    })));
                })));
            }
            else {
                return of(generalConfig);
            }
        }))); })));
        return appConfig;
    };
    GeneralConfigResolver.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    GeneralConfigResolver.ctorParameters = function () { return [
        { type: TcSharedStateService },
        { type: TcGeneralConfigService },
        { type: HttpClient },
        { type: Location },
        { type: Router }
    ]; };
    return GeneralConfigResolver;
}());
export { GeneralConfigResolver };
if (false) {
    /** @type {?} */
    GeneralConfigResolver.prototype.DEFAULT_CONFIG_URL;
    /** @type {?} */
    GeneralConfigResolver.prototype.APP_ID_URL;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.sandboxId;
    /** @type {?} */
    GeneralConfigResolver.prototype.defaultAppConfig;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.uiAppId;
    /** @type {?} */
    GeneralConfigResolver.prototype.setSandbox;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.getDefaultAppConfig;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.getAppId;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.tcSharedState;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.generalConfigService;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.http;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.location;
    /**
     * @type {?}
     * @private
     */
    GeneralConfigResolver.prototype.router;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhbC1jb25maWcucmVzb2x2ZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGliY28tdGNzdGsvdGMtY29yZS1saWIvIiwic291cmNlcyI6WyJsaWIvcmVzb2x2ZXJzL2dlbmVyYWwtY29uZmlnLnJlc29sdmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBU0EsTUFBTSxLQUFPLG1CQUFtQixHQUFHLElBQUksYUFBYSxFQUFFLENBQUMsV0FBVyxDQUFDO0lBQ2pFLEVBQUUsRUFBRSxlQUFlO0lBQ25CLE9BQU8sRUFBRSx1QkFBdUI7SUFDaEMsU0FBUyxFQUFFLGVBQWU7SUFDMUIsVUFBVSxFQUFFLENBQUM7Q0FDZCxDQUFDO0FBRUYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQVUsTUFBTSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDaEQsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0QyxPQUFPLEVBQWMsYUFBYSxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDbkUsT0FBTyxFQUFDLFVBQVUsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3RSxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUN6RSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDaEQsT0FBTyxFQUFDLHNCQUFzQixFQUFDLE1BQU0sdUNBQXVDLENBQUM7QUFDN0UsT0FBTyxFQUFDLGFBQWEsRUFBRSxhQUFhLEVBQUMsTUFBTSw2QkFBNkIsQ0FBQztBQUN6RSxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFDLHFCQUFxQixFQUFDLE1BQU0sb0NBQW9DLENBQUM7QUFFekU7SUFVRSwyQ0FBMkM7SUFDM0MsK0JBQW9CLGFBQW1DLEVB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QUFDLENBQ0gsQ0FBQzthQUNGO2lCQUFNO2dCQUNOLE9BQU8sRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2FBQzFCO1FBQ0gsQ0FBQyxFQUNGLENBQ0YsRUFyRW9CLENBcUVwQixFQUNBLENBQ0Y7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDOztnQkEvR0YsVUFBVTs7OztnQkFQSCxvQkFBb0I7Z0JBRXBCLHNCQUFzQjtnQkFEdEIsVUFBVTtnQkFHVixRQUFRO2dCQVJDLE1BQU07O0lBNEh2Qiw0QkFBQztDQUFBLEFBakhELElBaUhDO1NBaEhZLHFCQUFxQjs7O0lBRWhDLG1EQUE2SDs7SUFDN0gsMkNBQTRHOzs7OztJQUU1RywwQ0FBMEI7O0lBQzFCLGlEQUF1Qzs7Ozs7SUFDdkMsd0NBQXdCOztJQU94QiwyQ0FFQzs7Ozs7SUFHRCxvREFFQzs7Ozs7SUFHRCx5Q0FTQzs7Ozs7SUF2QlcsOENBQTJDOzs7OztJQUFFLHFEQUFvRDs7Ozs7SUFBRSxxQ0FBd0I7Ozs7O0lBQUUseUNBQTBCOzs7OztJQUFFLHVDQUFzQiIsInNvdXJjZXNDb250ZW50IjpbIi8qIFVzZWQgdG8gcmVzb2x2ZSBjb250ZW50cyBvZiBnZW5lcmFsIGNvbmZpZyBmaWxlICovXG5cbi8qIFRoaXMgcmVzb2x2ZXIgd2lsbCB0cnkgYW5kIHJlYWQgdGhlIGNvbmZpZyBmcm9tIHNoYXJlZCBzdGF0ZVxuICogSWYgYSBzaGFyZWQgc3RhdGUgZW50cnkgZG9lcyBOT1QgZXhpc3QgaXQgd2lsbCB1c2UgdGhlIGRlZmF1bHRzIGZyb20gYSBjb25maWcgZmlsZVxuICogVGhlbiB1cGRhdGUgc2hhcmVkIHN0YXRlIHdpdGggdGhvc2UgY29udGVudHNcbiAqL1xuXG4vLyBpbXBvcnQge0dlbmVyYWxMYW5kaW5nUGFnZUNvbmZpZ1Jlc29sdmVyfSBmcm9tICdAdGliY28tdGNzdGsvdGMtY29yZS1saWInO1xuXG5leHBvcnQgY29uc3QgREVGQVVMVF9BRE1JTl9HUk9VUCA9IG5ldyBSb2xlQXR0cmlidXRlKCkuZGVzZXJpYWxpemUoe1xuICBpZDogJ0FkbWluaXN0cmF0b3InLFxuICAnZ3JvdXAnOiAnU3lzdGVtOiBBRE1JTklTVFJBVE9SJyxcbiAgJ2Rpc3BsYXknOiAnQWRtaW5pc3RyYXRvcicsXG4gICdwcmlvcml0eSc6IDdcbn0pO1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1Jlc29sdmUsIFJvdXRlcn0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1VpQXBwQ29uZmlnLCBVaUFwcElkQ29uZmlnfSBmcm9tICcuLi9tb2RlbHMvdGMtYXBwLWNvbmZpZyc7XG5pbXBvcnQge2NhdGNoRXJyb3IsIGZsYXRNYXAsIG1hcCwgbWVyZ2VNYXAsIHN3aXRjaE1hcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtUY1NoYXJlZFN0YXRlU2VydmljZX0gZnJvbSAnLi4vc2VydmljZXMvdGMtc2hhcmVkLXN0YXRlLnNlcnZpY2UnO1xuaW1wb3J0IHtIdHRwQ2xpZW50fSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge1RjR2VuZXJhbENvbmZpZ1NlcnZpY2V9IGZyb20gJy4uL3NlcnZpY2VzL3RjLWdlbmVyYWwtY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHtHZW5lcmFsQ29uZmlnLCBSb2xlQXR0cmlidXRlfSBmcm9tICcuLi9tb2RlbHMvdGMtZ2VuZXJhbC1jb25maWcnO1xuaW1wb3J0IHtMb2NhdGlvbn0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7VGNDb3JlQ29tbW9uRnVuY3Rpb25zfSBmcm9tICcuLi9jb21tb24vdGMtY29yZS1jb21tb24tZnVuY3Rpb25zJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEdlbmVyYWxDb25maWdSZXNvbHZlciBpbXBsZW1lbnRzIFJlc29sdmU8T2JzZXJ2YWJsZTxHZW5lcmFsQ29uZmlnPj4ge1xuXG4gIERFRkFVTFRfQ09ORklHX1VSTCA9IFRjQ29yZUNvbW1vbkZ1bmN0aW9ucy5wcmVwYXJlVXJsRm9yU3RhdGljUmVzb3VyY2UodGhpcy5sb2NhdGlvbiwgJ2Fzc2V0cy9jb25maWcvZ2VuZXJhbEFwcENvbmZpZy5qc29uJyk7XG4gIEFQUF9JRF9VUkwgPSBUY0NvcmVDb21tb25GdW5jdGlvbnMucHJlcGFyZVVybEZvclN0YXRpY1Jlc291cmNlKHRoaXMubG9jYXRpb24sICdhc3NldHMvY29uZmlnL3VpQXBwSWQuanNvbicpO1xuXG4gIHByaXZhdGUgc2FuZGJveElkOiBudW1iZXI7XG4gIHB1YmxpYyBkZWZhdWx0QXBwQ29uZmlnOiBHZW5lcmFsQ29uZmlnO1xuICBwcml2YXRlIHVpQXBwSWQ6IHN0cmluZztcblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgdGNTaGFyZWRTdGF0ZTogVGNTaGFyZWRTdGF0ZVNlcnZpY2UsIHByaXZhdGUgZ2VuZXJhbENvbmZpZ1NlcnZpY2U6IFRjR2VuZXJhbENvbmZpZ1NlcnZpY2UsIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCwgcHJpdmF0ZSBsb2NhdGlvbjogTG9jYXRpb24sIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIpIHt9XG4gIC8vIG5vdGUgYXBwQ29uZmlnUmVzb2x2ZXIgd2lsbCBuZWVkIHNhbmRib3hJZCB0byBjcmVhdGUgYXBwIGNvbmZpZyBzdGF0ZSByZWNvcmQuXG4gIC8vIFNvIHdlIGV4cGVjdCB0aGlzIHRvIGhhdmUgYmVlbiBzZXQgYnkgY2FsbGVyIChkb25lIGJ5IHRjLWxpdmVhcHBzLWxpYi9sYUNvbmZpZ1Jlc29sdmVyKS5cblxuICBwdWJsaWMgc2V0U2FuZGJveCA9IChzYW5kYm94SWQ6IG51bWJlcikgPT4ge1xuICAgIHRoaXMuc2FuZGJveElkID0gc2FuZGJveElkO1xuICB9XG5cbiAgLy8gY2FuIGJlIHVzZWQgdG8gbG9hZCBkZWZhdWx0QXBwQ29uZmlnIGZyb20gYSBKU09OIGNvbmZpZ1xuICBwcml2YXRlIGdldERlZmF1bHRBcHBDb25maWcgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodGhpcy5ERUZBVUxUX0NPTkZJR19VUkwpO1xuICB9XG5cbiAgLy8gbG9hZHMgdWlBcHBJZCBmcm9tIGpzb24gZmlsZSBpbiBhc3NldHMgKGFwcElkLmpzb24pXG4gIHByaXZhdGUgZ2V0QXBwSWQgPSAoKTogT2JzZXJ2YWJsZTxVaUFwcElkQ29uZmlnPiA9PiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodGhpcy5BUFBfSURfVVJMKS5waXBlKFxuICAgICAgbWFwKHVpQXBwSWQgPT4ge1xuICAgICAgICBjb25zdCB1aUFwcElkQ29uZmlnID0gbmV3IFVpQXBwSWRDb25maWcoKS5kZXNlcmlhbGl6ZSh1aUFwcElkKTtcbiAgICAgICAgdGhpcy51aUFwcElkID0gdWlBcHBJZENvbmZpZy51aUFwcElkO1xuICAgICAgICByZXR1cm4gdWlBcHBJZENvbmZpZztcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICByZXNvbHZlKCk6IE9ic2VydmFibGU8R2VuZXJhbENvbmZpZz4ge1xuICAgIGNvbnN0IGFwcENvbmZpZyA9IHRoaXMuZ2V0QXBwSWQoKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKHVpQXBwSWQgPT4gdGhpcy5nZW5lcmFsQ29uZmlnU2VydmljZS5nZXRHZW5lcmFsQ29uZmlnKHVpQXBwSWQudWlBcHBJZCwgdHJ1ZSwgZmFsc2UpXG4gICAgICAucGlwZShcbiAgICAgICAgbWVyZ2VNYXAoXG4gICAgICAgICAgZ2VuZXJhbENvbmZpZyA9PiB7XG4gICAgICAgICAgICBpZiAoZ2VuZXJhbENvbmZpZyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERlZmF1bHRBcHBDb25maWcoKS5waXBlKFxuICAgICAgICAgICAgICAgIGZsYXRNYXAoY29uZmlnID0+IHtcbiAgICAgICAgICAgICAgICAgIHRoaXMuZGVmYXVsdEFwcENvbmZpZyA9IG5ldyBHZW5lcmFsQ29uZmlnKCkuZGVzZXJpYWxpemUoY29uZmlnKTtcbiAgICAgICAgICAgICAgICAgIC8vIGNoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGFuIGFkbWluIGNvbmZpZ1xuICAgICAgICAgICAgICAgICAgY29uc3QgYWRtaW5EZWYgPSB0aGlzLmRlZmF1bHRBcHBDb25maWcucm9sZXMuZmluZChyb2xlID0+IHJvbGUuaWQgPT09ICdBZG1pbmlzdHJhdG9yJyk7XG4gICAgICAgICAgICAgICAgICAvLyBpZiBubyBhZG1pbiBjb25maWcgdGhlbiB1c2UgZGVmYXVsdFxuICAgICAgICAgICAgICAgICAgaWYgKCFhZG1pbkRlZikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRBcHBDb25maWcucm9sZXMucHVzaChERUZBVUxUX0FETUlOX0dST1VQKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIHRoaXMuZGVmYXVsdEFwcENvbmZpZy51aUFwcElkID0gdGhpcy51aUFwcElkO1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2VuZXJhbENvbmZpZ1NlcnZpY2UuY3JlYXRlR2VuZXJhbENvbmZpZyhcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zYW5kYm94SWQsXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVmYXVsdEFwcENvbmZpZy51aUFwcElkLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRBcHBDb25maWcpXG4gICAgICAgICAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgIGZsYXRNYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdBcHBDb25maWcgPSB0aGlzLmRlZmF1bHRBcHBDb25maWc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0FwcENvbmZpZy5pZCA9IHJlc3VsdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2VuZXJhbENvbmZpZ1NlcnZpY2UudXBkYXRlR2VuZXJhbENvbmZpZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNhbmRib3hJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdBcHBDb25maWcudWlBcHBJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdBcHBDb25maWcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0KS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhdE1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciBhIHJlYWQgdG8gZmx1c2ggdGhlIGNhY2hlIHNpbmNlIHdlIGNoYW5nZWQgaXRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRDb25mID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZW5lcmFsQ29uZmlnU2VydmljZS5nZXRHZW5lcmFsQ29uZmlnKHRoaXMudWlBcHBJZCwgdHJ1ZSwgdHJ1ZSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkQ29uZmlnID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkQ29uZmlnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJldHVybiBuZXdBcHBDb25maWc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBlcnJNZXNzYWdlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJDb2RlID0gJ05PVF9BRE1JTl9JTklUJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVyci5lcnJvciAmJiBlcnIuZXJyb3IuZXJyb3JNc2cpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJNZXNzYWdlID0gZXJyLmVycm9yLmVycm9yTXNnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdOT1RfQURNSU5fSU5JVDogVW5hYmxlIHRvIGNyZWF0ZSBuZXcgc2hhcmVkIHN0YXRlIGVudHJ5LiBMb2dpbiBhcyBhIHVzZXIgd2l0aCBBZG1pbiBHcm91cCBhY2Nlc3MgZmlyc3QgdG8gaW5pdGlhbGl6ZSBzaGFyZWQgc3RhdGU6ICcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVyck1lc3NhZ2UgPSAnVW5rbm93biBFcnJvciAtIGNoZWNrIGNvbnNvbGUgbG9ncyc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignVW5rbm93biBlcnJvciBjcmVhdGluZyBzaGFyZWQgc3RhdGUnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJy9lcnJvckhhbmRsZXIvJyArIGVyckNvZGUgKyAnLycgKyBlcnJNZXNzYWdlXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiBvZihnZW5lcmFsQ29uZmlnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgIClcbiAgICAgIClcbiAgICApXG4gICAgcmV0dXJuIGFwcENvbmZpZztcbiAgfVxuXG59XG4iXX0=