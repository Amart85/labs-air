/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/**
 * @ngdoc component
 * @name tcSharedStateService
 *
 * @description
 *
 * tcSharedStateService provides services for managing stored client config using the Tibco Live Apps shared state service.
 *
 * Although this is a live apps service rather than a Tibco Subscriber Cloud Service it is inside the core project since it will
 * be used for all applications to store configuration information.
 *
 * By hosting this service in the core we can avoid a circular dependency to the live apps library.
 *
 * Note: This service will use the http caching interceptor for 'GET' calls based on passed parameters.
 *
 *
 */
import { Injectable } from '@angular/core';
import { SharedStateContent, SharedStateEntry, SharedStateList } from '../models/tc-shared-state';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { map, tap } from 'rxjs/operators';
import { Location } from '@angular/common';
import { UiAppConfig } from '../models/tc-app-config';
import { TcCoreCommonFunctions } from '../common/tc-core-common-functions';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "@angular/common";
var TcSharedStateService = /** @class */ (function () {
    function TcSharedStateService(http, location) {
        this.http = http;
        this.location = location;
    }
    /**
     * @param {?} name
     * @param {?} type
     * @param {?} description
     * @param {?} sandboxId
     * @param {?} attributes
     * @param {?} roles
     * @param {?} links
     * @param {?} content
     * @return {?}
     */
    TcSharedStateService.prototype.createSharedState = /**
     * @param {?} name
     * @param {?} type
     * @param {?} description
     * @param {?} sandboxId
     * @param {?} attributes
     * @param {?} roles
     * @param {?} links
     * @param {?} content
     * @return {?}
     */
    function (name, type, description, sandboxId, attributes, roles, links, content) {
        /** @type {?} */
        var url = '/clientstate/v1/states';
        /** @type {?} */
        var body = {
            'name': name,
            'type': type,
            'description': description,
            'sandboxId': sandboxId,
            'attributes': attributes,
            'roles': roles,
            'links': links,
            content: content
        };
        /** @type {?} */
        var bodyStr = JSON.stringify(body);
        /** @type {?} */
        var headers = new HttpHeaders()
            .set('Content-Type', 'application/json');
        return this.http.post(url, bodyStr, { headers: headers })
            .pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        function (val) { return sessionStorage.setItem('tcsTimestamp', Date.now().toString()); })), map((/**
         * @param {?} result
         * @return {?}
         */
        function (result) {
            return result.toString();
        })));
    };
    /**
     * @param {?} sharedStateList
     * @return {?}
     */
    TcSharedStateService.prototype.updateSharedState = /**
     * @param {?} sharedStateList
     * @return {?}
     */
    function (sharedStateList) {
        /** @type {?} */
        var url = '/clientstate/v1/states';
        /** @type {?} */
        var body = sharedStateList;
        /** @type {?} */
        var bodyStr = JSON.stringify(body);
        /** @type {?} */
        var headers = new HttpHeaders()
            .set('Content-Type', 'application/json');
        return this.http.put(url, bodyStr, { headers: headers })
            .pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        function (val) { return sessionStorage.setItem('tcsTimestamp', Date.now().toString()); })), map((/**
         * @param {?} updatedSharedStateList
         * @return {?}
         */
        function (updatedSharedStateList) { return new SharedStateList().deserialize(updatedSharedStateList); })));
    };
    /**
     * @param {?} name
     * @param {?} type
     * @param {?} useCache
     * @param {?} flushCache
     * @return {?}
     */
    TcSharedStateService.prototype.getSharedState = /**
     * @param {?} name
     * @param {?} type
     * @param {?} useCache
     * @param {?} flushCache
     * @return {?}
     */
    function (name, type, useCache, flushCache) {
        /** @type {?} */
        var url = '/clientstate/v1/states?$filter=type=' + type
            + ' and name=\'' + name + '\'';
        /** @type {?} */
        var options = {}
        // set headers when caching required
        ;
        // set headers when caching required
        /** @type {?} */
        var headers = new HttpHeaders();
        if (useCache) {
            headers = headers.set('cacheResponse', 'true');
        }
        if (flushCache) {
            headers = headers.set('flushCache', 'true');
        }
        options = { headers: headers };
        return this.http.get(url, options)
            .pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        function (val) { return sessionStorage.setItem('tcsTimestamp', Date.now().toString()); })), map((/**
         * @param {?} sharedStateList
         * @return {?}
         */
        function (sharedStateList) { return new SharedStateList().deserialize(sharedStateList); })));
    };
    /* Ui App Config */
    /* Ui App Config */
    /**
     * @param {?} uiAppId
     * @param {?} useCache
     * @param {?} flushCache
     * @return {?}
     */
    TcSharedStateService.prototype.getUiAppConfig = /* Ui App Config */
    /**
     * @param {?} uiAppId
     * @param {?} useCache
     * @param {?} flushCache
     * @return {?}
     */
    function (uiAppId, useCache, flushCache) {
        // if useCache is false this will trigger the service to update the cached version with latest
        /** @type {?} */
        var ssName = uiAppId + '.config.tibcolabs.client.context.PUBLIC';
        return this.getSharedState(ssName, 'PUBLIC', useCache, flushCache)
            .pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            if (value.sharedStateEntries.length > 0) {
                /** @type {?} */
                var ssresult = new UiAppConfig().deserialize(JSON.parse(value.sharedStateEntries[0].content.json));
                ssresult.id = value.sharedStateEntries[0].id;
                return ssresult;
            }
            else {
                return undefined;
            }
        })));
    };
    /**
     * @param {?} sandboxId
     * @param {?} uiAppConfig
     * @param {?} uiAppId
     * @return {?}
     */
    TcSharedStateService.prototype.createUiAppConfig = /**
     * @param {?} sandboxId
     * @param {?} uiAppConfig
     * @param {?} uiAppId
     * @return {?}
     */
    function (sandboxId, uiAppConfig, uiAppId) {
        /** @type {?} */
        var ssName = uiAppId + '.config.tibcolabs.client.context.PUBLIC';
        /** @type {?} */
        var content = new SharedStateContent();
        content.json = TcCoreCommonFunctions.escapeString(JSON.stringify(uiAppConfig));
        return this.createSharedState(ssName, 'PUBLIC', '', sandboxId, undefined, undefined, undefined, content)
            .pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        function (value) { return value; })));
    };
    /**
     * @param {?} sandboxId
     * @param {?} uiAppConfig
     * @param {?} uiAppId
     * @param {?} id
     * @return {?}
     */
    TcSharedStateService.prototype.updateUiAppConfig = /**
     * @param {?} sandboxId
     * @param {?} uiAppConfig
     * @param {?} uiAppId
     * @param {?} id
     * @return {?}
     */
    function (sandboxId, uiAppConfig, uiAppId, id) {
        /** @type {?} */
        var ssName = uiAppId + '.config.tibcolabs.client.context.PUBLIC';
        /** @type {?} */
        var content = new SharedStateContent();
        content.json = TcCoreCommonFunctions.escapeString(JSON.stringify(uiAppConfig));
        /** @type {?} */
        var entry = new SharedStateEntry();
        entry.content = content;
        entry.sandboxId = sandboxId;
        entry.name = ssName;
        entry.type = 'PUBLIC';
        entry.id = id;
        /** @type {?} */
        var ssList = new SharedStateList();
        ssList.sharedStateEntries = [];
        ssList.sharedStateEntries.push(entry);
        return this.updateSharedState(ssList.sharedStateEntries)
            .pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            return new UiAppConfig().deserialize((JSON.parse(value.sharedStateEntries[0].content.json)));
        })));
    };
    TcSharedStateService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    TcSharedStateService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: Location }
    ]; };
    /** @nocollapse */ TcSharedStateService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function TcSharedStateService_Factory() { return new TcSharedStateService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.Location)); }, token: TcSharedStateService, providedIn: "root" });
    return TcSharedStateService;
}());
export { TcSharedStateService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    TcSharedStateService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    TcSharedStateService.prototype.location;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGMtc2hhcmVkLXN0YXRlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGliY28tdGNzdGsvdGMtY29yZS1saWIvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvdGMtc2hhcmVkLXN0YXRlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBa0JBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFDLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLGVBQWUsRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBRWhHLE9BQU8sRUFBQyxVQUFVLEVBQUUsV0FBVyxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDN0QsT0FBTyxFQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QyxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLHlCQUF5QixDQUFDO0FBQ3BELE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLG9DQUFvQyxDQUFDOzs7O0FBRXpFO0lBS0UsOEJBQW9CLElBQWdCLEVBQVUsUUFBa0I7UUFBNUMsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUFVLGFBQVEsR0FBUixRQUFRLENBQVU7SUFDaEUsQ0FBQzs7Ozs7Ozs7Ozs7O0lBRU0sZ0RBQWlCOzs7Ozs7Ozs7OztJQUF4QixVQUF5QixJQUFZLEVBQ1osSUFBWSxFQUNaLFdBQW1CLEVBQ25CLFNBQWlCLEVBQ2pCLFVBQW9CLEVBQ3BCLEtBQWUsRUFDZixLQUFlLEVBQ2YsT0FBMkI7O1lBQzVDLEdBQUcsR0FBRyx3QkFBd0I7O1lBRTlCLElBQUksR0FBRztZQUNYLE1BQU0sRUFBRSxJQUFJO1lBQ1osTUFBTSxFQUFFLElBQUk7WUFDWixhQUFhLEVBQUUsV0FBVztZQUMxQixXQUFXLEVBQUUsU0FBUztZQUN0QixZQUFZLEVB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RUFBQyxDQUNILENBQUM7SUFDTixDQUFDOztnQkE1SEYsVUFBVSxTQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7OztnQkFSTyxVQUFVO2dCQUVWLFFBQVE7OzsrQkF2QmhCO0NBMEpDLEFBL0hELElBK0hDO1NBNUhZLG9CQUFvQjs7Ozs7O0lBRW5CLG9DQUF3Qjs7Ozs7SUFBRSx3Q0FBMEIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBuZ2RvYyBjb21wb25lbnRcbiAqIEBuYW1lIHRjU2hhcmVkU3RhdGVTZXJ2aWNlXG4gKlxuICogQGRlc2NyaXB0aW9uXG4gKlxuICogdGNTaGFyZWRTdGF0ZVNlcnZpY2UgcHJvdmlkZXMgc2VydmljZXMgZm9yIG1hbmFnaW5nIHN0b3JlZCBjbGllbnQgY29uZmlnIHVzaW5nIHRoZSBUaWJjbyBMaXZlIEFwcHMgc2hhcmVkIHN0YXRlIHNlcnZpY2UuXG4gKlxuICogQWx0aG91Z2ggdGhpcyBpcyBhIGxpdmUgYXBwcyBzZXJ2aWNlIHJhdGhlciB0aGFuIGEgVGliY28gU3Vic2NyaWJlciBDbG91ZCBTZXJ2aWNlIGl0IGlzIGluc2lkZSB0aGUgY29yZSBwcm9qZWN0IHNpbmNlIGl0IHdpbGxcbiAqIGJlIHVzZWQgZm9yIGFsbCBhcHBsaWNhdGlvbnMgdG8gc3RvcmUgY29uZmlndXJhdGlvbiBpbmZvcm1hdGlvbi5cbiAqXG4gKiBCeSBob3N0aW5nIHRoaXMgc2VydmljZSBpbiB0aGUgY29yZSB3ZSBjYW4gYXZvaWQgYSBjaXJjdWxhciBkZXBlbmRlbmN5IHRvIHRoZSBsaXZlIGFwcHMgbGlicmFyeS5cbiAqXG4gKiBOb3RlOiBUaGlzIHNlcnZpY2Ugd2lsbCB1c2UgdGhlIGh0dHAgY2FjaGluZyBpbnRlcmNlcHRvciBmb3IgJ0dFVCcgY2FsbHMgYmFzZWQgb24gcGFzc2VkIHBhcmFtZXRlcnMuXG4gKlxuICpcbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1NoYXJlZFN0YXRlQ29udGVudCwgU2hhcmVkU3RhdGVFbnRyeSwgU2hhcmVkU3RhdGVMaXN0fSBmcm9tICcuLi9tb2RlbHMvdGMtc2hhcmVkLXN0YXRlJztcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XG5pbXBvcnQge0h0dHBDbGllbnQsIEh0dHBIZWFkZXJzfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge21hcCwgdGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge0xvY2F0aW9ufSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtVaUFwcENvbmZpZ30gZnJvbSAnLi4vbW9kZWxzL3RjLWFwcC1jb25maWcnO1xuaW1wb3J0IHtUY0NvcmVDb21tb25GdW5jdGlvbnN9IGZyb20gJy4uL2NvbW1vbi90Yy1jb3JlLWNvbW1vbi1mdW5jdGlvbnMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBUY1NoYXJlZFN0YXRlU2VydmljZSB7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LCBwcml2YXRlIGxvY2F0aW9uOiBMb2NhdGlvbikge1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVNoYXJlZFN0YXRlKG5hbWU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBzYW5kYm94SWQ6IG51bWJlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXM6IHN0cmluZ1tdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgcm9sZXM6IHN0cmluZ1tdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua3M6IHN0cmluZ1tdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudDogU2hhcmVkU3RhdGVDb250ZW50KTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICBjb25zdCB1cmwgPSAnL2NsaWVudHN0YXRlL3YxL3N0YXRlcyc7XG5cbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgJ25hbWUnOiBuYW1lLFxuICAgICAgJ3R5cGUnOiB0eXBlLFxuICAgICAgJ2Rlc2NyaXB0aW9uJzogZGVzY3JpcHRpb24sXG4gICAgICAnc2FuZGJveElkJzogc2FuZGJveElkLFxuICAgICAgJ2F0dHJpYnV0ZXMnOiBhdHRyaWJ1dGVzLFxuICAgICAgJ3JvbGVzJzogcm9sZXMsXG4gICAgICAnbGlua3MnOiBsaW5rcyxcbiAgICAgIGNvbnRlbnQ6IGNvbnRlbnRcbiAgICB9O1xuICAgIGNvbnN0IGJvZHlTdHIgPSBKU09OLnN0cmluZ2lmeShib2R5KTtcbiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKClcbiAgICAgIC5zZXQoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KHVybCwgYm9keVN0ciwge2hlYWRlcnN9KVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcCh2YWwgPT4gc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgndGNzVGltZXN0YW1wJywgRGF0ZS5ub3coKS50b1N0cmluZygpKSksXG4gICAgICAgIG1hcChyZXN1bHQgPT4ge1xuICAgICAgICAgIHJldHVybiByZXN1bHQudG9TdHJpbmcoKTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlU2hhcmVkU3RhdGUoc2hhcmVkU3RhdGVMaXN0KTogT2JzZXJ2YWJsZTxTaGFyZWRTdGF0ZUxpc3Q+IHtcbiAgICBjb25zdCB1cmwgPSAnL2NsaWVudHN0YXRlL3YxL3N0YXRlcyc7XG5cbiAgICBjb25zdCBib2R5ID0gc2hhcmVkU3RhdGVMaXN0O1xuICAgIGNvbnN0IGJvZHlTdHIgPSBKU09OLnN0cmluZ2lmeShib2R5KTtcbiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKClcbiAgICAgIC5zZXQoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wdXQodXJsLCBib2R5U3RyLCB7aGVhZGVyc30pXG4gICAgICAucGlwZShcbiAgICAgICAgdGFwKHZhbCA9PiBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCd0Y3NUaW1lc3RhbXAnLCBEYXRlLm5vdygpLnRvU3RyaW5nKCkpKSxcbiAgICAgICAgbWFwKHVwZGF0ZWRTaGFyZWRTdGF0ZUxpc3QgPT4gbmV3IFNoYXJlZFN0YXRlTGlzdCgpLmRlc2VyaWFsaXplKHVwZGF0ZWRTaGFyZWRTdGF0ZUxpc3QpKVxuICAgICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRTaGFyZWRTdGF0ZShuYW1lOiBzdHJpbmcsIHR5cGU6IHN0cmluZywgdXNlQ2FjaGU6IGJvb2xlYW4sIGZsdXNoQ2FjaGU6IGJvb2xlYW4pOiBPYnNlcnZhYmxlPFNoYXJlZFN0YXRlTGlzdD4ge1xuICAgIGNvbnN0IHVybCA9ICcvY2xpZW50c3RhdGUvdjEvc3RhdGVzPyRmaWx0ZXI9dHlwZT0nICsgdHlwZVxuICAgICAgKyAnIGFuZCBuYW1lPVxcJycgKyBuYW1lICsgJ1xcJyc7XG4gICAgbGV0IG9wdGlvbnMgPSB7fVxuICAgIC8vIHNldCBoZWFkZXJzIHdoZW4gY2FjaGluZyByZXF1aXJlZFxuICAgIGxldCBoZWFkZXJzOiBIdHRwSGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpO1xuICAgIGlmICh1c2VDYWNoZSkge1xuICAgICAgaGVhZGVycyA9IGhlYWRlcnMuc2V0KCdjYWNoZVJlc3BvbnNlJywgJ3RydWUnKTtcbiAgICB9XG4gICAgaWYgKGZsdXNoQ2FjaGUpIHtcbiAgICAgIGhlYWRlcnMgPSBoZWFkZXJzLnNldCgnZmx1c2hDYWNoZScsICd0cnVlJyk7XG4gICAgfVxuICAgIG9wdGlvbnMgPSB7aGVhZGVyczogaGVhZGVyc307XG5cbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh1cmwsIG9wdGlvbnMpXG4gICAgICAucGlwZShcbiAgICAgICAgdGFwKHZhbCA9PiBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCd0Y3NUaW1lc3RhbXAnLCBEYXRlLm5vdygpLnRvU3RyaW5nKCkpKSxcbiAgICAgICAgbWFwKHNoYXJlZFN0YXRlTGlzdCA9PiBuZXcgU2hhcmVkU3RhdGVMaXN0KCkuZGVzZXJpYWxpemUoc2hhcmVkU3RhdGVMaXN0KSkpO1xuICB9XG5cbiAgLyogVWkgQXBwIENvbmZpZyAqL1xuXG4gIHB1YmxpYyBnZXRVaUFwcENvbmZpZyh1aUFwcElkOiBzdHJpbmcsIHVzZUNhY2hlOiBib29sZWFuLCBmbHVzaENhY2hlOiBib29sZWFuKTogT2JzZXJ2YWJsZTxVaUFwcENvbmZpZz4ge1xuICAgIC8vIGlmIHVzZUNhY2hlIGlzIGZhbHNlIHRoaXMgd2lsbCB0cmlnZ2VyIHRoZSBzZXJ2aWNlIHRvIHVwZGF0ZSB0aGUgY2FjaGVkIHZlcnNpb24gd2l0aCBsYXRlc3RcbiAgICBjb25zdCBzc05hbWUgPSB1aUFwcElkICsgJy5jb25maWcudGliY29sYWJzLmNsaWVudC5jb250ZXh0LlBVQkxJQyc7XG5cbiAgICByZXR1cm4gdGhpcy5nZXRTaGFyZWRTdGF0ZShzc05hbWUsICdQVUJMSUMnLCB1c2VDYWNoZSwgZmx1c2hDYWNoZSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAodmFsdWUgPT4ge1xuICAgICAgICAgICAgaWYgKHZhbHVlLnNoYXJlZFN0YXRlRW50cmllcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHNzcmVzdWx0ID0gbmV3IFVpQXBwQ29uZmlnKCkuZGVzZXJpYWxpemUoSlNPTi5wYXJzZSh2YWx1ZS5zaGFyZWRTdGF0ZUVudHJpZXNbMF0uY29udGVudC5qc29uKSk7XG4gICAgICAgICAgICAgIHNzcmVzdWx0LmlkID0gdmFsdWUuc2hhcmVkU3RhdGVFbnRyaWVzWzBdLmlkO1xuICAgICAgICAgICAgICByZXR1cm4gc3NyZXN1bHQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgKVxuICAgICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVVaUFwcENvbmZpZyhzYW5kYm94SWQ6IG51bWJlciwgdWlBcHBDb25maWc6IFVpQXBwQ29uZmlnLCB1aUFwcElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIGNvbnN0IHNzTmFtZSA9IHVpQXBwSWQgKyAnLmNvbmZpZy50aWJjb2xhYnMuY2xpZW50LmNvbnRleHQuUFVCTElDJztcbiAgICBjb25zdCBjb250ZW50OiBTaGFyZWRTdGF0ZUNvbnRlbnQgPSBuZXcgU2hhcmVkU3RhdGVDb250ZW50KCk7XG4gICAgY29udGVudC5qc29uID0gVGNDb3JlQ29tbW9uRnVuY3Rpb25zLmVzY2FwZVN0cmluZyhKU09OLnN0cmluZ2lmeSh1aUFwcENvbmZpZykpO1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVNoYXJlZFN0YXRlKHNzTmFtZSwgJ1BVQkxJQycsICcnLCBzYW5kYm94SWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNvbnRlbnQpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKHZhbHVlID0+IHZhbHVlKVxuICAgICAgKTtcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVVaUFwcENvbmZpZyhzYW5kYm94SWQ6IG51bWJlciwgdWlBcHBDb25maWc6IFVpQXBwQ29uZmlnLCB1aUFwcElkOiBzdHJpbmcsIGlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFVpQXBwQ29uZmlnPiB7XG4gICAgY29uc3Qgc3NOYW1lID0gdWlBcHBJZCArICcuY29uZmlnLnRpYmNvbGFicy5jbGllbnQuY29udGV4dC5QVUJMSUMnO1xuICAgIGNvbnN0IGNvbnRlbnQ6IFNoYXJlZFN0YXRlQ29udGVudCA9IG5ldyBTaGFyZWRTdGF0ZUNvbnRlbnQoKTtcbiAgICBjb250ZW50Lmpzb24gPSBUY0NvcmVDb21tb25GdW5jdGlvbnMuZXNjYXBlU3RyaW5nKEpTT04uc3RyaW5naWZ5KHVpQXBwQ29uZmlnKSk7XG4gICAgY29uc3QgZW50cnk6IFNoYXJlZFN0YXRlRW50cnkgPSBuZXcgU2hhcmVkU3RhdGVFbnRyeSgpO1xuICAgIGVudHJ5LmNvbnRlbnQgPSBjb250ZW50O1xuICAgIGVudHJ5LnNhbmRib3hJZCA9IHNhbmRib3hJZDtcbiAgICBlbnRyeS5uYW1lID0gc3NOYW1lO1xuICAgIGVudHJ5LnR5cGUgPSAnUFVCTElDJztcbiAgICBlbnRyeS5pZCA9IGlkO1xuICAgIGNvbnN0IHNzTGlzdDogU2hhcmVkU3RhdGVMaXN0ID0gbmV3IFNoYXJlZFN0YXRlTGlzdCgpO1xuICAgIHNzTGlzdC5zaGFyZWRTdGF0ZUVudHJpZXMgPSBbXTtcbiAgICBzc0xpc3Quc2hhcmVkU3RhdGVFbnRyaWVzLnB1c2goZW50cnkpO1xuICAgIHJldHVybiB0aGlzLnVwZGF0ZVNoYXJlZFN0YXRlKHNzTGlzdC5zaGFyZWRTdGF0ZUVudHJpZXMpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKHZhbHVlID0+IHtcbiAgICAgICAgICByZXR1cm4gbmV3IFVpQXBwQ29uZmlnKCkuZGVzZXJpYWxpemUoKEpTT04ucGFyc2UodmFsdWUuc2hhcmVkU3RhdGVFbnRyaWVzWzBdLmNvbnRlbnQuanNvbikpKTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cblxuICAvKiBVSSBBcHAgQ29uZmlnICovXG59XG4iXX0=