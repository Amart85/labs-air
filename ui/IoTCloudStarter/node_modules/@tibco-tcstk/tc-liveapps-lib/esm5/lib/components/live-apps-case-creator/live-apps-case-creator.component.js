/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { LiveAppsComponent } from '../live-apps-component/live-apps-component.component';
import { ProcessId } from '../../models/liveappsdata';
import { LaProcessSelection } from '../../models/tc-case-processes';
import { LiveAppsService } from '../../services/live-apps.service';
import { map, take, takeUntil } from 'rxjs/operators';
import { CustomFormDefs } from '@tibco-tcstk/tc-forms-lib';
/**
 * Handles rendering of case creator form.
 *
 * \@example <tcla-live-apps-case-creator></tcla-live-apps-case-creator>
 */
var LiveAppsCaseCreatorComponent = /** @class */ (function (_super) {
    tslib_1.__extends(LiveAppsCaseCreatorComponent, _super);
    function LiveAppsCaseCreatorComponent(liveapps) {
        var _this = _super.call(this) || this;
        _this.liveapps = liveapps;
        /**
         * ~event caseChanged : Case action started (process started)
         * ~payload ProcessId : ProcessId object passed when a case has been updated or created by a process (action/creator)
         */
        _this.caseChanged = new EventEmitter();
        _this.handleSubmit = (/**
         * @param {?} data
         * @param {?} caseRef
         * @return {?}
         */
        function (data, caseRef) {
            // if no_process_submit then no need to run process as this was done inside a custom form app
            if (data !== 'NO_PROCESS_SUBMIT') {
                // run the process
                _this.liveapps.runProcess(_this.sandboxId, _this.applicationId, _this.process.process.id, caseRef, data)
                    .pipe(take(1), takeUntil(_this._destroyed$), map((/**
                 * @param {?} response
                 * @return {?}
                 */
                function (response) {
                    if (response) {
                        if (!response.data.errorMsg) {
                            // parse data to object
                            response.data = JSON.parse(response.data);
                            // case created send back response including caseIdentifier if one is present
                            /** @type {?} */
                            var caseIdentifier = void 0;
                            /** @type {?} */
                            var caseReference = void 0;
                            if (response.caseIdentifier) {
                                caseIdentifier = response.caseIdentifier;
                            }
                            if (response.caseReference) {
                                caseReference = response.caseReference;
                            }
                            /** @type {?} */
                            var processResponse = new ProcessId().deserialize({ 'caseIdentifier': caseIdentifier, 'caseReference': caseReference });
                            _this.caseChanged.emit(processResponse);
                            _this.schema = undefined;
                            _this.data = undefined;
                            _this.layout = undefined;
                        }
                        else {
                            console.error('Unable to run case creator');
                            console.error(response.data.errorMsg);
                        }
                    }
                })))
                    .subscribe((/**
                 * @param {?} success
                 * @return {?}
                 */
                function (success) { return success; }), (/**
                 * @param {?} error
                 * @return {?}
                 */
                function (error) {
                    console.error('Unable to run case creator');
                    console.error(error);
                }));
            }
            else {
                /** @type {?} */
                var processResponse = new ProcessId().deserialize({ 'caseIdentifier': undefined, 'caseReference': undefined });
                _this.caseChanged.emit(processResponse);
                _this.schema = undefined;
                _this.data = undefined;
                _this.layout = undefined;
            }
        });
        return _this;
    }
    /**
     * @return {?}
     */
    LiveAppsCaseCreatorComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.options = {
            defaultOptions: {
                'appearance': 'legacy'
            }
        };
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    LiveAppsCaseCreatorComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        // handle input param changes
        if (changes.process && changes.process.currentValue && (changes.process.currentValue !== changes.process.previousValue)) {
            if (changes.process.currentValue.process.jsonSchema.$schema === 'NOSCHEMA') {
                this.schema = undefined;
            }
            else {
                this.schema = changes.process.currentValue.process.jsonSchema;
            }
        }
        else if (changes.applicationId && (changes.applicationId.currentValue !== changes.applicationId.previousValue)) {
            // appId has changed: make sure no process selected/form displayed
            this.process = undefined;
        }
        if (changes.layout && (changes.layout.currentValue !== changes.layout.previousValue)) {
            this.layout = changes.layout.currentValue;
        }
        if (changes.dataOverride && (changes.dataOverride.currentValue !== changes.dataOverride.previousValue)) {
            this.data = this.dataOverride;
        }
    };
    LiveAppsCaseCreatorComponent.decorators = [
        { type: Component, args: [{
                    selector: 'tcla-live-apps-case-creator',
                    template: "<div fxFill>\n<tcfrm-rendered-form *ngIf=\"process\" style=\"min-height:500px; overflow: auto;\" [customFormDefs]=customFormDefs [formRef]=\"process.ref\" [appId]=\"applicationId\" [customFormDefs]=\"customFormDefs\" [schema]=\"schema\" [layout]=\"layout\" [data]=\"data\" [options]=\"options\" (formSubmit)=\"handleSubmit($event, undefined)\"></tcfrm-rendered-form>\n</div>\n",
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    LiveAppsCaseCreatorComponent.ctorParameters = function () { return [
        { type: LiveAppsService }
    ]; };
    LiveAppsCaseCreatorComponent.propDecorators = {
        sandboxId: [{ type: Input }],
        applicationId: [{ type: Input }],
        typeId: [{ type: Input }],
        process: [{ type: Input }],
        dataOverride: [{ type: Input }],
        customFormDefs: [{ type: Input }],
        caseChanged: [{ type: Output }]
    };
    return LiveAppsCaseCreatorComponent;
}(LiveAppsComponent));
export { LiveAppsCaseCreatorComponent };
if (false) {
    /**
     * sandboxId - this comes from claims resolver
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.sandboxId;
    /**
     * LA application ID
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.applicationId;
    /**
     * The LA Application Type Id (generally 1)
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.typeId;
    /**
     * The process definition of the action or creator to execute
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.process;
    /**
     * Data object that will be displayed on the form. Allows overriding over form data (eg. when selecting data in spotfire)
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.dataOverride;
    /**
     * Custom Form configuration file
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.customFormDefs;
    /**
     * ~event caseChanged : Case action started (process started)
     * ~payload ProcessId : ProcessId object passed when a case has been updated or created by a process (action/creator)
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.caseChanged;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.data;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.schema;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.layout;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.options;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.handleSubmit;
    /**
     * @type {?}
     * @protected
     */
    LiveAppsCaseCreatorComponent.prototype.liveapps;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS1hcHBzLWNhc2UtY3JlYXRvci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGliY28tdGNzdGsvdGMtbGl2ZWFwcHMtbGliLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvbGl2ZS1hcHBzLWNhc2UtY3JlYXRvci9saXZlLWFwcHMtY2FzZS1jcmVhdG9yLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBQyxTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBVSxNQUFNLEVBQXNDLE1BQU0sZUFBZSxDQUFDO0FBQ2xILE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLHNEQUFzRCxDQUFDO0FBQ3ZGLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSwyQkFBMkIsQ0FBQztBQUNwRCxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSxnQ0FBZ0MsQ0FBQztBQUNsRSxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sa0NBQWtDLENBQUM7QUFDakUsT0FBTyxFQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFFcEQsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLDJCQUEyQixDQUFDOzs7Ozs7QUFPekQ7SUFLa0Qsd0RBQWlCO0lBMkZqRSxzQ0FBc0IsUUFBeUI7UUFBL0MsWUFDRSxpQkFBTyxTQUNSO1FBRnFCLGNBQVEsR0FBUixRQUFRLENBQWlCOzs7OztRQXZEckMsaUJBQVcsR0FBNEIsSUFBSSxZQUFZLEVBQWEsQ0FBQztRQU8vRSxrQkFBWTs7Ozs7UUFBRyxVQUFDLElBQUksRUFBRSxPQUFPO1lBQzNCLDZGQUE2RjtZQUM3RixJQUFJLElBQUksS0FBSyxtQkFBbUIsRUFBRTtnQkFDaEMsa0JBQWtCO2dCQUNsQixLQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxLQUFJLENBQUMsU0FBUyxFQUFFLEtBQUksQ0FBQyxhQUFhLEVBQUUsS0FBSSxDQUFD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QU94QyxtREFBK0U7O0lBRS9FLDRDQUFVOztJQUNWLDhDQUFZOztJQUNaLDhDQUFjOztJQUNkLCtDQUFhOztJQUViLG9EQThDQzs7Ozs7SUFFVyxnREFBbUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT25Jbml0LCBPdXRwdXQsIE9uRGVzdHJveSwgU2ltcGxlQ2hhbmdlcywgT25DaGFuZ2VzfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7TGl2ZUFwcHNDb21wb25lbnR9IGZyb20gJy4uL2xpdmUtYXBwcy1jb21wb25lbnQvbGl2ZS1hcHBzLWNvbXBvbmVudC5jb21wb25lbnQnO1xuaW1wb3J0IHtQcm9jZXNzSWR9IGZyb20gJy4uLy4uL21vZGVscy9saXZlYXBwc2RhdGEnO1xuaW1wb3J0IHtMYVByb2Nlc3NTZWxlY3Rpb259IGZyb20gJy4uLy4uL21vZGVscy90Yy1jYXNlLXByb2Nlc3Nlcyc7XG5pbXBvcnQge0xpdmVBcHBzU2VydmljZX0gZnJvbSAnLi4vLi4vc2VydmljZXMvbGl2ZS1hcHBzLnNlcnZpY2UnO1xuaW1wb3J0IHttYXAsIHRha2UsIHRha2VVbnRpbH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtTdWJqZWN0fSBmcm9tICdyeGpzJztcbmltcG9ydCB7Q3VzdG9tRm9ybURlZnN9IGZyb20gJ0B0aWJjby10Y3N0ay90Yy1mb3Jtcy1saWInO1xuXG4vKipcbiAqIEhhbmRsZXMgcmVuZGVyaW5nIG9mIGNhc2UgY3JlYXRvciBmb3JtLlxuICpcbiAqQGV4YW1wbGUgPHRjbGEtbGl2ZS1hcHBzLWNhc2UtY3JlYXRvcj48L3RjbGEtbGl2ZS1hcHBzLWNhc2UtY3JlYXRvcj5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAndGNsYS1saXZlLWFwcHMtY2FzZS1jcmVhdG9yJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2xpdmUtYXBwcy1jYXNlLWNyZWF0b3IuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9saXZlLWFwcHMtY2FzZS1jcmVhdG9yLmNvbXBvbmVudC5jc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBMaXZlQXBwc0Nhc2VDcmVhdG9yQ29tcG9uZW50IGV4dGVuZHMgTGl2ZUFwcHNDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XG4gIC8qKlxuICAgKiBzYW5kYm94SWQgLSB0aGlzIGNvbWVzIGZyb20gY2xhaW1zIHJlc29sdmVyXG4gICAqL1xuICBASW5wdXQoKSBzYW5kYm94SWQ6IG51bWJlcjtcblxuICAvKipcbiAgICogTEEgYXBwbGljYXRpb24gSURcbiAgICovXG4gIEBJbnB1dCgpIGFwcGxpY2F0aW9uSWQ6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIExBIEFwcGxpY2F0aW9uIFR5cGUgSWQgKGdlbmVyYWxseSAxKVxuICAgKi9cbiAgQElucHV0KCkgdHlwZUlkOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBwcm9jZXNzIGRlZmluaXRpb24gb2YgdGhlIGFjdGlvbiBvciBjcmVhdG9yIHRvIGV4ZWN1dGVcbiAgICovXG4gIEBJbnB1dCgpIHByb2Nlc3M6IExhUHJvY2Vzc1NlbGVjdGlvbjtcblxuICAvKipcbiAgICogRGF0YSBvYmplY3QgdGhhdCB3aWxsIGJlIGRpc3BsYXllZCBvbiB0aGUgZm9ybS4gQWxsb3dzIG92ZXJyaWRpbmcgb3ZlciBmb3JtIGRhdGEgKGVnLiB3aGVuIHNlbGVjdGluZyBkYXRhIGluIHNwb3RmaXJlKVxuICAgKi9cbiAgQElucHV0KCkgZGF0YU92ZXJyaWRlOiBhbnk7XG5cbiAgLyoqXG4gICAqIEN1c3RvbSBGb3JtIGNvbmZpZ3VyYXRpb24gZmlsZVxuICAgKi9cbiAgQElucHV0KCkgY3VzdG9tRm9ybURlZnM6IEN1c3RvbUZvcm1EZWZzO1xuXG5cbiAgLyoqXG4gICAqIH5ldmVudCBjYXNlQ2hhbmdlZCA6IENhc2UgYWN0aW9uIHN0YXJ0ZWQgKHByb2Nlc3Mgc3RhcnRlZClcbiAgICogfnBheWxvYWQgUHJvY2Vzc0lkIDogUHJvY2Vzc0lkIG9iamVjdCBwYXNzZWQgd2hlbiBhIGNhc2UgaGFzIGJlZW4gdXBkYXRlZCBvciBjcmVhdGVkIGJ5IGEgcHJvY2VzcyAoYWN0aW9uL2NyZWF0b3IpXG4gICAqL1xuICBAT3V0cHV0KCkgY2FzZUNoYW5nZWQ6IEV2ZW50RW1pdHRlcjxQcm9jZXNzSWQ+ID0gbmV3IEV2ZW50RW1pdHRlcjxQcm9jZXNzSWQ+KCk7XG5cbiAgZGF0YTogYW55O1xuICBzY2hlbWE6IGFueTtcbiAgbGF5b3V0OiBhbnlbXTtcbiAgb3B0aW9uczogYW55O1xuXG4gIGhhbmRsZVN1Ym1pdCA9IChkYXRhLCBjYXNlUmVmKSA9PiB7XG4gICAgLy8gaWYgbm9fcHJvY2Vzc19zdWJtaXQgdGhlbiBubyBuZWVkIHRvIHJ1biBwcm9jZXNzIGFzIHRoaXMgd2FzIGRvbmUgaW5zaWRlIGEgY3VzdG9tIGZvcm0gYXBwXG4gICAgaWYgKGRhdGEgIT09ICdOT19QUk9DRVNTX1NVQk1JVCcpIHtcbiAgICAgIC8vIHJ1biB0aGUgcHJvY2Vzc1xuICAgICAgdGhpcy5saXZlYXBwcy5ydW5Qcm9jZXNzKHRoaXMuc2FuZGJveElkLCB0aGlzLmFwcGxpY2F0aW9uSWQsIHRoaXMucHJvY2Vzcy5wcm9jZXNzLmlkLCBjYXNlUmVmLCBkYXRhKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95ZWQkKSxcbiAgICAgICAgICBtYXAocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgIGlmICghcmVzcG9uc2UuZGF0YS5lcnJvck1zZykge1xuICAgICAgICAgICAgICAgIC8vIHBhcnNlIGRhdGEgdG8gb2JqZWN0XG4gICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YSA9IEpTT04ucGFyc2UocmVzcG9uc2UuZGF0YSk7XG4gICAgICAgICAgICAgICAgLy8gY2FzZSBjcmVhdGVkIHNlbmQgYmFjayByZXNwb25zZSBpbmNsdWRpbmcgY2FzZUlkZW50aWZpZXIgaWYgb25lIGlzIHByZXNlbnRcbiAgICAgICAgICAgICAgICBsZXQgY2FzZUlkZW50aWZpZXI7XG4gICAgICAgICAgICAgICAgbGV0IGNhc2VSZWZlcmVuY2U7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmNhc2VJZGVudGlmaWVyKSB7XG4gICAgICAgICAgICAgICAgICBjYXNlSWRlbnRpZmllciA9IHJlc3BvbnNlLmNhc2VJZGVudGlmaWVyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuY2FzZVJlZmVyZW5jZSkge1xuICAgICAgICAgICAgICAgICAgY2FzZVJlZmVyZW5jZSA9IHJlc3BvbnNlLmNhc2VSZWZlcmVuY2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnN0IHByb2Nlc3NSZXNwb25zZSA9IG5ldyBQcm9jZXNzSWQoKS5kZXNlcmlhbGl6ZSh7J2Nhc2VJZGVudGlmaWVyJzogY2FzZUlkZW50aWZpZXIsICdjYXNlUmVmZXJlbmNlJzogY2FzZVJlZmVyZW5jZX0pO1xuICAgICAgICAgICAgICAgIHRoaXMuY2FzZUNoYW5nZWQuZW1pdChwcm9jZXNzUmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIHRoaXMuc2NoZW1hID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB0aGlzLmxheW91dCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdVbmFibGUgdG8gcnVuIGNhc2UgY3JlYXRvcicpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IocmVzcG9uc2UuZGF0YS5lcnJvck1zZyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoc3VjY2VzcyA9PiBzdWNjZXNzLCBlcnJvciA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdVbmFibGUgdG8gcnVuIGNhc2UgY3JlYXRvcicpO1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBwcm9jZXNzUmVzcG9uc2UgPSBuZXcgUHJvY2Vzc0lkKCkuZGVzZXJpYWxpemUoeydjYXNlSWRlbnRpZmllcic6IHVuZGVmaW5lZCwgJ2Nhc2VSZWZlcmVuY2UnOiB1bmRlZmluZWR9KTtcbiAgICAgIHRoaXMuY2FzZUNoYW5nZWQuZW1pdChwcm9jZXNzUmVzcG9uc2UpO1xuICAgICAgdGhpcy5zY2hlbWEgPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLmRhdGEgPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLmxheW91dCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgbGl2ZWFwcHM6IExpdmVBcHBzU2VydmljZSkge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLm9wdGlvbnMgPSB7XG4gICAgICBkZWZhdWx0T3B0aW9uczoge1xuICAgICAgICAnYXBwZWFyYW5jZSc6ICdsZWdhY3knXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICAvLyBoYW5kbGUgaW5wdXQgcGFyYW0gY2hhbmdlc1xuICAgIGlmIChjaGFuZ2VzLnByb2Nlc3MgJiYgY2hhbmdlcy5wcm9jZXNzLmN1cnJlbnRWYWx1ZSAmJiAoY2hhbmdlcy5wcm9jZXNzLmN1cnJlbnRWYWx1ZSAhPT0gY2hhbmdlcy5wcm9jZXNzLnByZXZpb3VzVmFsdWUpKSB7XG4gICAgICBpZiAoY2hhbmdlcy5wcm9jZXNzLmN1cnJlbnRWYWx1ZS5wcm9jZXNzLmpzb25TY2hlbWEuJHNjaGVtYSA9PT0gJ05PU0NIRU1BJykge1xuICAgICAgICB0aGlzLnNjaGVtYSA9IHVuZGVmaW5lZDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc2NoZW1hID0gY2hhbmdlcy5wcm9jZXNzLmN1cnJlbnRWYWx1ZS5wcm9jZXNzLmpzb25TY2hlbWE7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChjaGFuZ2VzLmFwcGxpY2F0aW9uSWQgJiYgKGNoYW5nZXMuYXBwbGljYXRpb25JZC5jdXJyZW50VmFsdWUgIT09IGNoYW5nZXMuYXBwbGljYXRpb25JZC5wcmV2aW91c1ZhbHVlKSkge1xuICAgICAgLy8gYXBwSWQgaGFzIGNoYW5nZWQ6IG1ha2Ugc3VyZSBubyBwcm9jZXNzIHNlbGVjdGVkL2Zvcm0gZGlzcGxheWVkXG4gICAgICB0aGlzLnByb2Nlc3MgPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGlmIChjaGFuZ2VzLmxheW91dCAmJiAoY2hhbmdlcy5sYXlvdXQuY3VycmVudFZhbHVlICE9PSBjaGFuZ2VzLmxheW91dC5wcmV2aW91c1ZhbHVlKSkge1xuICAgICAgdGhpcy5sYXlvdXQgPSBjaGFuZ2VzLmxheW91dC5jdXJyZW50VmFsdWU7XG4gICAgfVxuICAgIGlmIChjaGFuZ2VzLmRhdGFPdmVycmlkZSAmJiAoY2hhbmdlcy5kYXRhT3ZlcnJpZGUuY3VycmVudFZhbHVlICE9PSBjaGFuZ2VzLmRhdGFPdmVycmlkZS5wcmV2aW91c1ZhbHVlKSkge1xuICAgICAgdGhpcy5kYXRhID0gdGhpcy5kYXRhT3ZlcnJpZGU7XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==