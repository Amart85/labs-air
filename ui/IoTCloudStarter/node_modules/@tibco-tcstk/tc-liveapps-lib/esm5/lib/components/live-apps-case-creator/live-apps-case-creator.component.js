/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { LiveAppsComponent } from '../live-apps-component/live-apps-component.component';
import { ProcessId } from '../../models/liveappsdata';
import { LaProcessSelection } from '../../models/tc-case-processes';
import { LiveAppsService } from '../../services/live-apps.service';
import { take, takeUntil } from 'rxjs/operators';
import { CustomFormDefs } from '@tibco-tcstk/tc-forms-lib';
/**
 * Handles rendering of case creator form.
 *
 * \@example <tcla-live-apps-case-creator></tcla-live-apps-case-creator>
 */
var LiveAppsCaseCreatorComponent = /** @class */ (function (_super) {
    tslib_1.__extends(LiveAppsCaseCreatorComponent, _super);
    function LiveAppsCaseCreatorComponent(liveapps) {
        var _this = _super.call(this) || this;
        _this.liveapps = liveapps;
        /**
         * Enable legacy creators
         */
        _this.legacyCreators = _this.legacyCreators ? _this.legacyCreators : false;
        /**
         * Allow override of forms framework
         * Options: bootstrap-4 or material-design
         */
        _this.formsFramework = _this.formsFramework ? _this.formsFramework : 'material-design';
        /**
         * ~event caseChanged : Case action started (process started)
         * ~payload ProcessId : ProcessId object passed when a case has been updated or created by a process (action/creator)
         */
        _this.caseChanged = new EventEmitter();
        _this.isCustomForm = false;
        _this.handleSubmit = (/**
         * @param {?} data
         * @param {?} caseRef
         * @return {?}
         */
        function (data, caseRef) {
            // if no_process_submit then no need to run process as this was done inside a custom form app
            if (data !== 'NO_PROCESS_SUBMIT') {
                // run the process
                _this.liveapps.runProcess(_this.sandboxId, _this.applicationId, _this.process.process.id, caseRef, data)
                    .pipe(take(1), takeUntil(_this._destroyed$))
                    .subscribe((/**
                 * @param {?} response
                 * @return {?}
                 */
                function (response) {
                    if (response) {
                        if (!response.data.errorMsg) {
                            // parse data to object
                            response.data = JSON.parse(response.data);
                            // case created send back response including caseIdentifier if one is present
                            /** @type {?} */
                            var caseIdentifier = void 0;
                            /** @type {?} */
                            var caseReference = void 0;
                            if (response.caseIdentifier) {
                                caseIdentifier = response.caseIdentifier;
                            }
                            if (response.caseReference) {
                                caseReference = response.caseReference;
                            }
                            /** @type {?} */
                            var processResponse = new ProcessId().deserialize({ 'caseIdentifier': caseIdentifier, 'caseReference': caseReference });
                            _this.caseChanged.emit(processResponse);
                            _this.schema = undefined;
                            _this.data = undefined;
                            _this.layout = undefined;
                        }
                        else {
                            console.error('Unable to run case creator');
                            console.error(response.data.errorMsg);
                        }
                    }
                }), (/**
                 * @param {?} error
                 * @return {?}
                 */
                function (error) {
                    console.error('Unable to run case creator');
                    console.error(error);
                }));
            }
            else {
                /** @type {?} */
                var processResponse = new ProcessId().deserialize({ 'caseIdentifier': undefined, 'caseReference': undefined });
                _this.caseChanged.emit(processResponse);
                _this.schema = undefined;
                _this.data = undefined;
                _this.layout = undefined;
            }
        });
        _this.handleLegacyProcessComplete = (/**
         * @return {?}
         */
        function () {
            /** @type {?} */
            var processResponse = new ProcessId().deserialize({ 'caseIdentifier': undefined, 'caseReference': undefined });
            _this.caseChanged.emit(processResponse);
        });
        _this.handleLegacyProcessCancelled = (/**
         * @return {?}
         */
        function () {
            // -1 for caseReference means cancelled
            /** @type {?} */
            var processResponse = new ProcessId().deserialize({ 'caseIdentifier': undefined, 'caseReference': '-1' });
            _this.caseChanged.emit(processResponse);
        });
        return _this;
    }
    /**
     * @return {?}
     */
    LiveAppsCaseCreatorComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.options = {
            defaultOptions: {
                'appearance': 'legacy'
            }
        };
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    LiveAppsCaseCreatorComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        var _this = this;
        // handle input param changes
        if (changes.process && changes.process.currentValue && (changes.process.currentValue !== changes.process.previousValue)) {
            if (this.customFormDefs && this.customFormDefs.customForms) {
                this.isCustomForm = (this.customFormDefs.customForms.findIndex((/**
                 * @param {?} form
                 * @return {?}
                 */
                function (form) {
                    return (form === _this.process.ref);
                })) !== -1);
            }
            else {
                this.isCustomForm = false;
            }
            if (changes.process.currentValue.process.jsonSchema.$schema === 'NOSCHEMA') {
                this.schema = undefined;
            }
            else {
                this.schema = changes.process.currentValue.process.jsonSchema;
            }
        }
        else if (changes.applicationId && (changes.applicationId.currentValue !== changes.applicationId.previousValue)) {
            // appId has changed: make sure no process selected/form displayed
            this.process = undefined;
        }
        if (changes.layout && (changes.layout.currentValue !== changes.layout.previousValue)) {
            this.layout = changes.layout.currentValue;
        }
        if (changes.dataOverride && (changes.dataOverride.currentValue !== changes.dataOverride.previousValue)) {
            this.data = this.dataOverride;
        }
    };
    LiveAppsCaseCreatorComponent.decorators = [
        { type: Component, args: [{
                    selector: 'tcla-live-apps-case-creator',
                    template: "<div fxFill>\n  <tcfrm-rendered-form *ngIf=\"process && (!legacyCreators || isCustomForm)\" style=\"overflow: auto;\" [formsFramework]=\"formsFramework\" [customFormDefs]=customFormDefs [formRef]=\"process.ref\" [appId]=\"applicationId\" [customFormDefs]=\"customFormDefs\" [schema]=\"schema\" [layout]=\"layout\" [data]=\"data\" [options]=\"options\" (formSubmit)=\"handleSubmit($event, undefined)\"></tcfrm-rendered-form>\n  <tcla-live-apps-legacy-process *ngIf=\"process && legacyCreators && !isCustomForm\" [process]=\"process\" [type]=\"'creator'\" [applicationId]=\"applicationId\" [typeId]=\"typeId\" (processCancelled)=\"handleLegacyProcessCancelled()\" (processComplete)=\"handleLegacyProcessComplete()\" class=\"live-apps-widget\" fxFill></tcla-live-apps-legacy-process>\n</div>\n",
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    LiveAppsCaseCreatorComponent.ctorParameters = function () { return [
        { type: LiveAppsService }
    ]; };
    LiveAppsCaseCreatorComponent.propDecorators = {
        sandboxId: [{ type: Input }],
        applicationId: [{ type: Input }],
        typeId: [{ type: Input }],
        process: [{ type: Input }],
        dataOverride: [{ type: Input }],
        customFormDefs: [{ type: Input }],
        legacyCreators: [{ type: Input }],
        formsFramework: [{ type: Input }],
        caseChanged: [{ type: Output }]
    };
    return LiveAppsCaseCreatorComponent;
}(LiveAppsComponent));
export { LiveAppsCaseCreatorComponent };
if (false) {
    /**
     * sandboxId - this comes from claims resolver
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.sandboxId;
    /**
     * LA application ID
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.applicationId;
    /**
     * The LA Application Type Id (generally 1)
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.typeId;
    /**
     * The process definition of the action or creator to execute
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.process;
    /**
     * Data object that will be displayed on the form. Allows overriding over form data (eg. when selecting data in spotfire)
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.dataOverride;
    /**
     * Custom Form configuration file
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.customFormDefs;
    /**
     * Enable legacy creators
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.legacyCreators;
    /**
     * Allow override of forms framework
     * Options: bootstrap-4 or material-design
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.formsFramework;
    /**
     * ~event caseChanged : Case action started (process started)
     * ~payload ProcessId : ProcessId object passed when a case has been updated or created by a process (action/creator)
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.caseChanged;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.data;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.schema;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.layout;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.options;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.isCustomForm;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.handleSubmit;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.handleLegacyProcessComplete;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.handleLegacyProcessCancelled;
    /**
     * @type {?}
     * @protected
     */
    LiveAppsCaseCreatorComponent.prototype.liveapps;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS1hcHBzLWNhc2UtY3JlYXRvci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGliY28tdGNzdGsvdGMtbGl2ZWFwcHMtbGliLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvbGl2ZS1hcHBzLWNhc2UtY3JlYXRvci9saXZlLWFwcHMtY2FzZS1jcmVhdG9yLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBQyxTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBVSxNQUFNLEVBQXNDLE1BQU0sZUFBZSxDQUFDO0FBQ2xILE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLHNEQUFzRCxDQUFDO0FBQ3ZGLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSwyQkFBMkIsQ0FBQztBQUNwRCxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSxnQ0FBZ0MsQ0FBQztBQUNsRSxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sa0NBQWtDLENBQUM7QUFDakUsT0FBTyxFQUFNLElBQUksRUFBRSxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUVwRCxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sMkJBQTJCLENBQUM7Ozs7OztBQU96RDtJQUtrRCx3REFBaUI7SUFnSGpFLHNDQUFzQixRQUF5QjtRQUEvQyxZQUNFLGlCQUFPLFNBQ1I7UUFGcUIsY0FBUSxHQUFSLFFBQVEsQ0FBaUI7Ozs7UUE5RXRDLG9CQUFjLEdBQVksS0FBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsS0FBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDOzs7OztRQU01RSxvQkFBYyxHQUFXLEtBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLEtBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDOzs7OztRQU10RixpQkFBVyxHQUE0QixJQUFJLFlBQVksRUFBYSxDQUFDO1FBTS9FLGtCQUFZLEdB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O0lBRS9FLDRDQUFVOztJQUNWLDhDQUFZOztJQUNaLDhDQUFjOztJQUNkLCtDQUFhOztJQUNiLG9EQUFxQjs7SUFFckIsb0RBNkNDOztJQUVELG1FQUdDOztJQUVELG9FQUlDOzs7OztJQUVXLGdEQUFtQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkluaXQsIE91dHB1dCwgT25EZXN0cm95LCBTaW1wbGVDaGFuZ2VzLCBPbkNoYW5nZXN9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtMaXZlQXBwc0NvbXBvbmVudH0gZnJvbSAnLi4vbGl2ZS1hcHBzLWNvbXBvbmVudC9saXZlLWFwcHMtY29tcG9uZW50LmNvbXBvbmVudCc7XG5pbXBvcnQge1Byb2Nlc3NJZH0gZnJvbSAnLi4vLi4vbW9kZWxzL2xpdmVhcHBzZGF0YSc7XG5pbXBvcnQge0xhUHJvY2Vzc1NlbGVjdGlvbn0gZnJvbSAnLi4vLi4vbW9kZWxzL3RjLWNhc2UtcHJvY2Vzc2VzJztcbmltcG9ydCB7TGl2ZUFwcHNTZXJ2aWNlfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9saXZlLWFwcHMuc2VydmljZSc7XG5pbXBvcnQge21hcCwgdGFrZSwgdGFrZVVudGlsfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1N1YmplY3R9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtDdXN0b21Gb3JtRGVmc30gZnJvbSAnQHRpYmNvLXRjc3RrL3RjLWZvcm1zLWxpYic7XG5cbi8qKlxuICogSGFuZGxlcyByZW5kZXJpbmcgb2YgY2FzZSBjcmVhdG9yIGZvcm0uXG4gKlxuICpAZXhhbXBsZSA8dGNsYS1saXZlLWFwcHMtY2FzZS1jcmVhdG9yPjwvdGNsYS1saXZlLWFwcHMtY2FzZS1jcmVhdG9yPlxuICovXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd0Y2xhLWxpdmUtYXBwcy1jYXNlLWNyZWF0b3InLFxuICB0ZW1wbGF0ZVVybDogJy4vbGl2ZS1hcHBzLWNhc2UtY3JlYXRvci5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2xpdmUtYXBwcy1jYXNlLWNyZWF0b3IuY29tcG9uZW50LmNzcyddXG59KVxuZXhwb3J0IGNsYXNzIExpdmVBcHBzQ2FzZUNyZWF0b3JDb21wb25lbnQgZXh0ZW5kcyBMaXZlQXBwc0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcbiAgLyoqXG4gICAqIHNhbmRib3hJZCAtIHRoaXMgY29tZXMgZnJvbSBjbGFpbXMgcmVzb2x2ZXJcbiAgICovXG4gIEBJbnB1dCgpIHNhbmRib3hJZDogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBMQSBhcHBsaWNhdGlvbiBJRFxuICAgKi9cbiAgQElucHV0KCkgYXBwbGljYXRpb25JZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgTEEgQXBwbGljYXRpb24gVHlwZSBJZCAoZ2VuZXJhbGx5IDEpXG4gICAqL1xuICBASW5wdXQoKSB0eXBlSWQ6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHByb2Nlc3MgZGVmaW5pdGlvbiBvZiB0aGUgYWN0aW9uIG9yIGNyZWF0b3IgdG8gZXhlY3V0ZVxuICAgKi9cbiAgQElucHV0KCkgcHJvY2VzczogTGFQcm9jZXNzU2VsZWN0aW9uO1xuXG4gIC8qKlxuICAgKiBEYXRhIG9iamVjdCB0aGF0IHdpbGwgYmUgZGlzcGxheWVkIG9uIHRoZSBmb3JtLiBBbGxvd3Mgb3ZlcnJpZGluZyBvdmVyIGZvcm0gZGF0YSAoZWcuIHdoZW4gc2VsZWN0aW5nIGRhdGEgaW4gc3BvdGZpcmUpXG4gICAqL1xuICBASW5wdXQoKSBkYXRhT3ZlcnJpZGU6IGFueTtcblxuICAvKipcbiAgICogQ3VzdG9tIEZvcm0gY29uZmlndXJhdGlvbiBmaWxlXG4gICAqL1xuICBASW5wdXQoKSBjdXN0b21Gb3JtRGVmczogQ3VzdG9tRm9ybURlZnM7XG5cbiAgLyoqXG4gICAqIEVuYWJsZSBsZWdhY3kgY3JlYXRvcnNcbiAgICovXG4gIEBJbnB1dCgpIGxlZ2FjeUNyZWF0b3JzOiBib29sZWFuID0gdGhpcy5sZWdhY3lDcmVhdG9ycyA/IHRoaXMubGVnYWN5Q3JlYXRvcnMgOiBmYWxzZTtcblxuICAvKipcbiAgICogQWxsb3cgb3ZlcnJpZGUgb2YgZm9ybXMgZnJhbWV3b3JrXG4gICAqIE9wdGlvbnM6IGJvb3RzdHJhcC00IG9yIG1hdGVyaWFsLWRlc2lnblxuICAgKi9cbiAgQElucHV0KCkgZm9ybXNGcmFtZXdvcms6IHN0cmluZyA9IHRoaXMuZm9ybXNGcmFtZXdvcmsgPyB0aGlzLmZvcm1zRnJhbWV3b3JrIDogJ21hdGVyaWFsLWRlc2lnbic7XG5cbiAgLyoqXG4gICAqIH5ldmVudCBjYXNlQ2hhbmdlZCA6IENhc2UgYWN0aW9uIHN0YXJ0ZWQgKHByb2Nlc3Mgc3RhcnRlZClcbiAgICogfnBheWxvYWQgUHJvY2Vzc0lkIDogUHJvY2Vzc0lkIG9iamVjdCBwYXNzZWQgd2hlbiBhIGNhc2UgaGFzIGJlZW4gdXBkYXRlZCBvciBjcmVhdGVkIGJ5IGEgcHJvY2VzcyAoYWN0aW9uL2NyZWF0b3IpXG4gICAqL1xuICBAT3V0cHV0KCkgY2FzZUNoYW5nZWQ6IEV2ZW50RW1pdHRlcjxQcm9jZXNzSWQ+ID0gbmV3IEV2ZW50RW1pdHRlcjxQcm9jZXNzSWQ+KCk7XG5cbiAgZGF0YTogYW55O1xuICBzY2hlbWE6IGFueTtcbiAgbGF5b3V0OiBhbnlbXTtcbiAgb3B0aW9uczogYW55O1xuICBpc0N1c3RvbUZvcm0gPSBmYWxzZTtcblxuICBoYW5kbGVTdWJtaXQgPSAoZGF0YSwgY2FzZVJlZikgPT4ge1xuICAgIC8vIGlmIG5vX3Byb2Nlc3Nfc3VibWl0IHRoZW4gbm8gbmVlZCB0byBydW4gcHJvY2VzcyBhcyB0aGlzIHdhcyBkb25lIGluc2lkZSBhIGN1c3RvbSBmb3JtIGFwcFxuICAgIGlmIChkYXRhICE9PSAnTk9fUFJPQ0VTU19TVUJNSVQnKSB7XG4gICAgICAvLyBydW4gdGhlIHByb2Nlc3NcbiAgICAgIHRoaXMubGl2ZWFwcHMucnVuUHJvY2Vzcyh0aGlzLnNhbmRib3hJZCwgdGhpcy5hcHBsaWNhdGlvbklkLCB0aGlzLnByb2Nlc3MucHJvY2Vzcy5pZCwgY2FzZVJlZiwgZGF0YSlcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveWVkJClcbiAgICAgICAgKVxuICAgICAgICAuc3Vic2NyaWJlKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICBpZiAocmVzcG9uc2UpIHtcbiAgICAgICAgICAgIGlmICghcmVzcG9uc2UuZGF0YS5lcnJvck1zZykge1xuICAgICAgICAgICAgICAvLyBwYXJzZSBkYXRhIHRvIG9iamVjdFxuICAgICAgICAgICAgICByZXNwb25zZS5kYXRhID0gSlNPTi5wYXJzZShyZXNwb25zZS5kYXRhKTtcbiAgICAgICAgICAgICAgLy8gY2FzZSBjcmVhdGVkIHNlbmQgYmFjayByZXNwb25zZSBpbmNsdWRpbmcgY2FzZUlkZW50aWZpZXIgaWYgb25lIGlzIHByZXNlbnRcbiAgICAgICAgICAgICAgbGV0IGNhc2VJZGVudGlmaWVyO1xuICAgICAgICAgICAgICBsZXQgY2FzZVJlZmVyZW5jZTtcbiAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmNhc2VJZGVudGlmaWVyKSB7XG4gICAgICAgICAgICAgICAgY2FzZUlkZW50aWZpZXIgPSByZXNwb25zZS5jYXNlSWRlbnRpZmllcjtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuY2FzZVJlZmVyZW5jZSkge1xuICAgICAgICAgICAgICAgIGNhc2VSZWZlcmVuY2UgPSByZXNwb25zZS5jYXNlUmVmZXJlbmNlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGNvbnN0IHByb2Nlc3NSZXNwb25zZSA9IG5ldyBQcm9jZXNzSWQoKS5kZXNlcmlhbGl6ZSh7J2Nhc2VJZGVudGlmaWVyJzogY2FzZUlkZW50aWZpZXIsICdjYXNlUmVmZXJlbmNlJzogY2FzZVJlZmVyZW5jZX0pO1xuICAgICAgICAgICAgICB0aGlzLmNhc2VDaGFuZ2VkLmVtaXQocHJvY2Vzc1Jlc3BvbnNlKTtcbiAgICAgICAgICAgICAgdGhpcy5zY2hlbWEgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgIHRoaXMuZGF0YSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgdGhpcy5sYXlvdXQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdVbmFibGUgdG8gcnVuIGNhc2UgY3JlYXRvcicpO1xuICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKHJlc3BvbnNlLmRhdGEuZXJyb3JNc2cpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignVW5hYmxlIHRvIHJ1biBjYXNlIGNyZWF0b3InKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgcHJvY2Vzc1Jlc3BvbnNlID0gbmV3IFByb2Nlc3NJZCgpLmRlc2VyaWFsaXplKHsnY2FzZUlkZW50aWZpZXInOiB1bmRlZmluZWQsICdjYXNlUmVmZXJlbmNlJzogdW5kZWZpbmVkfSk7XG4gICAgICB0aGlzLmNhc2VDaGFuZ2VkLmVtaXQocHJvY2Vzc1Jlc3BvbnNlKTtcbiAgICAgIHRoaXMuc2NoZW1hID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5kYXRhID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5sYXlvdXQgPSB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgaGFuZGxlTGVnYWN5UHJvY2Vzc0NvbXBsZXRlID0gKCkgPT4ge1xuICAgIGNvbnN0IHByb2Nlc3NSZXNwb25zZSA9IG5ldyBQcm9jZXNzSWQoKS5kZXNlcmlhbGl6ZSh7J2Nhc2VJZGVudGlmaWVyJzogdW5kZWZpbmVkLCAnY2FzZVJlZmVyZW5jZSc6IHVuZGVmaW5lZH0pO1xuICAgIHRoaXMuY2FzZUNoYW5nZWQuZW1pdChwcm9jZXNzUmVzcG9uc2UpO1xuICB9XG5cbiAgaGFuZGxlTGVnYWN5UHJvY2Vzc0NhbmNlbGxlZCA9ICgpID0+IHtcbiAgICAvLyAtMSBmb3IgY2FzZVJlZmVyZW5jZSBtZWFucyBjYW5jZWxsZWRcbiAgICBjb25zdCBwcm9jZXNzUmVzcG9uc2UgPSBuZXcgUHJvY2Vzc0lkKCkuZGVzZXJpYWxpemUoeydjYXNlSWRlbnRpZmllcic6IHVuZGVmaW5lZCwgJ2Nhc2VSZWZlcmVuY2UnOiAnLTEnfSk7XG4gICAgdGhpcy5jYXNlQ2hhbmdlZC5lbWl0KHByb2Nlc3NSZXNwb25zZSk7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgbGl2ZWFwcHM6IExpdmVBcHBzU2VydmljZSkge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLm9wdGlvbnMgPSB7XG4gICAgICBkZWZhdWx0T3B0aW9uczoge1xuICAgICAgICAnYXBwZWFyYW5jZSc6ICdsZWdhY3knXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICAvLyBoYW5kbGUgaW5wdXQgcGFyYW0gY2hhbmdlc1xuICAgIGlmIChjaGFuZ2VzLnByb2Nlc3MgJiYgY2hhbmdlcy5wcm9jZXNzLmN1cnJlbnRWYWx1ZSAmJiAoY2hhbmdlcy5wcm9jZXNzLmN1cnJlbnRWYWx1ZSAhPT0gY2hhbmdlcy5wcm9jZXNzLnByZXZpb3VzVmFsdWUpKSB7XG4gICAgICBpZiAodGhpcy5jdXN0b21Gb3JtRGVmcyAmJiB0aGlzLmN1c3RvbUZvcm1EZWZzLmN1c3RvbUZvcm1zKSB7XG4gICAgICAgIHRoaXMuaXNDdXN0b21Gb3JtID0gKHRoaXMuY3VzdG9tRm9ybURlZnMuY3VzdG9tRm9ybXMuZmluZEluZGV4KChmb3JtKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIChmb3JtID09PSB0aGlzLnByb2Nlc3MucmVmKTtcbiAgICAgICAgfSkgIT09IC0xKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuaXNDdXN0b21Gb3JtID0gZmFsc2U7XG4gICAgICB9XG4gICAgICBpZiAoY2hhbmdlcy5wcm9jZXNzLmN1cnJlbnRWYWx1ZS5wcm9jZXNzLmpzb25TY2hlbWEuJHNjaGVtYSA9PT0gJ05PU0NIRU1BJykge1xuICAgICAgICB0aGlzLnNjaGVtYSA9IHVuZGVmaW5lZDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc2NoZW1hID0gY2hhbmdlcy5wcm9jZXNzLmN1cnJlbnRWYWx1ZS5wcm9jZXNzLmpzb25TY2hlbWE7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChjaGFuZ2VzLmFwcGxpY2F0aW9uSWQgJiYgKGNoYW5nZXMuYXBwbGljYXRpb25JZC5jdXJyZW50VmFsdWUgIT09IGNoYW5nZXMuYXBwbGljYXRpb25JZC5wcmV2aW91c1ZhbHVlKSkge1xuICAgICAgLy8gYXBwSWQgaGFzIGNoYW5nZWQ6IG1ha2Ugc3VyZSBubyBwcm9jZXNzIHNlbGVjdGVkL2Zvcm0gZGlzcGxheWVkXG4gICAgICB0aGlzLnByb2Nlc3MgPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGlmIChjaGFuZ2VzLmxheW91dCAmJiAoY2hhbmdlcy5sYXlvdXQuY3VycmVudFZhbHVlICE9PSBjaGFuZ2VzLmxheW91dC5wcmV2aW91c1ZhbHVlKSkge1xuICAgICAgdGhpcy5sYXlvdXQgPSBjaGFuZ2VzLmxheW91dC5jdXJyZW50VmFsdWU7XG4gICAgfVxuICAgIGlmIChjaGFuZ2VzLmRhdGFPdmVycmlkZSAmJiAoY2hhbmdlcy5kYXRhT3ZlcnJpZGUuY3VycmVudFZhbHVlICE9PSBjaGFuZ2VzLmRhdGFPdmVycmlkZS5wcmV2aW91c1ZhbHVlKSkge1xuICAgICAgdGhpcy5kYXRhID0gdGhpcy5kYXRhT3ZlcnJpZGU7XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==