/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { LiveAppsComponent } from '../live-apps-component/live-apps-component.component';
import { TcLiveAppsReportingService } from '../../services/tc-live-apps-reporting.service';
import { map, take, takeUntil } from 'rxjs/operators';
import 'chartjs-plugin-datalabels';
import { DEFAULT_COLORS, DEFAULT_TYPE_COLOR } from '../../services/tc-case-card-config.service';
/**
 * Home page active cases widget sub component
 *
 * \@example <tcla-live-apps-active-cases-for-type-report></tcla-live-apps-active-cases-for-type-report>
 */
var LiveAppsActiveCasesForTypeReportComponent = /** @class */ (function (_super) {
    tslib_1.__extends(LiveAppsActiveCasesForTypeReportComponent, _super);
    function LiveAppsActiveCasesForTypeReportComponent(reportingService) {
        var _this = _super.call(this) || this;
        _this.reportingService = reportingService;
        /**
         * Maximum rows to show in legend before it is hidden (otherwise would take whole widget)
         */
        _this.maxLegendItems = _this.maxLegendItems ? _this.maxLegendItems : 8;
        /**
         * Whether to show percentages or raw case numbers on the doughnut chart
         */
        _this.showPercentages = _this.showPercentages ? _this.showPercentages : false;
        /**
         * ~event selectedCaseTypeState : Case Type state selected in vizualization
         * ~payload CaseTypeStateReportStateInfo : CaseTypeStateReportStateInfo object selected from component (to drive caller to display something different (drill down))
         */
        _this.selectedCaseTypeState = new EventEmitter();
        _this.renderChart = false;
        _this.doughnutChartData = [];
        _this.doughnutChartType = 'doughnut';
        _this.chartColors = [];
        _this.defaultColors = DEFAULT_COLORS.slice().reverse();
        _this.getCaseCount = (/**
         * @return {?}
         */
        function () {
            return _this.totalActiveCaseCount;
        });
        _this.doughnutChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
                position: 'left'
            },
            layout: {
                padding: {
                    left: 0,
                    right: 0,
                    top: 10,
                    bottom: 10
                }
            },
            plugins: {
                doughnutlabel: {
                    labels: [
                        {
                            text: _this.getCaseCount,
                            font: {
                                size: '20',
                                family: 'Source Sans Pro',
                                weight: 'bold'
                            },
                            color: '#FF7800'
                        },
                        {
                            text: 'cases',
                            font: {
                                size: '16',
                                family: 'Source Sans Pro',
                            },
                            color: '#FF7800'
                        }
                    ]
                },
                datalabels: {
                    anchor: 'end',
                    backgroundColor: (/**
                     * @param {?} context
                     * @return {?}
                     */
                    function (context) {
                        return context.dataset.backgroundColor;
                    }),
                    borderColor: 'white',
                    borderRadius: 25,
                    borderWidth: 2,
                    color: 'white',
                    display: (/**
                     * @param {?} context
                     * @return {?}
                     */
                    function (context) {
                        /** @type {?} */
                        var dataset = context.dataset;
                        /** @type {?} */
                        var value = dataset.data[context.dataIndex];
                        return value > 0;
                    }),
                    font: {
                        weight: 'bold'
                    },
                    formatter: (/**
                     * @param {?} value
                     * @param {?} ctx
                     * @return {?}
                     */
                    function (value, ctx) {
                        /** @type {?} */
                        var datasets = ctx.chart.data.datasets;
                        if (datasets.indexOf(ctx.dataset) === datasets.length - 1) {
                            if (_this.showPercentages) {
                                /** @type {?} */
                                var sum = datasets[0].data.reduce((/**
                                 * @param {?} a
                                 * @param {?} b
                                 * @return {?}
                                 */
                                function (a, b) { return a + b; }), 0);
                                /** @type {?} */
                                var percentage = Math.round((value / sum) * 100) + '%';
                                return percentage;
                            }
                            else {
                                return value;
                            }
                        }
                        else {
                            return 0;
                        }
                    })
                }
            }
        };
        _this.initReportDataToChart = (/**
         * @param {?} reportData
         * @param {?} status
         * @return {?}
         */
        function (reportData, status) {
            _this.doughnutChartData = [];
            _this.totalActiveCaseCount = 0;
            /** @type {?} */
            var casesByStateArray = [];
            /** @type {?} */
            var labels = [];
            /** @type {?} */
            var colorArray = [];
            // remove any taken colors from the defaultColors
            // we have to do this before parsing the record to avoid getting same colors
            reportData.caseStates.forEach((/**
             * @param {?} cs
             * @return {?}
             */
            function (cs) {
                // remove color from defaults
                if (cs.stateInfo.color) {
                    _this.defaultColors = _this.defaultColors.filter((/**
                     * @param {?} item
                     * @return {?}
                     */
                    function (item) { return item !== cs.stateInfo.color; }));
                }
            }));
            // parse record
            reportData.caseStates.forEach((/**
             * @param {?} caseState
             * @return {?}
             */
            function (caseState) {
                _this.totalActiveCaseCount = _this.totalActiveCaseCount + caseState.caseCount;
                casesByStateArray.push(caseState.caseCount);
                labels.push(caseState.stateInfo.label);
                // we will re-color anything that has the default color
                /** @type {?} */
                var col;
                if (caseState.stateInfo.color && caseState.stateInfo.color !== DEFAULT_TYPE_COLOR) {
                    // use the set color
                    col = caseState.stateInfo.color;
                }
                else {
                    // try and get a color from the palette
                    /** @type {?} */
                    var palCol = _this.defaultColors.pop();
                    if (palCol) {
                        col = palCol;
                    }
                    else {
                        // if no more in palette use a random color!
                        /** @type {?} */
                        var i = Math.random() * 0xffffff;
                        /** @type {?} */
                        var p = parseInt(i.toString(), 0);
                        col = '#' + p.toString(16);
                    }
                }
                colorArray.push(col);
            }));
            _this.doughnutChartData.push(casesByStateArray);
            _this.doughnutChartLabels = labels;
            _this.chartColors.push({ backgroundColor: colorArray });
            // showing more than 8 in the legend will take up too much space
            _this.doughnutChartOptions.legend.display = labels.length <= 8;
            _this.renderChart = true;
        });
        _this.refresh = (/**
         * @return {?}
         */
        function () {
            _this.reportingService.getCaseTypeStateReport(_this.sandboxId, _this.appId, _this.typeId, false, _this.uiAppId).pipe(take(1), takeUntil(_this._destroyed$), map((/**
             * @param {?} report
             * @return {?}
             */
            function (report) {
                _this.caseTypeStateReport = report;
                _this.initReportDataToChart(report, status);
                return report;
            })))
                .subscribe(null, (/**
             * @param {?} error
             * @return {?}
             */
            function (error) { _this.errorMessage = 'Error retrieving case types report: ' + error.error.errorMsg; }));
        });
        return _this;
    }
    // events
    // events
    /**
     * @param {?} __0
     * @return {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.chartClicked = 
    // events
    /**
     * @param {?} __0
     * @return {?}
     */
    function (_a) {
        var event = _a.event, active = _a.active;
        if (active.length > 0) {
            /** @type {?} */
            var chart = active[0]._chart;
            /** @type {?} */
            var activePoints = chart.getElementAtEvent(event);
            if (activePoints.length > 0) {
                // get the internal index of slice in pie chart
                /** @type {?} */
                var clickedElementIndex = activePoints[0]._index;
                /** @type {?} */
                var label = chart.data.labels[clickedElementIndex];
                // get value by index
                /** @type {?} */
                var value = chart.data.datasets[0].data[clickedElementIndex];
                console.log(clickedElementIndex, label, value);
                this.selectedCaseTypeState.emit(this.caseTypeStateReport.caseStates[clickedElementIndex].stateInfo);
            }
        }
    };
    /**
     * @param {?} __0
     * @return {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.chartHovered = /**
     * @param {?} __0
     * @return {?}
     */
    function (_a) {
        var event = _a.event, active = _a.active;
        // console.log(event, active);
    };
    /**
     * @return {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        if (changes.appId && (changes.firstChange || (changes.appId.currentValue !== changes.appId.previousValue))) {
            this.refresh();
        }
    };
    LiveAppsActiveCasesForTypeReportComponent.decorators = [
        { type: Component, args: [{
                    selector: 'tcla-live-apps-active-cases-for-type-report',
                    template: "<div fxLayout=\"column\" fxFlex style=\"overflow: auto\">\n  <div *ngIf=\"renderChart\" style=\"height:100%; width:100%; padding: 20px\" class=\"relative\">\n    <canvas #caseReportChart baseChart\n            [data]=\"doughnutChartData\"\n            [labels]=\"doughnutChartLabels\"\n            [chartType]=\"doughnutChartType\"\n            [options]=\"doughnutChartOptions\"\n            [colors]=\"chartColors\"\n            (chartHover)=\"chartHovered($event)\"\n            (chartClick)=\"chartClicked($event)\"\n    >\n    </canvas>\n  </div>\n</div>\n",
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    LiveAppsActiveCasesForTypeReportComponent.ctorParameters = function () { return [
        { type: TcLiveAppsReportingService }
    ]; };
    LiveAppsActiveCasesForTypeReportComponent.propDecorators = {
        sandboxId: [{ type: Input }],
        appId: [{ type: Input }],
        typeId: [{ type: Input }],
        uiAppId: [{ type: Input }],
        maxLegendItems: [{ type: Input }],
        showPercentages: [{ type: Input }],
        selectedCaseTypeState: [{ type: Output }]
    };
    return LiveAppsActiveCasesForTypeReportComponent;
}(LiveAppsComponent));
export { LiveAppsActiveCasesForTypeReportComponent };
if (false) {
    /**
     * sandboxId - this comes from claims resolver
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.sandboxId;
    /**
     * The LA Application Id
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.appId;
    /**
     * The LA Application Type Id (generally 1)
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.typeId;
    /**
     * The Application ID of the UI (should ideally be unique as it is shared state key)
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.uiAppId;
    /**
     * Maximum rows to show in legend before it is hidden (otherwise would take whole widget)
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.maxLegendItems;
    /**
     * Whether to show percentages or raw case numbers on the doughnut chart
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.showPercentages;
    /**
     * ~event selectedCaseTypeState : Case Type state selected in vizualization
     * ~payload CaseTypeStateReportStateInfo : CaseTypeStateReportStateInfo object selected from component (to drive caller to display something different (drill down))
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.selectedCaseTypeState;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.errorMessage;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.caseTypeStateReport;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.renderChart;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.doughnutChartLabels;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.doughnutChartData;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.doughnutChartType;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.chartColors;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.defaultColors;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.legendData;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.totalActiveCaseCount;
    /**
     * @type {?}
     * @private
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.getCaseCount;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.doughnutChartOptions;
    /**
     * @type {?}
     * @private
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.initReportDataToChart;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.refresh;
    /**
     * @type {?}
     * @private
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.reportingService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS1hcHBzLWFjdGl2ZS1jYXNlcy1mb3ItdHlwZS1yZXBvcnQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRpYmNvLXRjc3RrL3RjLWxpdmVhcHBzLWxpYi8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2xpdmUtYXBwcy1hY3RpdmUtY2FzZXMtZm9yLXR5cGUtcmVwb3J0L2xpdmUtYXBwcy1hY3RpdmUtY2FzZXMtZm9yLXR5cGUtcmVwb3J0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBQyxTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBcUIsTUFBTSxFQUEyQixNQUFNLGVBQWUsQ0FBQztBQUdsSCxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSxzREFBc0QsQ0FBQztBQUN2RixPQUFPLEVBQUMsMEJBQTBCLEVBQUMsTUFBTSwrQ0FBK0MsQ0FBQztBQUV6RixPQUFPLEVBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNwRCxPQUFPLDJCQUEyQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxjQUFjLEVBQUUsa0JBQWtCLEVBQUMsTUFBTSw0Q0FBNEMsQ0FBQzs7Ozs7O0FBUTlGO0lBSytELHFFQUFpQjtJQXFJOUUsbURBQW9CLGdCQUE0QztRQUFoRSxZQUNFLGlCQUFPLFNBQ1I7UUFGbUIsc0JBQWdCLEdBQWhCLGdCQUFnQixDQUE0Qjs7OztRQTFHdkQsb0JBQWMsR0FBVyxLQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxLQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Ozs7UUFLdkUscUJBQWUsR0FBRyxLQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxLQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7Ozs7O1FBTXJFLDJCQUFxQixHQUErQyxJQUFJLFlBQVksRUFBZ0MsQ0FBQztR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Ozs7SUE5RFcscUVBQW9EIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE9uQ2hhbmdlcywgT25Jbml0LCBPdXRwdXQsIFNpbXBsZUNoYW5nZXMsIFZpZXdDaGlsZH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0NoYXJ0VHlwZX0gZnJvbSAnY2hhcnQuanMnO1xuaW1wb3J0IHtMYWJlbCwgTXVsdGlEYXRhU2V0fSBmcm9tICduZzItY2hhcnRzJztcbmltcG9ydCB7TGl2ZUFwcHNDb21wb25lbnR9IGZyb20gJy4uL2xpdmUtYXBwcy1jb21wb25lbnQvbGl2ZS1hcHBzLWNvbXBvbmVudC5jb21wb25lbnQnO1xuaW1wb3J0IHtUY0xpdmVBcHBzUmVwb3J0aW5nU2VydmljZX0gZnJvbSAnLi4vLi4vc2VydmljZXMvdGMtbGl2ZS1hcHBzLXJlcG9ydGluZy5zZXJ2aWNlJztcbmltcG9ydCB7Q2FzZVR5cGVTdGF0ZVJlcG9ydCwgQ2FzZVR5cGVTdGF0ZVJlcG9ydFN0YXRlSW5mb30gZnJvbSAnLi4vLi4vbW9kZWxzL3RjLWxpdmUtYXBwcy1yZXBvcnRpbmcnO1xuaW1wb3J0IHttYXAsIHRha2UsIHRha2VVbnRpbH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0ICdjaGFydGpzLXBsdWdpbi1kYXRhbGFiZWxzJztcbmltcG9ydCB7REVGQVVMVF9DT0xPUlMsIERFRkFVTFRfVFlQRV9DT0xPUn0gZnJvbSAnLi4vLi4vc2VydmljZXMvdGMtY2FzZS1jYXJkLWNvbmZpZy5zZXJ2aWNlJztcblxuXG4vKipcbiAqIEhvbWUgcGFnZSBhY3RpdmUgY2FzZXMgd2lkZ2V0IHN1YiBjb21wb25lbnRcbiAqXG4gKkBleGFtcGxlIDx0Y2xhLWxpdmUtYXBwcy1hY3RpdmUtY2FzZXMtZm9yLXR5cGUtcmVwb3J0PjwvdGNsYS1saXZlLWFwcHMtYWN0aXZlLWNhc2VzLWZvci10eXBlLXJlcG9ydD5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAndGNsYS1saXZlLWFwcHMtYWN0aXZlLWNhc2VzLWZvci10eXBlLXJlcG9ydCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9saXZlLWFwcHMtYWN0aXZlLWNhc2VzLWZvci10eXBlLXJlcG9ydC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2xpdmUtYXBwcy1hY3RpdmUtY2FzZXMtZm9yLXR5cGUtcmVwb3J0LmNvbXBvbmVudC5jc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBMaXZlQXBwc0FjdGl2ZUNhc2VzRm9yVHlwZVJlcG9ydENvbXBvbmVudCBleHRlbmRzIExpdmVBcHBzQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMge1xuXG5cblxuICAvKipcbiAgICogc2FuZGJveElkIC0gdGhpcyBjb21lcyBmcm9tIGNsYWltcyByZXNvbHZlclxuICAgKi9cbiAgQElucHV0KCkgc2FuZGJveElkOiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBMQSBBcHBsaWNhdGlvbiBJZFxuICAgKi9cbiAgQElucHV0KCkgYXBwSWQ6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIExBIEFwcGxpY2F0aW9uIFR5cGUgSWQgKGdlbmVyYWxseSAxKVxuICAgKi9cbiAgQElucHV0KCkgdHlwZUlkOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBBcHBsaWNhdGlvbiBJRCBvZiB0aGUgVUkgKHNob3VsZCBpZGVhbGx5IGJlIHVuaXF1ZSBhcyBpdCBpcyBzaGFyZWQgc3RhdGUga2V5KVxuICAgKi9cbiAgQElucHV0KCkgdWlBcHBJZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBNYXhpbXVtIHJvd3MgdG8gc2hvdyBpbiBsZWdlbmQgYmVmb3JlIGl0IGlzIGhpZGRlbiAob3RoZXJ3aXNlIHdvdWxkIHRha2Ugd2hvbGUgd2lkZ2V0KVxuICAgKi9cbiAgQElucHV0KCkgbWF4TGVnZW5kSXRlbXM6IG51bWJlciA9IHRoaXMubWF4TGVnZW5kSXRlbXMgPyB0aGlzLm1heExlZ2VuZEl0ZW1zIDogODtcblxuICAvKipcbiAgICogV2hldGhlciB0byBzaG93IHBlcmNlbnRhZ2VzIG9yIHJhdyBjYXNlIG51bWJlcnMgb24gdGhlIGRvdWdobnV0IGNoYXJ0XG4gICAqL1xuICBASW5wdXQoKSBzaG93UGVyY2VudGFnZXMgPSB0aGlzLnNob3dQZXJjZW50YWdlcyA/IHRoaXMuc2hvd1BlcmNlbnRhZ2VzIDogZmFsc2U7XG5cbiAgLyoqXG4gICAqIH5ldmVudCBzZWxlY3RlZENhc2VUeXBlU3RhdGUgOiBDYXNlIFR5cGUgc3RhdGUgc2VsZWN0ZWQgaW4gdml6dWFsaXphdGlvblxuICAgKiB+cGF5bG9hZCBDYXNlVHlwZVN0YXRlUmVwb3J0U3RhdGVJbmZvIDogQ2FzZVR5cGVTdGF0ZVJlcG9ydFN0YXRlSW5mbyBvYmplY3Qgc2VsZWN0ZWQgZnJvbSBjb21wb25lbnQgKHRvIGRyaXZlIGNhbGxlciB0byBkaXNwbGF5IHNvbWV0aGluZyBkaWZmZXJlbnQgKGRyaWxsIGRvd24pKVxuICAgKi9cbiAgQE91dHB1dCgpIHNlbGVjdGVkQ2FzZVR5cGVTdGF0ZTogRXZlbnRFbWl0dGVyPENhc2VUeXBlU3RhdGVSZXBvcnRTdGF0ZUluZm8+ID0gbmV3IEV2ZW50RW1pdHRlcjxDYXNlVHlwZVN0YXRlUmVwb3J0U3RhdGVJbmZvPigpO1xuXG4gIC8vIEBWaWV3Q2hpbGQoQmFzZUNoYXJ0RGlyZWN0aXZlKSBjYXNlVHlwZVN0YXRlUmVwb3J0Q2hhcnQ6IEJhc2VDaGFydERpcmVjdGl2ZTtcblxuICBwdWJsaWMgZXJyb3JNZXNzYWdlOiBzdHJpbmc7XG4gIHB1YmxpYyBjYXNlVHlwZVN0YXRlUmVwb3J0OiBDYXNlVHlwZVN0YXRlUmVwb3J0O1xuICBwdWJsaWMgcmVuZGVyQ2hhcnQgPSBmYWxzZTtcblxuICBwdWJsaWMgZG91Z2hudXRDaGFydExhYmVsczogTGFiZWxbXTtcbiAgcHVibGljIGRvdWdobnV0Q2hhcnREYXRhOiBNdWx0aURhdGFTZXQgPSBbXTtcbiAgcHVibGljIGRvdWdobnV0Q2hhcnRUeXBlOiBDaGFydFR5cGUgPSAnZG91Z2hudXQnO1xuICBwdWJsaWMgY2hhcnRDb2xvcnM6IGFueVtdID0gW107XG4gIHB1YmxpYyBkZWZhdWx0Q29sb3JzOiBzdHJpbmdbXSA9IERFRkFVTFRfQ09MT1JTLnNsaWNlKCkucmV2ZXJzZSgpO1xuXG4gIHB1YmxpYyBsZWdlbmREYXRhOiBhbnk7XG4gIHB1YmxpYyB0b3RhbEFjdGl2ZUNhc2VDb3VudDogbnVtYmVyO1xuXG4gIHByaXZhdGUgZ2V0Q2FzZUNvdW50ID0gKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLnRvdGFsQWN0aXZlQ2FzZUNvdW50O1xuICB9XG5cbiAgcHVibGljIGRvdWdobnV0Q2hhcnRPcHRpb25zOiBhbnkgPSB7XG4gICAgcmVzcG9uc2l2ZTogdHJ1ZSxcbiAgICBtYWludGFpbkFzcGVjdFJhdGlvOiBmYWxzZSxcbiAgICBsZWdlbmQ6IHtcbiAgICAgIHBvc2l0aW9uOiAnbGVmdCdcbiAgICB9LFxuICAgIGxheW91dDoge1xuICAgICAgcGFkZGluZzoge1xuICAgICAgICBsZWZ0OiAwLFxuICAgICAgICByaWdodDogMCxcbiAgICAgICAgdG9wOiAxMCxcbiAgICAgICAgYm90dG9tOiAxMFxuICAgICAgfVxuICAgIH0sXG4gICAgcGx1Z2luczoge1xuICAgICAgZG91Z2hudXRsYWJlbDoge1xuICAgICAgICBsYWJlbHM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0ZXh0OiB0aGlzLmdldENhc2VDb3VudCxcbiAgICAgICAgICAgIGZvbnQ6IHtcbiAgICAgICAgICAgICAgc2l6ZTogJzIwJyxcbiAgICAgICAgICAgICAgZmFtaWx5OiAnU291cmNlIFNhbnMgUHJvJyxcbiAgICAgICAgICAgICAgd2VpZ2h0OiAnYm9sZCdcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjb2xvcjogJyNGRjc4MDAnXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0ZXh0OiAnY2FzZXMnLFxuICAgICAgICAgICAgZm9udDoge1xuICAgICAgICAgICAgICBzaXplOiAnMTYnLFxuICAgICAgICAgICAgICBmYW1pbHk6ICdTb3VyY2UgU2FucyBQcm8nLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNvbG9yOiAnI0ZGNzgwMCdcbiAgICAgICAgICB9XG4gICAgICAgIF1cbiAgICAgIH0sXG4gICAgICBkYXRhbGFiZWxzOiB7XG4gICAgICAgIGFuY2hvcjogJ2VuZCcsXG4gICAgICAgIGJhY2tncm91bmRDb2xvcjogZnVuY3Rpb24oY29udGV4dCkge1xuICAgICAgICAgIHJldHVybiBjb250ZXh0LmRhdGFzZXQuYmFja2dyb3VuZENvbG9yO1xuICAgICAgICB9LFxuICAgICAgICBib3JkZXJDb2xvcjogJ3doaXRlJyxcbiAgICAgICAgYm9yZGVyUmFkaXVzOiAyNSxcbiAgICAgICAgYm9yZGVyV2lkdGg6IDIsXG4gICAgICAgIGNvbG9yOiAnd2hpdGUnLFxuICAgICAgICBkaXNwbGF5OiBmdW5jdGlvbihjb250ZXh0KSB7XG4gICAgICAgICAgY29uc3QgZGF0YXNldCA9IGNvbnRleHQuZGF0YXNldDtcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IGRhdGFzZXQuZGF0YVtjb250ZXh0LmRhdGFJbmRleF07XG4gICAgICAgICAgcmV0dXJuIHZhbHVlID4gMDtcbiAgICAgICAgfSxcbiAgICAgICAgZm9udDoge1xuICAgICAgICAgIHdlaWdodDogJ2JvbGQnXG4gICAgICAgIH0sXG4gICAgICAgIGZvcm1hdHRlcjogKHZhbHVlLCBjdHgpID0+IHtcblxuICAgICAgICAgIGNvbnN0IGRhdGFzZXRzID0gY3R4LmNoYXJ0LmRhdGEuZGF0YXNldHM7XG5cbiAgICAgICAgICBpZiAoZGF0YXNldHMuaW5kZXhPZihjdHguZGF0YXNldCkgPT09IGRhdGFzZXRzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnNob3dQZXJjZW50YWdlcykge1xuICAgICAgICAgICAgICBjb25zdCBzdW0gPSBkYXRhc2V0c1swXS5kYXRhLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApO1xuICAgICAgICAgICAgICBjb25zdCBwZXJjZW50YWdlID0gTWF0aC5yb3VuZCgodmFsdWUgLyBzdW0pICogMTAwKSArICclJztcbiAgICAgICAgICAgICAgcmV0dXJuIHBlcmNlbnRhZ2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgfVxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVwb3J0aW5nU2VydmljZTogVGNMaXZlQXBwc1JlcG9ydGluZ1NlcnZpY2UpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0UmVwb3J0RGF0YVRvQ2hhcnQgPSAocmVwb3J0RGF0YTogQ2FzZVR5cGVTdGF0ZVJlcG9ydCwgc3RhdHVzOiBzdHJpbmcpID0+IHtcbiAgICB0aGlzLmRvdWdobnV0Q2hhcnREYXRhID0gW107XG4gICAgdGhpcy50b3RhbEFjdGl2ZUNhc2VDb3VudCA9IDA7XG4gICAgY29uc3QgY2FzZXNCeVN0YXRlQXJyYXk6IG51bWJlcltdID0gW107XG4gICAgY29uc3QgbGFiZWxzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IGNvbG9yQXJyYXk6IHN0cmluZ1tdID0gW107XG4gICAgLy8gcmVtb3ZlIGFueSB0YWtlbiBjb2xvcnMgZnJvbSB0aGUgZGVmYXVsdENvbG9yc1xuICAgIC8vIHdlIGhhdmUgdG8gZG8gdGhpcyBiZWZvcmUgcGFyc2luZyB0aGUgcmVjb3JkIHRvIGF2b2lkIGdldHRpbmcgc2FtZSBjb2xvcnNcbiAgICByZXBvcnREYXRhLmNhc2VTdGF0ZXMuZm9yRWFjaChjcyA9PiB7XG4gICAgICAvLyByZW1vdmUgY29sb3IgZnJvbSBkZWZhdWx0c1xuICAgICAgaWYgKGNzLnN0YXRlSW5mby5jb2xvcikge1xuICAgICAgICB0aGlzLmRlZmF1bHRDb2xvcnMgPSB0aGlzLmRlZmF1bHRDb2xvcnMuZmlsdGVyKGl0ZW0gPT4gaXRlbSAhPT0gY3Muc3RhdGVJbmZvLmNvbG9yKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICAvLyBwYXJzZSByZWNvcmRcbiAgICByZXBvcnREYXRhLmNhc2VTdGF0ZXMuZm9yRWFjaChjYXNlU3RhdGUgPT4ge1xuICAgICAgICB0aGlzLnRvdGFsQWN0aXZlQ2FzZUNvdW50ID0gdGhpcy50b3RhbEFjdGl2ZUNhc2VDb3VudCArIGNhc2VTdGF0ZS5jYXNlQ291bnQ7XG4gICAgICAgIGNhc2VzQnlTdGF0ZUFycmF5LnB1c2goY2FzZVN0YXRlLmNhc2VDb3VudCk7XG4gICAgICAgIGxhYmVscy5wdXNoKGNhc2VTdGF0ZS5zdGF0ZUluZm8ubGFiZWwpO1xuICAgICAgLy8gd2Ugd2lsbCByZS1jb2xvciBhbnl0aGluZyB0aGF0IGhhcyB0aGUgZGVmYXVsdCBjb2xvclxuICAgICAgbGV0IGNvbDogc3RyaW5nO1xuICAgICAgaWYgKGNhc2VTdGF0ZS5zdGF0ZUluZm8uY29sb3IgJiYgY2FzZVN0YXRlLnN0YXRlSW5mby5jb2xvciAhPT0gREVGQVVMVF9UWVBFX0NPTE9SKSB7XG4gICAgICAgIC8vIHVzZSB0aGUgc2V0IGNvbG9yXG4gICAgICAgIGNvbCA9IGNhc2VTdGF0ZS5zdGF0ZUluZm8uY29sb3I7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyB0cnkgYW5kIGdldCBhIGNvbG9yIGZyb20gdGhlIHBhbGV0dGVcbiAgICAgICAgY29uc3QgcGFsQ29sID0gdGhpcy5kZWZhdWx0Q29sb3JzLnBvcCgpO1xuICAgICAgICBpZiAocGFsQ29sKSB7XG4gICAgICAgICAgY29sID0gcGFsQ29sO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIGlmIG5vIG1vcmUgaW4gcGFsZXR0ZSB1c2UgYSByYW5kb20gY29sb3IhXG4gICAgICAgICAgY29uc3QgaSA9IE1hdGgucmFuZG9tKCkgKiAweGZmZmZmZjtcbiAgICAgICAgICBjb25zdCBwID0gcGFyc2VJbnQoaS50b1N0cmluZygpLCAwKTtcbiAgICAgICAgICBjb2wgPSAnIycgKyBwLnRvU3RyaW5nKDE2KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29sb3JBcnJheS5wdXNoKGNvbCk7XG4gICAgfSk7XG4gICAgdGhpcy5kb3VnaG51dENoYXJ0RGF0YS5wdXNoKGNhc2VzQnlTdGF0ZUFycmF5KTtcbiAgICB0aGlzLmRvdWdobnV0Q2hhcnRMYWJlbHMgPSBsYWJlbHM7XG4gICAgdGhpcy5jaGFydENvbG9ycy5wdXNoKCB7IGJhY2tncm91bmRDb2xvcjogY29sb3JBcnJheX0pO1xuICAgIC8vIHNob3dpbmcgbW9yZSB0aGFuIDggaW4gdGhlIGxlZ2VuZCB3aWxsIHRha2UgdXAgdG9vIG11Y2ggc3BhY2VcbiAgICB0aGlzLmRvdWdobnV0Q2hhcnRPcHRpb25zLmxlZ2VuZC5kaXNwbGF5ID0gbGFiZWxzLmxlbmd0aCA8PSA4O1xuICAgIHRoaXMucmVuZGVyQ2hhcnQgPSB0cnVlO1xuICB9XG5cbiAgcHVibGljIHJlZnJlc2ggPSAoKSA9PiB7XG4gICAgdGhpcy5yZXBvcnRpbmdTZXJ2aWNlLmdldENhc2VUeXBlU3RhdGVSZXBvcnQodGhpcy5zYW5kYm94SWQsIHRoaXMuYXBwSWQsIHRoaXMudHlwZUlkLCBmYWxzZSwgdGhpcy51aUFwcElkKS5waXBlKFxuICAgICAgdGFrZSgxKSxcbiAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95ZWQkKSxcbiAgICAgIG1hcChyZXBvcnQgPT4ge1xuICAgICAgICB0aGlzLmNhc2VUeXBlU3RhdGVSZXBvcnQgPSByZXBvcnQ7XG4gICAgICAgIHRoaXMuaW5pdFJlcG9ydERhdGFUb0NoYXJ0KHJlcG9ydCwgc3RhdHVzKTtcbiAgICAgICAgcmV0dXJuIHJlcG9ydDtcbiAgICAgIH0pKVxuICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgbnVsbCwgZXJyb3IgPT4geyB0aGlzLmVycm9yTWVzc2FnZSA9ICdFcnJvciByZXRyaWV2aW5nIGNhc2UgdHlwZXMgcmVwb3J0OiAnICsgZXJyb3IuZXJyb3IuZXJyb3JNc2c7IH1cbiAgICAgICk7XG4gIH1cblxuICAvLyBldmVudHNcbiAgcHVibGljIGNoYXJ0Q2xpY2tlZCh7IGV2ZW50LCBhY3RpdmUgfTogeyBldmVudDogTW91c2VFdmVudCwgYWN0aXZlOiBhbnkgfSk6IHZvaWQge1xuICAgIGlmIChhY3RpdmUubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgY2hhcnQgPSBhY3RpdmVbMF0uX2NoYXJ0O1xuICAgICAgY29uc3QgYWN0aXZlUG9pbnRzOiBhbnkgPSBjaGFydC5nZXRFbGVtZW50QXRFdmVudChldmVudCk7XG4gICAgICBpZiAoIGFjdGl2ZVBvaW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIC8vIGdldCB0aGUgaW50ZXJuYWwgaW5kZXggb2Ygc2xpY2UgaW4gcGllIGNoYXJ0XG4gICAgICAgIGNvbnN0IGNsaWNrZWRFbGVtZW50SW5kZXggPSBhY3RpdmVQb2ludHNbMF0uX2luZGV4O1xuICAgICAgICBjb25zdCBsYWJlbCA9IGNoYXJ0LmRhdGEubGFiZWxzW2NsaWNrZWRFbGVtZW50SW5kZXhdO1xuICAgICAgICAvLyBnZXQgdmFsdWUgYnkgaW5kZXhcbiAgICAgICAgY29uc3QgdmFsdWUgPSBjaGFydC5kYXRhLmRhdGFzZXRzWzBdLmRhdGFbY2xpY2tlZEVsZW1lbnRJbmRleF07XG4gICAgICAgIGNvbnNvbGUubG9nKGNsaWNrZWRFbGVtZW50SW5kZXgsIGxhYmVsLCB2YWx1ZSk7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRDYXNlVHlwZVN0YXRlLmVtaXQodGhpcy5jYXNlVHlwZVN0YXRlUmVwb3J0LmNhc2VTdGF0ZXNbY2xpY2tlZEVsZW1lbnRJbmRleF0uc3RhdGVJbmZvKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY2hhcnRIb3ZlcmVkKHsgZXZlbnQsIGFjdGl2ZSB9OiB7IGV2ZW50OiBNb3VzZUV2ZW50LCBhY3RpdmU6IHt9W10gfSk6IHZvaWQge1xuICAgIC8vIGNvbnNvbGUubG9nKGV2ZW50LCBhY3RpdmUpO1xuICB9XG5cblxuICBuZ09uSW5pdCgpIHtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoY2hhbmdlcy5hcHBJZCAmJiAoY2hhbmdlcy5maXJzdENoYW5nZSB8fCAoY2hhbmdlcy5hcHBJZC5jdXJyZW50VmFsdWUgIT09IGNoYW5nZXMuYXBwSWQucHJldmlvdXNWYWx1ZSkpKSB7XG4gICAgICB0aGlzLnJlZnJlc2goKTtcbiAgICB9XG4gIH1cblxufVxuIl19