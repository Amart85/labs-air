/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { BaseChartDirective } from 'ng2-charts';
import { TcLiveAppsReportingService } from '../../services/tc-live-apps-reporting.service';
import { LiveAppsComponent } from '../live-apps-component/live-apps-component.component';
import { map, take, takeUntil } from 'rxjs/operators';
import { DEFAULT_COLORS, DEFAULT_TYPE_COLOR } from '../../services/tc-case-card-config.service';
/**
 * Home page active cases widget sub component
 *
 * \@example <tcla-live-apps-active-cases-report></tcla-live-apps-active-cases-report>
 */
var LiveAppsActiveCasesReportComponent = /** @class */ (function (_super) {
    tslib_1.__extends(LiveAppsActiveCasesReportComponent, _super);
    function LiveAppsActiveCasesReportComponent(reportingService) {
        var _this = _super.call(this) || this;
        _this.reportingService = reportingService;
        /**
         * Maximum rows to show in legend before it is hidden (otherwise would take whole widget)
         */
        _this.maxLegendItems = _this.maxLegendItems ? _this.maxLegendItems : 8;
        /**
         * Whether to show percentages or raw case numbers on the doughnut chart
         */
        _this.showPercentages = _this.showPercentages ? _this.showPercentages : false;
        /**
         * ~event selectedCaseType : Case Type selected in vizualization
         * ~payload CaseTypeReportRecord : CaseTypeReportRecord object selected from component
         */
        _this.selectedCaseType = new EventEmitter();
        _this.renderChart = false;
        _this.doughnutChartData = [];
        _this.doughnutChartType = 'doughnut';
        _this.chartColors = [];
        _this.defaultColors = DEFAULT_COLORS.slice().reverse();
        _this.getCaseCount = (/**
         * @return {?}
         */
        function () {
            return _this.totalActiveCaseCount;
        });
        _this.doughnutChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
                display: false,
                position: 'left'
            },
            layout: {
                padding: {
                    left: 0,
                    right: 0,
                    top: 10,
                    bottom: 10
                }
            },
            plugins: {
                doughnutlabel: {
                    labels: [
                        {
                            text: _this.getCaseCount,
                            font: {
                                size: '20',
                                family: 'Source Sans Pro',
                                weight: 'bold'
                            },
                            color: '#b6b6b6'
                        },
                        {
                            text: 'cases',
                            font: {
                                size: '16',
                                family: 'Source Sans Pro',
                            },
                            color: '#b6b6b6'
                        }
                    ]
                },
                datalabels: {
                    anchor: 'end',
                    backgroundColor: (/**
                     * @param {?} context
                     * @return {?}
                     */
                    function (context) {
                        return context.dataset.backgroundColor;
                    }),
                    borderColor: 'white',
                    borderRadius: 25,
                    borderWidth: 2,
                    color: 'white',
                    display: (/**
                     * @param {?} context
                     * @return {?}
                     */
                    function (context) {
                        /** @type {?} */
                        var dataset = context.dataset;
                        /** @type {?} */
                        var value = dataset.data[context.dataIndex];
                        return value > 0;
                    }),
                    font: {
                        weight: 'bold'
                    },
                    formatter: (/**
                     * @param {?} value
                     * @param {?} ctx
                     * @return {?}
                     */
                    function (value, ctx) {
                        /** @type {?} */
                        var datasets = ctx.chart.data.datasets;
                        if (datasets.indexOf(ctx.dataset) === datasets.length - 1) {
                            if (_this.showPercentages) {
                                /** @type {?} */
                                var sum = datasets[0].data.reduce((/**
                                 * @param {?} a
                                 * @param {?} b
                                 * @return {?}
                                 */
                                function (a, b) { return a + b; }), 0);
                                /** @type {?} */
                                var percentage = Math.round((value / sum) * 100) + '%';
                                return percentage;
                            }
                            else {
                                return value;
                            }
                        }
                        else {
                            return 0;
                        }
                    })
                }
            }
        };
        _this.initReportDataToChart = (/**
         * @param {?} reportData
         * @return {?}
         */
        function (reportData) {
            _this.doughnutChartData = [];
            _this.totalActiveCaseCount = 0;
            /** @type {?} */
            var activeCasesArray = [];
            /** @type {?} */
            var labels = [];
            /** @type {?} */
            var colorArray = [];
            // remove any taken colors from the defaultColors
            // we have to do this before parsing the record to avoid getting same colors
            reportData.caseTypes.forEach((/**
             * @param {?} ct
             * @return {?}
             */
            function (ct) {
                // remove color from defaults
                if (ct.caseTypeInfo.color) {
                    _this.defaultColors = _this.defaultColors.filter((/**
                     * @param {?} item
                     * @return {?}
                     */
                    function (item) { return item !== ct.caseTypeInfo.color; }));
                }
            }));
            // parse record
            reportData.caseTypes.forEach((/**
             * @param {?} caseType
             * @return {?}
             */
            function (caseType) {
                activeCasesArray.push(caseType.activeStateCaseCount);
                _this.totalActiveCaseCount = _this.totalActiveCaseCount + caseType.activeStateCaseCount;
                _this.totalTerminatedCaseCount = _this.totalTerminatedCaseCount + caseType.terminalStateCaseCount;
                labels.push(caseType.caseTypeInfo.label);
                // we will re-color anything that has the default color
                /** @type {?} */
                var col;
                if (caseType.caseTypeInfo.color && caseType.caseTypeInfo.color !== DEFAULT_TYPE_COLOR) {
                    // use the set color
                    col = caseType.caseTypeInfo.color;
                }
                else {
                    // try and get a color from the palette
                    /** @type {?} */
                    var palCol = _this.defaultColors.pop();
                    if (palCol) {
                        col = palCol;
                    }
                    else {
                        // if no more in palette use a random color!
                        /** @type {?} */
                        var i = Math.random() * 0xffffff;
                        /** @type {?} */
                        var p = parseInt(i.toString(), 0);
                        col = '#' + p.toString(16);
                    }
                }
                colorArray.push(col);
            }));
            // showing more than 8 in the legend will take up too much space
            _this.doughnutChartOptions.legend.display = labels.length <= 8;
            _this.doughnutChartData = activeCasesArray;
            _this.doughnutChartLabels = labels;
            _this.chartColors.push({ backgroundColor: colorArray });
            _this.renderChart = true;
        });
        _this.refresh = (/**
         * @return {?}
         */
        function () {
            _this.reportingService.getCaseTypesReport(_this.sandboxId, _this.appIds, _this.uiAppId).pipe(take(1), takeUntil(_this._destroyed$), map((/**
             * @param {?} report
             * @return {?}
             */
            function (report) {
                _this.caseTypesReport = report;
                _this.initReportDataToChart(report);
                return report;
            })))
                .subscribe(null, (/**
             * @param {?} error
             * @return {?}
             */
            function (error) { _this.errorMessage = 'Error retrieving case types report: ' + error.error.errorMsg; }));
        });
        return _this;
    }
    // events
    // events
    /**
     * @param {?} __0
     * @return {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.chartClicked = 
    // events
    /**
     * @param {?} __0
     * @return {?}
     */
    function (_a) {
        var event = _a.event, active = _a.active;
        if (active.length > 0) {
            /** @type {?} */
            var chart = active[0]._chart;
            /** @type {?} */
            var activePoints = chart.getElementAtEvent(event);
            if (activePoints.length > 0) {
                // get the internal index of slice in pie chart
                /** @type {?} */
                var clickedElementIndex = activePoints[0]._index;
                /** @type {?} */
                var label = chart.data.labels[clickedElementIndex];
                // get value by index
                /** @type {?} */
                var value = chart.data.datasets[0].data[clickedElementIndex];
                this.caseTypesReport.caseTypes[clickedElementIndex].incTerminal = false;
                this.selectedCaseType.emit(this.caseTypesReport.caseTypes[clickedElementIndex]);
            }
        }
    };
    /**
     * @param {?} __0
     * @return {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.chartHovered = /**
     * @param {?} __0
     * @return {?}
     */
    function (_a) {
        var event = _a.event, active = _a.active;
        // console.log(event, active);
    };
    /**
     * @return {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.refresh();
    };
    LiveAppsActiveCasesReportComponent.decorators = [
        { type: Component, args: [{
                    selector: 'tcla-live-apps-active-cases-report',
                    template: "  <div fxLayout=\"column\" fxFlex style=\"overflow: auto\">\n    <div *ngIf=\"renderChart\" style=\"height:100%; width:100%; padding: 20px\" class=\"relative\">\n      <canvas #caseReportChart baseChart\n              [data]=\"doughnutChartData\"\n              [labels]=\"doughnutChartLabels\"\n              [chartType]=\"doughnutChartType\"\n              [options]=\"doughnutChartOptions\"\n              [colors]=\"chartColors\"\n              (chartHover)=\"chartHovered($event)\"\n              (chartClick)=\"chartClicked($event)\"\n      >\n      </canvas>\n    </div>\n  </div>\n",
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    LiveAppsActiveCasesReportComponent.ctorParameters = function () { return [
        { type: TcLiveAppsReportingService }
    ]; };
    LiveAppsActiveCasesReportComponent.propDecorators = {
        sandboxId: [{ type: Input }],
        appIds: [{ type: Input }],
        showHeader: [{ type: Input }],
        uiAppId: [{ type: Input }],
        maxLegendItems: [{ type: Input }],
        showPercentages: [{ type: Input }],
        selectedCaseType: [{ type: Output }],
        caseReportChart: [{ type: ViewChild, args: [BaseChartDirective, { static: false },] }]
    };
    return LiveAppsActiveCasesReportComponent;
}(LiveAppsComponent));
export { LiveAppsActiveCasesReportComponent };
if (false) {
    /**
     * sandboxId - this comes from claims resolver
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.sandboxId;
    /**
     * The list of LA Application IDs you want to handle
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.appIds;
    /**
     * Whether to show the header bar in the widget - eg. favorites on home page (contains icon etc) - if off icons still appear without bar
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.showHeader;
    /**
     * The Application ID of the UI (should ideally be unique as it is shared state key)
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.uiAppId;
    /**
     * Maximum rows to show in legend before it is hidden (otherwise would take whole widget)
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.maxLegendItems;
    /**
     * Whether to show percentages or raw case numbers on the doughnut chart
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.showPercentages;
    /**
     * ~event selectedCaseType : Case Type selected in vizualization
     * ~payload CaseTypeReportRecord : CaseTypeReportRecord object selected from component
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.selectedCaseType;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.caseReportChart;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.errorMessage;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.caseTypesReport;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.totalActiveCaseCount;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.totalTerminatedCaseCount;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.renderChart;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.doughnutChartLabels;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.doughnutChartData;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.doughnutChartType;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.chartColors;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.defaultColors;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.legendData;
    /**
     * @type {?}
     * @private
     */
    LiveAppsActiveCasesReportComponent.prototype.getCaseCount;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.doughnutChartOptions;
    /**
     * @type {?}
     * @private
     */
    LiveAppsActiveCasesReportComponent.prototype.initReportDataToChart;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.refresh;
    /**
     * @type {?}
     * @private
     */
    LiveAppsActiveCasesReportComponent.prototype.reportingService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS1hcHBzLWFjdGl2ZS1jYXNlcy1yZXBvcnQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRpYmNvLXRjc3RrL3RjLWxpdmVhcHBzLWxpYi8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2xpdmUtYXBwcy1hY3RpdmUtY2FzZXMtcmVwb3J0L2xpdmUtYXBwcy1hY3RpdmUtY2FzZXMtcmVwb3J0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBQyxTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBVSxNQUFNLEVBQUUsU0FBUyxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBRXhGLE9BQU8sRUFBQyxrQkFBa0IsRUFBb0QsTUFBTSxZQUFZLENBQUM7QUFFakcsT0FBTyxFQUFDLDBCQUEwQixFQUFDLE1BQU0sK0NBQStDLENBQUM7QUFDekYsT0FBTyxFQUFDLGlCQUFpQixFQUFDLE1BQU0sc0RBQXNELENBQUM7QUFDdkYsT0FBTyxFQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFHcEQsT0FBTyxFQUFDLGNBQWMsRUFBRSxrQkFBa0IsRUFBQyxNQUFNLDRDQUE0QyxDQUFDOzs7Ozs7QUFPOUY7SUFLd0QsOERBQWlCO0lBRXZFLDRDQUFvQixnQkFBNEM7UUFBaEUsWUFDRSxpQkFBTyxTQUNSO1FBRm1CLHNCQUFnQixHQUFoQixnQkFBZ0IsQ0FBNEI7Ozs7UUEyQnZELG9CQUFjLEdBQVcsS0FBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsS0FBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDOzs7O1FBS3ZFLHFCQUFlLEdBQUcsS0FBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsS0FBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDOzs7OztRQU9yRSxzQkFBZ0IsR0FBdUMsSUFBSSxZQUFZLEVBQXdCLENBQUM7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bnB1dCwgT25Jbml0LCBPdXRwdXQsIFZpZXdDaGlsZH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0Nhc2VUeXBlUmVwb3J0UmVjb3JkLCBDYXNlVHlwZXNSZXBvcnR9IGZyb20gJy4uLy4uL21vZGVscy90Yy1saXZlLWFwcHMtcmVwb3J0aW5nJztcbmltcG9ydCB7QmFzZUNoYXJ0RGlyZWN0aXZlLCBkZWZhdWx0Q29sb3JzLCBMYWJlbCwgTXVsdGlEYXRhU2V0LCBTaW5nbGVEYXRhU2V0fSBmcm9tICduZzItY2hhcnRzJztcbmltcG9ydCB7Q2hhcnRUeXBlfSBmcm9tICdjaGFydC5qcyc7XG5pbXBvcnQge1RjTGl2ZUFwcHNSZXBvcnRpbmdTZXJ2aWNlfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy90Yy1saXZlLWFwcHMtcmVwb3J0aW5nLnNlcnZpY2UnO1xuaW1wb3J0IHtMaXZlQXBwc0NvbXBvbmVudH0gZnJvbSAnLi4vbGl2ZS1hcHBzLWNvbXBvbmVudC9saXZlLWFwcHMtY29tcG9uZW50LmNvbXBvbmVudCc7XG5pbXBvcnQge21hcCwgdGFrZSwgdGFrZVVudGlsfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7Y29weX0gZnJvbSAnYW5ndWxhcjYtanNvbi1zY2hlbWEtZm9ybSc7XG5pbXBvcnQge0RFRkFVTFRfQ09MT1JTLCBERUZBVUxUX1RZUEVfQ09MT1J9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3RjLWNhc2UtY2FyZC1jb25maWcuc2VydmljZSc7XG5cbi8qKlxuICogSG9tZSBwYWdlIGFjdGl2ZSBjYXNlcyB3aWRnZXQgc3ViIGNvbXBvbmVudFxuICpcbiAqQGV4YW1wbGUgPHRjbGEtbGl2ZS1hcHBzLWFjdGl2ZS1jYXNlcy1yZXBvcnQ+PC90Y2xhLWxpdmUtYXBwcy1hY3RpdmUtY2FzZXMtcmVwb3J0PlxuICovXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd0Y2xhLWxpdmUtYXBwcy1hY3RpdmUtY2FzZXMtcmVwb3J0JyxcbiAgdGVtcGxhdGVVcmw6ICcuL2xpdmUtYXBwcy1hY3RpdmUtY2FzZXMtcmVwb3J0LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vbGl2ZS1hcHBzLWFjdGl2ZS1jYXNlcy1yZXBvcnQuY29tcG9uZW50LmNzcyddXG59KVxuZXhwb3J0IGNsYXNzIExpdmVBcHBzQWN0aXZlQ2FzZXNSZXBvcnRDb21wb25lbnQgZXh0ZW5kcyBMaXZlQXBwc0NvbXBvbmVudCBpbXBsZW1lbnRzICBPbkluaXQge1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVwb3J0aW5nU2VydmljZTogVGNMaXZlQXBwc1JlcG9ydGluZ1NlcnZpY2UpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIHNhbmRib3hJZCAtIHRoaXMgY29tZXMgZnJvbSBjbGFpbXMgcmVzb2x2ZXJcbiAgICovXG4gIEBJbnB1dCgpIHNhbmRib3hJZDogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgbGlzdCBvZiBMQSBBcHBsaWNhdGlvbiBJRHMgeW91IHdhbnQgdG8gaGFuZGxlXG4gICAqL1xuICBASW5wdXQoKSBhcHBJZHM6IHN0cmluZ1tdO1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIHNob3cgdGhlIGhlYWRlciBiYXIgaW4gdGhlIHdpZGdldCAtIGVnLiBmYXZvcml0ZXMgb24gaG9tZSBwYWdlIChjb250YWlucyBpY29uIGV0YykgLSBpZiBvZmYgaWNvbnMgc3RpbGwgYXBwZWFyIHdpdGhvdXQgYmFyXG4gICAqL1xuICBASW5wdXQoKSBzaG93SGVhZGVyOiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBUaGUgQXBwbGljYXRpb24gSUQgb2YgdGhlIFVJIChzaG91bGQgaWRlYWxseSBiZSB1bmlxdWUgYXMgaXQgaXMgc2hhcmVkIHN0YXRlIGtleSlcbiAgICovXG4gIEBJbnB1dCgpIHVpQXBwSWQ6IHN0cmluZztcblxuICAvKipcbiAgICogTWF4aW11bSByb3dzIHRvIHNob3cgaW4gbGVnZW5kIGJlZm9yZSBpdCBpcyBoaWRkZW4gKG90aGVyd2lzZSB3b3VsZCB0YWtlIHdob2xlIHdpZGdldClcbiAgICovXG4gIEBJbnB1dCgpIG1heExlZ2VuZEl0ZW1zOiBudW1iZXIgPSB0aGlzLm1heExlZ2VuZEl0ZW1zID8gdGhpcy5tYXhMZWdlbmRJdGVtcyA6IDg7XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gc2hvdyBwZXJjZW50YWdlcyBvciByYXcgY2FzZSBudW1iZXJzIG9uIHRoZSBkb3VnaG51dCBjaGFydFxuICAgKi9cbiAgQElucHV0KCkgc2hvd1BlcmNlbnRhZ2VzID0gdGhpcy5zaG93UGVyY2VudGFnZXMgPyB0aGlzLnNob3dQZXJjZW50YWdlcyA6IGZhbHNlO1xuXG5cbiAgLyoqXG4gICAqIH5ldmVudCBzZWxlY3RlZENhc2VUeXBlIDogQ2FzZSBUeXBlIHNlbGVjdGVkIGluIHZpenVhbGl6YXRpb25cbiAgICogfnBheWxvYWQgQ2FzZVR5cGVSZXBvcnRSZWNvcmQgOiBDYXNlVHlwZVJlcG9ydFJlY29yZCBvYmplY3Qgc2VsZWN0ZWQgZnJvbSBjb21wb25lbnRcbiAgICovXG4gIEBPdXRwdXQoKSBzZWxlY3RlZENhc2VUeXBlOiBFdmVudEVtaXR0ZXI8Q2FzZVR5cGVSZXBvcnRSZWNvcmQ+ID0gbmV3IEV2ZW50RW1pdHRlcjxDYXNlVHlwZVJlcG9ydFJlY29yZD4oKTtcblxuICBAVmlld0NoaWxkKEJhc2VDaGFydERpcmVjdGl2ZSwge3N0YXRpYzogZmFsc2V9KSBjYXNlUmVwb3J0Q2hhcnQ6IEJhc2VDaGFydERpcmVjdGl2ZTtcblxuICBwdWJsaWMgZXJyb3JNZXNzYWdlOiBzdHJpbmc7XG4gIHB1YmxpYyBjYXNlVHlwZXNSZXBvcnQ6IENhc2VUeXBlc1JlcG9ydDtcbiAgcHVibGljIHRvdGFsQWN0aXZlQ2FzZUNvdW50OiBudW1iZXI7XG4gIHB1YmxpYyB0b3RhbFRlcm1pbmF0ZWRDYXNlQ291bnQ6IG51bWJlcjtcbiAgcHVibGljIHJlbmRlckNoYXJ0ID0gZmFsc2U7XG5cbiAgcHVibGljIGRvdWdobnV0Q2hhcnRMYWJlbHM6IExhYmVsW107XG4gIHB1YmxpYyBkb3VnaG51dENoYXJ0RGF0YTogU2luZ2xlRGF0YVNldCA9IFtdO1xuICBwdWJsaWMgZG91Z2hudXRDaGFydFR5cGU6IENoYXJ0VHlwZSA9ICdkb3VnaG51dCc7XG4gIHB1YmxpYyBjaGFydENvbG9yczogYW55W10gPSBbXTtcbiAgcHVibGljIGRlZmF1bHRDb2xvcnM6IHN0cmluZ1tdID0gREVGQVVMVF9DT0xPUlMuc2xpY2UoKS5yZXZlcnNlKCk7XG5cbiAgcHVibGljIGxlZ2VuZERhdGE6IGFueTtcblxuICBwcml2YXRlIGdldENhc2VDb3VudCA9ICgpID0+IHtcbiAgICByZXR1cm4gdGhpcy50b3RhbEFjdGl2ZUNhc2VDb3VudDtcbiAgfVxuXG4gIHB1YmxpYyBkb3VnaG51dENoYXJ0T3B0aW9uczogYW55ID0ge1xuICAgIHJlc3BvbnNpdmU6IHRydWUsXG4gICAgbWFpbnRhaW5Bc3BlY3RSYXRpbzogZmFsc2UsXG4gICAgbGVnZW5kOiB7XG4gICAgICBkaXNwbGF5OiBmYWxzZSxcbiAgICAgIHBvc2l0aW9uOiAnbGVmdCdcbiAgICB9LFxuICAgIGxheW91dDoge1xuICAgICAgcGFkZGluZzoge1xuICAgICAgICBsZWZ0OiAwLFxuICAgICAgICByaWdodDogMCxcbiAgICAgICAgdG9wOiAxMCxcbiAgICAgICAgYm90dG9tOiAxMFxuICAgICAgfVxuICAgIH0sXG4gICAgcGx1Z2luczoge1xuICAgICAgZG91Z2hudXRsYWJlbDoge1xuICAgICAgICBsYWJlbHM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0ZXh0OiB0aGlzLmdldENhc2VDb3VudCxcbiAgICAgICAgICAgIGZvbnQ6IHtcbiAgICAgICAgICAgICAgc2l6ZTogJzIwJyxcbiAgICAgICAgICAgICAgZmFtaWx5OiAnU291cmNlIFNhbnMgUHJvJyxcbiAgICAgICAgICAgICAgd2VpZ2h0OiAnYm9sZCdcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjb2xvcjogJyNiNmI2YjYnXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0ZXh0OiAnY2FzZXMnLFxuICAgICAgICAgICAgZm9udDoge1xuICAgICAgICAgICAgICBzaXplOiAnMTYnLFxuICAgICAgICAgICAgICBmYW1pbHk6ICdTb3VyY2UgU2FucyBQcm8nLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNvbG9yOiAnI2I2YjZiNidcbiAgICAgICAgICB9XG4gICAgICAgIF1cbiAgICAgIH0sXG4gICAgICBkYXRhbGFiZWxzOiB7XG4gICAgICAgIGFuY2hvcjogJ2VuZCcsXG4gICAgICAgIGJhY2tncm91bmRDb2xvcjogZnVuY3Rpb24oY29udGV4dCkge1xuICAgICAgICAgIHJldHVybiBjb250ZXh0LmRhdGFzZXQuYmFja2dyb3VuZENvbG9yO1xuICAgICAgICB9LFxuICAgICAgICBib3JkZXJDb2xvcjogJ3doaXRlJyxcbiAgICAgICAgYm9yZGVyUmFkaXVzOiAyNSxcbiAgICAgICAgYm9yZGVyV2lkdGg6IDIsXG4gICAgICAgIGNvbG9yOiAnd2hpdGUnLFxuICAgICAgICBkaXNwbGF5OiBmdW5jdGlvbihjb250ZXh0KSB7XG4gICAgICAgICAgY29uc3QgZGF0YXNldCA9IGNvbnRleHQuZGF0YXNldDtcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IGRhdGFzZXQuZGF0YVtjb250ZXh0LmRhdGFJbmRleF07XG4gICAgICAgICAgcmV0dXJuIHZhbHVlID4gMDtcbiAgICAgICAgfSxcbiAgICAgICAgZm9udDoge1xuICAgICAgICAgIHdlaWdodDogJ2JvbGQnXG4gICAgICAgIH0sXG4gICAgICAgIGZvcm1hdHRlcjogKHZhbHVlLCBjdHgpID0+IHtcblxuICAgICAgICAgIGNvbnN0IGRhdGFzZXRzID0gY3R4LmNoYXJ0LmRhdGEuZGF0YXNldHM7XG5cbiAgICAgICAgICBpZiAoZGF0YXNldHMuaW5kZXhPZihjdHguZGF0YXNldCkgPT09IGRhdGFzZXRzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnNob3dQZXJjZW50YWdlcykge1xuICAgICAgICAgICAgICBjb25zdCBzdW0gPSBkYXRhc2V0c1swXS5kYXRhLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApO1xuICAgICAgICAgICAgICBjb25zdCBwZXJjZW50YWdlID0gTWF0aC5yb3VuZCgodmFsdWUgLyBzdW0pICogMTAwKSArICclJztcbiAgICAgICAgICAgICAgcmV0dXJuIHBlcmNlbnRhZ2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIGluaXRSZXBvcnREYXRhVG9DaGFydCA9IChyZXBvcnREYXRhOiBDYXNlVHlwZXNSZXBvcnQpID0+IHtcbiAgICB0aGlzLmRvdWdobnV0Q2hhcnREYXRhID0gW107XG4gICAgdGhpcy50b3RhbEFjdGl2ZUNhc2VDb3VudCA9IDA7XG4gICAgY29uc3QgYWN0aXZlQ2FzZXNBcnJheTogYW55W10gPSBbXTtcbiAgICBjb25zdCBsYWJlbHM6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgY29sb3JBcnJheTogc3RyaW5nW10gPSBbXTtcbiAgICAvLyByZW1vdmUgYW55IHRha2VuIGNvbG9ycyBmcm9tIHRoZSBkZWZhdWx0Q29sb3JzXG4gICAgLy8gd2UgaGF2ZSB0byBkbyB0aGlzIGJlZm9yZSBwYXJzaW5nIHRoZSByZWNvcmQgdG8gYXZvaWQgZ2V0dGluZyBzYW1lIGNvbG9yc1xuICAgIHJlcG9ydERhdGEuY2FzZVR5cGVzLmZvckVhY2goY3QgPT4ge1xuICAgICAgLy8gcmVtb3ZlIGNvbG9yIGZyb20gZGVmYXVsdHNcbiAgICAgIGlmIChjdC5jYXNlVHlwZUluZm8uY29sb3IpIHtcbiAgICAgICAgdGhpcy5kZWZhdWx0Q29sb3JzID0gdGhpcy5kZWZhdWx0Q29sb3JzLmZpbHRlcihpdGVtID0+IGl0ZW0gIT09IGN0LmNhc2VUeXBlSW5mby5jb2xvcik7XG4gICAgICB9XG4gICAgfSk7XG4gICAgLy8gcGFyc2UgcmVjb3JkXG4gICAgcmVwb3J0RGF0YS5jYXNlVHlwZXMuZm9yRWFjaChjYXNlVHlwZSA9PiB7XG4gICAgICBhY3RpdmVDYXNlc0FycmF5LnB1c2goY2FzZVR5cGUuYWN0aXZlU3RhdGVDYXNlQ291bnQpO1xuICAgICAgdGhpcy50b3RhbEFjdGl2ZUNhc2VDb3VudCA9IHRoaXMudG90YWxBY3RpdmVDYXNlQ291bnQgKyBjYXNlVHlwZS5hY3RpdmVTdGF0ZUNhc2VDb3VudDtcbiAgICAgIHRoaXMudG90YWxUZXJtaW5hdGVkQ2FzZUNvdW50ID0gdGhpcy50b3RhbFRlcm1pbmF0ZWRDYXNlQ291bnQgKyBjYXNlVHlwZS50ZXJtaW5hbFN0YXRlQ2FzZUNvdW50O1xuICAgICAgbGFiZWxzLnB1c2goY2FzZVR5cGUuY2FzZVR5cGVJbmZvLmxhYmVsKTtcbiAgICAgIC8vIHdlIHdpbGwgcmUtY29sb3IgYW55dGhpbmcgdGhhdCBoYXMgdGhlIGRlZmF1bHQgY29sb3JcbiAgICAgIGxldCBjb2w6IHN0cmluZztcbiAgICAgIGlmIChjYXNlVHlwZS5jYXNlVHlwZUluZm8uY29sb3IgJiYgY2FzZVR5cGUuY2FzZVR5cGVJbmZvLmNvbG9yICE9PSBERUZBVUxUX1RZUEVfQ09MT1IpIHtcbiAgICAgICAgLy8gdXNlIHRoZSBzZXQgY29sb3JcbiAgICAgICAgY29sID0gY2FzZVR5cGUuY2FzZVR5cGVJbmZvLmNvbG9yO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gdHJ5IGFuZCBnZXQgYSBjb2xvciBmcm9tIHRoZSBwYWxldHRlXG4gICAgICAgIGNvbnN0IHBhbENvbCA9IHRoaXMuZGVmYXVsdENvbG9ycy5wb3AoKTtcbiAgICAgICAgaWYgKHBhbENvbCkge1xuICAgICAgICAgIGNvbCA9IHBhbENvbDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBpZiBubyBtb3JlIGluIHBhbGV0dGUgdXNlIGEgcmFuZG9tIGNvbG9yIVxuICAgICAgICAgIGNvbnN0IGkgPSBNYXRoLnJhbmRvbSgpICogMHhmZmZmZmY7XG4gICAgICAgICAgY29uc3QgcCA9IHBhcnNlSW50KGkudG9TdHJpbmcoKSwgMCk7XG4gICAgICAgICAgY29sID0gJyMnICsgcC50b1N0cmluZygxNik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbG9yQXJyYXkucHVzaChjb2wpO1xuICAgIH0pO1xuICAgIC8vIHNob3dpbmcgbW9yZSB0aGFuIDggaW4gdGhlIGxlZ2VuZCB3aWxsIHRha2UgdXAgdG9vIG11Y2ggc3BhY2VcbiAgICB0aGlzLmRvdWdobnV0Q2hhcnRPcHRpb25zLmxlZ2VuZC5kaXNwbGF5ID0gbGFiZWxzLmxlbmd0aCA8PSA4O1xuICAgIHRoaXMuZG91Z2hudXRDaGFydERhdGEgPSBhY3RpdmVDYXNlc0FycmF5O1xuICAgIHRoaXMuZG91Z2hudXRDaGFydExhYmVscyA9IGxhYmVscztcbiAgICB0aGlzLmNoYXJ0Q29sb3JzLnB1c2goIHsgYmFja2dyb3VuZENvbG9yOiBjb2xvckFycmF5fSk7XG4gICAgdGhpcy5yZW5kZXJDaGFydCA9IHRydWU7XG4gIH1cblxuICBwdWJsaWMgcmVmcmVzaCA9ICgpID0+IHtcbiAgICB0aGlzLnJlcG9ydGluZ1NlcnZpY2UuZ2V0Q2FzZVR5cGVzUmVwb3J0KHRoaXMuc2FuZGJveElkLCB0aGlzLmFwcElkcywgdGhpcy51aUFwcElkKS5waXBlKFxuICAgICAgdGFrZSgxKSxcbiAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95ZWQkKSxcbiAgICAgIG1hcChyZXBvcnQgPT4ge1xuICAgICAgICB0aGlzLmNhc2VUeXBlc1JlcG9ydCA9IHJlcG9ydDtcbiAgICAgICAgdGhpcy5pbml0UmVwb3J0RGF0YVRvQ2hhcnQocmVwb3J0KTtcbiAgICAgICAgcmV0dXJuIHJlcG9ydDtcbiAgICAgIH0pKVxuICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgbnVsbCwgZXJyb3IgPT4geyB0aGlzLmVycm9yTWVzc2FnZSA9ICdFcnJvciByZXRyaWV2aW5nIGNhc2UgdHlwZXMgcmVwb3J0OiAnICsgZXJyb3IuZXJyb3IuZXJyb3JNc2c7IH1cbiAgICAgICk7XG4gIH1cblxuICAvLyBldmVudHNcbiAgcHVibGljIGNoYXJ0Q2xpY2tlZCh7IGV2ZW50LCBhY3RpdmUgfTogeyBldmVudDogTW91c2VFdmVudCwgYWN0aXZlOiBhbnkgfSk6IHZvaWQge1xuICAgIGlmIChhY3RpdmUubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgY2hhcnQgPSBhY3RpdmVbMF0uX2NoYXJ0O1xuICAgICAgY29uc3QgYWN0aXZlUG9pbnRzOiBhbnkgPSBjaGFydC5nZXRFbGVtZW50QXRFdmVudChldmVudCk7XG4gICAgICBpZiAoIGFjdGl2ZVBvaW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIC8vIGdldCB0aGUgaW50ZXJuYWwgaW5kZXggb2Ygc2xpY2UgaW4gcGllIGNoYXJ0XG4gICAgICAgIGNvbnN0IGNsaWNrZWRFbGVtZW50SW5kZXggPSBhY3RpdmVQb2ludHNbMF0uX2luZGV4O1xuICAgICAgICBjb25zdCBsYWJlbCA9IGNoYXJ0LmRhdGEubGFiZWxzW2NsaWNrZWRFbGVtZW50SW5kZXhdO1xuICAgICAgICAvLyBnZXQgdmFsdWUgYnkgaW5kZXhcbiAgICAgICAgY29uc3QgdmFsdWUgPSBjaGFydC5kYXRhLmRhdGFzZXRzWzBdLmRhdGFbY2xpY2tlZEVsZW1lbnRJbmRleF07XG4gICAgICAgIHRoaXMuY2FzZVR5cGVzUmVwb3J0LmNhc2VUeXBlc1tjbGlja2VkRWxlbWVudEluZGV4XS5pbmNUZXJtaW5hbCA9IGZhbHNlO1xuICAgICAgICB0aGlzLnNlbGVjdGVkQ2FzZVR5cGUuZW1pdCh0aGlzLmNhc2VUeXBlc1JlcG9ydC5jYXNlVHlwZXNbY2xpY2tlZEVsZW1lbnRJbmRleF0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjaGFydEhvdmVyZWQoeyBldmVudCwgYWN0aXZlIH06IHsgZXZlbnQ6IE1vdXNlRXZlbnQsIGFjdGl2ZToge31bXSB9KTogdm9pZCB7XG4gICAgLy8gY29uc29sZS5sb2coZXZlbnQsIGFjdGl2ZSk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnJlZnJlc2goKTtcbiAgfVxuXG59XG4iXX0=