/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { of } from 'rxjs';
import { TcCoreCommonFunctions, UiAppIdConfig } from '@tibco-tcstk/tc-core-lib';
import { flatMap, map, mergeMap, switchMap } from 'rxjs/operators';
import { TcSharedStateService } from '@tibco-tcstk/tc-core-lib';
import { HttpClient } from '@angular/common/http';
import { TcLiveAppsConfigService } from '../services/tc-live-apps-config.service';
import { LiveAppsConfig } from '../models/tc-liveapps-config';
import { TcCaseCardConfigService } from '../services/tc-case-card-config.service';
import { Location } from '@angular/common';
var LiveAppsConfigResolver = /** @class */ (function () {
    function LiveAppsConfigResolver(tcSharedState, liveAppsConfigService, caseCardConfigService, http, location) {
        var _this = this;
        this.tcSharedState = tcSharedState;
        this.liveAppsConfigService = liveAppsConfigService;
        this.caseCardConfigService = caseCardConfigService;
        this.http = http;
        this.location = location;
        this.DEFAULT_CONFIG_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/liveAppsConfig.json');
        this.APP_ID_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/uiAppId.json');
        // note appConfigResolver will need sandboxId to create app config state record.
        // So we expect this to have been set by caller (done by tc-liveapps-lib/laConfigResolver).
        this.setSandbox = (/**
         * @param {?} sandboxId
         * @return {?}
         */
        function (sandboxId) {
            _this.sandboxId = sandboxId;
        });
        // can be used to load defaultAppConfig from a JSON config
        this.getDefaultAppConfig = (/**
         * @return {?}
         */
        function () {
            return _this.http.get(_this.DEFAULT_CONFIG_URL);
        });
        // loads uiAppId from json file in assets (appId.json)
        this.getAppId = (/**
         * @return {?}
         */
        function () {
            return _this.http.get(_this.APP_ID_URL).pipe(map((/**
             * @param {?} uiAppId
             * @return {?}
             */
            function (uiAppId) {
                /** @type {?} */
                var uiAppIdConfig = new UiAppIdConfig().deserialize(uiAppId);
                _this.uiAppId = uiAppIdConfig.uiAppId;
                return uiAppIdConfig;
            })));
        });
        this.triggerCardConfigFetch = (/**
         * @param {?} liveAppsConfig
         * @return {?}
         */
        function (liveAppsConfig) {
            // optimization: I want to avoid reading the card config when we display a large list of cards in the calling app
            // therefore we can trigger of a read of the card configs for each app in the config to ensure they are cached by
            // http interceptor
            /** @type {?} */
            var laConfig = new LiveAppsConfig().deserialize(liveAppsConfig);
            laConfig.applicationIds.forEach((/**
             * @param {?} appId
             * @return {?}
             */
            function (appId) {
                _this.caseCardConfigService.getCardConfig(_this.uiAppId, appId, true, false).subscribe();
            }));
        });
    }
    /**
     * @param {?} routeSnapshot
     * @return {?}
     */
    LiveAppsConfigResolver.prototype.resolve = /**
     * @param {?} routeSnapshot
     * @return {?}
     */
    function (routeSnapshot) {
        var _this = this;
        /** @type {?} */
        var appConfig = this.getAppId().pipe(switchMap((/**
         * @param {?} uiAppId
         * @return {?}
         */
        function (uiAppId) { return _this.liveAppsConfigService.getLiveAppsConfig(uiAppId.uiAppId, true, false)
            .pipe(mergeMap((/**
         * @param {?} liveAppsConfig
         * @return {?}
         */
        function (liveAppsConfig) {
            if (liveAppsConfig === undefined) {
                return _this.getDefaultAppConfig().pipe(flatMap((/**
                 * @param {?} config
                 * @return {?}
                 */
                function (config) {
                    _this.defaultAppConfig = new LiveAppsConfig().deserialize(config);
                    _this.defaultAppConfig.caseIconsFolderId = _this.uiAppId + '_Icons';
                    return _this.liveAppsConfigService.createLiveAppsConfig(_this.sandboxId, uiAppId.uiAppId, _this.defaultAppConfig)
                        .pipe(map((/**
                     * @param {?} result
                     * @return {?}
                     */
                    function (result) {
                        /** @type {?} */
                        var newAppConfig = _this.defaultAppConfig;
                        newAppConfig.id = result;
                        _this.liveAppsConfigService.updateLiveAppsConfig(_this.sandboxId, uiAppId.uiAppId, newAppConfig, result).subscribe((
                        // trigger a read to flush the cache since we changed it
                        // trigger a read to flush the cache since we changed it
                        /**
                         * @param {?} updatedConf
                         * @return {?}
                         */
                        function (updatedConf) {
                            _this.liveAppsConfigService.getLiveAppsConfig(_this.uiAppId, true, true).subscribe();
                        }));
                        _this.triggerCardConfigFetch(newAppConfig);
                        return newAppConfig;
                    })));
                })));
            }
            else {
                _this.triggerCardConfigFetch(liveAppsConfig);
                return of(liveAppsConfig);
            }
        }))); })));
        return appConfig;
    };
    LiveAppsConfigResolver.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    LiveAppsConfigResolver.ctorParameters = function () { return [
        { type: TcSharedStateService },
        { type: TcLiveAppsConfigService },
        { type: TcCaseCardConfigService },
        { type: HttpClient },
        { type: Location }
    ]; };
    return LiveAppsConfigResolver;
}());
export { LiveAppsConfigResolver };
if (false) {
    /** @type {?} */
    LiveAppsConfigResolver.prototype.DEFAULT_CONFIG_URL;
    /** @type {?} */
    LiveAppsConfigResolver.prototype.APP_ID_URL;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.sandboxId;
    /** @type {?} */
    LiveAppsConfigResolver.prototype.defaultAppConfig;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.uiAppId;
    /** @type {?} */
    LiveAppsConfigResolver.prototype.setSandbox;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.getDefaultAppConfig;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.getAppId;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.triggerCardConfigFetch;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.tcSharedState;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.liveAppsConfigService;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.caseCardConfigService;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.http;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.location;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZWFwcHMtY29uZmlnLnJlc29sdmVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRpYmNvLXRjc3RrL3RjLWxpdmVhcHBzLWxpYi8iLCJzb3VyY2VzIjpbImxpYi9yZXNvbHZlcnMvbGl2ZWFwcHMtY29uZmlnLnJlc29sdmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFDLHFCQUFxQixFQUFlLGFBQWEsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBQzNGLE9BQU8sRUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqRSxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUM5RCxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDaEQsT0FBTyxFQUFDLHVCQUF1QixFQUFDLE1BQU0seUNBQXlDLENBQUM7QUFDaEYsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLDhCQUE4QixDQUFDO0FBQzVELE9BQU8sRUFBQyx1QkFBdUIsRUFBQyxNQUFNLHlDQUF5QyxDQUFDO0FBQ2hGLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUV6QztJQVVFLGdDQUFvQixhQUFtQyxFQUFVLHFCQUE4QyxFQUFVLHFCQUE4QyxFQUFVLElBQWdCLEVBQVUsUUFBa0I7UUFBN04saUJBQWlPO1FBQTdNLGtCQUFhLEdBQWIsYUFBYSxDQUFzQjtRQUFVLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBeUI7UUFBVSwwQkFBcUIsR0FBckIscUJBQXFCLENBQXlCO1FBQVUsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUFVLGFBQVEsR0FBUixRQUFRLENBQVU7UUFQN04sdUJBQWtCLEdBQUcscUJB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QkFBaUIsQ0FBQyxLQUFJLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQzt3QkFDckYsQ0FBQyxFQUNGLENBQUM7d0JBQ0YsS0FBSSxDQUFDLHNCQUFzQixDQUFDLFlBQVksQ0FBQyxDQUFDO3dCQUMxQyxPQUFPLFlBQVksQ0FBQztvQkFDdEIsQ0FBQyxFQUFDLENBQ0wsQ0FBQztnQkFDTixDQUFDLEVBQUMsQ0FDSCxDQUFDO2FBQ0g7aUJBQU07Z0JBQ0wsS0FBSSxDQUFDLHNCQUFzQixDQUFDLGNBQWMsQ0FBQyxDQUFDO2dCQUM1QyxPQUFPLEVBQUUsQ0FBQyxjQUFjLENBQUMsQ0FBQzthQUMzQjtRQUNILENBQUMsRUFDRixDQUNGLEVBeENrQixDQXdDbEIsRUFDRixDQUNGO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQzs7Z0JBM0ZGLFVBQVU7Ozs7Z0JBUEgsb0JBQW9CO2dCQUVwQix1QkFBdUI7Z0JBRXZCLHVCQUF1QjtnQkFIdkIsVUFBVTtnQkFJVixRQUFROztJQStGaEIsNkJBQUM7Q0FBQSxBQTdGRCxJQTZGQztTQTVGWSxzQkFBc0I7OztJQUVqQyxvREFBMkg7O0lBQzNILDRDQUE0Rzs7Ozs7SUFFNUcsMkNBQTBCOztJQUMxQixrREFBd0M7Ozs7O0lBQ3hDLHlDQUF3Qjs7SUFNeEIsNENBRUM7Ozs7O0lBR0QscURBRUM7Ozs7O0lBR0QsMENBU0M7Ozs7O0lBRUQsd0RBUUM7Ozs7O0lBakNXLCtDQUEyQzs7Ozs7SUFBRSx1REFBc0Q7Ozs7O0lBQUUsdURBQXNEOzs7OztJQUFFLHNDQUF3Qjs7Ozs7SUFBRSwwQ0FBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0FjdGl2YXRlZFJvdXRlU25hcHNob3QsIFJlc29sdmV9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtUY0NvcmVDb21tb25GdW5jdGlvbnMsIFVpQXBwQ29uZmlnLCBVaUFwcElkQ29uZmlnfSBmcm9tICdAdGliY28tdGNzdGsvdGMtY29yZS1saWInO1xuaW1wb3J0IHtmbGF0TWFwLCBtYXAsIG1lcmdlTWFwLCBzd2l0Y2hNYXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7VGNTaGFyZWRTdGF0ZVNlcnZpY2V9IGZyb20gJ0B0aWJjby10Y3N0ay90Yy1jb3JlLWxpYic7XG5pbXBvcnQge0h0dHBDbGllbnR9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7VGNMaXZlQXBwc0NvbmZpZ1NlcnZpY2V9IGZyb20gJy4uL3NlcnZpY2VzL3RjLWxpdmUtYXBwcy1jb25maWcuc2VydmljZSc7XG5pbXBvcnQge0xpdmVBcHBzQ29uZmlnfSBmcm9tICcuLi9tb2RlbHMvdGMtbGl2ZWFwcHMtY29uZmlnJztcbmltcG9ydCB7VGNDYXNlQ2FyZENvbmZpZ1NlcnZpY2V9IGZyb20gJy4uL3NlcnZpY2VzL3RjLWNhc2UtY2FyZC1jb25maWcuc2VydmljZSc7XG5pbXBvcnQge0xvY2F0aW9ufSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTGl2ZUFwcHNDb25maWdSZXNvbHZlciBpbXBsZW1lbnRzIFJlc29sdmU8T2JzZXJ2YWJsZTxMaXZlQXBwc0NvbmZpZz4+IHtcblxuICBERUZBVUxUX0NPTkZJR19VUkwgPSBUY0NvcmVDb21tb25GdW5jdGlvbnMucHJlcGFyZVVybEZvclN0YXRpY1Jlc291cmNlKHRoaXMubG9jYXRpb24sICdhc3NldHMvY29uZmlnL2xpdmVBcHBzQ29uZmlnLmpzb24nKTtcbiAgQVBQX0lEX1VSTCA9IFRjQ29yZUNvbW1vbkZ1bmN0aW9ucy5wcmVwYXJlVXJsRm9yU3RhdGljUmVzb3VyY2UodGhpcy5sb2NhdGlvbiwgJ2Fzc2V0cy9jb25maWcvdWlBcHBJZC5qc29uJyk7XG5cbiAgcHJpdmF0ZSBzYW5kYm94SWQ6IG51bWJlcjtcbiAgcHVibGljIGRlZmF1bHRBcHBDb25maWc6IExpdmVBcHBzQ29uZmlnO1xuICBwcml2YXRlIHVpQXBwSWQ6IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRjU2hhcmVkU3RhdGU6IFRjU2hhcmVkU3RhdGVTZXJ2aWNlLCBwcml2YXRlIGxpdmVBcHBzQ29uZmlnU2VydmljZTogVGNMaXZlQXBwc0NvbmZpZ1NlcnZpY2UsIHByaXZhdGUgY2FzZUNhcmRDb25maWdTZXJ2aWNlOiBUY0Nhc2VDYXJkQ29uZmlnU2VydmljZSwgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LCBwcml2YXRlIGxvY2F0aW9uOiBMb2NhdGlvbikge31cbiAgLy8gbm90ZSBhcHBDb25maWdSZXNvbHZlciB3aWxsIG5lZWQgc2FuZGJveElkIHRvIGNyZWF0ZSBhcHAgY29uZmlnIHN0YXRlIHJlY29yZC5cbiAgLy8gU28gd2UgZXhwZWN0IHRoaXMgdG8gaGF2ZSBiZWVuIHNldCBieSBjYWxsZXIgKGRvbmUgYnkgdGMtbGl2ZWFwcHMtbGliL2xhQ29uZmlnUmVzb2x2ZXIpLlxuXG4gIHB1YmxpYyBzZXRTYW5kYm94ID0gKHNhbmRib3hJZDogbnVtYmVyKSA9PiB7XG4gICAgdGhpcy5zYW5kYm94SWQgPSBzYW5kYm94SWQ7XG4gIH1cblxuICAvLyBjYW4gYmUgdXNlZCB0byBsb2FkIGRlZmF1bHRBcHBDb25maWcgZnJvbSBhIEpTT04gY29uZmlnXG4gIHByaXZhdGUgZ2V0RGVmYXVsdEFwcENvbmZpZyA9ICgpID0+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh0aGlzLkRFRkFVTFRfQ09ORklHX1VSTCk7XG4gIH1cblxuICAvLyBsb2FkcyB1aUFwcElkIGZyb20ganNvbiBmaWxlIGluIGFzc2V0cyAoYXBwSWQuanNvbilcbiAgcHJpdmF0ZSBnZXRBcHBJZCA9ICgpOiBPYnNlcnZhYmxlPFVpQXBwSWRDb25maWc+ID0+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh0aGlzLkFQUF9JRF9VUkwpLnBpcGUoXG4gICAgICBtYXAodWlBcHBJZCA9PiB7XG4gICAgICAgICAgY29uc3QgdWlBcHBJZENvbmZpZyA9IG5ldyBVaUFwcElkQ29uZmlnKCkuZGVzZXJpYWxpemUodWlBcHBJZCk7XG4gICAgICAgICAgdGhpcy51aUFwcElkID0gdWlBcHBJZENvbmZpZy51aUFwcElkO1xuICAgICAgICAgIHJldHVybiB1aUFwcElkQ29uZmlnO1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgdHJpZ2dlckNhcmRDb25maWdGZXRjaCA9IChsaXZlQXBwc0NvbmZpZzogTGl2ZUFwcHNDb25maWcpID0+IHtcbiAgICAvLyBvcHRpbWl6YXRpb246IEkgd2FudCB0byBhdm9pZCByZWFkaW5nIHRoZSBjYXJkIGNvbmZpZyB3aGVuIHdlIGRpc3BsYXkgYSBsYXJnZSBsaXN0IG9mIGNhcmRzIGluIHRoZSBjYWxsaW5nIGFwcFxuICAgIC8vIHRoZXJlZm9yZSB3ZSBjYW4gdHJpZ2dlciBvZiBhIHJlYWQgb2YgdGhlIGNhcmQgY29uZmlncyBmb3IgZWFjaCBhcHAgaW4gdGhlIGNvbmZpZyB0byBlbnN1cmUgdGhleSBhcmUgY2FjaGVkIGJ5XG4gICAgLy8gaHR0cCBpbnRlcmNlcHRvclxuICAgIGNvbnN0IGxhQ29uZmlnID0gbmV3IExpdmVBcHBzQ29uZmlnKCkuZGVzZXJpYWxpemUobGl2ZUFwcHNDb25maWcpO1xuICAgIGxhQ29uZmlnLmFwcGxpY2F0aW9uSWRzLmZvckVhY2goYXBwSWQgPT4ge1xuICAgICAgdGhpcy5jYXNlQ2FyZENvbmZpZ1NlcnZpY2UuZ2V0Q2FyZENvbmZpZyh0aGlzLnVpQXBwSWQsIGFwcElkLCB0cnVlLCBmYWxzZSkuc3Vic2NyaWJlKCk7XG4gICAgfSk7XG4gIH1cblxuICByZXNvbHZlKHJvdXRlU25hcHNob3Q6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBPYnNlcnZhYmxlPExpdmVBcHBzQ29uZmlnPiB7XG4gICAgY29uc3QgYXBwQ29uZmlnID0gdGhpcy5nZXRBcHBJZCgpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAodWlBcHBJZCA9PiB0aGlzLmxpdmVBcHBzQ29uZmlnU2VydmljZS5nZXRMaXZlQXBwc0NvbmZpZyh1aUFwcElkLnVpQXBwSWQsIHRydWUsIGZhbHNlKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICBtZXJnZU1hcChcbiAgICAgICAgICAgIGxpdmVBcHBzQ29uZmlnID0+IHtcbiAgICAgICAgICAgICAgaWYgKGxpdmVBcHBzQ29uZmlnID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREZWZhdWx0QXBwQ29uZmlnKCkucGlwZShcbiAgICAgICAgICAgICAgICAgIGZsYXRNYXAoY29uZmlnID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0QXBwQ29uZmlnID0gbmV3IExpdmVBcHBzQ29uZmlnKCkuZGVzZXJpYWxpemUoY29uZmlnKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0QXBwQ29uZmlnLmNhc2VJY29uc0ZvbGRlcklkID0gdGhpcy51aUFwcElkICsgJ19JY29ucyc7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxpdmVBcHBzQ29uZmlnU2VydmljZS5jcmVhdGVMaXZlQXBwc0NvbmZpZyhcbiAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNhbmRib3hJZCxcbiAgICAgICAgICAgICAgICAgICAgICB1aUFwcElkLnVpQXBwSWQsXG4gICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0QXBwQ29uZmlnKVxuICAgICAgICAgICAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgbWFwKFxuICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0FwcENvbmZpZyA9IHRoaXMuZGVmYXVsdEFwcENvbmZpZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdBcHBDb25maWcuaWQgPSByZXN1bHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5saXZlQXBwc0NvbmZpZ1NlcnZpY2UudXBkYXRlTGl2ZUFwcHNDb25maWcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNhbmRib3hJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpQXBwSWQudWlBcHBJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0FwcENvbmZpZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciBhIHJlYWQgdG8gZmx1c2ggdGhlIGNhY2hlIHNpbmNlIHdlIGNoYW5nZWQgaXRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRDb25mID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5saXZlQXBwc0NvbmZpZ1NlcnZpY2UuZ2V0TGl2ZUFwcHNDb25maWcodGhpcy51aUFwcElkLCB0cnVlLCB0cnVlKS5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlckNhcmRDb25maWdGZXRjaChuZXdBcHBDb25maWcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXdBcHBDb25maWc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJDYXJkQ29uZmlnRmV0Y2gobGl2ZUFwcHNDb25maWcpO1xuICAgICAgICAgICAgICAgIHJldHVybiBvZihsaXZlQXBwc0NvbmZpZyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgIClcbiAgICApXG4gICAgcmV0dXJuIGFwcENvbmZpZztcbiAgfVxuXG59XG4iXX0=