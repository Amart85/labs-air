/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { throwError } from 'rxjs';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { ApiResponseError, ApiResponseText } from '../models/liveappsdata';
import { LiveAppsService } from './live-apps.service';
import { DocumentList, OrgFolder } from '../models/tc-document';
import { catchError, flatMap, map, tap } from 'rxjs/operators';
import { TcCoreCommonFunctions } from '@tibco-tcstk/tc-core-lib';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./live-apps.service";
var TcDocumentService = /** @class */ (function () {
    function TcDocumentService(http, liveapps) {
        this.http = http;
        this.liveapps = liveapps;
    }
    /**
     * @param {?} name
     * @return {?}
     */
    TcDocumentService.prototype.createOrgFolder = /**
     * @param {?} name
     * @return {?}
     */
    function (name) {
        /** @type {?} */
        var url = '/webresource/v1/orgFolders/';
        /** @type {?} */
        var body = new OrgFolder().deserialize({ name: name });
        /** @type {?} */
        var bodyStr = JSON.stringify(body);
        /** @type {?} */
        var headers = new HttpHeaders()
            .set('Content-Type', 'application/json');
        return this.http.post(url, bodyStr, { headers: headers }).pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        function (val) { return sessionStorage.setItem('tcsTimestamp', Date.now().toString()); })), map((/**
         * @param {?} response
         * @return {?}
         */
        function (response) { return new ApiResponseText().deserialize(response); })));
    };
    /**
     * @param {?} name
     * @param {?} useCache
     * @param {?} flushCache
     * @return {?}
     */
    TcDocumentService.prototype.getOrgFolder = /**
     * @param {?} name
     * @param {?} useCache
     * @param {?} flushCache
     * @return {?}
     */
    function (name, useCache, flushCache) {
        var _this = this;
        /** @type {?} */
        var url = '/webresource/v1/orgFolders/' + name + '/';
        /** @type {?} */
        var headers = new HttpHeaders();
        if (useCache) {
            headers = headers.set('cacheResponse', 'true');
        }
        if (flushCache) {
            headers = headers.set('flushCache', 'true');
        }
        /** @type {?} */
        var options = { headers: headers };
        return this.http.get(url, options).pipe(map((/**
         * @param {?} response
         * @return {?}
         */
        function (response) {
            return new OrgFolder().deserialize(response);
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        function (error) {
            /** @type {?} */
            var apiError = new ApiResponseError().deserialize(error.error);
            if (apiError.errorCode === 'WR_FOLDER_DOES_NOT_EXIST') {
                return _this.createOrgFolder(name).pipe(flatMap((/**
                 * @param {?} newOrgFolder
                 * @return {?}
                 */
                function (newOrgFolder) {
                    // trigger cache flush
                    return _this.getOrgFolder(name, true, true);
                })));
            }
            else {
                throwError(error);
            }
        })));
    };
    /**
     * @param {?} name
     * @return {?}
     */
    TcDocumentService.prototype.initOrgFolder = /**
     * @param {?} name
     * @return {?}
     */
    function (name) {
        var _this = this;
        /** @type {?} */
        var orgFolder$ = this.getOrgFolder(name, true, false).pipe(map((/**
         * @param {?} orgFolderResp
         * @return {?}
         */
        function (orgFolderResp) {
            return new ApiResponseText().deserialize({ message: 'orgFolder ok' });
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        function (error) {
            /** @type {?} */
            var apiError = new ApiResponseError().deserialize(error.error);
            if (apiError.errorCode === 'WR_FOLDER_DOES_NOT_EXIST') {
                return _this.createOrgFolder(name).pipe(map((/**
                 * @param {?} newOrgFolder
                 * @return {?}
                 */
                function (newOrgFolder) {
                    // trigger cache flush
                    _this.getOrgFolder(name, true, true).subscribe();
                    return newOrgFolder;
                })));
            }
            else {
                throwError(error);
            }
        })));
        return orgFolder$;
    };
    /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} sandboxId
     * @param {?} filter
     * @return {?}
     */
    TcDocumentService.prototype.listDocuments = /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} sandboxId
     * @param {?} filter
     * @return {?}
     */
    function (folderType, folderId, sandboxId, filter) {
        var _this = this;
        /** @type {?} */
        var url;
        url = '/webresource/v1/' + folderType + '/' + folderId + '/artifacts/';
        if (sandboxId) {
            url = url + '?$sandbox=' + sandboxId;
        }
        if (filter) {
            url = url + '&$filter=contains(name,\'' + filter + '\')';
        }
        return this.http.get(url)
            .pipe(map((/**
         * @param {?} docs
         * @return {?}
         */
        function (docs) {
            /** @type {?} */
            var docList = new DocumentList().deserialize(docs);
            for (var x = 0; x < docList.documents.length; x++) {
                docList.documents[x] = _this.parseDocument(docList.documents[x]);
            }
            return docList;
        })));
    };
    /**
     * @private
     * @param {?} document
     * @return {?}
     */
    TcDocumentService.prototype.parseDocument = /**
     * @private
     * @param {?} document
     * @return {?}
     */
    function (document) {
        /** @type {?} */
        var splitDocName = document.name.split('.');
        if (splitDocName.length > 1) {
            document.extension = splitDocName[splitDocName.length - 1];
        }
        else {
            document.extension = '';
        }
        document.fileIcon = this.getIcon(document.extension);
        document.fileSize = TcCoreCommonFunctions.fileSizeToHuman(Number(document.size));
        this.liveapps.getUserInfo(document.author).subscribe((/**
         * @param {?} val
         * @return {?}
         */
        function (val) {
            document.authorDetails = val;
            return document;
        }), (/**
         * @param {?} error
         * @return {?}
         */
        function (error) { console.log('Unable to retrieve user details for user: ' + error.errorMsg); }));
        this.liveapps.getUserInfo(document.lastModifiedBy).subscribe((/**
         * @param {?} val
         * @return {?}
         */
        function (val) {
            document.lastModifiedByDetails = val;
            return document;
        }), (/**
         * @param {?} error
         * @return {?}
         */
        function (error) { console.log('Unable to retrieve user details for user: ' + error.errorMsg); }));
        return document;
    };
    /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} documentName
     * @param {?} sandboxId
     * @return {?}
     */
    TcDocumentService.prototype.deleteDocument = /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} documentName
     * @param {?} sandboxId
     * @return {?}
     */
    function (folderType, folderId, documentName, sandboxId) {
        /** @type {?} */
        var url = '/webresource/v1/' + folderType + '/' + folderId + '/artifacts/' + documentName + '?$sandbox=' + sandboxId;
        return this.http.delete(url)
            .pipe(map((/**
         * @param {?} val
         * @return {?}
         */
        function (val) { return new ApiResponseText().deserialize(val); })));
    };
    /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} docId
     * @param {?} docVersion
     * @param {?} sandboxId
     * @return {?}
     */
    TcDocumentService.prototype.getUrlForDocument = /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} docId
     * @param {?} docVersion
     * @param {?} sandboxId
     * @return {?}
     */
    function (folderType, folderId, docId, docVersion, sandboxId) {
        /** @type {?} */
        var url = '/webresource/';
        if (folderType === 'orgFolders') {
            url = url + 'orgFolders/' + folderId;
        }
        else {
            url = url + 'folders/' + folderId;
        }
        if (sandboxId && folderType !== 'orgFolders') {
            url = url + '/' + sandboxId;
        }
        url = url + '/' + docId;
        if (docVersion) {
            url = url + '?$version=' + docVersion;
        }
        return url;
    };
    /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} docId
     * @param {?} docVersion
     * @param {?} sandboxId
     * @return {?}
     */
    TcDocumentService.prototype.downloadDocument = /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} docId
     * @param {?} docVersion
     * @param {?} sandboxId
     * @return {?}
     */
    function (folderType, folderId, docId, docVersion, sandboxId) {
        /** @type {?} */
        var url = '/webresource/';
        if (folderType === 'orgFolders') {
            url = url + 'orgFolders/' + folderId;
        }
        else {
            url = url + 'folders/' + folderId;
        }
        if (sandboxId && folderType !== 'orgFolders') {
            url = url + '/' + sandboxId;
        }
        url = url + '/' + docId + '?$download=true';
        if (docVersion) {
            url = url + '&$version=' + docVersion;
        }
        // todo: Check whether application/octet-stream is ok or whether we should change it
        /** @type {?} */
        var headers = new HttpHeaders({
            'Content-Type': 'application/octet-stream',
        });
        return this.http.get(url, { headers: headers, responseType: (/** @type {?} */ ('blob')) });
    };
    /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} sandboxId
     * @param {?} fileToUpload
     * @param {?} fileName
     * @param {?} description
     * @return {?}
     */
    TcDocumentService.prototype.uploadDocument = /**
     * @param {?} folderType
     * @param {?} folderId
     * @param {?} sandboxId
     * @param {?} fileToUpload
     * @param {?} fileName
     * @param {?} description
     * @return {?}
     */
    function (folderType, folderId, sandboxId, fileToUpload, fileName, description) {
        /** @type {?} */
        var url = '/webresource/v1/' + folderType
            + '/' + folderId
            + '/artifacts/' + fileName + '/upload/';
        if (sandboxId) {
            url = url + '?$sandbox=' + sandboxId;
        }
        if (description) {
            url = url + '&description=' + description;
        }
        /** @type {?} */
        var headers = new HttpHeaders({
            'accept': 'application/json',
            'Content-Type': 'multipart/form-data',
            'filename': fileName,
            'enctype': 'multipart/form-data'
        });
        /** @type {?} */
        var formData = new FormData();
        formData.append('artifactContents', fileToUpload);
        return this.http.post(url, formData, { headers: headers, reportProgress: true, observe: 'events' });
    };
    /**
     * @private
     * @param {?} extension
     * @return {?}
     */
    TcDocumentService.prototype.getIcon = /**
     * @private
     * @param {?} extension
     * @return {?}
     */
    function (extension) {
        if (extension === 'txt') {
            return ('doc');
        }
        else if (extension === 'css') {
            return ('doc');
        }
        else if (extension === 'js') {
            return ('doc');
        }
        else if (extension === 'pdf') {
            return ('doc');
        }
        else if (extension === 'xml') {
            return ('doc');
        }
        else if (extension === 'doc') {
            return ('doc');
        }
        else if (extension === 'zip') {
            return ('zip');
        }
        else if (extension === 'ppt') {
            return ('doc');
        }
        else if (extension === 'png') {
            return ('image');
        }
        else {
            return ('doc');
        }
    };
    TcDocumentService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    TcDocumentService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: LiveAppsService }
    ]; };
    /** @nocollapse */ TcDocumentService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function TcDocumentService_Factory() { return new TcDocumentService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.LiveAppsService)); }, token: TcDocumentService, providedIn: "root" });
    return TcDocumentService;
}());
export { TcDocumentService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    TcDocumentService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    TcDocumentService.prototype.liveapps;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGMtZG9jdW1lbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0aWJjby10Y3N0ay90Yy1saXZlYXBwcy1saWIvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvdGMtZG9jdW1lbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWEsVUFBVSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQzVDLE9BQU8sRUFBQyxVQUFVLEVBQUUsV0FBVyxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDN0QsT0FBTyxFQUFDLGdCQUFnQixFQUFFLGVBQWUsRUFBQyxNQUFNLHdCQUF3QixDQUFDO0FBQ3pFLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUNwRCxPQUFPLEVBQVcsWUFBWSxFQUFFLFNBQVMsRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBQ3hFLE9BQU8sRUFBQyxVQUFVLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3RCxPQUFPLEVBQUMscUJBQXFCLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQzs7OztBQUUvRDtJQUtFLDJCQUFvQixJQUFnQixFQUFVLFFBQXlCO1FBQW5ELFNBQUksR0FBSixJQUFJLENBQVk7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFpQjtJQUN2RSxDQUFDOzs7OztJQUVNLDJDQUFlOzs7O0lBQXRCLFVBQXVCLElBQVk7O1lBQzNCLEdBQUcsR0FBRyw2QkFBNkI7O1lBQ25DLElBQUksR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQzs7WUFDbEQsT0FBTyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDOztZQUM5QixPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUU7YUFDOUIsR0FB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QUssQ0FBQyxDQUFDO1NBQ2Y7YUFBTSxJQUFJLFNBQVMsS0FBSyxLQUFLLEVBQUU7WUFDOUIsT0FBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ2Y7YUFBTSxJQUFJLFNBQVMsS0FBSyxLQUFLLEVBQUU7WUFDOUIsT0FBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ2Y7YUFBTSxJQUFJLFNBQVMsS0FBSyxLQUFLLEVBQUU7WUFDOUIsT0FBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ2pCO2FBQU07WUFDTCxPQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDZjtJQUNILENBQUM7O2dCQS9NRixVQUFVLFNBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzs7O2dCQVRPLFVBQVU7Z0JBRVYsZUFBZTs7OzRCQUp2QjtDQTBOQyxBQWpORCxJQWlOQztTQTlNWSxpQkFBaUI7Ozs7OztJQUVoQixpQ0FBd0I7Ozs7O0lBQUUscUNBQWlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtPYnNlcnZhYmxlLCB0aHJvd0Vycm9yfSBmcm9tICdyeGpzJztcbmltcG9ydCB7SHR0cENsaWVudCwgSHR0cEhlYWRlcnN9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7QXBpUmVzcG9uc2VFcnJvciwgQXBpUmVzcG9uc2VUZXh0fSBmcm9tICcuLi9tb2RlbHMvbGl2ZWFwcHNkYXRhJztcbmltcG9ydCB7TGl2ZUFwcHNTZXJ2aWNlfSBmcm9tICcuL2xpdmUtYXBwcy5zZXJ2aWNlJztcbmltcG9ydCB7RG9jdW1lbnQsIERvY3VtZW50TGlzdCwgT3JnRm9sZGVyfSBmcm9tICcuLi9tb2RlbHMvdGMtZG9jdW1lbnQnO1xuaW1wb3J0IHtjYXRjaEVycm9yLCBmbGF0TWFwLCBtYXAsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtUY0NvcmVDb21tb25GdW5jdGlvbnN9IGZyb20gJ0B0aWJjby10Y3N0ay90Yy1jb3JlLWxpYic7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFRjRG9jdW1lbnRTZXJ2aWNlIHtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsIHByaXZhdGUgbGl2ZWFwcHM6IExpdmVBcHBzU2VydmljZSkge1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZU9yZ0ZvbGRlcihuYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEFwaVJlc3BvbnNlVGV4dD4ge1xuICAgIGNvbnN0IHVybCA9ICcvd2VicmVzb3VyY2UvdjEvb3JnRm9sZGVycy8nO1xuICAgIGNvbnN0IGJvZHkgPSBuZXcgT3JnRm9sZGVyKCkuZGVzZXJpYWxpemUoeyBuYW1lOiBuYW1lIH0pO1xuICAgIGNvbnN0IGJvZHlTdHIgPSBKU09OLnN0cmluZ2lmeShib2R5KTtcbiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKClcbiAgICAgIC5zZXQoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KHVybCwgYm9keVN0ciwgeyBoZWFkZXJzIH0pLnBpcGUoXG4gICAgICB0YXAoIHZhbCA9PiBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCd0Y3NUaW1lc3RhbXAnLCBEYXRlLm5vdygpLnRvU3RyaW5nKCkpKSxcbiAgICAgIG1hcChyZXNwb25zZSA9PiBuZXcgQXBpUmVzcG9uc2VUZXh0KCkuZGVzZXJpYWxpemUocmVzcG9uc2UpKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZ2V0T3JnRm9sZGVyKG5hbWU6IHN0cmluZywgdXNlQ2FjaGU6IGJvb2xlYW4sIGZsdXNoQ2FjaGU6IGJvb2xlYW4pOiBPYnNlcnZhYmxlPE9yZ0ZvbGRlcj4ge1xuICAgIGNvbnN0IHVybCA9ICcvd2VicmVzb3VyY2UvdjEvb3JnRm9sZGVycy8nICsgbmFtZSArICcvJztcbiAgICBsZXQgaGVhZGVyczogSHR0cEhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoKTtcbiAgICBpZiAodXNlQ2FjaGUpIHtcbiAgICAgIGhlYWRlcnMgPSBoZWFkZXJzLnNldCgnY2FjaGVSZXNwb25zZScsICd0cnVlJyk7XG4gICAgfVxuICAgIGlmIChmbHVzaENhY2hlKSB7XG4gICAgICBoZWFkZXJzID0gaGVhZGVycy5zZXQoJ2ZsdXNoQ2FjaGUnLCAndHJ1ZScpO1xuICAgIH1cbiAgICBjb25zdCBvcHRpb25zID0ge2hlYWRlcnM6IGhlYWRlcnN9O1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHVybCwgb3B0aW9ucykucGlwZShcbiAgICAgIG1hcChyZXNwb25zZSA9PiB7XG4gICAgICAgIHJldHVybiBuZXcgT3JnRm9sZGVyKCkuZGVzZXJpYWxpemUocmVzcG9uc2UpO1xuICAgICAgfSksXG4gICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcbiAgICAgICAgY29uc3QgYXBpRXJyb3IgPSBuZXcgQXBpUmVzcG9uc2VFcnJvcigpLmRlc2VyaWFsaXplKGVycm9yLmVycm9yKTtcbiAgICAgICAgaWYgKGFwaUVycm9yLmVycm9yQ29kZSA9PT0gJ1dSX0ZPTERFUl9ET0VTX05PVF9FWElTVCcpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVPcmdGb2xkZXIobmFtZSkucGlwZShcbiAgICAgICAgICAgIGZsYXRNYXAobmV3T3JnRm9sZGVyID0+IHtcbiAgICAgICAgICAgICAgLy8gdHJpZ2dlciBjYWNoZSBmbHVzaFxuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRPcmdGb2xkZXIobmFtZSwgdHJ1ZSwgdHJ1ZSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3dFcnJvcihlcnJvcik7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBpbml0T3JnRm9sZGVyKG5hbWU6IHN0cmluZyk6IE9ic2VydmFibGU8QXBpUmVzcG9uc2VUZXh0PiB7XG4gICAgY29uc3Qgb3JnRm9sZGVyJCA9IHRoaXMuZ2V0T3JnRm9sZGVyKG5hbWUsIHRydWUsIGZhbHNlKS5waXBlKFxuICAgICAgbWFwKG9yZ0ZvbGRlclJlc3AgPT4ge1xuICAgICAgICByZXR1cm4gbmV3IEFwaVJlc3BvbnNlVGV4dCgpLmRlc2VyaWFsaXplKHsgbWVzc2FnZTogJ29yZ0ZvbGRlciBvayd9KTtcbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XG4gICAgICAgIGNvbnN0IGFwaUVycm9yID0gbmV3IEFwaVJlc3BvbnNlRXJyb3IoKS5kZXNlcmlhbGl6ZShlcnJvci5lcnJvcik7XG4gICAgICAgIGlmIChhcGlFcnJvci5lcnJvckNvZGUgPT09ICdXUl9GT0xERVJfRE9FU19OT1RfRVhJU1QnKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlT3JnRm9sZGVyKG5hbWUpLnBpcGUoXG4gICAgICAgICAgICBtYXAobmV3T3JnRm9sZGVyID0+IHtcbiAgICAgICAgICAgICAgLy8gdHJpZ2dlciBjYWNoZSBmbHVzaFxuICAgICAgICAgICAgICB0aGlzLmdldE9yZ0ZvbGRlcihuYW1lLCB0cnVlLCB0cnVlKS5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgcmV0dXJuIG5ld09yZ0ZvbGRlcjtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvd0Vycm9yKGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuICAgIHJldHVybiBvcmdGb2xkZXIkO1xuICB9XG5cbiAgcHVibGljIGxpc3REb2N1bWVudHMoZm9sZGVyVHlwZTogc3RyaW5nLCBmb2xkZXJJZDogc3RyaW5nLCBzYW5kYm94SWQ6IG51bWJlciwgZmlsdGVyOiBzdHJpbmcpOiBPYnNlcnZhYmxlPERvY3VtZW50TGlzdD4ge1xuICAgIGxldCB1cmw6IHN0cmluZztcbiAgICB1cmwgPSAnL3dlYnJlc291cmNlL3YxLycgKyBmb2xkZXJUeXBlICsgJy8nICsgZm9sZGVySWQgKyAnL2FydGlmYWN0cy8nO1xuICAgIGlmIChzYW5kYm94SWQpIHtcbiAgICAgIHVybCA9IHVybCArICc/JHNhbmRib3g9JyArIHNhbmRib3hJZDtcbiAgICB9XG4gICAgaWYgKGZpbHRlcikge1xuICAgICAgdXJsID0gdXJsICsgJyYkZmlsdGVyPWNvbnRhaW5zKG5hbWUsXFwnJyArIGZpbHRlciArICdcXCcpJztcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcChkb2NzID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGRvY0xpc3QgPSBuZXcgRG9jdW1lbnRMaXN0KCkuZGVzZXJpYWxpemUoZG9jcyk7XG4gICAgICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IGRvY0xpc3QuZG9jdW1lbnRzLmxlbmd0aDsgeCsrKSB7XG4gICAgICAgICAgICAgIGRvY0xpc3QuZG9jdW1lbnRzW3hdID0gdGhpcy5wYXJzZURvY3VtZW50KGRvY0xpc3QuZG9jdW1lbnRzW3hdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBkb2NMaXN0O1xuICAgICAgICAgIH1cbiAgICAgICAgKVxuICAgICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VEb2N1bWVudChkb2N1bWVudCk6IERvY3VtZW50IHtcbiAgICBjb25zdCBzcGxpdERvY05hbWUgPSBkb2N1bWVudC5uYW1lLnNwbGl0KCcuJyk7XG4gICAgaWYgKHNwbGl0RG9jTmFtZS5sZW5ndGggPiAxKSB7XG4gICAgICBkb2N1bWVudC5leHRlbnNpb24gPSBzcGxpdERvY05hbWVbc3BsaXREb2NOYW1lLmxlbmd0aCAtIDFdO1xuICAgIH0gZWxzZSB7XG4gICAgICBkb2N1bWVudC5leHRlbnNpb24gPSAnJztcbiAgICB9XG4gICAgZG9jdW1lbnQuZmlsZUljb24gPSB0aGlzLmdldEljb24oZG9jdW1lbnQuZXh0ZW5zaW9uKTtcbiAgICBkb2N1bWVudC5maWxlU2l6ZSA9IFRjQ29yZUNvbW1vbkZ1bmN0aW9ucy5maWxlU2l6ZVRvSHVtYW4oTnVtYmVyKGRvY3VtZW50LnNpemUpKTtcbiAgICB0aGlzLmxpdmVhcHBzLmdldFVzZXJJbmZvKGRvY3VtZW50LmF1dGhvcikuc3Vic2NyaWJlKHZhbCA9PiB7XG4gICAgICBkb2N1bWVudC5hdXRob3JEZXRhaWxzID0gdmFsO1xuICAgICAgcmV0dXJuIGRvY3VtZW50O1xuICAgIH0sIGVycm9yID0+IHsgY29uc29sZS5sb2coJ1VuYWJsZSB0byByZXRyaWV2ZSB1c2VyIGRldGFpbHMgZm9yIHVzZXI6ICcgKyBlcnJvci5lcnJvck1zZyk7IH0pO1xuICAgIHRoaXMubGl2ZWFwcHMuZ2V0VXNlckluZm8oZG9jdW1lbnQubGFzdE1vZGlmaWVkQnkpLnN1YnNjcmliZSh2YWwgPT4ge1xuICAgICAgZG9jdW1lbnQubGFzdE1vZGlmaWVkQnlEZXRhaWxzID0gdmFsO1xuICAgICAgcmV0dXJuIGRvY3VtZW50O1xuICAgIH0sIGVycm9yID0+IHsgY29uc29sZS5sb2coJ1VuYWJsZSB0byByZXRyaWV2ZSB1c2VyIGRldGFpbHMgZm9yIHVzZXI6ICcgKyBlcnJvci5lcnJvck1zZyk7IH0pO1xuICAgIHJldHVybiBkb2N1bWVudDtcbiAgfVxuXG4gIHB1YmxpYyBkZWxldGVEb2N1bWVudChmb2xkZXJUeXBlOiBzdHJpbmcsIGZvbGRlcklkOiBzdHJpbmcsIGRvY3VtZW50TmFtZTogc3RyaW5nLCBzYW5kYm94SWQ6IG51bWJlcik6IE9ic2VydmFibGU8QXBpUmVzcG9uc2VUZXh0PiB7XG4gICAgY29uc3QgdXJsID0gJy93ZWJyZXNvdXJjZS92MS8nICsgZm9sZGVyVHlwZSArICcvJyArIGZvbGRlcklkICsgJy9hcnRpZmFjdHMvJyArIGRvY3VtZW50TmFtZSArICc/JHNhbmRib3g9JyArIHNhbmRib3hJZDtcbiAgICByZXR1cm4gdGhpcy5odHRwLmRlbGV0ZSh1cmwpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKCB2YWwgPT4gbmV3IEFwaVJlc3BvbnNlVGV4dCgpLmRlc2VyaWFsaXplKHZhbCkpXG4gICAgICApO1xuICB9XG5cbiAgcHVibGljIGdldFVybEZvckRvY3VtZW50KGZvbGRlclR5cGU6IHN0cmluZywgZm9sZGVySWQ6IHN0cmluZywgZG9jSWQ6IHN0cmluZywgZG9jVmVyc2lvbjogc3RyaW5nLCBzYW5kYm94SWQ6IG51bWJlcik6IHN0cmluZyB7XG4gICAgbGV0IHVybCA9ICcvd2VicmVzb3VyY2UvJztcbiAgICBpZiAoZm9sZGVyVHlwZSA9PT0gJ29yZ0ZvbGRlcnMnKSB7XG4gICAgICB1cmwgPSB1cmwgKyAnb3JnRm9sZGVycy8nICsgZm9sZGVySWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHVybCA9IHVybCArICdmb2xkZXJzLycgKyBmb2xkZXJJZDtcbiAgICB9XG4gICAgaWYgKHNhbmRib3hJZCAmJiBmb2xkZXJUeXBlICE9PSAnb3JnRm9sZGVycycpIHtcbiAgICAgIHVybCA9IHVybCArICcvJyArIHNhbmRib3hJZDtcbiAgICB9XG4gICAgdXJsID0gdXJsICsgJy8nICsgZG9jSWQ7XG4gICAgaWYgKGRvY1ZlcnNpb24pIHtcbiAgICAgIHVybCA9IHVybCArICc/JHZlcnNpb249JyArIGRvY1ZlcnNpb247XG4gICAgfVxuICAgIHJldHVybiB1cmw7XG4gIH1cblxuICBwdWJsaWMgZG93bmxvYWREb2N1bWVudChmb2xkZXJUeXBlOiBzdHJpbmcsIGZvbGRlcklkOiBzdHJpbmcsIGRvY0lkOiBzdHJpbmcsIGRvY1ZlcnNpb246IHN0cmluZywgc2FuZGJveElkOiBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGxldCB1cmwgPSAnL3dlYnJlc291cmNlLyc7XG4gICAgaWYgKGZvbGRlclR5cGUgPT09ICdvcmdGb2xkZXJzJykge1xuICAgICAgdXJsID0gdXJsICsgJ29yZ0ZvbGRlcnMvJyArIGZvbGRlcklkO1xuICAgIH0gZWxzZSB7XG4gICAgICB1cmwgPSB1cmwgKyAnZm9sZGVycy8nICsgZm9sZGVySWQ7XG4gICAgfVxuICAgIGlmIChzYW5kYm94SWQgJiYgZm9sZGVyVHlwZSAhPT0gJ29yZ0ZvbGRlcnMnKSB7XG4gICAgICB1cmwgPSB1cmwgKyAnLycgKyBzYW5kYm94SWQ7XG4gICAgfVxuICAgIHVybCA9IHVybCArICcvJyArIGRvY0lkICsgJz8kZG93bmxvYWQ9dHJ1ZSc7XG4gICAgaWYgKGRvY1ZlcnNpb24pIHtcbiAgICAgIHVybCA9IHVybCArICcmJHZlcnNpb249JyArIGRvY1ZlcnNpb247XG4gICAgfVxuICAgIC8vIHRvZG86IENoZWNrIHdoZXRoZXIgYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtIGlzIG9rIG9yIHdoZXRoZXIgd2Ugc2hvdWxkIGNoYW5nZSBpdFxuICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoe1xuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLFxuICAgIH0pO1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHVybCwgeyBoZWFkZXJzLCByZXNwb25zZVR5cGU6ICdibG9iJyBhcyAnanNvbicgfSk7XG4gIH1cblxuICBwdWJsaWMgdXBsb2FkRG9jdW1lbnQoZm9sZGVyVHlwZTogc3RyaW5nLCBmb2xkZXJJZDogc3RyaW5nLCBzYW5kYm94SWQ6IG51bWJlcixcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVUb1VwbG9hZDogRmlsZSwgZmlsZU5hbWU6IHN0cmluZywgZGVzY3JpcHRpb246IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgbGV0IHVybCA9ICcvd2VicmVzb3VyY2UvdjEvJyArIGZvbGRlclR5cGVcbiAgICAgICsgJy8nICsgZm9sZGVySWRcbiAgICAgICsgJy9hcnRpZmFjdHMvJyArIGZpbGVOYW1lICsgJy91cGxvYWQvJztcblxuICAgIGlmIChzYW5kYm94SWQpIHtcbiAgICAgIHVybCA9IHVybCArICc/JHNhbmRib3g9JyArIHNhbmRib3hJZDtcbiAgICB9XG5cbiAgICBpZiAoZGVzY3JpcHRpb24pIHtcbiAgICAgIHVybCA9IHVybCArICcmZGVzY3JpcHRpb249JyArIGRlc2NyaXB0aW9uO1xuICAgIH1cbiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHtcbiAgICAgICdhY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAnQ29udGVudC1UeXBlJzogJ211bHRpcGFydC9mb3JtLWRhdGEnLFxuICAgICAgJ2ZpbGVuYW1lJzogZmlsZU5hbWUsXG4gICAgICAnZW5jdHlwZSc6ICdtdWx0aXBhcnQvZm9ybS1kYXRhJ1xuICAgIH0pO1xuICAgIGNvbnN0IGZvcm1EYXRhOiBGb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgIGZvcm1EYXRhLmFwcGVuZCgnYXJ0aWZhY3RDb250ZW50cycsIGZpbGVUb1VwbG9hZCk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KHVybCwgZm9ybURhdGEsIHsgaGVhZGVyczogaGVhZGVycywgcmVwb3J0UHJvZ3Jlc3M6IHRydWUsIG9ic2VydmU6ICdldmVudHMnIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRJY29uKGV4dGVuc2lvbjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAoZXh0ZW5zaW9uID09PSAndHh0Jykge1xuICAgICAgcmV0dXJuKCdkb2MnKTtcbiAgICB9IGVsc2UgaWYgKGV4dGVuc2lvbiA9PT0gJ2NzcycpIHtcbiAgICAgIHJldHVybignZG9jJyk7XG4gICAgfSBlbHNlIGlmIChleHRlbnNpb24gPT09ICdqcycpIHtcbiAgICAgIHJldHVybignZG9jJyk7XG4gICAgfSBlbHNlIGlmIChleHRlbnNpb24gPT09ICdwZGYnKSB7XG4gICAgICByZXR1cm4oJ2RvYycpO1xuICAgIH0gZWxzZSBpZiAoZXh0ZW5zaW9uID09PSAneG1sJykge1xuICAgICAgcmV0dXJuKCdkb2MnKTtcbiAgICB9IGVsc2UgaWYgKGV4dGVuc2lvbiA9PT0gJ2RvYycpIHtcbiAgICAgIHJldHVybignZG9jJyk7XG4gICAgfSBlbHNlIGlmIChleHRlbnNpb24gPT09ICd6aXAnKSB7XG4gICAgICByZXR1cm4oJ3ppcCcpO1xuICAgIH0gZWxzZSBpZiAoZXh0ZW5zaW9uID09PSAncHB0Jykge1xuICAgICAgcmV0dXJuKCdkb2MnKTtcbiAgICB9IGVsc2UgaWYgKGV4dGVuc2lvbiA9PT0gJ3BuZycpIHtcbiAgICAgIHJldHVybignaW1hZ2UnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuKCdkb2MnKTtcbiAgICB9XG4gIH1cblxufVxuIl19