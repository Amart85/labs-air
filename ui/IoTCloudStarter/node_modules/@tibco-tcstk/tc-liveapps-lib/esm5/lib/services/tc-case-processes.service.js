/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { CaseActionsList, CaseCreatorsList, JsonSchema, Process } from '../models/liveappsdata';
import { LaProcessSelection } from '../models/tc-case-processes';
import { LiveAppsService } from './live-apps.service';
import { flatMap, map, tap } from 'rxjs/operators';
import { TcCaseDataService } from './tc-case-data.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./live-apps.service";
import * as i3 from "./tc-case-data.service";
var TcCaseProcessesService = /** @class */ (function () {
    function TcCaseProcessesService(http, liveAppsService, caseDataService) {
        var _this = this;
        this.http = http;
        this.liveAppsService = liveAppsService;
        this.caseDataService = caseDataService;
        this.getCaseIDAttributeName = (/**
         * @param {?} caseType
         * @return {?}
         */
        function (caseType) {
            /** @type {?} */
            var caseIdAttrib;
            caseType.attributes.forEach((/**
             * @param {?} attribute
             * @return {?}
             */
            function (attribute) {
                if (attribute.isIdentifier) {
                    caseIdAttrib = attribute;
                }
            }));
            return caseIdAttrib;
        });
        // this is a helper function that given a case type 'schema' for the whole application will create an LaProcessSelection object
        // containing both the appSchema and particular details for this action
        // this object is required to submit the process later.
        this.createLaProcessSelection = (/**
         * @param {?} schema
         * @param {?} appId
         * @param {?} typeId
         * @param {?} action
         * @param {?} creator
         * @param {?} caseRef
         * @return {?}
         */
        function (schema, appId, typeId, action, creator, caseRef) {
            /** @type {?} */
            var processSelection;
            schema.casetypes.forEach((/**
             * @param {?} casetype
             * @return {?}
             */
            function (casetype) {
                // the schema will contain definitions for both the 'case' and any defined types in that case.
                // We want the schema for this 'case'.
                if (casetype.applicationId === appId && casetype.id === typeId) {
                    // if ( casetype.jsonSchema !== undefined) {
                    if (action) {
                        /** @type {?} */
                        var caseActionList = casetype.actions ? casetype.actions : [];
                        // now find the selected action
                        caseActionList.forEach((/**
                         * @param {?} actionDef
                         * @return {?}
                         */
                        function (actionDef) {
                            if (action.id === actionDef.id) {
                                if (!actionDef.jsonSchema) {
                                    // create blank form schema
                                    actionDef.jsonSchema = new JsonSchema();
                                    actionDef.jsonSchema.type = 'object';
                                    actionDef.jsonSchema.properties = [];
                                }
                                processSelection = new LaProcessSelection('action', schema, _this.getCaseIDAttributeName(casetype), actionDef, 
                                // Format of ref is <applicationName>.<applicationInternalName>.<processType>.<processName>
                                (casetype.applicationName + '.' + casetype.applicationInternalName + '.' + 'action' + '.' + actionDef.name), caseRef);
                            }
                        }));
                        if (!processSelection) {
                            // no schema for this process
                            /** @type {?} */
                            var process = new Process().deserialize({ jsonSchema: { $schema: 'NOSCHEMA' }, name: action.name, id: action.id });
                            processSelection = new LaProcessSelection('action', schema, _this.getCaseIDAttributeName(casetype), process, 
                            // Format of ref is <applicationName>.<applicationInternalName>.<processType>.<processName>
                            (casetype.applicationName + '.' + casetype.applicationInternalName + '.' + 'action' + '.' + action.name), caseRef);
                        }
                    }
                    else if (creator) {
                        /** @type {?} */
                        var caseCreatorList = casetype.creators ? casetype.creators : [];
                        // now find the selected action
                        caseCreatorList.forEach((/**
                         * @param {?} creatorDef
                         * @return {?}
                         */
                        function (creatorDef) {
                            if (creator.id === creatorDef.id) {
                                if (!creatorDef.jsonSchema) {
                                    // create blank form schema
                                    creatorDef.jsonSchema = new JsonSchema();
                                    creatorDef.jsonSchema.type = 'object';
                                    creatorDef.jsonSchema.properties = [];
                                }
                                processSelection = new LaProcessSelection('creator', schema, _this.getCaseIDAttributeName(casetype), creatorDef, 
                                // Format of ref is <applicationName>.<applicationInternalName>.<processType>.<processName>
                                (casetype.applicationName + '.' + casetype.applicationInternalName + '.' + 'creator' + '.' + creatorDef.name), null);
                            }
                        }));
                        if (!processSelection) {
                            // no schema for this process
                            /** @type {?} */
                            var process = new Process().deserialize({ jsonSchema: { $schema: 'NOSCHEMA' }, name: creator.name, id: creator.id });
                            processSelection = new LaProcessSelection('creator', schema, _this.getCaseIDAttributeName(casetype), process, 
                            // Format of ref is <applicationName>.<applicationInternalName>.<processType>.<processName>
                            (casetype.applicationName + '.' + casetype.applicationInternalName + '.' + 'creator' + '.' + creator.name), null);
                        }
                    }
                }
                // }
            }));
            return processSelection;
        });
    }
    //  This service gets the case state then uses that and the caseRef to get the available actions.
    //  This service gets the case state then uses that and the caseRef to get the available actions.
    /**
     * @param {?} caseRef
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} typeId
     * @return {?}
     */
    TcCaseProcessesService.prototype.getCaseActionsForCaseRef = 
    //  This service gets the case state then uses that and the caseRef to get the available actions.
    /**
     * @param {?} caseRef
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} typeId
     * @return {?}
     */
    function (caseRef, sandboxId, appId, typeId) {
        var _this = this;
        /** @type {?} */
        var caseState$ = this.caseDataService.getCaseState(caseRef, sandboxId);
        /** @type {?} */
        var caseActions$ = caseState$.pipe(flatMap((/**
         * @param {?} caseState
         * @return {?}
         */
        function (caseState) {
            return _this.getCaseActions(caseRef, sandboxId, appId, typeId, caseState);
        })));
        return caseActions$;
    };
    // todo: Note this is not a public API - update when Public API available
    // todo: Note this is not a public API - update when Public API available
    /**
     * @param {?} caseRef
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} typeId
     * @param {?} caseState
     * @return {?}
     */
    TcCaseProcessesService.prototype.getCaseActions = 
    // todo: Note this is not a public API - update when Public API available
    /**
     * @param {?} caseRef
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} typeId
     * @param {?} caseState
     * @return {?}
     */
    function (caseRef, sandboxId, appId, typeId, caseState) {
        // https://eu.liveapps.cloud.tibco.com/pageflow/caseActions?$sandbox=31&
        // $filter=applicationId%20eq%201742%20and%20caseType%20eq%201%20and%20caseState%20eq%20Responded%20and%20caseRef%20eq%20150491
        /** @type {?} */
        var url = '/pageflow/v1/caseActions?$sandbox=' + sandboxId
            + '&$filter=applicationId eq ' + appId
            + ' and caseType eq ' + typeId
            + ' and caseState eq ' + caseState
            + ' and caseRef eq ' + caseRef;
        return this.http.get(url)
            .pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        function (val) { return sessionStorage.setItem('tcsTimestamp', Date.now().toString()); })), map((/**
         * @param {?} caseactions
         * @return {?}
         */
        function (caseactions) {
            /** @type {?} */
            var caList = new CaseActionsList().deserialize(caseactions);
            // non public API returns action Id as number, switch to string to match other APIs
            caList.actions.forEach((/**
             * @param {?} action
             * @return {?}
             */
            function (action) {
                if (typeof action.id === 'number') {
                    action.id = String(action.id);
                }
            }));
            return caList;
        })));
    };
    // todo: Note this is not a public API - update when Public API available
    // todo: Note this is not a public API - update when Public API available
    /**
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} typeId
     * @return {?}
     */
    TcCaseProcessesService.prototype.getCaseCreators = 
    // todo: Note this is not a public API - update when Public API available
    /**
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} typeId
     * @return {?}
     */
    function (sandboxId, appId, typeId) {
        /** @type {?} */
        var url = '/pageflow/v1/caseCreators?$sandbox=' + sandboxId
            + '&$filter=applicationId eq ' + appId
            + ' and caseType eq ' + typeId;
        return this.http.get(url)
            .pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        function (val) { return sessionStorage.setItem('tcsTimestamp', Date.now().toString()); })), map((/**
         * @param {?} casecreators
         * @return {?}
         */
        function (casecreators) {
            /** @type {?} */
            var ccList = new CaseCreatorsList().deserialize(casecreators);
            // non public API returns creator Id as number, switch to string to match other APIs
            ccList.creators.forEach((/**
             * @param {?} creator
             * @return {?}
             */
            function (creator) {
                if (typeof creator.id === 'number') {
                    creator.id = String(creator.id);
                }
            }));
            return ccList;
        })));
    };
    /**
     * @param {?} caseRef
     * @param {?} appId
     * @param {?} typeId
     * @param {?} sandboxId
     * @param {?} action
     * @param {?} creator
     * @param {?} top
     * @return {?}
     */
    TcCaseProcessesService.prototype.getProcessDetails = /**
     * @param {?} caseRef
     * @param {?} appId
     * @param {?} typeId
     * @param {?} sandboxId
     * @param {?} action
     * @param {?} creator
     * @param {?} top
     * @return {?}
     */
    function (caseRef, appId, typeId, sandboxId, action, creator, top) {
        var _this = this;
        return this.liveAppsService.getCaseTypeSchema(sandboxId, appId, top).pipe(map((/**
         * @param {?} schema
         * @return {?}
         */
        function (schema) {
            return _this.createLaProcessSelection(schema, appId, typeId, action ? action : null, creator ? creator : null, caseRef);
        })));
    };
    TcCaseProcessesService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    TcCaseProcessesService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: LiveAppsService },
        { type: TcCaseDataService }
    ]; };
    /** @nocollapse */ TcCaseProcessesService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function TcCaseProcessesService_Factory() { return new TcCaseProcessesService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.LiveAppsService), i0.ɵɵinject(i3.TcCaseDataService)); }, token: TcCaseProcessesService, providedIn: "root" });
    return TcCaseProcessesService;
}());
export { TcCaseProcessesService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    TcCaseProcessesService.prototype.getCaseIDAttributeName;
    /**
     * @type {?}
     * @private
     */
    TcCaseProcessesService.prototype.createLaProcessSelection;
    /**
     * @type {?}
     * @private
     */
    TcCaseProcessesService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    TcCaseProcessesService.prototype.liveAppsService;
    /**
     * @type {?}
     * @private
     */
    TcCaseProcessesService.prototype.caseDataService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGMtY2FzZS1wcm9jZXNzZXMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0aWJjby10Y3N0ay90Yy1saXZlYXBwcy1saWIvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvdGMtY2FzZS1wcm9jZXNzZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDaEQsT0FBTyxFQUVMLGVBQWUsRUFFZixnQkFBZ0IsRUFHaEIsVUFBVSxFQUNWLE9BQU8sRUFDUixNQUFNLHdCQUF3QixDQUFDO0FBQ2hDLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLDZCQUE2QixDQUFDO0FBQy9ELE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUVwRCxPQUFPLEVBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqRCxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQzs7Ozs7QUFFekQ7SUFLRSxnQ0FBb0IsSUFBZ0IsRUFBVSxlQUFnQyxFQUFVLGVBQWtDO1FBQTFILGlCQUErSDtRQUEzRyxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQVUsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQVUsb0JBQWUsR0FBZixlQUFlLENBQW1CO1FBOERsSCwyQkFBc0I7Ozs7UUFBRyxVQUFDLFFBQWtCOztnQkFDOUMsWUFBaUI7WUFDckIsUUFBUSxDQUFDLFVBQVUsQ0FBQyxPQUFPOzs7O1lBQUMsVUFBQyxTQUFTO2dCQUNwQyxJQUFJLFNBQVMsQ0FBQyxZQUFZLEVBQUU7b0JBQzFCLFlBQVksR0FBRyxTQUFTLENBQUM7aUJBQzFCO1lBQ0gsQ0FBQyxFQUFDLENBQUM7WUFDSCxPQUFPLFlBQVksQ0FBQztRQUN0QixDQUFDLEVBQUE7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QWlCLEVBQ2pCLE1BQWtCLEVBQ2xCLE9BQW9CLEVBQ3BCLEdBQVc7UUFQYixpQkFjQztRQU5HLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FDdkUsR0FBRzs7OztRQUFDLFVBQUEsTUFBTTtZQUNSLE9BQU8sS0FBSSxDQUFDLHdCQUF3QixDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUEsQ0FBQyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN0SCxDQUFDLEVBQ0YsQ0FDRixDQUFDO0lBQ04sQ0FBQzs7Z0JBN0tKLFVBQVUsU0FBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7Ozs7Z0JBbkJPLFVBQVU7Z0JBWVYsZUFBZTtnQkFHZixpQkFBaUI7OztpQ0FoQnpCO0NBZ01DLEFBOUtELElBOEtDO1NBM0tZLHNCQUFzQjs7Ozs7O0lBZ0VqQyx3REFRQzs7Ozs7SUFLRCwwREE2RUM7Ozs7O0lBeEpXLHNDQUF3Qjs7Ozs7SUFBRSxpREFBd0M7Ozs7O0lBQUUsaURBQTBDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtIdHRwQ2xpZW50fSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge1xuICBDYXNlQWN0aW9uLFxuICBDYXNlQWN0aW9uc0xpc3QsXG4gIENhc2VDcmVhdG9yLFxuICBDYXNlQ3JlYXRvcnNMaXN0LFxuICBDYXNlVHlwZSxcbiAgQ2FzZVR5cGVzTGlzdCxcbiAgSnNvblNjaGVtYSxcbiAgUHJvY2Vzc1xufSBmcm9tICcuLi9tb2RlbHMvbGl2ZWFwcHNkYXRhJztcbmltcG9ydCB7TGFQcm9jZXNzU2VsZWN0aW9ufSBmcm9tICcuLi9tb2RlbHMvdGMtY2FzZS1wcm9jZXNzZXMnO1xuaW1wb3J0IHtMaXZlQXBwc1NlcnZpY2V9IGZyb20gJy4vbGl2ZS1hcHBzLnNlcnZpY2UnO1xuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdyeGpzJztcbmltcG9ydCB7ZmxhdE1hcCwgbWFwLCB0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7VGNDYXNlRGF0YVNlcnZpY2V9IGZyb20gJy4vdGMtY2FzZS1kYXRhLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBUY0Nhc2VQcm9jZXNzZXNTZXJ2aWNlIHtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsIHByaXZhdGUgbGl2ZUFwcHNTZXJ2aWNlOiBMaXZlQXBwc1NlcnZpY2UsIHByaXZhdGUgY2FzZURhdGFTZXJ2aWNlOiBUY0Nhc2VEYXRhU2VydmljZSkgeyB9XG5cbiAgLy8gIFRoaXMgc2VydmljZSBnZXRzIHRoZSBjYXNlIHN0YXRlIHRoZW4gdXNlcyB0aGF0IGFuZCB0aGUgY2FzZVJlZiB0byBnZXQgdGhlIGF2YWlsYWJsZSBhY3Rpb25zLlxuICBwdWJsaWMgZ2V0Q2FzZUFjdGlvbnNGb3JDYXNlUmVmKGNhc2VSZWY6IHN0cmluZywgc2FuZGJveElkOiBudW1iZXIsIGFwcElkOiBzdHJpbmcsIHR5cGVJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxDYXNlQWN0aW9uc0xpc3Q+IHtcbiAgICBjb25zdCBjYXNlU3RhdGUkID0gdGhpcy5jYXNlRGF0YVNlcnZpY2UuZ2V0Q2FzZVN0YXRlKGNhc2VSZWYsIHNhbmRib3hJZCk7XG4gICAgY29uc3QgY2FzZUFjdGlvbnMkID0gY2FzZVN0YXRlJC5waXBlKFxuICAgICAgZmxhdE1hcChjYXNlU3RhdGUgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRDYXNlQWN0aW9ucyhjYXNlUmVmLCBzYW5kYm94SWQsIGFwcElkLCB0eXBlSWQsIGNhc2VTdGF0ZSk7XG4gICAgICB9KVxuICAgICk7XG4gICAgcmV0dXJuIGNhc2VBY3Rpb25zJDtcbiAgfVxuXG5cbi8vIHRvZG86IE5vdGUgdGhpcyBpcyBub3QgYSBwdWJsaWMgQVBJIC0gdXBkYXRlIHdoZW4gUHVibGljIEFQSSBhdmFpbGFibGVcbiAgcHVibGljIGdldENhc2VBY3Rpb25zKGNhc2VSZWY6IHN0cmluZywgc2FuZGJveElkOiBudW1iZXIsIGFwcElkOiBzdHJpbmcsIHR5cGVJZDogc3RyaW5nLCBjYXNlU3RhdGU6IHN0cmluZyk6IE9ic2VydmFibGU8Q2FzZUFjdGlvbnNMaXN0PiB7XG4gICAgLy8gaHR0cHM6Ly9ldS5saXZlYXBwcy5jbG91ZC50aWJjby5jb20vcGFnZWZsb3cvY2FzZUFjdGlvbnM/JHNhbmRib3g9MzEmXG4gICAgLy8gJGZpbHRlcj1hcHBsaWNhdGlvbklkJTIwZXElMjAxNzQyJTIwYW5kJTIwY2FzZVR5cGUlMjBlcSUyMDElMjBhbmQlMjBjYXNlU3RhdGUlMjBlcSUyMFJlc3BvbmRlZCUyMGFuZCUyMGNhc2VSZWYlMjBlcSUyMDE1MDQ5MVxuICAgIGNvbnN0IHVybCA9ICcvcGFnZWZsb3cvdjEvY2FzZUFjdGlvbnM/JHNhbmRib3g9JyArIHNhbmRib3hJZFxuICAgICAgKyAnJiRmaWx0ZXI9YXBwbGljYXRpb25JZCBlcSAnICsgYXBwSWRcbiAgICAgICsgJyBhbmQgY2FzZVR5cGUgZXEgJyArIHR5cGVJZFxuICAgICAgKyAnIGFuZCBjYXNlU3RhdGUgZXEgJyArIGNhc2VTdGF0ZVxuICAgICAgKyAnIGFuZCBjYXNlUmVmIGVxICcgKyBjYXNlUmVmO1xuXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcCggdmFsID0+IHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ3Rjc1RpbWVzdGFtcCcsIERhdGUubm93KCkudG9TdHJpbmcoKSkpLFxuICAgICAgICBtYXAoY2FzZWFjdGlvbnMgPT4ge1xuICAgICAgICAgIGNvbnN0IGNhTGlzdCA9IG5ldyBDYXNlQWN0aW9uc0xpc3QoKS5kZXNlcmlhbGl6ZShjYXNlYWN0aW9ucyk7XG4gICAgICAgICAgLy8gbm9uIHB1YmxpYyBBUEkgcmV0dXJucyBhY3Rpb24gSWQgYXMgbnVtYmVyLCBzd2l0Y2ggdG8gc3RyaW5nIHRvIG1hdGNoIG90aGVyIEFQSXNcbiAgICAgICAgICBjYUxpc3QuYWN0aW9ucy5mb3JFYWNoKGFjdGlvbiA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGFjdGlvbi5pZCA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgICAgYWN0aW9uLmlkID0gU3RyaW5nKGFjdGlvbi5pZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgICByZXR1cm4gY2FMaXN0O1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG5cbiAgLy8gdG9kbzogTm90ZSB0aGlzIGlzIG5vdCBhIHB1YmxpYyBBUEkgLSB1cGRhdGUgd2hlbiBQdWJsaWMgQVBJIGF2YWlsYWJsZVxuICBwdWJsaWMgZ2V0Q2FzZUNyZWF0b3JzKHNhbmRib3hJZDogbnVtYmVyLCBhcHBJZDogc3RyaW5nLCB0eXBlSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8Q2FzZUNyZWF0b3JzTGlzdD4ge1xuICAgIGNvbnN0IHVybCA9ICcvcGFnZWZsb3cvdjEvY2FzZUNyZWF0b3JzPyRzYW5kYm94PScgKyBzYW5kYm94SWRcbiAgICAgICsgJyYkZmlsdGVyPWFwcGxpY2F0aW9uSWQgZXEgJyArIGFwcElkXG4gICAgICArICcgYW5kIGNhc2VUeXBlIGVxICcgKyB0eXBlSWRcblxuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHVybClcbiAgICAgIC5waXBlKFxuICAgICAgICB0YXAoIHZhbCA9PiBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCd0Y3NUaW1lc3RhbXAnLCBEYXRlLm5vdygpLnRvU3RyaW5nKCkpKSxcbiAgICAgICAgbWFwKGNhc2VjcmVhdG9ycyA9PiB7XG4gICAgICAgICAgY29uc3QgY2NMaXN0ID0gbmV3IENhc2VDcmVhdG9yc0xpc3QoKS5kZXNlcmlhbGl6ZShjYXNlY3JlYXRvcnMpO1xuICAgICAgICAgIC8vIG5vbiBwdWJsaWMgQVBJIHJldHVybnMgY3JlYXRvciBJZCBhcyBudW1iZXIsIHN3aXRjaCB0byBzdHJpbmcgdG8gbWF0Y2ggb3RoZXIgQVBJc1xuICAgICAgICAgIGNjTGlzdC5jcmVhdG9ycy5mb3JFYWNoKGNyZWF0b3IgPT4ge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBjcmVhdG9yLmlkID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgICBjcmVhdG9yLmlkID0gU3RyaW5nKGNyZWF0b3IuaWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgICAgcmV0dXJuIGNjTGlzdDtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldENhc2VJREF0dHJpYnV0ZU5hbWUgPSAoY2FzZVR5cGU6IENhc2VUeXBlKSA9PiB7XG4gICAgbGV0IGNhc2VJZEF0dHJpYjogYW55O1xuICAgIGNhc2VUeXBlLmF0dHJpYnV0ZXMuZm9yRWFjaCgoYXR0cmlidXRlKSA9PiB7XG4gICAgICBpZiAoYXR0cmlidXRlLmlzSWRlbnRpZmllcikge1xuICAgICAgICBjYXNlSWRBdHRyaWIgPSBhdHRyaWJ1dGU7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGNhc2VJZEF0dHJpYjtcbiAgfVxuXG4gIC8vIHRoaXMgaXMgYSBoZWxwZXIgZnVuY3Rpb24gdGhhdCBnaXZlbiBhIGNhc2UgdHlwZSAnc2NoZW1hJyBmb3IgdGhlIHdob2xlIGFwcGxpY2F0aW9uIHdpbGwgY3JlYXRlIGFuIExhUHJvY2Vzc1NlbGVjdGlvbiBvYmplY3RcbiAgLy8gY29udGFpbmluZyBib3RoIHRoZSBhcHBTY2hlbWEgYW5kIHBhcnRpY3VsYXIgZGV0YWlscyBmb3IgdGhpcyBhY3Rpb25cbiAgLy8gdGhpcyBvYmplY3QgaXMgcmVxdWlyZWQgdG8gc3VibWl0IHRoZSBwcm9jZXNzIGxhdGVyLlxuICBwcml2YXRlIGNyZWF0ZUxhUHJvY2Vzc1NlbGVjdGlvbiA9IChcbiAgICBzY2hlbWE6IENhc2VUeXBlc0xpc3QsXG4gICAgYXBwSWQ6IHN0cmluZyxcbiAgICB0eXBlSWQ6IHN0cmluZyxcbiAgICBhY3Rpb246IENhc2VBY3Rpb24sXG4gICAgY3JlYXRvcjogQ2FzZUNyZWF0b3IsXG4gICAgY2FzZVJlZjogc3RyaW5nKTogTGFQcm9jZXNzU2VsZWN0aW9uID0+IHtcbiAgICAgIGxldCBwcm9jZXNzU2VsZWN0aW9uOiBMYVByb2Nlc3NTZWxlY3Rpb247XG4gICAgICBzY2hlbWEuY2FzZXR5cGVzLmZvckVhY2goKGNhc2V0eXBlKSA9PiB7XG4gICAgICAgICAgLy8gdGhlIHNjaGVtYSB3aWxsIGNvbnRhaW4gZGVmaW5pdGlvbnMgZm9yIGJvdGggdGhlICdjYXNlJyBhbmQgYW55IGRlZmluZWQgdHlwZXMgaW4gdGhhdCBjYXNlLlxuICAgICAgICAgIC8vIFdlIHdhbnQgdGhlIHNjaGVtYSBmb3IgdGhpcyAnY2FzZScuXG4gICAgICAgICAgaWYgKGNhc2V0eXBlLmFwcGxpY2F0aW9uSWQgPT09IGFwcElkICYmIGNhc2V0eXBlLmlkID09PSB0eXBlSWQpIHtcbiAgICAgICAgICAgIC8vIGlmICggY2FzZXR5cGUuanNvblNjaGVtYSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgIGlmIChhY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjYXNlQWN0aW9uTGlzdCA9IGNhc2V0eXBlLmFjdGlvbnMgPyBjYXNldHlwZS5hY3Rpb25zIDogW107XG4gICAgICAgICAgICAgICAgLy8gbm93IGZpbmQgdGhlIHNlbGVjdGVkIGFjdGlvblxuICAgICAgICAgICAgICAgIGNhc2VBY3Rpb25MaXN0LmZvckVhY2goKGFjdGlvbkRlZikgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbi5pZCA9PT0gYWN0aW9uRGVmLmlkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYWN0aW9uRGVmLmpzb25TY2hlbWEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAvLyBjcmVhdGUgYmxhbmsgZm9ybSBzY2hlbWFcbiAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25EZWYuanNvblNjaGVtYSA9IG5ldyBKc29uU2NoZW1hKCk7XG4gICAgICAgICAgICAgICAgICAgICAgYWN0aW9uRGVmLmpzb25TY2hlbWEudHlwZSA9ICdvYmplY3QnO1xuICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkRlZi5qc29uU2NoZW1hLnByb3BlcnRpZXMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBwcm9jZXNzU2VsZWN0aW9uID0gbmV3IExhUHJvY2Vzc1NlbGVjdGlvbihcbiAgICAgICAgICAgICAgICAgICAgICAnYWN0aW9uJywgc2NoZW1hLCB0aGlzLmdldENhc2VJREF0dHJpYnV0ZU5hbWUoY2FzZXR5cGUpLCBhY3Rpb25EZWYsXG4gICAgICAgICAgICAgICAgICAgICAgLy8gRm9ybWF0IG9mIHJlZiBpcyA8YXBwbGljYXRpb25OYW1lPi48YXBwbGljYXRpb25JbnRlcm5hbE5hbWU+Ljxwcm9jZXNzVHlwZT4uPHByb2Nlc3NOYW1lPlxuICAgICAgICAgICAgICAgICAgICAgIChjYXNldHlwZS5hcHBsaWNhdGlvbk5hbWUgKyAnLicgKyBjYXNldHlwZS5hcHBsaWNhdGlvbkludGVybmFsTmFtZSArICcuJyArICdhY3Rpb24nICsgJy4nICsgYWN0aW9uRGVmLm5hbWUpLFxuICAgICAgICAgICAgICAgICAgICAgIGNhc2VSZWZcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAoIXByb2Nlc3NTZWxlY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgIC8vIG5vIHNjaGVtYSBmb3IgdGhpcyBwcm9jZXNzXG4gICAgICAgICAgICAgICAgICBjb25zdCBwcm9jZXNzOiBQcm9jZXNzID0gbmV3IFByb2Nlc3MoKS5kZXNlcmlhbGl6ZSh7IGpzb25TY2hlbWE6IHsgJHNjaGVtYTogJ05PU0NIRU1BJyB9LCBuYW1lOiBhY3Rpb24ubmFtZSwgaWQ6IGFjdGlvbi5pZCB9KTtcbiAgICAgICAgICAgICAgICAgIHByb2Nlc3NTZWxlY3Rpb24gPSBuZXcgTGFQcm9jZXNzU2VsZWN0aW9uKFxuICAgICAgICAgICAgICAgICAgICAnYWN0aW9uJywgc2NoZW1hLCB0aGlzLmdldENhc2VJREF0dHJpYnV0ZU5hbWUoY2FzZXR5cGUpLCBwcm9jZXNzLFxuICAgICAgICAgICAgICAgICAgICAvLyBGb3JtYXQgb2YgcmVmIGlzIDxhcHBsaWNhdGlvbk5hbWU+LjxhcHBsaWNhdGlvbkludGVybmFsTmFtZT4uPHByb2Nlc3NUeXBlPi48cHJvY2Vzc05hbWU+XG4gICAgICAgICAgICAgICAgICAgIChjYXNldHlwZS5hcHBsaWNhdGlvbk5hbWUgKyAnLicgKyBjYXNldHlwZS5hcHBsaWNhdGlvbkludGVybmFsTmFtZSArICcuJyArICdhY3Rpb24nICsgJy4nICsgYWN0aW9uLm5hbWUpLFxuICAgICAgICAgICAgICAgICAgICBjYXNlUmVmXG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSBlbHNlIGlmIChjcmVhdG9yKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2FzZUNyZWF0b3JMaXN0ID0gY2FzZXR5cGUuY3JlYXRvcnMgPyBjYXNldHlwZS5jcmVhdG9ycyA6IFtdO1xuICAgICAgICAgICAgICAgIC8vIG5vdyBmaW5kIHRoZSBzZWxlY3RlZCBhY3Rpb25cbiAgICAgICAgICAgICAgICBjYXNlQ3JlYXRvckxpc3QuZm9yRWFjaCgoY3JlYXRvckRlZikgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKGNyZWF0b3IuaWQgPT09IGNyZWF0b3JEZWYuaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjcmVhdG9yRGVmLmpzb25TY2hlbWEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAvLyBjcmVhdGUgYmxhbmsgZm9ybSBzY2hlbWFcbiAgICAgICAgICAgICAgICAgICAgICBjcmVhdG9yRGVmLmpzb25TY2hlbWEgPSBuZXcgSnNvblNjaGVtYSgpO1xuICAgICAgICAgICAgICAgICAgICAgIGNyZWF0b3JEZWYuanNvblNjaGVtYS50eXBlID0gJ29iamVjdCc7XG4gICAgICAgICAgICAgICAgICAgICAgY3JlYXRvckRlZi5qc29uU2NoZW1hLnByb3BlcnRpZXMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBwcm9jZXNzU2VsZWN0aW9uID0gbmV3IExhUHJvY2Vzc1NlbGVjdGlvbihcbiAgICAgICAgICAgICAgICAgICAgICAnY3JlYXRvcicsIHNjaGVtYSwgdGhpcy5nZXRDYXNlSURBdHRyaWJ1dGVOYW1lKGNhc2V0eXBlKSwgY3JlYXRvckRlZixcbiAgICAgICAgICAgICAgICAgICAgICAvLyBGb3JtYXQgb2YgcmVmIGlzIDxhcHBsaWNhdGlvbk5hbWU+LjxhcHBsaWNhdGlvbkludGVybmFsTmFtZT4uPHByb2Nlc3NUeXBlPi48cHJvY2Vzc05hbWU+XG4gICAgICAgICAgICAgICAgICAgICAgKGNhc2V0eXBlLmFwcGxpY2F0aW9uTmFtZSArICcuJyArIGNhc2V0eXBlLmFwcGxpY2F0aW9uSW50ZXJuYWxOYW1lICsgJy4nICsgJ2NyZWF0b3InICsgJy4nICsgY3JlYXRvckRlZi5uYW1lKSxcbiAgICAgICAgICAgICAgICAgICAgICBudWxsXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaWYgKCFwcm9jZXNzU2VsZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAvLyBubyBzY2hlbWEgZm9yIHRoaXMgcHJvY2Vzc1xuICAgICAgICAgICAgICAgICAgY29uc3QgcHJvY2VzczogUHJvY2VzcyA9IG5ldyBQcm9jZXNzKCkuZGVzZXJpYWxpemUoeyBqc29uU2NoZW1hOiB7ICRzY2hlbWE6ICdOT1NDSEVNQScgfSwgbmFtZTogY3JlYXRvci5uYW1lLCBpZDogY3JlYXRvci5pZCB9KTtcbiAgICAgICAgICAgICAgICAgIHByb2Nlc3NTZWxlY3Rpb24gPSBuZXcgTGFQcm9jZXNzU2VsZWN0aW9uKFxuICAgICAgICAgICAgICAgICAgICAnY3JlYXRvcicsIHNjaGVtYSwgdGhpcy5nZXRDYXNlSURBdHRyaWJ1dGVOYW1lKGNhc2V0eXBlKSwgcHJvY2VzcyxcbiAgICAgICAgICAgICAgICAgICAgLy8gRm9ybWF0IG9mIHJlZiBpcyA8YXBwbGljYXRpb25OYW1lPi48YXBwbGljYXRpb25JbnRlcm5hbE5hbWU+Ljxwcm9jZXNzVHlwZT4uPHByb2Nlc3NOYW1lPlxuICAgICAgICAgICAgICAgICAgICAoY2FzZXR5cGUuYXBwbGljYXRpb25OYW1lICsgJy4nICsgY2FzZXR5cGUuYXBwbGljYXRpb25JbnRlcm5hbE5hbWUgKyAnLicgKyAnY3JlYXRvcicgKyAnLicgKyBjcmVhdG9yLm5hbWUpLFxuICAgICAgICAgICAgICAgICAgICBudWxsXG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIC8vIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHJldHVybiBwcm9jZXNzU2VsZWN0aW9uO1xuICB9XG5cbiAgICBwdWJsaWMgZ2V0UHJvY2Vzc0RldGFpbHMoXG4gICAgICBjYXNlUmVmOiBzdHJpbmcsXG4gICAgICBhcHBJZDogc3RyaW5nLFxuICAgICAgdHlwZUlkOiBzdHJpbmcsXG4gICAgICBzYW5kYm94SWQ6IG51bWJlcixcbiAgICAgIGFjdGlvbjogQ2FzZUFjdGlvbixcbiAgICAgIGNyZWF0b3I6IENhc2VDcmVhdG9yLFxuICAgICAgdG9wOiBudW1iZXIpOiBPYnNlcnZhYmxlPExhUHJvY2Vzc1NlbGVjdGlvbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5saXZlQXBwc1NlcnZpY2UuZ2V0Q2FzZVR5cGVTY2hlbWEoc2FuZGJveElkLCBhcHBJZCwgdG9wKS5waXBlKFxuICAgICAgICAgIG1hcChzY2hlbWEgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlTGFQcm9jZXNzU2VsZWN0aW9uKHNjaGVtYSwgYXBwSWQsIHR5cGVJZCwgYWN0aW9uID8gYWN0aW9uIDogbnVsbCwgY3JlYXRvciA/IGNyZWF0b3I6IG51bGwsIGNhc2VSZWYpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=