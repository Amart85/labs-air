/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
// This guard is to check whether the user has appropriate role to access a route based on config settings
import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { LiveAppsService } from '../services/live-apps.service';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { map } from 'rxjs/operators';
import { forkJoin } from 'rxjs';
import { TcCoreCommonFunctions, TcGeneralConfigService, TcSharedStateService } from '@tibco-tcstk/tc-core-lib';
import { Location } from '@angular/common';
import { RouteAccessControlConfig } from '../models/tc-groups-data';
import { RolesResolver } from '../resolvers/roles.resolver';
var RoleGuard = /** @class */ (function () {
    function RoleGuard(liveapps, router, http, location, sharedStateService, generalConfigService) {
        var _this = this;
        this.liveapps = liveapps;
        this.router = router;
        this.http = http;
        this.location = location;
        this.sharedStateService = sharedStateService;
        this.generalConfigService = generalConfigService;
        this.DEFAULT_CONFIG_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/routeAccessControl.json');
        // can be used to load defaultAppConfig from a JSON config
        this.getRouteAccessControlConfig = (/**
         * @return {?}
         */
        function () {
            /** @type {?} */
            var headers = new HttpHeaders().set('cacheResponse', 'true');
            return _this.http.get(_this.DEFAULT_CONFIG_URL, { headers: headers }).pipe(map((/**
             * @param {?} configContents
             * @return {?}
             */
            function (configContents) { return new RouteAccessControlConfig().deserialize(configContents); })));
        });
        this.getRouteDef = (/**
         * @param {?} routeAccessConfig
         * @param {?} route
         * @return {?}
         */
        function (routeAccessConfig, route) {
            return routeAccessConfig.routes.find((/**
             * @param {?} routeRec
             * @return {?}
             */
            function (routeRec) {
                return (routeRec.routeUrl === route.routeConfig.path);
            }));
        });
        this.hasAccess = (/**
         * @param {?} config
         * @param {?} roles
         * @return {?}
         */
        function (config, roles) {
            /** @type {?} */
            var reqRole = roles.roles.find((/**
             * @param {?} role
             * @return {?}
             */
            function (role) {
                return (role.id === config.requiredRoleId);
            }));
            return reqRole ? true : false;
        });
    }
    /**
     * @param {?} route
     * @param {?} state
     * @return {?}
     */
    RoleGuard.prototype.canActivate = /**
     * @param {?} route
     * @param {?} state
     * @return {?}
     */
    function (route, state) {
        var _this = this;
        // get route config
        /** @type {?} */
        var routeConfig$ = this.getRouteAccessControlConfig();
        // we will need the roles we currently have
        /** @type {?} */
        var currentRolesRes = new RolesResolver(this.sharedStateService, this.generalConfigService, this.http, this.liveapps, this.location);
        /** @type {?} */
        var currentRoles$ = currentRolesRes.resolve();
        // run both in parallel then check access
        /** @type {?} */
        var decision$ = forkJoin(routeConfig$, currentRoles$).pipe(map((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var _b = tslib_1.__read(_a, 2), routeConfig = _b[0], currentRoles = _b[1];
            /** @type {?} */
            var routeConfigRec = _this.getRouteDef(routeConfig, route);
            if (_this.hasAccess(routeConfigRec, currentRoles)) {
                return true;
            }
            else {
                console.error('You do not have access to this page: ', route);
                _this.router.navigate(['/errorHandler/' + 'NO_ROUTE_ACCESS/' + 'Route <' + route.url + '> requires role <' + routeConfigRec.requiredRoleId + '>']);
                return false;
            }
        })));
        return decision$;
    };
    RoleGuard.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    RoleGuard.ctorParameters = function () { return [
        { type: LiveAppsService },
        { type: Router },
        { type: HttpClient },
        { type: Location },
        { type: TcSharedStateService },
        { type: TcGeneralConfigService }
    ]; };
    return RoleGuard;
}());
export { RoleGuard };
if (false) {
    /** @type {?} */
    RoleGuard.prototype.DEFAULT_CONFIG_URL;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.getRouteAccessControlConfig;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.getRouteDef;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.hasAccess;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.liveapps;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.router;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.http;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.location;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.sharedStateService;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.generalConfigService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm9sZS5ndWFyZC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0aWJjby10Y3N0ay90Yy1saXZlYXBwcy1saWIvIiwic291cmNlcyI6WyJsaWIvZ3VhcmRzL3JvbGUuZ3VhcmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBRUEsT0FBTyxFQUFTLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQUMsTUFBTSxFQUEyRCxNQUFNLGlCQUFpQixDQUFDO0FBQ2pHLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSwrQkFBK0IsQ0FBQztBQUM5RCxPQUFPLEVBQUMsVUFBVSxFQUFlLFdBQVcsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQzFFLE9BQU8sRUFBc0IsR0FBRyxFQUFXLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEUsT0FBTyxFQUFDLFFBQVEsRUFBNkIsTUFBTSxNQUFNLENBQUM7QUFFMUQsT0FBTyxFQUErQixxQkFBcUIsRUFBRSxzQkFBc0IsRUFBRSxvQkFBb0IsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBQzNJLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQVEsd0JBQXdCLEVBQWlCLE1BQU0sMEJBQTBCLENBQUM7QUFDekYsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLDZCQUE2QixDQUFDO0FBRTFEO0lBS0UsbUJBQW9CLFFBQXlCLEVBQVUsTUFBYyxFQUFVLElBQWdCLEVBQVUsUUFBa0IsRUFBVSxrQkFBd0MsRUFBVSxvQkFBNEM7UUFBbk8saUJBQ0M7UUFEbUIsYUFBUSxHQUFSLFFBQVEsQ0FBaUI7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVUsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUFVLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQXNCO1FBQVUseUJBQW9CLEdBQXBCLG9CQUFvQixDQUF3QjtRQUZuTyx1QkFBa0IsR0FBRyxxQkFB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QUVwQix1Q0FBK0g7Ozs7O0lBTS9ILGdEQUtDOzs7OztJQUVELGdDQUlDOzs7OztJQUVELDhCQUtDOzs7OztJQXRCVyw2QkFBaUM7Ozs7O0lBQUUsMkJBQXNCOzs7OztJQUFFLHlCQUF3Qjs7Ozs7SUFBRSw2QkFBMEI7Ozs7O0lBQUUsdUNBQWdEOzs7OztJQUFFLHlDQUFvRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIFRoaXMgZ3VhcmQgaXMgdG8gY2hlY2sgd2hldGhlciB0aGUgdXNlciBoYXMgYXBwcm9wcmlhdGUgcm9sZSB0byBhY2Nlc3MgYSByb3V0ZSBiYXNlZCBvbiBjb25maWcgc2V0dGluZ3NcblxuaW1wb3J0IHtJbmplY3QsIEluamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtSb3V0ZXIsIENhbkFjdGl2YXRlLCBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBSb3V0ZXJTdGF0ZVNuYXBzaG90fSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHtMaXZlQXBwc1NlcnZpY2V9IGZyb20gJy4uL3NlcnZpY2VzL2xpdmUtYXBwcy5zZXJ2aWNlJztcbmltcG9ydCB7SHR0cENsaWVudCwgSHR0cEhhbmRsZXIsIEh0dHBIZWFkZXJzfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge2NhdGNoRXJyb3IsIGZsYXRNYXAsIG1hcCwgbWVyZ2VNYXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7Zm9ya0pvaW4sIE9ic2VydmFibGUsIG9mLCB0aHJvd0Vycm9yfSBmcm9tICdyeGpzJztcbmltcG9ydCB7Q2xhaW1zUmVzb2x2ZXJ9IGZyb20gJy4uL3Jlc29sdmVycy9jbGFpbXMucmVzb2x2ZXInO1xuaW1wb3J0IHtDbGFpbSwgR2VuZXJhbENvbmZpZ1Jlc29sdmVyLCBUY0NvcmVDb21tb25GdW5jdGlvbnMsIFRjR2VuZXJhbENvbmZpZ1NlcnZpY2UsIFRjU2hhcmVkU3RhdGVTZXJ2aWNlfSBmcm9tICdAdGliY28tdGNzdGsvdGMtY29yZS1saWInO1xuaW1wb3J0IHtMb2NhdGlvbn0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7Um9sZXMsIFJvdXRlQWNjZXNzQ29udHJvbENvbmZpZywgUm91dGVBY2Nlc3NEZWZ9IGZyb20gJy4uL21vZGVscy90Yy1ncm91cHMtZGF0YSc7XG5pbXBvcnQge1JvbGVzUmVzb2x2ZXJ9IGZyb20gJy4uL3Jlc29sdmVycy9yb2xlcy5yZXNvbHZlcic7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBSb2xlR3VhcmQgaW1wbGVtZW50cyBDYW5BY3RpdmF0ZSB7XG5cbiAgREVGQVVMVF9DT05GSUdfVVJMID0gVGNDb3JlQ29tbW9uRnVuY3Rpb25zLnByZXBhcmVVcmxGb3JTdGF0aWNSZXNvdXJjZSh0aGlzLmxvY2F0aW9uLCAnYXNzZXRzL2NvbmZpZy9yb3V0ZUFjY2Vzc0NvbnRyb2wuanNvbicpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbGl2ZWFwcHM6IExpdmVBcHBzU2VydmljZSwgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlciwgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LCBwcml2YXRlIGxvY2F0aW9uOiBMb2NhdGlvbiwgcHJpdmF0ZSBzaGFyZWRTdGF0ZVNlcnZpY2U6IFRjU2hhcmVkU3RhdGVTZXJ2aWNlLCBwcml2YXRlIGdlbmVyYWxDb25maWdTZXJ2aWNlOiBUY0dlbmVyYWxDb25maWdTZXJ2aWNlKSB7XG4gIH1cblxuICAvLyBjYW4gYmUgdXNlZCB0byBsb2FkIGRlZmF1bHRBcHBDb25maWcgZnJvbSBhIEpTT04gY29uZmlnXG4gIHByaXZhdGUgZ2V0Um91dGVBY2Nlc3NDb250cm9sQ29uZmlnID0gKCk6IE9ic2VydmFibGU8Um91dGVBY2Nlc3NDb250cm9sQ29uZmlnPiA9PiB7XG4gICAgY29uc3QgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpLnNldCgnY2FjaGVSZXNwb25zZScsICd0cnVlJyk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodGhpcy5ERUZBVUxUX0NPTkZJR19VUkwsIHsgaGVhZGVycyB9KS5waXBlKFxuICAgICAgbWFwKGNvbmZpZ0NvbnRlbnRzID0+IG5ldyBSb3V0ZUFjY2Vzc0NvbnRyb2xDb25maWcoKS5kZXNlcmlhbGl6ZShjb25maWdDb250ZW50cykpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Um91dGVEZWYgPSAocm91dGVBY2Nlc3NDb25maWc6IFJvdXRlQWNjZXNzQ29udHJvbENvbmZpZywgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBSb3V0ZUFjY2Vzc0RlZiA9PiB7XG4gICAgcmV0dXJuIHJvdXRlQWNjZXNzQ29uZmlnLnJvdXRlcy5maW5kKHJvdXRlUmVjID0+IHtcbiAgICAgIHJldHVybiAocm91dGVSZWMucm91dGVVcmwgPT09IHJvdXRlLnJvdXRlQ29uZmlnLnBhdGgpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBoYXNBY2Nlc3MgPSAoY29uZmlnOiBSb3V0ZUFjY2Vzc0RlZiwgcm9sZXM6IFJvbGVzKTogYm9vbGVhbiA9PiB7XG4gICAgY29uc3QgcmVxUm9sZSA9IHJvbGVzLnJvbGVzLmZpbmQocm9sZSA9PiB7XG4gICAgICByZXR1cm4gKHJvbGUuaWQgPT09IGNvbmZpZy5yZXF1aXJlZFJvbGVJZCk7XG4gICAgfSlcbiAgICByZXR1cm4gcmVxUm9sZSA/IHRydWUgOiBmYWxzZTtcbiAgfVxuXG4gIGNhbkFjdGl2YXRlKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBzdGF0ZTogUm91dGVyU3RhdGVTbmFwc2hvdCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIC8vIGdldCByb3V0ZSBjb25maWdcbiAgICBjb25zdCByb3V0ZUNvbmZpZyQgPSB0aGlzLmdldFJvdXRlQWNjZXNzQ29udHJvbENvbmZpZygpO1xuXG4gICAgLy8gd2Ugd2lsbCBuZWVkIHRoZSByb2xlcyB3ZSBjdXJyZW50bHkgaGF2ZVxuICAgIGNvbnN0IGN1cnJlbnRSb2xlc1JlcyA9IG5ldyBSb2xlc1Jlc29sdmVyKHRoaXMuc2hhcmVkU3RhdGVTZXJ2aWNlLCB0aGlzLmdlbmVyYWxDb25maWdTZXJ2aWNlLCB0aGlzLmh0dHAsIHRoaXMubGl2ZWFwcHMsIHRoaXMubG9jYXRpb24pXG4gICAgY29uc3QgY3VycmVudFJvbGVzJCA9IGN1cnJlbnRSb2xlc1Jlcy5yZXNvbHZlKCk7XG5cbiAgICAvLyBydW4gYm90aCBpbiBwYXJhbGxlbCB0aGVuIGNoZWNrIGFjY2Vzc1xuICAgIGNvbnN0IGRlY2lzaW9uJCA9IGZvcmtKb2luKHJvdXRlQ29uZmlnJCwgY3VycmVudFJvbGVzJCkucGlwZShcbiAgICAgIG1hcCgoW3JvdXRlQ29uZmlnLCBjdXJyZW50Um9sZXNdKSA9PiB7XG4gICAgICAgIGNvbnN0IHJvdXRlQ29uZmlnUmVjID0gdGhpcy5nZXRSb3V0ZURlZihyb3V0ZUNvbmZpZywgcm91dGUpO1xuICAgICAgICBpZiAodGhpcy5oYXNBY2Nlc3Mocm91dGVDb25maWdSZWMsIGN1cnJlbnRSb2xlcykpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdZb3UgZG8gbm90IGhhdmUgYWNjZXNzIHRvIHRoaXMgcGFnZTogJywgcm91dGUpO1xuICAgICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnL2Vycm9ySGFuZGxlci8nICsgJ05PX1JPVVRFX0FDQ0VTUy8nICsgJ1JvdXRlIDwnICsgcm91dGUudXJsICsgJz4gcmVxdWlyZXMgcm9sZSA8JyArIHJvdXRlQ29uZmlnUmVjLnJlcXVpcmVkUm9sZUlkICsgJz4nIF0pO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSkpO1xuXG4gICAgcmV0dXJuIGRlY2lzaW9uJDtcbiAgfVxuXG59XG4iXX0=