/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { of } from 'rxjs';
import { TcCoreCommonFunctions, UiAppIdConfig } from '@tibco-tcstk/tc-core-lib';
import { flatMap, map, mergeMap, switchMap } from 'rxjs/operators';
import { TcSharedStateService } from '@tibco-tcstk/tc-core-lib';
import { HttpClient } from '@angular/common/http';
import { TcLiveAppsConfigService } from '../services/tc-live-apps-config.service';
import { LiveAppsConfig } from '../models/tc-liveapps-config';
import { TcCaseCardConfigService } from '../services/tc-case-card-config.service';
import { Location } from '@angular/common';
export class LiveAppsConfigResolver {
    /**
     * @param {?} tcSharedState
     * @param {?} liveAppsConfigService
     * @param {?} caseCardConfigService
     * @param {?} http
     * @param {?} location
     */
    constructor(tcSharedState, liveAppsConfigService, caseCardConfigService, http, location) {
        this.tcSharedState = tcSharedState;
        this.liveAppsConfigService = liveAppsConfigService;
        this.caseCardConfigService = caseCardConfigService;
        this.http = http;
        this.location = location;
        this.DEFAULT_CONFIG_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/liveAppsConfig.json');
        this.APP_ID_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/uiAppId.json');
        // note appConfigResolver will need sandboxId to create app config state record.
        // So we expect this to have been set by caller (done by tc-liveapps-lib/laConfigResolver).
        this.setSandbox = (/**
         * @param {?} sandboxId
         * @return {?}
         */
        (sandboxId) => {
            this.sandboxId = sandboxId;
        });
        // can be used to load defaultAppConfig from a JSON config
        this.getDefaultAppConfig = (/**
         * @return {?}
         */
        () => {
            return this.http.get(this.DEFAULT_CONFIG_URL);
        });
        // loads uiAppId from json file in assets (appId.json)
        this.getAppId = (/**
         * @return {?}
         */
        () => {
            return this.http.get(this.APP_ID_URL).pipe(map((/**
             * @param {?} uiAppId
             * @return {?}
             */
            uiAppId => {
                /** @type {?} */
                const uiAppIdConfig = new UiAppIdConfig().deserialize(uiAppId);
                this.uiAppId = uiAppIdConfig.uiAppId;
                return uiAppIdConfig;
            })));
        });
        this.triggerCardConfigFetch = (/**
         * @param {?} liveAppsConfig
         * @return {?}
         */
        (liveAppsConfig) => {
            // optimization: I want to avoid reading the card config when we display a large list of cards in the calling app
            // therefore we can trigger of a read of the card configs for each app in the config to ensure they are cached by
            // http interceptor
            /** @type {?} */
            const laConfig = new LiveAppsConfig().deserialize(liveAppsConfig);
            laConfig.applicationIds.forEach((/**
             * @param {?} appId
             * @return {?}
             */
            appId => {
                this.caseCardConfigService.getCardConfig(this.uiAppId, appId, true, false).subscribe();
            }));
        });
    }
    /**
     * @param {?} routeSnapshot
     * @return {?}
     */
    resolve(routeSnapshot) {
        /** @type {?} */
        const appConfig = this.getAppId().pipe(switchMap((/**
         * @param {?} uiAppId
         * @return {?}
         */
        uiAppId => this.liveAppsConfigService.getLiveAppsConfig(uiAppId.uiAppId, true, false)
            .pipe(mergeMap((/**
         * @param {?} liveAppsConfig
         * @return {?}
         */
        liveAppsConfig => {
            if (liveAppsConfig === undefined) {
                return this.getDefaultAppConfig().pipe(flatMap((/**
                 * @param {?} config
                 * @return {?}
                 */
                config => {
                    this.defaultAppConfig = new LiveAppsConfig().deserialize(config);
                    this.defaultAppConfig.caseIconsFolderId = this.uiAppId + '_Icons';
                    return this.liveAppsConfigService.createLiveAppsConfig(this.sandboxId, uiAppId.uiAppId, this.defaultAppConfig)
                        .pipe(map((/**
                     * @param {?} result
                     * @return {?}
                     */
                    result => {
                        /** @type {?} */
                        const newAppConfig = this.defaultAppConfig;
                        newAppConfig.id = result;
                        this.liveAppsConfigService.updateLiveAppsConfig(this.sandboxId, uiAppId.uiAppId, newAppConfig, result).subscribe((
                        // trigger a read to flush the cache since we changed it
                        /**
                         * @param {?} updatedConf
                         * @return {?}
                         */
                        updatedConf => {
                            this.liveAppsConfigService.getLiveAppsConfig(this.uiAppId, true, true).subscribe();
                        }));
                        this.triggerCardConfigFetch(newAppConfig);
                        return newAppConfig;
                    })));
                })));
            }
            else {
                this.triggerCardConfigFetch(liveAppsConfig);
                return of(liveAppsConfig);
            }
        }))))));
        return appConfig;
    }
}
LiveAppsConfigResolver.decorators = [
    { type: Injectable }
];
/** @nocollapse */
LiveAppsConfigResolver.ctorParameters = () => [
    { type: TcSharedStateService },
    { type: TcLiveAppsConfigService },
    { type: TcCaseCardConfigService },
    { type: HttpClient },
    { type: Location }
];
if (false) {
    /** @type {?} */
    LiveAppsConfigResolver.prototype.DEFAULT_CONFIG_URL;
    /** @type {?} */
    LiveAppsConfigResolver.prototype.APP_ID_URL;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.sandboxId;
    /** @type {?} */
    LiveAppsConfigResolver.prototype.defaultAppConfig;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.uiAppId;
    /** @type {?} */
    LiveAppsConfigResolver.prototype.setSandbox;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.getDefaultAppConfig;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.getAppId;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.triggerCardConfigFetch;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.tcSharedState;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.liveAppsConfigService;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.caseCardConfigService;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.http;
    /**
     * @type {?}
     * @private
     */
    LiveAppsConfigResolver.prototype.location;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZWFwcHMtY29uZmlnLnJlc29sdmVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRpYmNvLXRjc3RrL3RjLWxpdmVhcHBzLWxpYi8iLCJzb3VyY2VzIjpbImxpYi9yZXNvbHZlcnMvbGl2ZWFwcHMtY29uZmlnLnJlc29sdmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFDLHFCQUFxQixFQUFlLGFBQWEsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBQzNGLE9BQU8sRUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqRSxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUM5RCxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDaEQsT0FBTyxFQUFDLHVCQUF1QixFQUFDLE1BQU0seUNBQXlDLENBQUM7QUFDaEYsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLDhCQUE4QixDQUFDO0FBQzVELE9BQU8sRUFBQyx1QkFBdUIsRUFBQyxNQUFNLHlDQUF5QyxDQUFDO0FBQ2hGLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUd6QyxNQUFNLE9BQU8sc0JBQXNCOzs7Ozs7OztJQVNqQyxZQUFvQixhQUFtQyxFQUFVLHFCQUE4QyxFQUFVLHFCQUE4QyxFQUFVLElBQWdCLEVBQVUsUUFBa0I7UUFBek0sa0JBQWEsR0FBYixhQUFhLENBQXNCO1FBQVUsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF5QjtRQUFVLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBeUI7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQVA3Tix1QkFB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QixXQUFXLENBQUMsRUFBRTs0QkFDWixJQUFJLENBQUMscUJBQXFCLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7d0JBQ3JGLENBQUMsRUFDRixDQUFDO3dCQUNGLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxZQUFZLENBQUMsQ0FBQzt3QkFDMUMsT0FBTyxZQUFZLENBQUM7b0JBQ3RCLENBQUMsRUFBQyxDQUNMLENBQUM7Z0JBQ04sQ0FBQyxFQUFDLENBQ0gsQ0FBQzthQUNIO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxjQUFjLENBQUMsQ0FBQztnQkFDNUMsT0FBTyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUM7YUFDM0I7UUFDSCxDQUFDLEVBQ0YsQ0FDRixFQUNGLENBQ0Y7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDOzs7WUEzRkYsVUFBVTs7OztZQVBILG9CQUFvQjtZQUVwQix1QkFBdUI7WUFFdkIsdUJBQXVCO1lBSHZCLFVBQVU7WUFJVixRQUFROzs7O0lBS2Qsb0RBQTJIOztJQUMzSCw0Q0FBNEc7Ozs7O0lBRTVHLDJDQUEwQjs7SUFDMUIsa0RBQXdDOzs7OztJQUN4Qyx5Q0FBd0I7O0lBTXhCLDRDQUVDOzs7OztJQUdELHFEQUVDOzs7OztJQUdELDBDQVNDOzs7OztJQUVELHdEQVFDOzs7OztJQWpDVywrQ0FBMkM7Ozs7O0lBQUUsdURBQXNEOzs7OztJQUFFLHVEQUFzRDs7Ozs7SUFBRSxzQ0FBd0I7Ozs7O0lBQUUsMENBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBSZXNvbHZlfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7VGNDb3JlQ29tbW9uRnVuY3Rpb25zLCBVaUFwcENvbmZpZywgVWlBcHBJZENvbmZpZ30gZnJvbSAnQHRpYmNvLXRjc3RrL3RjLWNvcmUtbGliJztcbmltcG9ydCB7ZmxhdE1hcCwgbWFwLCBtZXJnZU1hcCwgc3dpdGNoTWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1RjU2hhcmVkU3RhdGVTZXJ2aWNlfSBmcm9tICdAdGliY28tdGNzdGsvdGMtY29yZS1saWInO1xuaW1wb3J0IHtIdHRwQ2xpZW50fSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge1RjTGl2ZUFwcHNDb25maWdTZXJ2aWNlfSBmcm9tICcuLi9zZXJ2aWNlcy90Yy1saXZlLWFwcHMtY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHtMaXZlQXBwc0NvbmZpZ30gZnJvbSAnLi4vbW9kZWxzL3RjLWxpdmVhcHBzLWNvbmZpZyc7XG5pbXBvcnQge1RjQ2FzZUNhcmRDb25maWdTZXJ2aWNlfSBmcm9tICcuLi9zZXJ2aWNlcy90Yy1jYXNlLWNhcmQtY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHtMb2NhdGlvbn0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIExpdmVBcHBzQ29uZmlnUmVzb2x2ZXIgaW1wbGVtZW50cyBSZXNvbHZlPE9ic2VydmFibGU8TGl2ZUFwcHNDb25maWc+PiB7XG5cbiAgREVGQVVMVF9DT05GSUdfVVJMID0gVGNDb3JlQ29tbW9uRnVuY3Rpb25zLnByZXBhcmVVcmxGb3JTdGF0aWNSZXNvdXJjZSh0aGlzLmxvY2F0aW9uLCAnYXNzZXRzL2NvbmZpZy9saXZlQXBwc0NvbmZpZy5qc29uJyk7XG4gIEFQUF9JRF9VUkwgPSBUY0NvcmVDb21tb25GdW5jdGlvbnMucHJlcGFyZVVybEZvclN0YXRpY1Jlc291cmNlKHRoaXMubG9jYXRpb24sICdhc3NldHMvY29uZmlnL3VpQXBwSWQuanNvbicpO1xuXG4gIHByaXZhdGUgc2FuZGJveElkOiBudW1iZXI7XG4gIHB1YmxpYyBkZWZhdWx0QXBwQ29uZmlnOiBMaXZlQXBwc0NvbmZpZztcbiAgcHJpdmF0ZSB1aUFwcElkOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSB0Y1NoYXJlZFN0YXRlOiBUY1NoYXJlZFN0YXRlU2VydmljZSwgcHJpdmF0ZSBsaXZlQXBwc0NvbmZpZ1NlcnZpY2U6IFRjTGl2ZUFwcHNDb25maWdTZXJ2aWNlLCBwcml2YXRlIGNhc2VDYXJkQ29uZmlnU2VydmljZTogVGNDYXNlQ2FyZENvbmZpZ1NlcnZpY2UsIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCwgcHJpdmF0ZSBsb2NhdGlvbjogTG9jYXRpb24pIHt9XG4gIC8vIG5vdGUgYXBwQ29uZmlnUmVzb2x2ZXIgd2lsbCBuZWVkIHNhbmRib3hJZCB0byBjcmVhdGUgYXBwIGNvbmZpZyBzdGF0ZSByZWNvcmQuXG4gIC8vIFNvIHdlIGV4cGVjdCB0aGlzIHRvIGhhdmUgYmVlbiBzZXQgYnkgY2FsbGVyIChkb25lIGJ5IHRjLWxpdmVhcHBzLWxpYi9sYUNvbmZpZ1Jlc29sdmVyKS5cblxuICBwdWJsaWMgc2V0U2FuZGJveCA9IChzYW5kYm94SWQ6IG51bWJlcikgPT4ge1xuICAgIHRoaXMuc2FuZGJveElkID0gc2FuZGJveElkO1xuICB9XG5cbiAgLy8gY2FuIGJlIHVzZWQgdG8gbG9hZCBkZWZhdWx0QXBwQ29uZmlnIGZyb20gYSBKU09OIGNvbmZpZ1xuICBwcml2YXRlIGdldERlZmF1bHRBcHBDb25maWcgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodGhpcy5ERUZBVUxUX0NPTkZJR19VUkwpO1xuICB9XG5cbiAgLy8gbG9hZHMgdWlBcHBJZCBmcm9tIGpzb24gZmlsZSBpbiBhc3NldHMgKGFwcElkLmpzb24pXG4gIHByaXZhdGUgZ2V0QXBwSWQgPSAoKTogT2JzZXJ2YWJsZTxVaUFwcElkQ29uZmlnPiA9PiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodGhpcy5BUFBfSURfVVJMKS5waXBlKFxuICAgICAgbWFwKHVpQXBwSWQgPT4ge1xuICAgICAgICAgIGNvbnN0IHVpQXBwSWRDb25maWcgPSBuZXcgVWlBcHBJZENvbmZpZygpLmRlc2VyaWFsaXplKHVpQXBwSWQpO1xuICAgICAgICAgIHRoaXMudWlBcHBJZCA9IHVpQXBwSWRDb25maWcudWlBcHBJZDtcbiAgICAgICAgICByZXR1cm4gdWlBcHBJZENvbmZpZztcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHRyaWdnZXJDYXJkQ29uZmlnRmV0Y2ggPSAobGl2ZUFwcHNDb25maWc6IExpdmVBcHBzQ29uZmlnKSA9PiB7XG4gICAgLy8gb3B0aW1pemF0aW9uOiBJIHdhbnQgdG8gYXZvaWQgcmVhZGluZyB0aGUgY2FyZCBjb25maWcgd2hlbiB3ZSBkaXNwbGF5IGEgbGFyZ2UgbGlzdCBvZiBjYXJkcyBpbiB0aGUgY2FsbGluZyBhcHBcbiAgICAvLyB0aGVyZWZvcmUgd2UgY2FuIHRyaWdnZXIgb2YgYSByZWFkIG9mIHRoZSBjYXJkIGNvbmZpZ3MgZm9yIGVhY2ggYXBwIGluIHRoZSBjb25maWcgdG8gZW5zdXJlIHRoZXkgYXJlIGNhY2hlZCBieVxuICAgIC8vIGh0dHAgaW50ZXJjZXB0b3JcbiAgICBjb25zdCBsYUNvbmZpZyA9IG5ldyBMaXZlQXBwc0NvbmZpZygpLmRlc2VyaWFsaXplKGxpdmVBcHBzQ29uZmlnKTtcbiAgICBsYUNvbmZpZy5hcHBsaWNhdGlvbklkcy5mb3JFYWNoKGFwcElkID0+IHtcbiAgICAgIHRoaXMuY2FzZUNhcmRDb25maWdTZXJ2aWNlLmdldENhcmRDb25maWcodGhpcy51aUFwcElkLCBhcHBJZCwgdHJ1ZSwgZmFsc2UpLnN1YnNjcmliZSgpO1xuICAgIH0pO1xuICB9XG5cbiAgcmVzb2x2ZShyb3V0ZVNuYXBzaG90OiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogT2JzZXJ2YWJsZTxMaXZlQXBwc0NvbmZpZz4ge1xuICAgIGNvbnN0IGFwcENvbmZpZyA9IHRoaXMuZ2V0QXBwSWQoKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKHVpQXBwSWQgPT4gdGhpcy5saXZlQXBwc0NvbmZpZ1NlcnZpY2UuZ2V0TGl2ZUFwcHNDb25maWcodWlBcHBJZC51aUFwcElkLCB0cnVlLCBmYWxzZSlcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgbWVyZ2VNYXAoXG4gICAgICAgICAgICBsaXZlQXBwc0NvbmZpZyA9PiB7XG4gICAgICAgICAgICAgIGlmIChsaXZlQXBwc0NvbmZpZyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGVmYXVsdEFwcENvbmZpZygpLnBpcGUoXG4gICAgICAgICAgICAgICAgICBmbGF0TWFwKGNvbmZpZyA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVmYXVsdEFwcENvbmZpZyA9IG5ldyBMaXZlQXBwc0NvbmZpZygpLmRlc2VyaWFsaXplKGNvbmZpZyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVmYXVsdEFwcENvbmZpZy5jYXNlSWNvbnNGb2xkZXJJZCA9IHRoaXMudWlBcHBJZCArICdfSWNvbnMnO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5saXZlQXBwc0NvbmZpZ1NlcnZpY2UuY3JlYXRlTGl2ZUFwcHNDb25maWcoXG4gICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYW5kYm94SWQsXG4gICAgICAgICAgICAgICAgICAgICAgdWlBcHBJZC51aUFwcElkLFxuICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVmYXVsdEFwcENvbmZpZylcbiAgICAgICAgICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdBcHBDb25maWcgPSB0aGlzLmRlZmF1bHRBcHBDb25maWc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3QXBwQ29uZmlnLmlkID0gcmVzdWx0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGl2ZUFwcHNDb25maWdTZXJ2aWNlLnVwZGF0ZUxpdmVBcHBzQ29uZmlnKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYW5kYm94SWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aUFwcElkLnVpQXBwSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdBcHBDb25maWcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRyaWdnZXIgYSByZWFkIHRvIGZsdXNoIHRoZSBjYWNoZSBzaW5jZSB3ZSBjaGFuZ2VkIGl0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkQ29uZiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGl2ZUFwcHNDb25maWdTZXJ2aWNlLmdldExpdmVBcHBzQ29uZmlnKHRoaXMudWlBcHBJZCwgdHJ1ZSwgdHJ1ZSkuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJDYXJkQ29uZmlnRmV0Y2gobmV3QXBwQ29uZmlnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3QXBwQ29uZmlnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyQ2FyZENvbmZpZ0ZldGNoKGxpdmVBcHBzQ29uZmlnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YobGl2ZUFwcHNDb25maWcpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICApXG4gICAgKVxuICAgIHJldHVybiBhcHBDb25maWc7XG4gIH1cblxufVxuIl19