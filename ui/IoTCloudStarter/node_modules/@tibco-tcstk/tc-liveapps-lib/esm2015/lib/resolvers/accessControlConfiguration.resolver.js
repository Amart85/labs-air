/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { of } from 'rxjs';
import { TcCoreCommonFunctions, UiAppIdConfig, } from '@tibco-tcstk/tc-core-lib';
import { map, switchMap, mergeMap, flatMap } from 'rxjs/operators';
import { RouteAccessControlConfig } from '../models/tc-groups-data';
import { HttpClient } from '@angular/common/http';
import { Location } from '@angular/common';
import { TcAccessControlService } from '../services/tc-access-control.service';
export class AccessControlConfigurationResolver {
    /**
     * @param {?} location
     * @param {?} http
     * @param {?} accessControlService
     */
    constructor(location, http, accessControlService) {
        this.location = location;
        this.http = http;
        this.accessControlService = accessControlService;
        this.DEFAULT_CONFIG_URL = 'assets/config/routeAccessControl.json';
        this.APP_ID_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/uiAppId.json');
        // can be used to load defaultAppConfig from a JSON config
        this.getDefaultAppConfig = (/**
         * @return {?}
         */
        () => {
            return this.http.get(TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, this.DEFAULT_CONFIG_URL));
        });
        // loads uiAppId from json file in assets (appId.json)
        this.getAppId = (/**
         * @return {?}
         */
        () => {
            return this.http.get(this.APP_ID_URL).pipe(map((/**
             * @param {?} uiAppId
             * @return {?}
             */
            uiAppId => {
                /** @type {?} */
                const uiAppIdConfig = new UiAppIdConfig().deserialize(uiAppId);
                this.uiAppId = uiAppIdConfig.uiAppId;
                return uiAppIdConfig;
            })));
        });
    }
    /**
     * @return {?}
     */
    resolve() {
        /** @type {?} */
        const accessConfig$ = this.getAppId().pipe(switchMap((/**
         * @param {?} uiAppId
         * @return {?}
         */
        uiAppId => this.accessControlService.getAccessControlConfig(uiAppId.uiAppId, true, false)
            .pipe(mergeMap((/**
         * @param {?} accessControlConfig
         * @return {?}
         */
        accessControlConfig => {
            if (accessControlConfig === undefined) {
                return this.getDefaultAppConfig().pipe(flatMap((/**
                 * @param {?} config
                 * @return {?}
                 */
                config => {
                    this.defaultAccessControlConfig = new RouteAccessControlConfig().deserialize(config);
                    this.defaultAccessControlConfig.uiAppId = this.uiAppId;
                    return this.accessControlService.createLAccessControlConfig(this.sandboxId, this.uiAppId, this.defaultAccessControlConfig)
                        .pipe(flatMap((/**
                     * @param {?} result
                     * @return {?}
                     */
                    result => {
                        /** @type {?} */
                        const newAppConfig = this.defaultAccessControlConfig;
                        newAppConfig.id = result;
                        return this.accessControlService.updateAccessControlConfig(this.sandboxId, this.uiAppId, newAppConfig, result).pipe(flatMap((
                        // trigger a read to flush the cache since we changed it
                        /**
                         * @param {?} updatedConf
                         * @return {?}
                         */
                        updatedConf => {
                            return this.accessControlService.getAccessControlConfig(this.uiAppId, true, true).pipe(map((/**
                             * @param {?} cachedConfig
                             * @return {?}
                             */
                            cachedConfig => {
                                return cachedConfig;
                            })));
                        })));
                        // return newAppConfig;
                    })));
                })));
            }
            else {
                return of(accessControlConfig);
            }
        }))))));
        return accessConfig$;
    }
}
AccessControlConfigurationResolver.decorators = [
    { type: Injectable }
];
/** @nocollapse */
AccessControlConfigurationResolver.ctorParameters = () => [
    { type: Location },
    { type: HttpClient },
    { type: TcAccessControlService }
];
if (false) {
    /** @type {?} */
    AccessControlConfigurationResolver.prototype.DEFAULT_CONFIG_URL;
    /** @type {?} */
    AccessControlConfigurationResolver.prototype.APP_ID_URL;
    /**
     * @type {?}
     * @private
     */
    AccessControlConfigurationResolver.prototype.sandboxId;
    /** @type {?} */
    AccessControlConfigurationResolver.prototype.defaultAccessControlConfig;
    /**
     * @type {?}
     * @private
     */
    AccessControlConfigurationResolver.prototype.uiAppId;
    /**
     * @type {?}
     * @private
     */
    AccessControlConfigurationResolver.prototype.getDefaultAppConfig;
    /**
     * @type {?}
     * @private
     */
    AccessControlConfigurationResolver.prototype.getAppId;
    /**
     * @type {?}
     * @private
     */
    AccessControlConfigurationResolver.prototype.location;
    /**
     * @type {?}
     * @private
     */
    AccessControlConfigurationResolver.prototype.http;
    /**
     * @type {?}
     * @private
     */
    AccessControlConfigurationResolver.prototype.accessControlService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWNjZXNzQ29udHJvbENvbmZpZ3VyYXRpb24ucmVzb2x2ZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGliY28tdGNzdGsvdGMtbGl2ZWFwcHMtbGliLyIsInNvdXJjZXMiOlsibGliL3Jlc29sdmVycy9hY2Nlc3NDb250cm9sQ29uZmlndXJhdGlvbi5yZXNvbHZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQXdCLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNoRCxPQUFPLEVBQzJDLHFCQUFxQixFQUFFLGFBQWEsR0FDckYsTUFBTSwwQkFBMEIsQ0FBQztBQUNsQyxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkUsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDcEUsT0FBTyxFQUFFLFVBQVUsRUFBZSxNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUzQyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQztBQUsvRSxNQUFNLE9BQU8sa0NBQWtDOzs7Ozs7SUFTM0MsWUFDWSxRQUFrQixFQUNsQixJQUFnQixFQUNoQixvQkFBNEM7UUFGNUMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBd0I7UUFWeEQsdUJBQWtCLEdBQUcsdUNBQXVDLENBQUM7UUFDN0QsZUFBVSxHQUFHLHFCQUFxQixDQUFDLDJCQUEyQixDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsNEJBQTRCLENBQUMsQ0FBQzs7UUFhcEcsd0JBQW1COzs7UUFBRyxHQUFHLEVBQUU7WUFDL0IsT0FBTyxJQUFJ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Qzs7Ozs7SUFHRCxzREFTQzs7Ozs7SUFwQkcsc0RBQTBCOzs7OztJQUMxQixrREFBd0I7Ozs7O0lBQ3hCLGtFQUFvRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJlc29sdmUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZm9ya0pvaW4sIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICAgIFRjU2hhcmVkU3RhdGVTZXJ2aWNlLCBUY0dlbmVyYWxDb25maWdTZXJ2aWNlLCBUY0NvcmVDb21tb25GdW5jdGlvbnMsIFVpQXBwSWRDb25maWcsXG59IGZyb20gJ0B0aWJjby10Y3N0ay90Yy1jb3JlLWxpYic7XG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCwgbWVyZ2VNYXAsIGZsYXRNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBSb3V0ZUFjY2Vzc0NvbnRyb2xDb25maWcgfSBmcm9tICcuLi9tb2RlbHMvdGMtZ3JvdXBzLWRhdGEnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBSb2xlQWN0aXZlUmVzb2x2ZXIgfSBmcm9tICcuL3JvbGUtYWN0aXZlLnJlc29sdmVyJztcbmltcG9ydCB7IFRjQWNjZXNzQ29udHJvbFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy90Yy1hY2Nlc3MtY29udHJvbC5zZXJ2aWNlJztcbmltcG9ydCB7IExpdmVBcHBzU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2xpdmUtYXBwcy5zZXJ2aWNlJztcbmltcG9ydCB7IFRjUm9sZXNTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvdGMtcm9sZXMtc2VydmljZS50cy5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEFjY2Vzc0NvbnRyb2xDb25maWd1cmF0aW9uUmVzb2x2ZXIgaW1wbGVtZW50cyBSZXNvbHZlPE9ic2VydmFibGU8Um91dGVBY2Nlc3NDb250cm9sQ29uZmlnPj4ge1xuXG4gICAgREVGQVVMVF9DT05GSUdfVVJMID0gJ2Fzc2V0cy9jb25maWcvcm91dGVBY2Nlc3NDb250cm9sLmpzb24nO1xuICAgIEFQUF9JRF9VUkwgPSBUY0NvcmVDb21tb25GdW5jdGlvbnMucHJlcGFyZVVybEZvclN0YXRpY1Jlc291cmNlKHRoaXMubG9jYXRpb24sICdhc3NldHMvY29uZmlnL3VpQXBwSWQuanNvbicpO1xuXG4gICAgcHJpdmF0ZSBzYW5kYm94SWQ6IG51bWJlcjtcbiAgICBwdWJsaWMgZGVmYXVsdEFjY2Vzc0NvbnRyb2xDb25maWc6IFJvdXRlQWNjZXNzQ29udHJvbENvbmZpZztcbiAgICBwcml2YXRlIHVpQXBwSWQ6IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGxvY2F0aW9uOiBMb2NhdGlvbixcbiAgICAgICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICAgICAgICBwcml2YXRlIGFjY2Vzc0NvbnRyb2xTZXJ2aWNlOiBUY0FjY2Vzc0NvbnRyb2xTZXJ2aWNlXG4gICAgKSB7IH1cblxuICAgIC8vIGNhbiBiZSB1c2VkIHRvIGxvYWQgZGVmYXVsdEFwcENvbmZpZyBmcm9tIGEgSlNPTiBjb25maWdcbiAgICBwcml2YXRlIGdldERlZmF1bHRBcHBDb25maWcgPSAoKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KFRjQ29yZUNvbW1vbkZ1bmN0aW9ucy5wcmVwYXJlVXJsRm9yU3RhdGljUmVzb3VyY2UodGhpcy5sb2NhdGlvbiwgdGhpcy5ERUZBVUxUX0NPTkZJR19VUkwpKTtcbiAgICB9XG5cbiAgICAvLyBsb2FkcyB1aUFwcElkIGZyb20ganNvbiBmaWxlIGluIGFzc2V0cyAoYXBwSWQuanNvbilcbiAgICBwcml2YXRlIGdldEFwcElkID0gKCk6IE9ic2VydmFibGU8VWlBcHBJZENvbmZpZz4gPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5odHRwLmdldCh0aGlzLkFQUF9JRF9VUkwpLnBpcGUoXG4gICAgICAgICAgICBtYXAodWlBcHBJZCA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgdWlBcHBJZENvbmZpZyA9IG5ldyBVaUFwcElkQ29uZmlnKCkuZGVzZXJpYWxpemUodWlBcHBJZCk7XG4gICAgICAgICAgICAgICAgdGhpcy51aUFwcElkID0gdWlBcHBJZENvbmZpZy51aUFwcElkO1xuICAgICAgICAgICAgICAgIHJldHVybiB1aUFwcElkQ29uZmlnO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHJlc29sdmUoKTogT2JzZXJ2YWJsZTxSb3V0ZUFjY2Vzc0NvbnRyb2xDb25maWc+IHtcbiAgICAgICAgY29uc3QgYWNjZXNzQ29uZmlnJCA9IHRoaXMuZ2V0QXBwSWQoKS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKHVpQXBwSWQgPT4gdGhpcy5hY2Nlc3NDb250cm9sU2VydmljZS5nZXRBY2Nlc3NDb250cm9sQ29uZmlnKHVpQXBwSWQudWlBcHBJZCwgdHJ1ZSwgZmFsc2UpXG4gICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgIG1lcmdlTWFwKFxuICAgICAgICAgICAgICAgICAgICAgICAgYWNjZXNzQ29udHJvbENvbmZpZyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjY2Vzc0NvbnRyb2xDb25maWcgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREZWZhdWx0QXBwQ29uZmlnKCkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYXRNYXAoY29uZmlnID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRBY2Nlc3NDb250cm9sQ29uZmlnID0gbmV3IFJvdXRlQWNjZXNzQ29udHJvbENvbmZpZygpLmRlc2VyaWFsaXplKGNvbmZpZyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0QWNjZXNzQ29udHJvbENvbmZpZy51aUFwcElkID0gdGhpcy51aUFwcElkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFjY2Vzc0NvbnRyb2xTZXJ2aWNlLmNyZWF0ZUxBY2Nlc3NDb250cm9sQ29uZmlnKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNhbmRib3hJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51aUFwcElkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRBY2Nlc3NDb250cm9sQ29uZmlnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYXRNYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3QXBwQ29uZmlnID0gdGhpcy5kZWZhdWx0QWNjZXNzQ29udHJvbENvbmZpZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3QXBwQ29uZmlnLmlkID0gcmVzdWx0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hY2Nlc3NDb250cm9sU2VydmljZS51cGRhdGVBY2Nlc3NDb250cm9sQ29uZmlnKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYW5kYm94SWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVpQXBwSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdBcHBDb25maWcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQpLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhdE1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciBhIHJlYWQgdG8gZmx1c2ggdGhlIGNhY2hlIHNpbmNlIHdlIGNoYW5nZWQgaXRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZENvbmYgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWNjZXNzQ29udHJvbFNlcnZpY2UuZ2V0QWNjZXNzQ29udHJvbENvbmZpZyh0aGlzLnVpQXBwSWQsIHRydWUsIHRydWUpLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZWRDb25maWcgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZENvbmZpZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJldHVybiBuZXdBcHBDb25maWc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKGFjY2Vzc0NvbnRyb2xDb25maWcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgICByZXR1cm4gYWNjZXNzQ29uZmlnJDtcbiAgICB9XG5cbn0iXX0=