/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { LiveAppsComponent } from '../live-apps-component/live-apps-component.component';
import { ProcessId } from '../../models/liveappsdata';
import { LaProcessSelection } from '../../models/tc-case-processes';
import { LiveAppsService } from '../../services/live-apps.service';
import { map, take, takeUntil } from 'rxjs/operators';
import { CustomFormDefs } from '@tibco-tcstk/tc-forms-lib';
/**
 * Handles rendering of case creator form.
 *
 * \@example <tcla-live-apps-case-creator></tcla-live-apps-case-creator>
 */
export class LiveAppsCaseCreatorComponent extends LiveAppsComponent {
    /**
     * @param {?} liveapps
     */
    constructor(liveapps) {
        super();
        this.liveapps = liveapps;
        /**
         * ~event caseChanged : Case action started (process started)
         * ~payload ProcessId : ProcessId object passed when a case has been updated or created by a process (action/creator)
         */
        this.caseChanged = new EventEmitter();
        this.handleSubmit = (/**
         * @param {?} data
         * @param {?} caseRef
         * @return {?}
         */
        (data, caseRef) => {
            // if no_process_submit then no need to run process as this was done inside a custom form app
            if (data !== 'NO_PROCESS_SUBMIT') {
                // run the process
                this.liveapps.runProcess(this.sandboxId, this.applicationId, this.process.process.id, caseRef, data)
                    .pipe(take(1), takeUntil(this._destroyed$), map((/**
                 * @param {?} response
                 * @return {?}
                 */
                response => {
                    if (response) {
                        if (!response.data.errorMsg) {
                            // parse data to object
                            response.data = JSON.parse(response.data);
                            // case created send back response including caseIdentifier if one is present
                            /** @type {?} */
                            let caseIdentifier;
                            /** @type {?} */
                            let caseReference;
                            if (response.caseIdentifier) {
                                caseIdentifier = response.caseIdentifier;
                            }
                            if (response.caseReference) {
                                caseReference = response.caseReference;
                            }
                            /** @type {?} */
                            const processResponse = new ProcessId().deserialize({ 'caseIdentifier': caseIdentifier, 'caseReference': caseReference });
                            this.caseChanged.emit(processResponse);
                            this.schema = undefined;
                            this.data = undefined;
                            this.layout = undefined;
                        }
                        else {
                            console.error('Unable to run case creator');
                            console.error(response.data.errorMsg);
                        }
                    }
                })))
                    .subscribe((/**
                 * @param {?} success
                 * @return {?}
                 */
                success => success), (/**
                 * @param {?} error
                 * @return {?}
                 */
                error => {
                    console.error('Unable to run case creator');
                    console.error(error);
                }));
            }
            else {
                /** @type {?} */
                const processResponse = new ProcessId().deserialize({ 'caseIdentifier': undefined, 'caseReference': undefined });
                this.caseChanged.emit(processResponse);
                this.schema = undefined;
                this.data = undefined;
                this.layout = undefined;
            }
        });
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.options = {
            defaultOptions: {
                'appearance': 'legacy'
            }
        };
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        // handle input param changes
        if (changes.process && changes.process.currentValue && (changes.process.currentValue !== changes.process.previousValue)) {
            if (changes.process.currentValue.process.jsonSchema.$schema === 'NOSCHEMA') {
                this.schema = undefined;
            }
            else {
                this.schema = changes.process.currentValue.process.jsonSchema;
            }
        }
        else if (changes.applicationId && (changes.applicationId.currentValue !== changes.applicationId.previousValue)) {
            // appId has changed: make sure no process selected/form displayed
            this.process = undefined;
        }
        if (changes.layout && (changes.layout.currentValue !== changes.layout.previousValue)) {
            this.layout = changes.layout.currentValue;
        }
        if (changes.dataOverride && (changes.dataOverride.currentValue !== changes.dataOverride.previousValue)) {
            this.data = this.dataOverride;
        }
    }
}
LiveAppsCaseCreatorComponent.decorators = [
    { type: Component, args: [{
                selector: 'tcla-live-apps-case-creator',
                template: "<div fxFill>\n<tcfrm-rendered-form *ngIf=\"process\" style=\"min-height:500px; overflow: auto;\" [customFormDefs]=customFormDefs [formRef]=\"process.ref\" [appId]=\"applicationId\" [customFormDefs]=\"customFormDefs\" [schema]=\"schema\" [layout]=\"layout\" [data]=\"data\" [options]=\"options\" (formSubmit)=\"handleSubmit($event, undefined)\"></tcfrm-rendered-form>\n</div>\n",
                styles: [""]
            }] }
];
/** @nocollapse */
LiveAppsCaseCreatorComponent.ctorParameters = () => [
    { type: LiveAppsService }
];
LiveAppsCaseCreatorComponent.propDecorators = {
    sandboxId: [{ type: Input }],
    applicationId: [{ type: Input }],
    typeId: [{ type: Input }],
    process: [{ type: Input }],
    dataOverride: [{ type: Input }],
    customFormDefs: [{ type: Input }],
    caseChanged: [{ type: Output }]
};
if (false) {
    /**
     * sandboxId - this comes from claims resolver
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.sandboxId;
    /**
     * LA application ID
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.applicationId;
    /**
     * The LA Application Type Id (generally 1)
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.typeId;
    /**
     * The process definition of the action or creator to execute
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.process;
    /**
     * Data object that will be displayed on the form. Allows overriding over form data (eg. when selecting data in spotfire)
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.dataOverride;
    /**
     * Custom Form configuration file
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.customFormDefs;
    /**
     * ~event caseChanged : Case action started (process started)
     * ~payload ProcessId : ProcessId object passed when a case has been updated or created by a process (action/creator)
     * @type {?}
     */
    LiveAppsCaseCreatorComponent.prototype.caseChanged;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.data;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.schema;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.layout;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.options;
    /** @type {?} */
    LiveAppsCaseCreatorComponent.prototype.handleSubmit;
    /**
     * @type {?}
     * @protected
     */
    LiveAppsCaseCreatorComponent.prototype.liveapps;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS1hcHBzLWNhc2UtY3JlYXRvci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGliY28tdGNzdGsvdGMtbGl2ZWFwcHMtbGliLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvbGl2ZS1hcHBzLWNhc2UtY3JlYXRvci9saXZlLWFwcHMtY2FzZS1jcmVhdG9yLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFVLE1BQU0sRUFBc0MsTUFBTSxlQUFlLENBQUM7QUFDbEgsT0FBTyxFQUFDLGlCQUFpQixFQUFDLE1BQU0sc0RBQXNELENBQUM7QUFDdkYsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBQ3BELE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLGdDQUFnQyxDQUFDO0FBQ2xFLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxrQ0FBa0MsQ0FBQztBQUNqRSxPQUFPLEVBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUVwRCxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sMkJBQTJCLENBQUM7Ozs7OztBQVl6RCxNQUFNLE9BQU8sNEJBQTZCLFNBQVEsaUJBQWlCOzs7O0lBMkZqRSxZQUFzQixRQUF5QjtRQUM3QyxLQUFLLEVBQUUsQ0FBQztRQURZLGFBQVEsR0FBUixRQUFRLENBQWlCOzs7OztRQXZEckMsZ0JBQVcsR0FBNEIsSUFBSSxZQUFZLEVBQWEsQ0FBQztRQU8vRSxpQkFBWTs7Ozs7UUFBRyxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsRUFBRTtZQUMvQiw2RkFBNkY7WUFDN0YsSUFBSSxJQUFJLEtBQUssbUJBQW1CLEVBQUU7Z0JBQ2hDLGtCQUFrQjtnQkFDbEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJ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O0lBRWIsb0RBOENDOzs7OztJQUVXLGdEQUFtQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkluaXQsIE91dHB1dCwgT25EZXN0cm95LCBTaW1wbGVDaGFuZ2VzLCBPbkNoYW5nZXN9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtMaXZlQXBwc0NvbXBvbmVudH0gZnJvbSAnLi4vbGl2ZS1hcHBzLWNvbXBvbmVudC9saXZlLWFwcHMtY29tcG9uZW50LmNvbXBvbmVudCc7XG5pbXBvcnQge1Byb2Nlc3NJZH0gZnJvbSAnLi4vLi4vbW9kZWxzL2xpdmVhcHBzZGF0YSc7XG5pbXBvcnQge0xhUHJvY2Vzc1NlbGVjdGlvbn0gZnJvbSAnLi4vLi4vbW9kZWxzL3RjLWNhc2UtcHJvY2Vzc2VzJztcbmltcG9ydCB7TGl2ZUFwcHNTZXJ2aWNlfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9saXZlLWFwcHMuc2VydmljZSc7XG5pbXBvcnQge21hcCwgdGFrZSwgdGFrZVVudGlsfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1N1YmplY3R9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtDdXN0b21Gb3JtRGVmc30gZnJvbSAnQHRpYmNvLXRjc3RrL3RjLWZvcm1zLWxpYic7XG5cbi8qKlxuICogSGFuZGxlcyByZW5kZXJpbmcgb2YgY2FzZSBjcmVhdG9yIGZvcm0uXG4gKlxuICpAZXhhbXBsZSA8dGNsYS1saXZlLWFwcHMtY2FzZS1jcmVhdG9yPjwvdGNsYS1saXZlLWFwcHMtY2FzZS1jcmVhdG9yPlxuICovXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd0Y2xhLWxpdmUtYXBwcy1jYXNlLWNyZWF0b3InLFxuICB0ZW1wbGF0ZVVybDogJy4vbGl2ZS1hcHBzLWNhc2UtY3JlYXRvci5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2xpdmUtYXBwcy1jYXNlLWNyZWF0b3IuY29tcG9uZW50LmNzcyddXG59KVxuZXhwb3J0IGNsYXNzIExpdmVBcHBzQ2FzZUNyZWF0b3JDb21wb25lbnQgZXh0ZW5kcyBMaXZlQXBwc0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcbiAgLyoqXG4gICAqIHNhbmRib3hJZCAtIHRoaXMgY29tZXMgZnJvbSBjbGFpbXMgcmVzb2x2ZXJcbiAgICovXG4gIEBJbnB1dCgpIHNhbmRib3hJZDogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBMQSBhcHBsaWNhdGlvbiBJRFxuICAgKi9cbiAgQElucHV0KCkgYXBwbGljYXRpb25JZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgTEEgQXBwbGljYXRpb24gVHlwZSBJZCAoZ2VuZXJhbGx5IDEpXG4gICAqL1xuICBASW5wdXQoKSB0eXBlSWQ6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHByb2Nlc3MgZGVmaW5pdGlvbiBvZiB0aGUgYWN0aW9uIG9yIGNyZWF0b3IgdG8gZXhlY3V0ZVxuICAgKi9cbiAgQElucHV0KCkgcHJvY2VzczogTGFQcm9jZXNzU2VsZWN0aW9uO1xuXG4gIC8qKlxuICAgKiBEYXRhIG9iamVjdCB0aGF0IHdpbGwgYmUgZGlzcGxheWVkIG9uIHRoZSBmb3JtLiBBbGxvd3Mgb3ZlcnJpZGluZyBvdmVyIGZvcm0gZGF0YSAoZWcuIHdoZW4gc2VsZWN0aW5nIGRhdGEgaW4gc3BvdGZpcmUpXG4gICAqL1xuICBASW5wdXQoKSBkYXRhT3ZlcnJpZGU6IGFueTtcblxuICAvKipcbiAgICogQ3VzdG9tIEZvcm0gY29uZmlndXJhdGlvbiBmaWxlXG4gICAqL1xuICBASW5wdXQoKSBjdXN0b21Gb3JtRGVmczogQ3VzdG9tRm9ybURlZnM7XG5cblxuICAvKipcbiAgICogfmV2ZW50IGNhc2VDaGFuZ2VkIDogQ2FzZSBhY3Rpb24gc3RhcnRlZCAocHJvY2VzcyBzdGFydGVkKVxuICAgKiB+cGF5bG9hZCBQcm9jZXNzSWQgOiBQcm9jZXNzSWQgb2JqZWN0IHBhc3NlZCB3aGVuIGEgY2FzZSBoYXMgYmVlbiB1cGRhdGVkIG9yIGNyZWF0ZWQgYnkgYSBwcm9jZXNzIChhY3Rpb24vY3JlYXRvcilcbiAgICovXG4gIEBPdXRwdXQoKSBjYXNlQ2hhbmdlZDogRXZlbnRFbWl0dGVyPFByb2Nlc3NJZD4gPSBuZXcgRXZlbnRFbWl0dGVyPFByb2Nlc3NJZD4oKTtcblxuICBkYXRhOiBhbnk7XG4gIHNjaGVtYTogYW55O1xuICBsYXlvdXQ6IGFueVtdO1xuICBvcHRpb25zOiBhbnk7XG5cbiAgaGFuZGxlU3VibWl0ID0gKGRhdGEsIGNhc2VSZWYpID0+IHtcbiAgICAvLyBpZiBub19wcm9jZXNzX3N1Ym1pdCB0aGVuIG5vIG5lZWQgdG8gcnVuIHByb2Nlc3MgYXMgdGhpcyB3YXMgZG9uZSBpbnNpZGUgYSBjdXN0b20gZm9ybSBhcHBcbiAgICBpZiAoZGF0YSAhPT0gJ05PX1BST0NFU1NfU1VCTUlUJykge1xuICAgICAgLy8gcnVuIHRoZSBwcm9jZXNzXG4gICAgICB0aGlzLmxpdmVhcHBzLnJ1blByb2Nlc3ModGhpcy5zYW5kYm94SWQsIHRoaXMuYXBwbGljYXRpb25JZCwgdGhpcy5wcm9jZXNzLnByb2Nlc3MuaWQsIGNhc2VSZWYsIGRhdGEpXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3llZCQpLFxuICAgICAgICAgIG1hcChyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZS5kYXRhLmVycm9yTXNnKSB7XG4gICAgICAgICAgICAgICAgLy8gcGFyc2UgZGF0YSB0byBvYmplY3RcbiAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhID0gSlNPTi5wYXJzZShyZXNwb25zZS5kYXRhKTtcbiAgICAgICAgICAgICAgICAvLyBjYXNlIGNyZWF0ZWQgc2VuZCBiYWNrIHJlc3BvbnNlIGluY2x1ZGluZyBjYXNlSWRlbnRpZmllciBpZiBvbmUgaXMgcHJlc2VudFxuICAgICAgICAgICAgICAgIGxldCBjYXNlSWRlbnRpZmllcjtcbiAgICAgICAgICAgICAgICBsZXQgY2FzZVJlZmVyZW5jZTtcbiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuY2FzZUlkZW50aWZpZXIpIHtcbiAgICAgICAgICAgICAgICAgIGNhc2VJZGVudGlmaWVyID0gcmVzcG9uc2UuY2FzZUlkZW50aWZpZXI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5jYXNlUmVmZXJlbmNlKSB7XG4gICAgICAgICAgICAgICAgICBjYXNlUmVmZXJlbmNlID0gcmVzcG9uc2UuY2FzZVJlZmVyZW5jZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgcHJvY2Vzc1Jlc3BvbnNlID0gbmV3IFByb2Nlc3NJZCgpLmRlc2VyaWFsaXplKHsnY2FzZUlkZW50aWZpZXInOiBjYXNlSWRlbnRpZmllciwgJ2Nhc2VSZWZlcmVuY2UnOiBjYXNlUmVmZXJlbmNlfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5jYXNlQ2hhbmdlZC5lbWl0KHByb2Nlc3NSZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5zY2hlbWEgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHRoaXMubGF5b3V0ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1VuYWJsZSB0byBydW4gY2FzZSBjcmVhdG9yJyk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihyZXNwb25zZS5kYXRhLmVycm9yTXNnKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICAgLnN1YnNjcmliZShzdWNjZXNzID0+IHN1Y2Nlc3MsIGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1VuYWJsZSB0byBydW4gY2FzZSBjcmVhdG9yJyk7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHByb2Nlc3NSZXNwb25zZSA9IG5ldyBQcm9jZXNzSWQoKS5kZXNlcmlhbGl6ZSh7J2Nhc2VJZGVudGlmaWVyJzogdW5kZWZpbmVkLCAnY2FzZVJlZmVyZW5jZSc6IHVuZGVmaW5lZH0pO1xuICAgICAgdGhpcy5jYXNlQ2hhbmdlZC5lbWl0KHByb2Nlc3NSZXNwb25zZSk7XG4gICAgICB0aGlzLnNjaGVtYSA9IHVuZGVmaW5lZDtcbiAgICAgIHRoaXMuZGF0YSA9IHVuZGVmaW5lZDtcbiAgICAgIHRoaXMubGF5b3V0ID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBsaXZlYXBwczogTGl2ZUFwcHNTZXJ2aWNlKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMub3B0aW9ucyA9IHtcbiAgICAgIGRlZmF1bHRPcHRpb25zOiB7XG4gICAgICAgICdhcHBlYXJhbmNlJzogJ2xlZ2FjeSdcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIC8vIGhhbmRsZSBpbnB1dCBwYXJhbSBjaGFuZ2VzXG4gICAgaWYgKGNoYW5nZXMucHJvY2VzcyAmJiBjaGFuZ2VzLnByb2Nlc3MuY3VycmVudFZhbHVlICYmIChjaGFuZ2VzLnByb2Nlc3MuY3VycmVudFZhbHVlICE9PSBjaGFuZ2VzLnByb2Nlc3MucHJldmlvdXNWYWx1ZSkpIHtcbiAgICAgIGlmIChjaGFuZ2VzLnByb2Nlc3MuY3VycmVudFZhbHVlLnByb2Nlc3MuanNvblNjaGVtYS4kc2NoZW1hID09PSAnTk9TQ0hFTUEnKSB7XG4gICAgICAgIHRoaXMuc2NoZW1hID0gdW5kZWZpbmVkO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zY2hlbWEgPSBjaGFuZ2VzLnByb2Nlc3MuY3VycmVudFZhbHVlLnByb2Nlc3MuanNvblNjaGVtYTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGNoYW5nZXMuYXBwbGljYXRpb25JZCAmJiAoY2hhbmdlcy5hcHBsaWNhdGlvbklkLmN1cnJlbnRWYWx1ZSAhPT0gY2hhbmdlcy5hcHBsaWNhdGlvbklkLnByZXZpb3VzVmFsdWUpKSB7XG4gICAgICAvLyBhcHBJZCBoYXMgY2hhbmdlZDogbWFrZSBzdXJlIG5vIHByb2Nlc3Mgc2VsZWN0ZWQvZm9ybSBkaXNwbGF5ZWRcbiAgICAgIHRoaXMucHJvY2VzcyA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgaWYgKGNoYW5nZXMubGF5b3V0ICYmIChjaGFuZ2VzLmxheW91dC5jdXJyZW50VmFsdWUgIT09IGNoYW5nZXMubGF5b3V0LnByZXZpb3VzVmFsdWUpKSB7XG4gICAgICB0aGlzLmxheW91dCA9IGNoYW5nZXMubGF5b3V0LmN1cnJlbnRWYWx1ZTtcbiAgICB9XG4gICAgaWYgKGNoYW5nZXMuZGF0YU92ZXJyaWRlICYmIChjaGFuZ2VzLmRhdGFPdmVycmlkZS5jdXJyZW50VmFsdWUgIT09IGNoYW5nZXMuZGF0YU92ZXJyaWRlLnByZXZpb3VzVmFsdWUpKSB7XG4gICAgICB0aGlzLmRhdGEgPSB0aGlzLmRhdGFPdmVycmlkZTtcbiAgICB9XG4gIH1cblxufVxuIl19