/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Input, ViewChild } from '@angular/core';
import { LiveAppsCaseCreatorComponent } from '../live-apps-case-creator/live-apps-case-creator.component';
import { LiveAppsService } from '../../services/live-apps.service';
import { take, takeUntil } from 'rxjs/operators';
import { LiveAppsLegacyProcessComponent } from '../live-apps-legacy-process/live-apps-legacy-process.component';
/**
 * Wraps rendering an execution of an action
 *
 * \@example <tcla-live-apps-case-action></tcla-live-apps-case-action>
 */
export class LiveAppsCaseActionComponent extends LiveAppsCaseCreatorComponent {
    /**
     * @param {?} lasvc
     */
    constructor(lasvc) {
        super(lasvc);
        this.lasvc = lasvc;
        /**
         * Enable legacy actions
         */
        this.legacyActions = this.legacyActions ? this.legacyActions : false;
        /**
         * Allow override of forms framework
         * Options: bootstrap-4 or material-design
         */
        this.formsFramework = this.formsFramework ? this.formsFramework : 'material-design';
        this.getCaseData = (/**
         * @param {?} caseRef
         * @return {?}
         */
        (caseRef) => {
            // retrieve the case data for this case reference
            this.liveapps.getCase(this.caseRef, this.sandboxId, this.applicationId, this.typeId)
                .pipe(take(1), takeUntil(this._destroyed$))
                .subscribe((/**
             * @param {?} result
             * @return {?}
             */
            result => {
                if (result.metadata.applicationId === this.applicationId.toString()) {
                    /** @type {?} */
                    const casedata = result.untaggedCasedataObj;
                    this.caseState = casedata.state;
                    this.originalData = {
                        [this.process.process.name]: casedata
                    };
                    // JS: use name rather than internalObjectName to handle appliction name change
                    /** @type {?} */
                    const caseTypeName = this.getMainCaseTypeFromSchema(this.typeId, this.process).name;
                    this.data = {
                        [caseTypeName]: casedata
                    };
                }
                else {
                    console.error('The selected case is not the right case type for this action');
                }
            }), (/**
             * @param {?} error
             * @return {?}
             */
            error => {
                // Emit any error retrieving case data to the parent
                console.error('Unable to retrieve case data');
                console.error(error);
            }));
        });
        this.cancelAction = (/**
         * @return {?}
         */
        () => {
            if (this.legacyProcessComponent) {
                this.legacyProcessComponent.cancelProcess();
            }
        });
    }
    /**
     * @private
     * @param {?} typeId
     * @param {?} process
     * @return {?}
     */
    getMainCaseTypeFromSchema(typeId, process) {
        /** @type {?} */
        let requestedType;
        process.appSchema.casetypes.forEach((/**
         * @param {?} cType
         * @return {?}
         */
        (cType) => {
            if (cType.id === typeId) {
                requestedType = cType;
            }
        }));
        return requestedType;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        // set default layout
        // this.layout = [];
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        // the extended class will detect change in the process and layout passed
        super.ngOnChanges(changes);
        // handle input param changes
        if ((changes.caseRef && changes.caseRef.currentValue && (changes.caseRef.currentValue !== changes.caseRef.previousValue))
            || (changes.process && changes.process.currentValue && (changes.process.currentValue !== changes.process.previousValue))) {
            // get case data if anything changes
            if (changes.process.currentValue) {
                this.getCaseData(this.caseRef);
            }
        }
        // handle process change for legacy action process
        if (changes.process && changes.process.currentValue && (changes.process.currentValue !== changes.process.previousValue)) {
            if (this.legacyProcessComponent) {
                this.legacyProcessComponent.changeProcess(changes.process.currentValue);
            }
        }
    }
}
LiveAppsCaseActionComponent.decorators = [
    { type: Component, args: [{
                selector: 'tcla-live-apps-case-action',
                template: "<div class=\"tcs-case-action-pane\" fxLayout=\"column\" fxFill>\n  <tc-tibco-cloud-widget-header *ngIf=\"showHeader\" fxFlex=\"nogrow\" [headerText]=\"'Action'\" [icon]=\"'tcs-case-action-item'\"></tc-tibco-cloud-widget-header>\n  <tcfrm-rendered-form *ngIf=\"data && process && (!legacyActions || isCustomForm)\" [schema]=\"schema\" [layout]=\"layout\" [data]=\"data\" [caseRef]=\"caseRef\" [appId]=\"applicationId\" [customFormDefs]=\"customFormDefs\" [formsFramework]=\"formsFramework\" [formRef]=\"process.ref\" (formSubmit)=\"handleSubmit($event, caseRef)\"></tcfrm-rendered-form>\n  <tcla-live-apps-legacy-process *ngIf=\"data && process && legacyActions && !isCustomForm\" [process]=\"process\" [caseState]=\"caseState\" [type]=\"'action'\" [applicationId]=\"applicationId\" [typeId]=\"typeId\" [caseRef]=\"caseRef\" (processCancelled)=\"handleLegacyProcessCancelled()\" (processComplete)=\"handleLegacyProcessComplete()\" class=\"live-apps-widget\" fxFill></tcla-live-apps-legacy-process>\n</div>\n",
                styles: [".tcs-case-action-pane{border-radius:3px;box-shadow:0 2px 4px 0 rgba(0,0,0,.33);background-color:#fff}.tcs-case-action-header{height:40px;border-radius:3px 3px 0 0;box-shadow:0 1px 2px 0 #dedede;padding-left:20px;padding-right:20px}.tcs-case-action-header-text{margin-left:10px;font-family:Source Sans Pro;font-size:18px;font-weight:600;font-style:normal;font-stretch:normal;line-height:1.5;letter-spacing:.3px}"]
            }] }
];
/** @nocollapse */
LiveAppsCaseActionComponent.ctorParameters = () => [
    { type: LiveAppsService }
];
LiveAppsCaseActionComponent.propDecorators = {
    caseRef: [{ type: Input }],
    showHeader: [{ type: Input }],
    legacyActions: [{ type: Input }],
    formsFramework: [{ type: Input }],
    legacyProcessComponent: [{ type: ViewChild, args: [LiveAppsLegacyProcessComponent, { static: false },] }]
};
if (false) {
    /**
     * The case reference
     * @type {?}
     */
    LiveAppsCaseActionComponent.prototype.caseRef;
    /**
     * Whether to show the header bar in the widget - eg. favorites on home page (contains icon etc) - if off icons still appear without bar
     * @type {?}
     */
    LiveAppsCaseActionComponent.prototype.showHeader;
    /**
     * Enable legacy actions
     * @type {?}
     */
    LiveAppsCaseActionComponent.prototype.legacyActions;
    /**
     * Allow override of forms framework
     * Options: bootstrap-4 or material-design
     * @type {?}
     */
    LiveAppsCaseActionComponent.prototype.formsFramework;
    /** @type {?} */
    LiveAppsCaseActionComponent.prototype.legacyProcessComponent;
    /** @type {?} */
    LiveAppsCaseActionComponent.prototype.originalData;
    /** @type {?} */
    LiveAppsCaseActionComponent.prototype.caseState;
    /**
     * @type {?}
     * @private
     */
    LiveAppsCaseActionComponent.prototype.getCaseData;
    /** @type {?} */
    LiveAppsCaseActionComponent.prototype.cancelAction;
    /**
     * @type {?}
     * @protected
     */
    LiveAppsCaseActionComponent.prototype.lasvc;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS1hcHBzLWNhc2UtYWN0aW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0aWJjby10Y3N0ay90Yy1saXZlYXBwcy1saWIvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9saXZlLWFwcHMtY2FzZS1hY3Rpb24vbGl2ZS1hcHBzLWNhc2UtYWN0aW9uLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBZ0IsS0FBSyxFQUE0QyxTQUFTLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDbEgsT0FBTyxFQUFDLDRCQUE0QixFQUFDLE1BQU0sNERBQTRELENBQUM7QUFDeEcsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLGtDQUFrQyxDQUFDO0FBQ2pFLE9BQU8sRUFBTSxJQUFJLEVBQUUsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFHcEQsT0FBTyxFQUFDLDhCQUE4QixFQUFDLE1BQU0sZ0VBQWdFLENBQUM7Ozs7OztBQWM5RyxNQUFNLE9BQU8sMkJBQTRCLFNBQVEsNEJBQTRCOzs7O0lBeUUzRSxZQUFzQixLQUFzQjtRQUMxQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFETyxVQUFLLEdBQUwsS0FBSyxDQUFpQjs7OztRQTNEbkMsa0JBQWEsR0FBWSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7Ozs7O1FBTXpFLG1CQUFjLEdBQVcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsaUJBQWlCLENBQUM7UUFrQnhGLGdCQUFXOzs7O1FBQUcsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUNoQyxpREFBaUQ7WUFDakQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFF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Q0FBQyxPQUFPLENBQUMsWUFBWSxLQUFLLE9BQU8sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDdkgsSUFBSSxJQUFJLENBQUMsc0JBQXNCLEVBQUU7Z0JBQy9CLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUN6RTtTQUNGO0lBQ0gsQ0FBQzs7O1lBeEdGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsNEJBQTRCO2dCQUN0QywwL0JBQXFEOzthQUV0RDs7OztZQWpCTyxlQUFlOzs7c0JBc0JwQixLQUFLO3lCQUtMLEtBQUs7NEJBS0wsS0FBSzs2QkFNTCxLQUFLO3FDQUdMLFNBQVMsU0FBQyw4QkFBOEIsRUFBRSxFQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUM7Ozs7Ozs7SUFuQjFELDhDQUF5Qjs7Ozs7SUFLekIsaURBQTZCOzs7OztJQUs3QixvREFBa0Y7Ozs7OztJQU1sRixxREFBZ0c7O0lBR2hHLDZEQUFtSDs7SUFFbkgsbURBQWtCOztJQUNsQixnREFBa0I7Ozs7O0lBWWxCLGtEQTJCQzs7SUFFRCxtREFJQzs7Ozs7SUFFVyw0Q0FBZ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT25DaGFuZ2VzLCBPbkluaXQsIE91dHB1dCwgU2ltcGxlQ2hhbmdlcywgVmlld0NoaWxkfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7TGl2ZUFwcHNDYXNlQ3JlYXRvckNvbXBvbmVudH0gZnJvbSAnLi4vbGl2ZS1hcHBzLWNhc2UtY3JlYXRvci9saXZlLWFwcHMtY2FzZS1jcmVhdG9yLmNvbXBvbmVudCc7XG5pbXBvcnQge0xpdmVBcHBzU2VydmljZX0gZnJvbSAnLi4vLi4vc2VydmljZXMvbGl2ZS1hcHBzLnNlcnZpY2UnO1xuaW1wb3J0IHttYXAsIHRha2UsIHRha2VVbnRpbH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtDYXNlVHlwZSwgUHJvY2Vzc0lkfSBmcm9tICcuLi8uLi9tb2RlbHMvbGl2ZWFwcHNkYXRhJztcbmltcG9ydCB7TGFQcm9jZXNzU2VsZWN0aW9ufSBmcm9tICcuLi8uLi9tb2RlbHMvdGMtY2FzZS1wcm9jZXNzZXMnO1xuaW1wb3J0IHtMaXZlQXBwc0xlZ2FjeVByb2Nlc3NDb21wb25lbnR9IGZyb20gJy4uL2xpdmUtYXBwcy1sZWdhY3ktcHJvY2Vzcy9saXZlLWFwcHMtbGVnYWN5LXByb2Nlc3MuY29tcG9uZW50JztcblxuXG4vKipcbiAqIFdyYXBzIHJlbmRlcmluZyBhbiBleGVjdXRpb24gb2YgYW4gYWN0aW9uXG4gKlxuICpAZXhhbXBsZSA8dGNsYS1saXZlLWFwcHMtY2FzZS1hY3Rpb24+PC90Y2xhLWxpdmUtYXBwcy1jYXNlLWFjdGlvbj5cbiAqL1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd0Y2xhLWxpdmUtYXBwcy1jYXNlLWFjdGlvbicsXG4gIHRlbXBsYXRlVXJsOiAnLi9saXZlLWFwcHMtY2FzZS1hY3Rpb24uY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9saXZlLWFwcHMtY2FzZS1hY3Rpb24uY29tcG9uZW50LmNzcyddXG59KVxuZXhwb3J0IGNsYXNzIExpdmVBcHBzQ2FzZUFjdGlvbkNvbXBvbmVudCBleHRlbmRzIExpdmVBcHBzQ2FzZUNyZWF0b3JDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XG4gIC8qKlxuICAgKiBUaGUgY2FzZSByZWZlcmVuY2VcbiAgICovXG4gIEBJbnB1dCgpIGNhc2VSZWY6IHN0cmluZztcblxuICAvKipcbiAgICogV2hldGhlciB0byBzaG93IHRoZSBoZWFkZXIgYmFyIGluIHRoZSB3aWRnZXQgLSBlZy4gZmF2b3JpdGVzIG9uIGhvbWUgcGFnZSAoY29udGFpbnMgaWNvbiBldGMpIC0gaWYgb2ZmIGljb25zIHN0aWxsIGFwcGVhciB3aXRob3V0IGJhclxuICAgKi9cbiAgQElucHV0KCkgc2hvd0hlYWRlcjogYm9vbGVhbjtcblxuICAvKipcbiAgICogRW5hYmxlIGxlZ2FjeSBhY3Rpb25zXG4gICAqL1xuICBASW5wdXQoKSBsZWdhY3lBY3Rpb25zOiBib29sZWFuID0gdGhpcy5sZWdhY3lBY3Rpb25zID8gdGhpcy5sZWdhY3lBY3Rpb25zIDogZmFsc2U7XG5cbiAgLyoqXG4gICAqIEFsbG93IG92ZXJyaWRlIG9mIGZvcm1zIGZyYW1ld29ya1xuICAgKiBPcHRpb25zOiBib290c3RyYXAtNCBvciBtYXRlcmlhbC1kZXNpZ25cbiAgICovXG4gIEBJbnB1dCgpIGZvcm1zRnJhbWV3b3JrOiBzdHJpbmcgPSB0aGlzLmZvcm1zRnJhbWV3b3JrID8gdGhpcy5mb3Jtc0ZyYW1ld29yayA6ICdtYXRlcmlhbC1kZXNpZ24nO1xuXG5cbiAgQFZpZXdDaGlsZChMaXZlQXBwc0xlZ2FjeVByb2Nlc3NDb21wb25lbnQsIHtzdGF0aWM6IGZhbHNlfSkgbGVnYWN5UHJvY2Vzc0NvbXBvbmVudDogTGl2ZUFwcHNMZWdhY3lQcm9jZXNzQ29tcG9uZW50O1xuXG4gIG9yaWdpbmFsRGF0YTogYW55O1xuICBjYXNlU3RhdGU6IHN0cmluZztcblxuICBwcml2YXRlIGdldE1haW5DYXNlVHlwZUZyb21TY2hlbWEodHlwZUlkOiBzdHJpbmcsIHByb2Nlc3M6IExhUHJvY2Vzc1NlbGVjdGlvbik6IENhc2VUeXBlIHtcbiAgICBsZXQgcmVxdWVzdGVkVHlwZTogQ2FzZVR5cGU7XG4gICAgcHJvY2Vzcy5hcHBTY2hlbWEuY2FzZXR5cGVzLmZvckVhY2goKGNUeXBlKSA9PiB7XG4gICAgICBpZiAoY1R5cGUuaWQgPT09IHR5cGVJZCkge1xuICAgICAgICByZXF1ZXN0ZWRUeXBlID0gY1R5cGU7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlcXVlc3RlZFR5cGU7XG4gIH1cblxuICBwcml2YXRlIGdldENhc2VEYXRhID0gKGNhc2VSZWYpID0+IHtcbiAgICAvLyByZXRyaWV2ZSB0aGUgY2FzZSBkYXRhIGZvciB0aGlzIGNhc2UgcmVmZXJlbmNlXG4gICAgdGhpcy5saXZlYXBwcy5nZXRDYXNlKHRoaXMuY2FzZVJlZiwgdGhpcy5zYW5kYm94SWQsIHRoaXMuYXBwbGljYXRpb25JZCwgdGhpcy50eXBlSWQgKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRha2UoMSksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95ZWQkKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZShyZXN1bHQgPT4ge1xuICAgICAgICBpZiAocmVzdWx0Lm1ldGFkYXRhLmFwcGxpY2F0aW9uSWQgPT09IHRoaXMuYXBwbGljYXRpb25JZC50b1N0cmluZygpKSB7XG4gICAgICAgICAgY29uc3QgY2FzZWRhdGEgPSByZXN1bHQudW50YWdnZWRDYXNlZGF0YU9iajtcbiAgICAgICAgICB0aGlzLmNhc2VTdGF0ZSA9IGNhc2VkYXRhLnN0YXRlO1xuICAgICAgICAgIHRoaXMub3JpZ2luYWxEYXRhID0ge1xuICAgICAgICAgICAgW3RoaXMucHJvY2Vzcy5wcm9jZXNzLm5hbWVdOiBjYXNlZGF0YVxuICAgICAgICAgIH07XG4gICAgICAgICAgLy8gSlM6IHVzZSBuYW1lIHJhdGhlciB0aGFuIGludGVybmFsT2JqZWN0TmFtZSB0byBoYW5kbGUgYXBwbGljdGlvbiBuYW1lIGNoYW5nZVxuICAgICAgICAgIGNvbnN0IGNhc2VUeXBlTmFtZSA9IHRoaXMuZ2V0TWFpbkNhc2VUeXBlRnJvbVNjaGVtYSh0aGlzLnR5cGVJZCwgdGhpcy5wcm9jZXNzKS5uYW1lO1xuICAgICAgICAgIHRoaXMuZGF0YSA9IHtcbiAgICAgICAgICAgIFtjYXNlVHlwZU5hbWVdOiBjYXNlZGF0YVxuICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignVGhlIHNlbGVjdGVkIGNhc2UgaXMgbm90IHRoZSByaWdodCBjYXNlIHR5cGUgZm9yIHRoaXMgYWN0aW9uJyk7XG4gICAgICAgIH1cbiAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgLy8gRW1pdCBhbnkgZXJyb3IgcmV0cmlldmluZyBjYXNlIGRhdGEgdG8gdGhlIHBhcmVudFxuICAgICAgICBjb25zb2xlLmVycm9yKCdVbmFibGUgdG8gcmV0cmlldmUgY2FzZSBkYXRhJyk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgfSk7XG4gIH1cblxuICBwdWJsaWMgY2FuY2VsQWN0aW9uID0gKCkgPT4ge1xuICAgIGlmICh0aGlzLmxlZ2FjeVByb2Nlc3NDb21wb25lbnQpIHtcbiAgICAgIHRoaXMubGVnYWN5UHJvY2Vzc0NvbXBvbmVudC5jYW5jZWxQcm9jZXNzKCk7XG4gICAgfVxuICB9XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGxhc3ZjOiBMaXZlQXBwc1NlcnZpY2UpIHtcbiAgICBzdXBlcihsYXN2Yyk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICAvLyBzZXQgZGVmYXVsdCBsYXlvdXRcbiAgICAvLyB0aGlzLmxheW91dCA9IFtdO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIC8vIHRoZSBleHRlbmRlZCBjbGFzcyB3aWxsIGRldGVjdCBjaGFuZ2UgaW4gdGhlIHByb2Nlc3MgYW5kIGxheW91dCBwYXNzZWRcbiAgICBzdXBlci5uZ09uQ2hhbmdlcyhjaGFuZ2VzKTtcbiAgICAvLyBoYW5kbGUgaW5wdXQgcGFyYW0gY2hhbmdlc1xuICAgIGlmICgoY2hhbmdlcy5jYXNlUmVmICYmIGNoYW5nZXMuY2FzZVJlZi5jdXJyZW50VmFsdWUgJiYgKGNoYW5nZXMuY2FzZVJlZi5jdXJyZW50VmFsdWUgIT09IGNoYW5nZXMuY2FzZVJlZi5wcmV2aW91c1ZhbHVlKSlcbiAgICAgIHx8IChjaGFuZ2VzLnByb2Nlc3MgJiYgY2hhbmdlcy5wcm9jZXNzLmN1cnJlbnRWYWx1ZSAmJiAoY2hhbmdlcy5wcm9jZXNzLmN1cnJlbnRWYWx1ZSAhPT0gY2hhbmdlcy5wcm9jZXNzLnByZXZpb3VzVmFsdWUpKSkge1xuICAgICAgLy8gZ2V0IGNhc2UgZGF0YSBpZiBhbnl0aGluZyBjaGFuZ2VzXG4gICAgICBpZiAoY2hhbmdlcy5wcm9jZXNzLmN1cnJlbnRWYWx1ZSkge1xuICAgICAgICB0aGlzLmdldENhc2VEYXRhKHRoaXMuY2FzZVJlZik7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIGhhbmRsZSBwcm9jZXNzIGNoYW5nZSBmb3IgbGVnYWN5IGFjdGlvbiBwcm9jZXNzXG4gICAgaWYgKGNoYW5nZXMucHJvY2VzcyAmJiBjaGFuZ2VzLnByb2Nlc3MuY3VycmVudFZhbHVlICYmIChjaGFuZ2VzLnByb2Nlc3MuY3VycmVudFZhbHVlICE9PSBjaGFuZ2VzLnByb2Nlc3MucHJldmlvdXNWYWx1ZSkpIHtcbiAgICAgIGlmICh0aGlzLmxlZ2FjeVByb2Nlc3NDb21wb25lbnQpIHtcbiAgICAgICAgdGhpcy5sZWdhY3lQcm9jZXNzQ29tcG9uZW50LmNoYW5nZVByb2Nlc3MoY2hhbmdlcy5wcm9jZXNzLmN1cnJlbnRWYWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==