/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { LiveAppsService } from '../../services/live-apps.service';
import { take, takeUntil, tap } from 'rxjs/operators';
import { LiveAppsComponent } from '../live-apps-component/live-apps-component.component';
import { TcCaseProcessesService } from '../../services/tc-case-processes.service';
/**
 * Renders case action buttons
 *
 * ![alt-text](../live-apps-case-actions.png "Image")
 *
 * \@example <tcla-live-apps-case-actions></tcla-live-apps-case-actions>
 */
export class LiveAppsCaseActionsComponent extends LiveAppsComponent {
    /**
     * @param {?} liveapps
     * @param {?} caseProcessesService
     */
    constructor(liveapps, caseProcessesService) {
        super();
        this.liveapps = liveapps;
        this.caseProcessesService = caseProcessesService;
        /**
         * Max Actions that can be run simultaneously
         */
        this.maxActions = 1;
        /**
         * ~event actionClicked : Case Action selected
         * ~payload LaProcessSelection : LaProcessSelection object output when an action is clicked (ie. message to parent to run action component)
         */
        this.actionClicked = new EventEmitter();
        this.disabled = false;
        this.refresh = (/**
         * @return {?}
         */
        () => {
            this.caseProcessesService.getCaseActionsForCaseRef(this.caseRef, this.sandboxId, this.appId, this.typeId)
                .pipe(take(1), takeUntil(this._destroyed$)).subscribe((/**
             * @param {?} caseactions
             * @return {?}
             */
            caseactions => {
                if (this.actionFilter) {
                    caseactions.actions = caseactions.actions.filter((/**
                     * @param {?} act
                     * @return {?}
                     */
                    act => {
                        // check if it matches any of the actionFilters
                        /** @type {?} */
                        let test = true;
                        this.actionFilter.forEach((/**
                         * @param {?} actfilter
                         * @return {?}
                         */
                        actfilter => {
                            if (test && act.label.substr(0, actfilter.length) === actfilter) {
                                test = false;
                            }
                        }));
                        return test;
                    }));
                }
                this.caseactions = caseactions.actions;
            }), (/**
             * @param {?} error
             * @return {?}
             */
            error => { this.errorMessage = 'Error retrieving case actions: ' + error.error.errorMsg; }));
        });
        this.toggleEnable = (/**
         * @return {?}
         */
        () => {
            this.disabled = !this.disabled;
        });
    }
    /**
     * @param {?} action
     * @return {?}
     */
    selectAction(action) {
        this.caseProcessesService.getProcessDetails(this.caseRef, this.appId, this.typeId, this.sandboxId, action, null, 100).pipe(take(1), takeUntil(this._destroyed$), tap((/**
         * @param {?} processDetails
         * @return {?}
         */
        processDetails => {
            if (!processDetails || !processDetails.process || (processDetails.process.jsonSchema.$schema === 'NOSCHEMA')) {
                // This will be triggered when no form schema is available
                // Typically happens when:
                // 1) The form has elements that are not supported by the Live Apps API for form schemas such as participant selectors
                // 2) The Live Apps application is legacy and has no form schema at all, redeploying the live apps application would fix this.
                console.error('No schema available for this case type: The form may not be supported or you may need to update/re-deploy the live apps application');
            }
        })))
            .subscribe((/**
         * @param {?} processSchema
         * @return {?}
         */
        processSchema => {
            this.actionClicked.emit(processSchema);
            return processSchema;
        }), (/**
         * @param {?} error
         * @return {?}
         */
        error => { this.errorMessage = 'Error retrieving case actions: ' + error.error.errorMsg; }));
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.refresh();
    }
}
LiveAppsCaseActionsComponent.decorators = [
    { type: Component, args: [{
                selector: 'tcla-live-apps-case-actions',
                template: "<div fxLayout=\"row\">\n  <button [disabled]=\"disabled\" [ngClass]=\"disabled ? 'disabled' : ''\" mat-button class=\"tcs-case-action-button\" *ngFor=\"let action of caseactions| slice:0:maxActions\"\n          matTooltip=\"{{action.label}}\" matTooltipShowDelay=\"1000\" matTooltipPosition=\"above\"\n          (click)=\"selectAction(action)\">\n    {{action.label | ellipsis: 30 }}\n  </button>\n  <div fxLayout=\"row\" fxLayoutAlign=\"center center\" style=\"width: 75px\" *ngIf=\"caseactions && caseactions.length > maxActions\">\n    <mat-select class=\"tcs-case-action-option\" [disableOptionCentering]=\"true\" placeholder=\"More\" matTooltip=\"\" matTooltipShowDelay=\"1000\" matTooltipPosition=\"below\">\n      <mat-option *ngFor=\"let action of caseactions | slice:maxActions:caseactions.length\" [value]=\"\" (click)=\"selectAction(action)\">\n        <span>{{action.label}}</span>\n      </mat-option>\n    </mat-select>\n  </div>\n</div>\n",
                styles: [".tcs-case-action-button{height:40px;border-radius:3px;background-color:#fff;color:#0081cb;font-family:Source Sans Pro;font-size:16px;font-weight:400;font-style:normal;font-stretch:normal;line-height:normal;letter-spacing:.2px;margin:5px;border:1px solid #0081cb}.tcs-case-action-button.disabled{border:none}.tcs-case-action-option{padding-top:9px;padding-left:10px;padding-right:10px;height:40px;border-radius:3px;background-color:#fff;color:#0081cb;border:1px solid #0081cb}"]
            }] }
];
/** @nocollapse */
LiveAppsCaseActionsComponent.ctorParameters = () => [
    { type: LiveAppsService },
    { type: TcCaseProcessesService }
];
LiveAppsCaseActionsComponent.propDecorators = {
    caseRef: [{ type: Input }],
    appId: [{ type: Input }],
    typeId: [{ type: Input }],
    sandboxId: [{ type: Input }],
    maxActions: [{ type: Input }],
    actionFilter: [{ type: Input }],
    actionClicked: [{ type: Output }]
};
if (false) {
    /**
     * The case reference
     * @type {?}
     */
    LiveAppsCaseActionsComponent.prototype.caseRef;
    /**
     * The LA Application Id
     * @type {?}
     */
    LiveAppsCaseActionsComponent.prototype.appId;
    /**
     * The LA Application Type Id (generally 1)
     * @type {?}
     */
    LiveAppsCaseActionsComponent.prototype.typeId;
    /**
     * sandboxId - this comes from claims resolver
     * @type {?}
     */
    LiveAppsCaseActionsComponent.prototype.sandboxId;
    /**
     * Max Actions that can be run simultaneously
     * @type {?}
     */
    LiveAppsCaseActionsComponent.prototype.maxActions;
    /**
     * Dont show buttons for any actions that start with this string.
     * eg: '$' will remove the action $Update
     * @type {?}
     */
    LiveAppsCaseActionsComponent.prototype.actionFilter;
    /**
     * ~event actionClicked : Case Action selected
     * ~payload LaProcessSelection : LaProcessSelection object output when an action is clicked (ie. message to parent to run action component)
     * @type {?}
     */
    LiveAppsCaseActionsComponent.prototype.actionClicked;
    /** @type {?} */
    LiveAppsCaseActionsComponent.prototype.caseactions;
    /** @type {?} */
    LiveAppsCaseActionsComponent.prototype.errorMessage;
    /** @type {?} */
    LiveAppsCaseActionsComponent.prototype.disabled;
    /** @type {?} */
    LiveAppsCaseActionsComponent.prototype.appSchema;
    /** @type {?} */
    LiveAppsCaseActionsComponent.prototype.caseType;
    /** @type {?} */
    LiveAppsCaseActionsComponent.prototype.caseActionList;
    /** @type {?} */
    LiveAppsCaseActionsComponent.prototype.refresh;
    /** @type {?} */
    LiveAppsCaseActionsComponent.prototype.toggleEnable;
    /**
     * @type {?}
     * @protected
     */
    LiveAppsCaseActionsComponent.prototype.liveapps;
    /**
     * @type {?}
     * @protected
     */
    LiveAppsCaseActionsComponent.prototype.caseProcessesService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS1hcHBzLWNhc2UtYWN0aW9ucy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGliY28tdGNzdGsvdGMtbGl2ZWFwcHMtbGliLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvbGl2ZS1hcHBzLWNhc2UtYWN0aW9ucy9saXZlLWFwcHMtY2FzZS1hY3Rpb25zLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsT0FBTyxFQUFDLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFxQixNQUFNLEVBQVksTUFBTSxlQUFlLENBQUM7QUFFbkcsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLGtDQUFrQyxDQUFDO0FBQ2pFLE9BQU8sRUFBTSxJQUFJLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBR3pELE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLHNEQUFzRCxDQUFDO0FBQ3ZGLE9BQU8sRUFBQyxzQkFBc0IsRUFBQyxNQUFNLDBDQUEwQyxDQUFDOzs7Ozs7OztBQWdCaEYsTUFBTSxPQUFPLDRCQUE2QixTQUFRLGlCQUFpQjs7Ozs7SUErQ2pFLFlBQXNCLFFBQXlCLEVBQVksb0JBQTRDO1FBQ3JHLEtBQUssRUFBRSxDQUFDO1FBRFksYUFBUSxHQUFSLFFBQVEsQ0FBaUI7UUFBWSx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXdCOzs7O1FBdkI5RixlQUFVLEdBQUcsQ0FBQyxDQUFDOzs7OztRQWFkLGtCQUFhLEdBQXFDLElBQUksWUFBWSxFQUFzQixDQUFDO1FBSTVGLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFVakIsWUFBTzs7O1FBQUcsR0FBRyxFQUFFO1lBQ3BCLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDO2lCQUN0RyxJ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Qiw4Q0FBd0I7Ozs7O0lBS3hCLGlEQUEyQjs7Ozs7SUFLM0Isa0RBQXdCOzs7Ozs7SUFPeEIsb0RBQWdDOzs7Ozs7SUFNaEMscURBQW1HOztJQUVuRyxtREFBaUM7O0lBQ2pDLG9EQUE0Qjs7SUFDNUIsZ0RBQXdCOztJQUV4QixpREFBeUI7O0lBQ3pCLGdEQUFtQjs7SUFDbkIsc0RBQTBCOztJQU0xQiwrQ0FxQkM7O0lBRUQsb0RBRUM7Ozs7O0lBN0JXLGdEQUFtQzs7Ozs7SUFBRSw0REFBc0QiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7Q29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkRlc3Ryb3ksIE9uSW5pdCwgT3V0cHV0LCBWaWV3Q2hpbGR9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtTdWJqZWN0fSBmcm9tICdyeGpzJztcbmltcG9ydCB7TGl2ZUFwcHNTZXJ2aWNlfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9saXZlLWFwcHMuc2VydmljZSc7XG5pbXBvcnQge21hcCwgdGFrZSwgdGFrZVVudGlsLCB0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7Q2FzZUFjdGlvbiwgQ2FzZVR5cGUsIENhc2VUeXBlc0xpc3QsIFByb2Nlc3N9IGZyb20gJy4uLy4uL21vZGVscy9saXZlYXBwc2RhdGEnO1xuaW1wb3J0IHtMYVByb2Nlc3NTZWxlY3Rpb259IGZyb20gJy4uLy4uL21vZGVscy90Yy1jYXNlLXByb2Nlc3Nlcyc7XG5pbXBvcnQge0xpdmVBcHBzQ29tcG9uZW50fSBmcm9tICcuLi9saXZlLWFwcHMtY29tcG9uZW50L2xpdmUtYXBwcy1jb21wb25lbnQuY29tcG9uZW50JztcbmltcG9ydCB7VGNDYXNlUHJvY2Vzc2VzU2VydmljZX0gZnJvbSAnLi4vLi4vc2VydmljZXMvdGMtY2FzZS1wcm9jZXNzZXMuc2VydmljZSc7XG5pbXBvcnQge0N1c3RvbUZvcm1EZWZzfSBmcm9tICdAdGliY28tdGNzdGsvdGMtZm9ybXMtbGliJztcblxuXG4vKipcbiAqIFJlbmRlcnMgY2FzZSBhY3Rpb24gYnV0dG9uc1xuICpcbiAqICFbYWx0LXRleHRdKC4uL2xpdmUtYXBwcy1jYXNlLWFjdGlvbnMucG5nIFwiSW1hZ2VcIilcbiAqXG4gKkBleGFtcGxlIDx0Y2xhLWxpdmUtYXBwcy1jYXNlLWFjdGlvbnM+PC90Y2xhLWxpdmUtYXBwcy1jYXNlLWFjdGlvbnM+XG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3RjbGEtbGl2ZS1hcHBzLWNhc2UtYWN0aW9ucycsXG4gIHRlbXBsYXRlVXJsOiAnLi9saXZlLWFwcHMtY2FzZS1hY3Rpb25zLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vbGl2ZS1hcHBzLWNhc2UtYWN0aW9ucy5jb21wb25lbnQuY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgTGl2ZUFwcHNDYXNlQWN0aW9uc0NvbXBvbmVudCBleHRlbmRzIExpdmVBcHBzQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgLyoqXG4gICAqIFRoZSBjYXNlIHJlZmVyZW5jZVxuICAgKi9cbiAgQElucHV0KCkgY2FzZVJlZjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgTEEgQXBwbGljYXRpb24gSWRcbiAgICovXG4gIEBJbnB1dCgpIGFwcElkOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBMQSBBcHBsaWNhdGlvbiBUeXBlIElkIChnZW5lcmFsbHkgMSlcbiAgICovXG4gIEBJbnB1dCgpIHR5cGVJZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBzYW5kYm94SWQgLSB0aGlzIGNvbWVzIGZyb20gY2xhaW1zIHJlc29sdmVyXG4gICAqL1xuICBASW5wdXQoKSBzYW5kYm94SWQ6IG51bWJlcjtcblxuICAvKipcbiAgICogTWF4IEFjdGlvbnMgdGhhdCBjYW4gYmUgcnVuIHNpbXVsdGFuZW91c2x5XG4gICAqL1xuICBASW5wdXQoKSBtYXhBY3Rpb25zID0gMTtcblxuXG4gIC8qKlxuICAgKiBEb250IHNob3cgYnV0dG9ucyBmb3IgYW55IGFjdGlvbnMgdGhhdCBzdGFydCB3aXRoIHRoaXMgc3RyaW5nLlxuICAgKiBlZzogJyQnIHdpbGwgcmVtb3ZlIHRoZSBhY3Rpb24gJFVwZGF0ZVxuICAgKi9cbiAgQElucHV0KCkgYWN0aW9uRmlsdGVyOiBzdHJpbmdbXTtcblxuICAvKipcbiAgICogfmV2ZW50IGFjdGlvbkNsaWNrZWQgOiBDYXNlIEFjdGlvbiBzZWxlY3RlZFxuICAgKiB+cGF5bG9hZCBMYVByb2Nlc3NTZWxlY3Rpb24gOiBMYVByb2Nlc3NTZWxlY3Rpb24gb2JqZWN0IG91dHB1dCB3aGVuIGFuIGFjdGlvbiBpcyBjbGlja2VkIChpZS4gbWVzc2FnZSB0byBwYXJlbnQgdG8gcnVuIGFjdGlvbiBjb21wb25lbnQpXG4gICAqL1xuICBAT3V0cHV0KCkgYWN0aW9uQ2xpY2tlZDogRXZlbnRFbWl0dGVyPExhUHJvY2Vzc1NlbGVjdGlvbj4gPSBuZXcgRXZlbnRFbWl0dGVyPExhUHJvY2Vzc1NlbGVjdGlvbj4oKTtcblxuICBwdWJsaWMgY2FzZWFjdGlvbnM6IENhc2VBY3Rpb25bXTtcbiAgcHVibGljIGVycm9yTWVzc2FnZTogc3RyaW5nO1xuICBwdWJsaWMgZGlzYWJsZWQgPSBmYWxzZTtcblxuICBhcHBTY2hlbWE6IENhc2VUeXBlc0xpc3Q7XG4gIGNhc2VUeXBlOiBDYXNlVHlwZTtcbiAgY2FzZUFjdGlvbkxpc3Q6IFByb2Nlc3NbXTtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgbGl2ZWFwcHM6IExpdmVBcHBzU2VydmljZSwgcHJvdGVjdGVkIGNhc2VQcm9jZXNzZXNTZXJ2aWNlOiBUY0Nhc2VQcm9jZXNzZXNTZXJ2aWNlKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIHB1YmxpYyByZWZyZXNoID0gKCkgPT4ge1xuICAgIHRoaXMuY2FzZVByb2Nlc3Nlc1NlcnZpY2UuZ2V0Q2FzZUFjdGlvbnNGb3JDYXNlUmVmKHRoaXMuY2FzZVJlZiwgdGhpcy5zYW5kYm94SWQsIHRoaXMuYXBwSWQsIHRoaXMudHlwZUlkKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRha2UoMSksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95ZWQkKVxuICAgICAgKS5zdWJzY3JpYmUoXG4gICAgICBjYXNlYWN0aW9ucyA9PiB7XG4gICAgICAgIGlmICh0aGlzLmFjdGlvbkZpbHRlcikge1xuICAgICAgICAgIGNhc2VhY3Rpb25zLmFjdGlvbnMgPSBjYXNlYWN0aW9ucy5hY3Rpb25zLmZpbHRlcihhY3QgPT4ge1xuICAgICAgICAgICAgLy8gY2hlY2sgaWYgaXQgbWF0Y2hlcyBhbnkgb2YgdGhlIGFjdGlvbkZpbHRlcnNcbiAgICAgICAgICAgIGxldCB0ZXN0ID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuYWN0aW9uRmlsdGVyLmZvckVhY2goYWN0ZmlsdGVyID0+IHtcbiAgICAgICAgICAgICAgaWYgKHRlc3QgJiYgYWN0LmxhYmVsLnN1YnN0cigwLCBhY3RmaWx0ZXIubGVuZ3RoKSA9PT0gYWN0ZmlsdGVyKSB7XG4gICAgICAgICAgICAgICAgdGVzdCA9IGZhbHNlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiB0ZXN0O1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2FzZWFjdGlvbnMgPSBjYXNlYWN0aW9ucy5hY3Rpb25zO1xuICAgICAgfSwgZXJyb3IgPT4geyB0aGlzLmVycm9yTWVzc2FnZSA9ICdFcnJvciByZXRyaWV2aW5nIGNhc2UgYWN0aW9uczogJyArIGVycm9yLmVycm9yLmVycm9yTXNnOyB9KTtcbiAgfVxuXG4gIHB1YmxpYyB0b2dnbGVFbmFibGUgPSAoKSA9PiB7XG4gICAgdGhpcy5kaXNhYmxlZCA9ICF0aGlzLmRpc2FibGVkO1xuICB9XG5cbiAgcHVibGljIHNlbGVjdEFjdGlvbihhY3Rpb246IENhc2VBY3Rpb24pIHtcblxuICAgIHRoaXMuY2FzZVByb2Nlc3Nlc1NlcnZpY2UuZ2V0UHJvY2Vzc0RldGFpbHModGhpcy5jYXNlUmVmLCB0aGlzLmFwcElkLCB0aGlzLnR5cGVJZCwgdGhpcy5zYW5kYm94SWQsIGFjdGlvbiwgbnVsbCwgMTAwKS5waXBlKFxuICAgICAgdGFrZSgxKSxcbiAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95ZWQkKSxcbiAgICAgIHRhcChwcm9jZXNzRGV0YWlscyA9PiB7XG4gICAgICAgIGlmICghcHJvY2Vzc0RldGFpbHMgfHwgIXByb2Nlc3NEZXRhaWxzLnByb2Nlc3MgfHwgKHByb2Nlc3NEZXRhaWxzLnByb2Nlc3MuanNvblNjaGVtYS4kc2NoZW1hID09PSAnTk9TQ0hFTUEnKSkge1xuICAgICAgICAgIC8vIFRoaXMgd2lsbCBiZSB0cmlnZ2VyZWQgd2hlbiBubyBmb3JtIHNjaGVtYSBpcyBhdmFpbGFibGVcbiAgICAgICAgICAvLyBUeXBpY2FsbHkgaGFwcGVucyB3aGVuOlxuICAgICAgICAgIC8vIDEpIFRoZSBmb3JtIGhhcyBlbGVtZW50cyB0aGF0IGFyZSBub3Qgc3VwcG9ydGVkIGJ5IHRoZSBMaXZlIEFwcHMgQVBJIGZvciBmb3JtIHNjaGVtYXMgc3VjaCBhcyBwYXJ0aWNpcGFudCBzZWxlY3RvcnNcbiAgICAgICAgICAvLyAyKSBUaGUgTGl2ZSBBcHBzIGFwcGxpY2F0aW9uIGlzIGxlZ2FjeSBhbmQgaGFzIG5vIGZvcm0gc2NoZW1hIGF0IGFsbCwgcmVkZXBsb3lpbmcgdGhlIGxpdmUgYXBwcyBhcHBsaWNhdGlvbiB3b3VsZCBmaXggdGhpcy5cbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ05vIHNjaGVtYSBhdmFpbGFibGUgZm9yIHRoaXMgY2FzZSB0eXBlOiBUaGUgZm9ybSBtYXkgbm90IGJlIHN1cHBvcnRlZCBvciB5b3UgbWF5IG5lZWQgdG8gdXBkYXRlL3JlLWRlcGxveSB0aGUgbGl2ZSBhcHBzIGFwcGxpY2F0aW9uJyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApXG4gICAgKVxuICAgIC5zdWJzY3JpYmUocHJvY2Vzc1NjaGVtYSA9PiB7XG4gICAgICB0aGlzLmFjdGlvbkNsaWNrZWQuZW1pdChwcm9jZXNzU2NoZW1hKTtcbiAgICAgIHJldHVybiBwcm9jZXNzU2NoZW1hO1xuICAgIH0sIGVycm9yID0+IHsgdGhpcy5lcnJvck1lc3NhZ2UgPSAnRXJyb3IgcmV0cmlldmluZyBjYXNlIGFjdGlvbnM6ICcgKyBlcnJvci5lcnJvci5lcnJvck1zZzsgfSk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnJlZnJlc2goKTtcbiAgfVxuXG59XG4iXX0=