/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { BaseChartDirective } from 'ng2-charts';
import { TcLiveAppsReportingService } from '../../services/tc-live-apps-reporting.service';
import { LiveAppsComponent } from '../live-apps-component/live-apps-component.component';
import { map, take, takeUntil } from 'rxjs/operators';
import { DEFAULT_COLORS, DEFAULT_TYPE_COLOR } from '../../services/tc-case-card-config.service';
/**
 * Home page active cases widget sub component
 *
 * \@example <tcla-live-apps-active-cases-report></tcla-live-apps-active-cases-report>
 */
export class LiveAppsActiveCasesReportComponent extends LiveAppsComponent {
    /**
     * @param {?} reportingService
     */
    constructor(reportingService) {
        super();
        this.reportingService = reportingService;
        /**
         * Maximum rows to show in legend before it is hidden (otherwise would take whole widget)
         */
        this.maxLegendItems = this.maxLegendItems ? this.maxLegendItems : 8;
        /**
         * Whether to show percentages or raw case numbers on the doughnut chart
         */
        this.showPercentages = this.showPercentages ? this.showPercentages : false;
        /**
         * ~event selectedCaseType : Case Type selected in vizualization
         * ~payload CaseTypeReportRecord : CaseTypeReportRecord object selected from component
         */
        this.selectedCaseType = new EventEmitter();
        this.renderChart = false;
        this.doughnutChartData = [];
        this.doughnutChartType = 'doughnut';
        this.chartColors = [];
        this.defaultColors = DEFAULT_COLORS.slice().reverse();
        this.getCaseCount = (/**
         * @return {?}
         */
        () => {
            return this.totalActiveCaseCount;
        });
        this.doughnutChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
                display: false,
                position: 'left'
            },
            layout: {
                padding: {
                    left: 0,
                    right: 0,
                    top: 10,
                    bottom: 10
                }
            },
            plugins: {
                doughnutlabel: {
                    labels: [
                        {
                            text: this.getCaseCount,
                            font: {
                                size: '20',
                                family: 'Source Sans Pro',
                                weight: 'bold'
                            },
                            color: '#b6b6b6'
                        },
                        {
                            text: 'cases',
                            font: {
                                size: '16',
                                family: 'Source Sans Pro',
                            },
                            color: '#b6b6b6'
                        }
                    ]
                },
                datalabels: {
                    anchor: 'end',
                    backgroundColor: (/**
                     * @param {?} context
                     * @return {?}
                     */
                    function (context) {
                        return context.dataset.backgroundColor;
                    }),
                    borderColor: 'white',
                    borderRadius: 25,
                    borderWidth: 2,
                    color: 'white',
                    display: (/**
                     * @param {?} context
                     * @return {?}
                     */
                    function (context) {
                        /** @type {?} */
                        const dataset = context.dataset;
                        /** @type {?} */
                        const value = dataset.data[context.dataIndex];
                        return value > 0;
                    }),
                    font: {
                        weight: 'bold'
                    },
                    formatter: (/**
                     * @param {?} value
                     * @param {?} ctx
                     * @return {?}
                     */
                    (value, ctx) => {
                        /** @type {?} */
                        const datasets = ctx.chart.data.datasets;
                        if (datasets.indexOf(ctx.dataset) === datasets.length - 1) {
                            if (this.showPercentages) {
                                /** @type {?} */
                                const sum = datasets[0].data.reduce((/**
                                 * @param {?} a
                                 * @param {?} b
                                 * @return {?}
                                 */
                                (a, b) => a + b), 0);
                                /** @type {?} */
                                const percentage = Math.round((value / sum) * 100) + '%';
                                return percentage;
                            }
                            else {
                                return value;
                            }
                        }
                        else {
                            return 0;
                        }
                    })
                }
            }
        };
        this.initReportDataToChart = (/**
         * @param {?} reportData
         * @return {?}
         */
        (reportData) => {
            this.doughnutChartData = [];
            this.totalActiveCaseCount = 0;
            /** @type {?} */
            const activeCasesArray = [];
            /** @type {?} */
            const labels = [];
            /** @type {?} */
            const colorArray = [];
            // remove any taken colors from the defaultColors
            // we have to do this before parsing the record to avoid getting same colors
            reportData.caseTypes.forEach((/**
             * @param {?} ct
             * @return {?}
             */
            ct => {
                // remove color from defaults
                if (ct.caseTypeInfo.color) {
                    this.defaultColors = this.defaultColors.filter((/**
                     * @param {?} item
                     * @return {?}
                     */
                    item => item !== ct.caseTypeInfo.color));
                }
            }));
            // parse record
            reportData.caseTypes.forEach((/**
             * @param {?} caseType
             * @return {?}
             */
            caseType => {
                activeCasesArray.push(caseType.activeStateCaseCount);
                this.totalActiveCaseCount = this.totalActiveCaseCount + caseType.activeStateCaseCount;
                this.totalTerminatedCaseCount = this.totalTerminatedCaseCount + caseType.terminalStateCaseCount;
                labels.push(caseType.caseTypeInfo.label);
                // we will re-color anything that has the default color
                /** @type {?} */
                let col;
                if (caseType.caseTypeInfo.color && caseType.caseTypeInfo.color !== DEFAULT_TYPE_COLOR) {
                    // use the set color
                    col = caseType.caseTypeInfo.color;
                }
                else {
                    // try and get a color from the palette
                    /** @type {?} */
                    const palCol = this.defaultColors.pop();
                    if (palCol) {
                        col = palCol;
                    }
                    else {
                        // if no more in palette use a random color!
                        /** @type {?} */
                        const i = Math.random() * 0xffffff;
                        /** @type {?} */
                        const p = parseInt(i.toString(), 0);
                        col = '#' + p.toString(16);
                    }
                }
                colorArray.push(col);
            }));
            // showing more than 8 in the legend will take up too much space
            this.doughnutChartOptions.legend.display = labels.length <= 8;
            this.doughnutChartData = activeCasesArray;
            this.doughnutChartLabels = labels;
            this.chartColors.push({ backgroundColor: colorArray });
            this.renderChart = true;
        });
        this.refresh = (/**
         * @return {?}
         */
        () => {
            this.reportingService.getCaseTypesReport(this.sandboxId, this.appIds, this.uiAppId).pipe(take(1), takeUntil(this._destroyed$), map((/**
             * @param {?} report
             * @return {?}
             */
            report => {
                this.caseTypesReport = report;
                this.initReportDataToChart(report);
                return report;
            })))
                .subscribe(null, (/**
             * @param {?} error
             * @return {?}
             */
            error => { this.errorMessage = 'Error retrieving case types report: ' + error.error.errorMsg; }));
        });
    }
    // events
    /**
     * @param {?} __0
     * @return {?}
     */
    chartClicked({ event, active }) {
        if (active.length > 0) {
            /** @type {?} */
            const chart = active[0]._chart;
            /** @type {?} */
            const activePoints = chart.getElementAtEvent(event);
            if (activePoints.length > 0) {
                // get the internal index of slice in pie chart
                /** @type {?} */
                const clickedElementIndex = activePoints[0]._index;
                /** @type {?} */
                const label = chart.data.labels[clickedElementIndex];
                // get value by index
                /** @type {?} */
                const value = chart.data.datasets[0].data[clickedElementIndex];
                this.caseTypesReport.caseTypes[clickedElementIndex].incTerminal = false;
                this.selectedCaseType.emit(this.caseTypesReport.caseTypes[clickedElementIndex]);
            }
        }
    }
    /**
     * @param {?} __0
     * @return {?}
     */
    chartHovered({ event, active }) {
        // console.log(event, active);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.refresh();
    }
}
LiveAppsActiveCasesReportComponent.decorators = [
    { type: Component, args: [{
                selector: 'tcla-live-apps-active-cases-report',
                template: "  <div fxLayout=\"column\" fxFlex style=\"overflow: auto\">\n    <div *ngIf=\"renderChart\" style=\"height:100%; width:100%; padding: 20px\" class=\"relative\">\n      <canvas #caseReportChart baseChart\n              [data]=\"doughnutChartData\"\n              [labels]=\"doughnutChartLabels\"\n              [chartType]=\"doughnutChartType\"\n              [options]=\"doughnutChartOptions\"\n              [colors]=\"chartColors\"\n              (chartHover)=\"chartHovered($event)\"\n              (chartClick)=\"chartClicked($event)\"\n      >\n      </canvas>\n    </div>\n  </div>\n",
                styles: [""]
            }] }
];
/** @nocollapse */
LiveAppsActiveCasesReportComponent.ctorParameters = () => [
    { type: TcLiveAppsReportingService }
];
LiveAppsActiveCasesReportComponent.propDecorators = {
    sandboxId: [{ type: Input }],
    appIds: [{ type: Input }],
    showHeader: [{ type: Input }],
    uiAppId: [{ type: Input }],
    maxLegendItems: [{ type: Input }],
    showPercentages: [{ type: Input }],
    selectedCaseType: [{ type: Output }],
    caseReportChart: [{ type: ViewChild, args: [BaseChartDirective, { static: false },] }]
};
if (false) {
    /**
     * sandboxId - this comes from claims resolver
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.sandboxId;
    /**
     * The list of LA Application IDs you want to handle
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.appIds;
    /**
     * Whether to show the header bar in the widget - eg. favorites on home page (contains icon etc) - if off icons still appear without bar
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.showHeader;
    /**
     * The Application ID of the UI (should ideally be unique as it is shared state key)
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.uiAppId;
    /**
     * Maximum rows to show in legend before it is hidden (otherwise would take whole widget)
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.maxLegendItems;
    /**
     * Whether to show percentages or raw case numbers on the doughnut chart
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.showPercentages;
    /**
     * ~event selectedCaseType : Case Type selected in vizualization
     * ~payload CaseTypeReportRecord : CaseTypeReportRecord object selected from component
     * @type {?}
     */
    LiveAppsActiveCasesReportComponent.prototype.selectedCaseType;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.caseReportChart;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.errorMessage;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.caseTypesReport;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.totalActiveCaseCount;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.totalTerminatedCaseCount;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.renderChart;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.doughnutChartLabels;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.doughnutChartData;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.doughnutChartType;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.chartColors;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.defaultColors;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.legendData;
    /**
     * @type {?}
     * @private
     */
    LiveAppsActiveCasesReportComponent.prototype.getCaseCount;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.doughnutChartOptions;
    /**
     * @type {?}
     * @private
     */
    LiveAppsActiveCasesReportComponent.prototype.initReportDataToChart;
    /** @type {?} */
    LiveAppsActiveCasesReportComponent.prototype.refresh;
    /**
     * @type {?}
     * @private
     */
    LiveAppsActiveCasesReportComponent.prototype.reportingService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS1hcHBzLWFjdGl2ZS1jYXNlcy1yZXBvcnQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRpYmNvLXRjc3RrL3RjLWxpdmVhcHBzLWxpYi8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2xpdmUtYXBwcy1hY3RpdmUtY2FzZXMtcmVwb3J0L2xpdmUtYXBwcy1hY3RpdmUtY2FzZXMtcmVwb3J0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFVLE1BQU0sRUFBRSxTQUFTLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFeEYsT0FBTyxFQUFDLGtCQUFrQixFQUFvRCxNQUFNLFlBQVksQ0FBQztBQUVqRyxPQUFPLEVBQUMsMEJBQTBCLEVBQUMsTUFBTSwrQ0FBK0MsQ0FBQztBQUN6RixPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSxzREFBc0QsQ0FBQztBQUN2RixPQUFPLEVBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUdwRCxPQUFPLEVBQUMsY0FBYyxFQUFFLGtCQUFrQixFQUFDLE1BQU0sNENBQTRDLENBQUM7Ozs7OztBQVk5RixNQUFNLE9BQU8sa0NBQW1DLFNBQVEsaUJBQWlCOzs7O0lBRXZFLFlBQW9CLGdCQUE0QztRQUM5RCxLQUFLLEVBQUUsQ0FBQztRQURVLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBNEI7Ozs7UUEyQnZELG1CQUFjLEdBQVcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDOzs7O1FBS3ZFLG9CQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDOzs7OztRQU9yRSxxQkFBZ0IsR0FBdUMsSUFBSSxZ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QUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQzthQUNqRjtTQUNGO0lBQ0gsQ0FBQzs7Ozs7SUFFTSxZQUFZLENBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUF1QztRQUN4RSw4QkFBOEI7SUFDaEMsQ0FBQzs7OztJQUVELFFBQVE7UUFDTixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDakIsQ0FBQzs7O1lBbE9GLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsb0NBQW9DO2dCQUM5Qyx5bEJBQTZEOzthQUU5RDs7OztZQWhCTywwQkFBMEI7Ozt3QkEwQi9CLEtBQUs7cUJBS0wsS0FBSzt5QkFLTCxLQUFLO3NCQUtMLEtBQUs7NkJBS0wsS0FBSzs4QkFLTCxLQUFLOytCQU9MLE1BQU07OEJBRU4sU0FBUyxTQUFDLGtCQUFrQixFQUFFLEVBQUMsTUFBTSxFQUFFLEtBQUssRUFBQzs7Ozs7OztJQWxDOUMsdURBQTJCOzs7OztJQUszQixvREFBMEI7Ozs7O0lBSzFCLHdEQUE2Qjs7Ozs7SUFLN0IscURBQXlCOzs7OztJQUt6Qiw0REFBZ0Y7Ozs7O0lBS2hGLDZEQUErRTs7Ozs7O0lBTy9FLDhEQUEwRzs7SUFFMUcsNkRBQW9GOztJQUVwRiwwREFBNEI7O0lBQzVCLDZEQUF3Qzs7SUFDeEMsa0VBQW9DOztJQUNwQyxzRUFBd0M7O0lBQ3hDLHlEQUEyQjs7SUFFM0IsaUVBQW9DOztJQUNwQywrREFBNkM7O0lBQzdDLCtEQUFpRDs7SUFDakQseURBQStCOztJQUMvQiwyREFBa0U7O0lBRWxFLHdEQUF1Qjs7Ozs7SUFFdkIsMERBRUM7O0lBRUQsa0VBd0VFOzs7OztJQUVGLG1FQTZDQzs7SUFFRCxxREFZQzs7Ozs7SUFsTVcsOERBQW9EIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE9uSW5pdCwgT3V0cHV0LCBWaWV3Q2hpbGR9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtDYXNlVHlwZVJlcG9ydFJlY29yZCwgQ2FzZVR5cGVzUmVwb3J0fSBmcm9tICcuLi8uLi9tb2RlbHMvdGMtbGl2ZS1hcHBzLXJlcG9ydGluZyc7XG5pbXBvcnQge0Jhc2VDaGFydERpcmVjdGl2ZSwgZGVmYXVsdENvbG9ycywgTGFiZWwsIE11bHRpRGF0YVNldCwgU2luZ2xlRGF0YVNldH0gZnJvbSAnbmcyLWNoYXJ0cyc7XG5pbXBvcnQge0NoYXJ0VHlwZX0gZnJvbSAnY2hhcnQuanMnO1xuaW1wb3J0IHtUY0xpdmVBcHBzUmVwb3J0aW5nU2VydmljZX0gZnJvbSAnLi4vLi4vc2VydmljZXMvdGMtbGl2ZS1hcHBzLXJlcG9ydGluZy5zZXJ2aWNlJztcbmltcG9ydCB7TGl2ZUFwcHNDb21wb25lbnR9IGZyb20gJy4uL2xpdmUtYXBwcy1jb21wb25lbnQvbGl2ZS1hcHBzLWNvbXBvbmVudC5jb21wb25lbnQnO1xuaW1wb3J0IHttYXAsIHRha2UsIHRha2VVbnRpbH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge2NvcHl9IGZyb20gJ2FuZ3VsYXI2LWpzb24tc2NoZW1hLWZvcm0nO1xuaW1wb3J0IHtERUZBVUxUX0NPTE9SUywgREVGQVVMVF9UWVBFX0NPTE9SfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy90Yy1jYXNlLWNhcmQtY29uZmlnLnNlcnZpY2UnO1xuXG4vKipcbiAqIEhvbWUgcGFnZSBhY3RpdmUgY2FzZXMgd2lkZ2V0IHN1YiBjb21wb25lbnRcbiAqXG4gKkBleGFtcGxlIDx0Y2xhLWxpdmUtYXBwcy1hY3RpdmUtY2FzZXMtcmVwb3J0PjwvdGNsYS1saXZlLWFwcHMtYWN0aXZlLWNhc2VzLXJlcG9ydD5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAndGNsYS1saXZlLWFwcHMtYWN0aXZlLWNhc2VzLXJlcG9ydCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9saXZlLWFwcHMtYWN0aXZlLWNhc2VzLXJlcG9ydC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2xpdmUtYXBwcy1hY3RpdmUtY2FzZXMtcmVwb3J0LmNvbXBvbmVudC5jc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBMaXZlQXBwc0FjdGl2ZUNhc2VzUmVwb3J0Q29tcG9uZW50IGV4dGVuZHMgTGl2ZUFwcHNDb21wb25lbnQgaW1wbGVtZW50cyAgT25Jbml0IHtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlcG9ydGluZ1NlcnZpY2U6IFRjTGl2ZUFwcHNSZXBvcnRpbmdTZXJ2aWNlKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBzYW5kYm94SWQgLSB0aGlzIGNvbWVzIGZyb20gY2xhaW1zIHJlc29sdmVyXG4gICAqL1xuICBASW5wdXQoKSBzYW5kYm94SWQ6IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIGxpc3Qgb2YgTEEgQXBwbGljYXRpb24gSURzIHlvdSB3YW50IHRvIGhhbmRsZVxuICAgKi9cbiAgQElucHV0KCkgYXBwSWRzOiBzdHJpbmdbXTtcblxuICAvKipcbiAgICogV2hldGhlciB0byBzaG93IHRoZSBoZWFkZXIgYmFyIGluIHRoZSB3aWRnZXQgLSBlZy4gZmF2b3JpdGVzIG9uIGhvbWUgcGFnZSAoY29udGFpbnMgaWNvbiBldGMpIC0gaWYgb2ZmIGljb25zIHN0aWxsIGFwcGVhciB3aXRob3V0IGJhclxuICAgKi9cbiAgQElucHV0KCkgc2hvd0hlYWRlcjogYm9vbGVhbjtcblxuICAvKipcbiAgICogVGhlIEFwcGxpY2F0aW9uIElEIG9mIHRoZSBVSSAoc2hvdWxkIGlkZWFsbHkgYmUgdW5pcXVlIGFzIGl0IGlzIHNoYXJlZCBzdGF0ZSBrZXkpXG4gICAqL1xuICBASW5wdXQoKSB1aUFwcElkOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIE1heGltdW0gcm93cyB0byBzaG93IGluIGxlZ2VuZCBiZWZvcmUgaXQgaXMgaGlkZGVuIChvdGhlcndpc2Ugd291bGQgdGFrZSB3aG9sZSB3aWRnZXQpXG4gICAqL1xuICBASW5wdXQoKSBtYXhMZWdlbmRJdGVtczogbnVtYmVyID0gdGhpcy5tYXhMZWdlbmRJdGVtcyA/IHRoaXMubWF4TGVnZW5kSXRlbXMgOiA4O1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIHNob3cgcGVyY2VudGFnZXMgb3IgcmF3IGNhc2UgbnVtYmVycyBvbiB0aGUgZG91Z2hudXQgY2hhcnRcbiAgICovXG4gIEBJbnB1dCgpIHNob3dQZXJjZW50YWdlcyA9IHRoaXMuc2hvd1BlcmNlbnRhZ2VzID8gdGhpcy5zaG93UGVyY2VudGFnZXMgOiBmYWxzZTtcblxuXG4gIC8qKlxuICAgKiB+ZXZlbnQgc2VsZWN0ZWRDYXNlVHlwZSA6IENhc2UgVHlwZSBzZWxlY3RlZCBpbiB2aXp1YWxpemF0aW9uXG4gICAqIH5wYXlsb2FkIENhc2VUeXBlUmVwb3J0UmVjb3JkIDogQ2FzZVR5cGVSZXBvcnRSZWNvcmQgb2JqZWN0IHNlbGVjdGVkIGZyb20gY29tcG9uZW50XG4gICAqL1xuICBAT3V0cHV0KCkgc2VsZWN0ZWRDYXNlVHlwZTogRXZlbnRFbWl0dGVyPENhc2VUeXBlUmVwb3J0UmVjb3JkPiA9IG5ldyBFdmVudEVtaXR0ZXI8Q2FzZVR5cGVSZXBvcnRSZWNvcmQ+KCk7XG5cbiAgQFZpZXdDaGlsZChCYXNlQ2hhcnREaXJlY3RpdmUsIHtzdGF0aWM6IGZhbHNlfSkgY2FzZVJlcG9ydENoYXJ0OiBCYXNlQ2hhcnREaXJlY3RpdmU7XG5cbiAgcHVibGljIGVycm9yTWVzc2FnZTogc3RyaW5nO1xuICBwdWJsaWMgY2FzZVR5cGVzUmVwb3J0OiBDYXNlVHlwZXNSZXBvcnQ7XG4gIHB1YmxpYyB0b3RhbEFjdGl2ZUNhc2VDb3VudDogbnVtYmVyO1xuICBwdWJsaWMgdG90YWxUZXJtaW5hdGVkQ2FzZUNvdW50OiBudW1iZXI7XG4gIHB1YmxpYyByZW5kZXJDaGFydCA9IGZhbHNlO1xuXG4gIHB1YmxpYyBkb3VnaG51dENoYXJ0TGFiZWxzOiBMYWJlbFtdO1xuICBwdWJsaWMgZG91Z2hudXRDaGFydERhdGE6IFNpbmdsZURhdGFTZXQgPSBbXTtcbiAgcHVibGljIGRvdWdobnV0Q2hhcnRUeXBlOiBDaGFydFR5cGUgPSAnZG91Z2hudXQnO1xuICBwdWJsaWMgY2hhcnRDb2xvcnM6IGFueVtdID0gW107XG4gIHB1YmxpYyBkZWZhdWx0Q29sb3JzOiBzdHJpbmdbXSA9IERFRkFVTFRfQ09MT1JTLnNsaWNlKCkucmV2ZXJzZSgpO1xuXG4gIHB1YmxpYyBsZWdlbmREYXRhOiBhbnk7XG5cbiAgcHJpdmF0ZSBnZXRDYXNlQ291bnQgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMudG90YWxBY3RpdmVDYXNlQ291bnQ7XG4gIH1cblxuICBwdWJsaWMgZG91Z2hudXRDaGFydE9wdGlvbnM6IGFueSA9IHtcbiAgICByZXNwb25zaXZlOiB0cnVlLFxuICAgIG1haW50YWluQXNwZWN0UmF0aW86IGZhbHNlLFxuICAgIGxlZ2VuZDoge1xuICAgICAgZGlzcGxheTogZmFsc2UsXG4gICAgICBwb3NpdGlvbjogJ2xlZnQnXG4gICAgfSxcbiAgICBsYXlvdXQ6IHtcbiAgICAgIHBhZGRpbmc6IHtcbiAgICAgICAgbGVmdDogMCxcbiAgICAgICAgcmlnaHQ6IDAsXG4gICAgICAgIHRvcDogMTAsXG4gICAgICAgIGJvdHRvbTogMTBcbiAgICAgIH1cbiAgICB9LFxuICAgIHBsdWdpbnM6IHtcbiAgICAgIGRvdWdobnV0bGFiZWw6IHtcbiAgICAgICAgbGFiZWxzOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgdGV4dDogdGhpcy5nZXRDYXNlQ291bnQsXG4gICAgICAgICAgICBmb250OiB7XG4gICAgICAgICAgICAgIHNpemU6ICcyMCcsXG4gICAgICAgICAgICAgIGZhbWlseTogJ1NvdXJjZSBTYW5zIFBybycsXG4gICAgICAgICAgICAgIHdlaWdodDogJ2JvbGQnXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY29sb3I6ICcjYjZiNmI2J1xuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgdGV4dDogJ2Nhc2VzJyxcbiAgICAgICAgICAgIGZvbnQ6IHtcbiAgICAgICAgICAgICAgc2l6ZTogJzE2JyxcbiAgICAgICAgICAgICAgZmFtaWx5OiAnU291cmNlIFNhbnMgUHJvJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjb2xvcjogJyNiNmI2YjYnXG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9LFxuICAgICAgZGF0YWxhYmVsczoge1xuICAgICAgICBhbmNob3I6ICdlbmQnLFxuICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGZ1bmN0aW9uKGNvbnRleHQpIHtcbiAgICAgICAgICByZXR1cm4gY29udGV4dC5kYXRhc2V0LmJhY2tncm91bmRDb2xvcjtcbiAgICAgICAgfSxcbiAgICAgICAgYm9yZGVyQ29sb3I6ICd3aGl0ZScsXG4gICAgICAgIGJvcmRlclJhZGl1czogMjUsXG4gICAgICAgIGJvcmRlcldpZHRoOiAyLFxuICAgICAgICBjb2xvcjogJ3doaXRlJyxcbiAgICAgICAgZGlzcGxheTogZnVuY3Rpb24oY29udGV4dCkge1xuICAgICAgICAgIGNvbnN0IGRhdGFzZXQgPSBjb250ZXh0LmRhdGFzZXQ7XG4gICAgICAgICAgY29uc3QgdmFsdWUgPSBkYXRhc2V0LmRhdGFbY29udGV4dC5kYXRhSW5kZXhdO1xuICAgICAgICAgIHJldHVybiB2YWx1ZSA+IDA7XG4gICAgICAgIH0sXG4gICAgICAgIGZvbnQ6IHtcbiAgICAgICAgICB3ZWlnaHQ6ICdib2xkJ1xuICAgICAgICB9LFxuICAgICAgICBmb3JtYXR0ZXI6ICh2YWx1ZSwgY3R4KSA9PiB7XG5cbiAgICAgICAgICBjb25zdCBkYXRhc2V0cyA9IGN0eC5jaGFydC5kYXRhLmRhdGFzZXRzO1xuXG4gICAgICAgICAgaWYgKGRhdGFzZXRzLmluZGV4T2YoY3R4LmRhdGFzZXQpID09PSBkYXRhc2V0cy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5zaG93UGVyY2VudGFnZXMpIHtcbiAgICAgICAgICAgICAgY29uc3Qgc3VtID0gZGF0YXNldHNbMF0uZGF0YS5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTtcbiAgICAgICAgICAgICAgY29uc3QgcGVyY2VudGFnZSA9IE1hdGgucm91bmQoKHZhbHVlIC8gc3VtKSAqIDEwMCkgKyAnJSc7XG4gICAgICAgICAgICAgIHJldHVybiBwZXJjZW50YWdlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBpbml0UmVwb3J0RGF0YVRvQ2hhcnQgPSAocmVwb3J0RGF0YTogQ2FzZVR5cGVzUmVwb3J0KSA9PiB7XG4gICAgdGhpcy5kb3VnaG51dENoYXJ0RGF0YSA9IFtdO1xuICAgIHRoaXMudG90YWxBY3RpdmVDYXNlQ291bnQgPSAwO1xuICAgIGNvbnN0IGFjdGl2ZUNhc2VzQXJyYXk6IGFueVtdID0gW107XG4gICAgY29uc3QgbGFiZWxzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IGNvbG9yQXJyYXk6IHN0cmluZ1tdID0gW107XG4gICAgLy8gcmVtb3ZlIGFueSB0YWtlbiBjb2xvcnMgZnJvbSB0aGUgZGVmYXVsdENvbG9yc1xuICAgIC8vIHdlIGhhdmUgdG8gZG8gdGhpcyBiZWZvcmUgcGFyc2luZyB0aGUgcmVjb3JkIHRvIGF2b2lkIGdldHRpbmcgc2FtZSBjb2xvcnNcbiAgICByZXBvcnREYXRhLmNhc2VUeXBlcy5mb3JFYWNoKGN0ID0+IHtcbiAgICAgIC8vIHJlbW92ZSBjb2xvciBmcm9tIGRlZmF1bHRzXG4gICAgICBpZiAoY3QuY2FzZVR5cGVJbmZvLmNvbG9yKSB7XG4gICAgICAgIHRoaXMuZGVmYXVsdENvbG9ycyA9IHRoaXMuZGVmYXVsdENvbG9ycy5maWx0ZXIoaXRlbSA9PiBpdGVtICE9PSBjdC5jYXNlVHlwZUluZm8uY29sb3IpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIC8vIHBhcnNlIHJlY29yZFxuICAgIHJlcG9ydERhdGEuY2FzZVR5cGVzLmZvckVhY2goY2FzZVR5cGUgPT4ge1xuICAgICAgYWN0aXZlQ2FzZXNBcnJheS5wdXNoKGNhc2VUeXBlLmFjdGl2ZVN0YXRlQ2FzZUNvdW50KTtcbiAgICAgIHRoaXMudG90YWxBY3RpdmVDYXNlQ291bnQgPSB0aGlzLnRvdGFsQWN0aXZlQ2FzZUNvdW50ICsgY2FzZVR5cGUuYWN0aXZlU3RhdGVDYXNlQ291bnQ7XG4gICAgICB0aGlzLnRvdGFsVGVybWluYXRlZENhc2VDb3VudCA9IHRoaXMudG90YWxUZXJtaW5hdGVkQ2FzZUNvdW50ICsgY2FzZVR5cGUudGVybWluYWxTdGF0ZUNhc2VDb3VudDtcbiAgICAgIGxhYmVscy5wdXNoKGNhc2VUeXBlLmNhc2VUeXBlSW5mby5sYWJlbCk7XG4gICAgICAvLyB3ZSB3aWxsIHJlLWNvbG9yIGFueXRoaW5nIHRoYXQgaGFzIHRoZSBkZWZhdWx0IGNvbG9yXG4gICAgICBsZXQgY29sOiBzdHJpbmc7XG4gICAgICBpZiAoY2FzZVR5cGUuY2FzZVR5cGVJbmZvLmNvbG9yICYmIGNhc2VUeXBlLmNhc2VUeXBlSW5mby5jb2xvciAhPT0gREVGQVVMVF9UWVBFX0NPTE9SKSB7XG4gICAgICAgIC8vIHVzZSB0aGUgc2V0IGNvbG9yXG4gICAgICAgIGNvbCA9IGNhc2VUeXBlLmNhc2VUeXBlSW5mby5jb2xvcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHRyeSBhbmQgZ2V0IGEgY29sb3IgZnJvbSB0aGUgcGFsZXR0ZVxuICAgICAgICBjb25zdCBwYWxDb2wgPSB0aGlzLmRlZmF1bHRDb2xvcnMucG9wKCk7XG4gICAgICAgIGlmIChwYWxDb2wpIHtcbiAgICAgICAgICBjb2wgPSBwYWxDb2w7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gaWYgbm8gbW9yZSBpbiBwYWxldHRlIHVzZSBhIHJhbmRvbSBjb2xvciFcbiAgICAgICAgICBjb25zdCBpID0gTWF0aC5yYW5kb20oKSAqIDB4ZmZmZmZmO1xuICAgICAgICAgIGNvbnN0IHAgPSBwYXJzZUludChpLnRvU3RyaW5nKCksIDApO1xuICAgICAgICAgIGNvbCA9ICcjJyArIHAudG9TdHJpbmcoMTYpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb2xvckFycmF5LnB1c2goY29sKTtcbiAgICB9KTtcbiAgICAvLyBzaG93aW5nIG1vcmUgdGhhbiA4IGluIHRoZSBsZWdlbmQgd2lsbCB0YWtlIHVwIHRvbyBtdWNoIHNwYWNlXG4gICAgdGhpcy5kb3VnaG51dENoYXJ0T3B0aW9ucy5sZWdlbmQuZGlzcGxheSA9IGxhYmVscy5sZW5ndGggPD0gODtcbiAgICB0aGlzLmRvdWdobnV0Q2hhcnREYXRhID0gYWN0aXZlQ2FzZXNBcnJheTtcbiAgICB0aGlzLmRvdWdobnV0Q2hhcnRMYWJlbHMgPSBsYWJlbHM7XG4gICAgdGhpcy5jaGFydENvbG9ycy5wdXNoKCB7IGJhY2tncm91bmRDb2xvcjogY29sb3JBcnJheX0pO1xuICAgIHRoaXMucmVuZGVyQ2hhcnQgPSB0cnVlO1xuICB9XG5cbiAgcHVibGljIHJlZnJlc2ggPSAoKSA9PiB7XG4gICAgdGhpcy5yZXBvcnRpbmdTZXJ2aWNlLmdldENhc2VUeXBlc1JlcG9ydCh0aGlzLnNhbmRib3hJZCwgdGhpcy5hcHBJZHMsIHRoaXMudWlBcHBJZCkucGlwZShcbiAgICAgIHRha2UoMSksXG4gICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveWVkJCksXG4gICAgICBtYXAocmVwb3J0ID0+IHtcbiAgICAgICAgdGhpcy5jYXNlVHlwZXNSZXBvcnQgPSByZXBvcnQ7XG4gICAgICAgIHRoaXMuaW5pdFJlcG9ydERhdGFUb0NoYXJ0KHJlcG9ydCk7XG4gICAgICAgIHJldHVybiByZXBvcnQ7XG4gICAgICB9KSlcbiAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgIG51bGwsIGVycm9yID0+IHsgdGhpcy5lcnJvck1lc3NhZ2UgPSAnRXJyb3IgcmV0cmlldmluZyBjYXNlIHR5cGVzIHJlcG9ydDogJyArIGVycm9yLmVycm9yLmVycm9yTXNnOyB9XG4gICAgICApO1xuICB9XG5cbiAgLy8gZXZlbnRzXG4gIHB1YmxpYyBjaGFydENsaWNrZWQoeyBldmVudCwgYWN0aXZlIH06IHsgZXZlbnQ6IE1vdXNlRXZlbnQsIGFjdGl2ZTogYW55IH0pOiB2b2lkIHtcbiAgICBpZiAoYWN0aXZlLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGNoYXJ0ID0gYWN0aXZlWzBdLl9jaGFydDtcbiAgICAgIGNvbnN0IGFjdGl2ZVBvaW50czogYW55ID0gY2hhcnQuZ2V0RWxlbWVudEF0RXZlbnQoZXZlbnQpO1xuICAgICAgaWYgKCBhY3RpdmVQb2ludHMubGVuZ3RoID4gMCkge1xuICAgICAgICAvLyBnZXQgdGhlIGludGVybmFsIGluZGV4IG9mIHNsaWNlIGluIHBpZSBjaGFydFxuICAgICAgICBjb25zdCBjbGlja2VkRWxlbWVudEluZGV4ID0gYWN0aXZlUG9pbnRzWzBdLl9pbmRleDtcbiAgICAgICAgY29uc3QgbGFiZWwgPSBjaGFydC5kYXRhLmxhYmVsc1tjbGlja2VkRWxlbWVudEluZGV4XTtcbiAgICAgICAgLy8gZ2V0IHZhbHVlIGJ5IGluZGV4XG4gICAgICAgIGNvbnN0IHZhbHVlID0gY2hhcnQuZGF0YS5kYXRhc2V0c1swXS5kYXRhW2NsaWNrZWRFbGVtZW50SW5kZXhdO1xuICAgICAgICB0aGlzLmNhc2VUeXBlc1JlcG9ydC5jYXNlVHlwZXNbY2xpY2tlZEVsZW1lbnRJbmRleF0uaW5jVGVybWluYWwgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5zZWxlY3RlZENhc2VUeXBlLmVtaXQodGhpcy5jYXNlVHlwZXNSZXBvcnQuY2FzZVR5cGVzW2NsaWNrZWRFbGVtZW50SW5kZXhdKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY2hhcnRIb3ZlcmVkKHsgZXZlbnQsIGFjdGl2ZSB9OiB7IGV2ZW50OiBNb3VzZUV2ZW50LCBhY3RpdmU6IHt9W10gfSk6IHZvaWQge1xuICAgIC8vIGNvbnNvbGUubG9nKGV2ZW50LCBhY3RpdmUpO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5yZWZyZXNoKCk7XG4gIH1cblxufVxuIl19