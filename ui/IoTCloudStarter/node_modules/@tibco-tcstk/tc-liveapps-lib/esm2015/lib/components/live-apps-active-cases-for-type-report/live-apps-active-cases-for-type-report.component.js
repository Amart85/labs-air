/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { LiveAppsComponent } from '../live-apps-component/live-apps-component.component';
import { TcLiveAppsReportingService } from '../../services/tc-live-apps-reporting.service';
import { map, take, takeUntil } from 'rxjs/operators';
import 'chartjs-plugin-datalabels';
import { DEFAULT_COLORS, DEFAULT_TYPE_COLOR } from '../../services/tc-case-card-config.service';
/**
 * Home page active cases widget sub component
 *
 * \@example <tcla-live-apps-active-cases-for-type-report></tcla-live-apps-active-cases-for-type-report>
 */
export class LiveAppsActiveCasesForTypeReportComponent extends LiveAppsComponent {
    /**
     * @param {?} reportingService
     */
    constructor(reportingService) {
        super();
        this.reportingService = reportingService;
        /**
         * Maximum rows to show in legend before it is hidden (otherwise would take whole widget)
         */
        this.maxLegendItems = this.maxLegendItems ? this.maxLegendItems : 8;
        /**
         * Whether to show percentages or raw case numbers on the doughnut chart
         */
        this.showPercentages = this.showPercentages ? this.showPercentages : false;
        /**
         * ~event selectedCaseTypeState : Case Type state selected in vizualization
         * ~payload CaseTypeStateReportStateInfo : CaseTypeStateReportStateInfo object selected from component (to drive caller to display something different (drill down))
         */
        this.selectedCaseTypeState = new EventEmitter();
        this.renderChart = false;
        this.doughnutChartData = [];
        this.doughnutChartType = 'doughnut';
        this.chartColors = [];
        this.defaultColors = DEFAULT_COLORS.slice().reverse();
        this.getCaseCount = (/**
         * @return {?}
         */
        () => {
            return this.totalActiveCaseCount;
        });
        this.doughnutChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
                position: 'left'
            },
            layout: {
                padding: {
                    left: 0,
                    right: 0,
                    top: 10,
                    bottom: 10
                }
            },
            plugins: {
                doughnutlabel: {
                    labels: [
                        {
                            text: this.getCaseCount,
                            font: {
                                size: '20',
                                family: 'Source Sans Pro',
                                weight: 'bold'
                            },
                            color: '#FF7800'
                        },
                        {
                            text: 'cases',
                            font: {
                                size: '16',
                                family: 'Source Sans Pro',
                            },
                            color: '#FF7800'
                        }
                    ]
                },
                datalabels: {
                    anchor: 'end',
                    backgroundColor: (/**
                     * @param {?} context
                     * @return {?}
                     */
                    function (context) {
                        return context.dataset.backgroundColor;
                    }),
                    borderColor: 'white',
                    borderRadius: 25,
                    borderWidth: 2,
                    color: 'white',
                    display: (/**
                     * @param {?} context
                     * @return {?}
                     */
                    function (context) {
                        /** @type {?} */
                        const dataset = context.dataset;
                        /** @type {?} */
                        const value = dataset.data[context.dataIndex];
                        return value > 0;
                    }),
                    font: {
                        weight: 'bold'
                    },
                    formatter: (/**
                     * @param {?} value
                     * @param {?} ctx
                     * @return {?}
                     */
                    (value, ctx) => {
                        /** @type {?} */
                        const datasets = ctx.chart.data.datasets;
                        if (datasets.indexOf(ctx.dataset) === datasets.length - 1) {
                            if (this.showPercentages) {
                                /** @type {?} */
                                const sum = datasets[0].data.reduce((/**
                                 * @param {?} a
                                 * @param {?} b
                                 * @return {?}
                                 */
                                (a, b) => a + b), 0);
                                /** @type {?} */
                                const percentage = Math.round((value / sum) * 100) + '%';
                                return percentage;
                            }
                            else {
                                return value;
                            }
                        }
                        else {
                            return 0;
                        }
                    })
                }
            }
        };
        this.initReportDataToChart = (/**
         * @param {?} reportData
         * @param {?} status
         * @return {?}
         */
        (reportData, status) => {
            this.doughnutChartData = [];
            this.totalActiveCaseCount = 0;
            /** @type {?} */
            const casesByStateArray = [];
            /** @type {?} */
            const labels = [];
            /** @type {?} */
            const colorArray = [];
            // remove any taken colors from the defaultColors
            // we have to do this before parsing the record to avoid getting same colors
            reportData.caseStates.forEach((/**
             * @param {?} cs
             * @return {?}
             */
            cs => {
                // remove color from defaults
                if (cs.stateInfo.color) {
                    this.defaultColors = this.defaultColors.filter((/**
                     * @param {?} item
                     * @return {?}
                     */
                    item => item !== cs.stateInfo.color));
                }
            }));
            // parse record
            reportData.caseStates.forEach((/**
             * @param {?} caseState
             * @return {?}
             */
            caseState => {
                this.totalActiveCaseCount = this.totalActiveCaseCount + caseState.caseCount;
                casesByStateArray.push(caseState.caseCount);
                labels.push(caseState.stateInfo.label);
                // we will re-color anything that has the default color
                /** @type {?} */
                let col;
                if (caseState.stateInfo.color && caseState.stateInfo.color !== DEFAULT_TYPE_COLOR) {
                    // use the set color
                    col = caseState.stateInfo.color;
                }
                else {
                    // try and get a color from the palette
                    /** @type {?} */
                    const palCol = this.defaultColors.pop();
                    if (palCol) {
                        col = palCol;
                    }
                    else {
                        // if no more in palette use a random color!
                        /** @type {?} */
                        const i = Math.random() * 0xffffff;
                        /** @type {?} */
                        const p = parseInt(i.toString(), 0);
                        col = '#' + p.toString(16);
                    }
                }
                colorArray.push(col);
            }));
            this.doughnutChartData.push(casesByStateArray);
            this.doughnutChartLabels = labels;
            this.chartColors.push({ backgroundColor: colorArray });
            // showing more than 8 in the legend will take up too much space
            this.doughnutChartOptions.legend.display = labels.length <= 8;
            this.renderChart = true;
        });
        this.refresh = (/**
         * @return {?}
         */
        () => {
            this.reportingService.getCaseTypeStateReport(this.sandboxId, this.appId, this.typeId, false, this.uiAppId).pipe(take(1), takeUntil(this._destroyed$), map((/**
             * @param {?} report
             * @return {?}
             */
            report => {
                this.caseTypeStateReport = report;
                this.initReportDataToChart(report, status);
                return report;
            })))
                .subscribe(null, (/**
             * @param {?} error
             * @return {?}
             */
            error => { this.errorMessage = 'Error retrieving case types report: ' + error.error.errorMsg; }));
        });
    }
    // events
    /**
     * @param {?} __0
     * @return {?}
     */
    chartClicked({ event, active }) {
        if (active.length > 0) {
            /** @type {?} */
            const chart = active[0]._chart;
            /** @type {?} */
            const activePoints = chart.getElementAtEvent(event);
            if (activePoints.length > 0) {
                // get the internal index of slice in pie chart
                /** @type {?} */
                const clickedElementIndex = activePoints[0]._index;
                /** @type {?} */
                const label = chart.data.labels[clickedElementIndex];
                // get value by index
                /** @type {?} */
                const value = chart.data.datasets[0].data[clickedElementIndex];
                console.log(clickedElementIndex, label, value);
                this.selectedCaseTypeState.emit(this.caseTypeStateReport.caseStates[clickedElementIndex].stateInfo);
            }
        }
    }
    /**
     * @param {?} __0
     * @return {?}
     */
    chartHovered({ event, active }) {
        // console.log(event, active);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (changes.appId && (changes.firstChange || (changes.appId.currentValue !== changes.appId.previousValue))) {
            this.refresh();
        }
    }
}
LiveAppsActiveCasesForTypeReportComponent.decorators = [
    { type: Component, args: [{
                selector: 'tcla-live-apps-active-cases-for-type-report',
                template: "<div fxLayout=\"column\" fxFlex style=\"overflow: auto\">\n  <div *ngIf=\"renderChart\" style=\"height:100%; width:100%; padding: 20px\" class=\"relative\">\n    <canvas #caseReportChart baseChart\n            [data]=\"doughnutChartData\"\n            [labels]=\"doughnutChartLabels\"\n            [chartType]=\"doughnutChartType\"\n            [options]=\"doughnutChartOptions\"\n            [colors]=\"chartColors\"\n            (chartHover)=\"chartHovered($event)\"\n            (chartClick)=\"chartClicked($event)\"\n    >\n    </canvas>\n  </div>\n</div>\n",
                styles: [""]
            }] }
];
/** @nocollapse */
LiveAppsActiveCasesForTypeReportComponent.ctorParameters = () => [
    { type: TcLiveAppsReportingService }
];
LiveAppsActiveCasesForTypeReportComponent.propDecorators = {
    sandboxId: [{ type: Input }],
    appId: [{ type: Input }],
    typeId: [{ type: Input }],
    uiAppId: [{ type: Input }],
    maxLegendItems: [{ type: Input }],
    showPercentages: [{ type: Input }],
    selectedCaseTypeState: [{ type: Output }]
};
if (false) {
    /**
     * sandboxId - this comes from claims resolver
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.sandboxId;
    /**
     * The LA Application Id
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.appId;
    /**
     * The LA Application Type Id (generally 1)
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.typeId;
    /**
     * The Application ID of the UI (should ideally be unique as it is shared state key)
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.uiAppId;
    /**
     * Maximum rows to show in legend before it is hidden (otherwise would take whole widget)
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.maxLegendItems;
    /**
     * Whether to show percentages or raw case numbers on the doughnut chart
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.showPercentages;
    /**
     * ~event selectedCaseTypeState : Case Type state selected in vizualization
     * ~payload CaseTypeStateReportStateInfo : CaseTypeStateReportStateInfo object selected from component (to drive caller to display something different (drill down))
     * @type {?}
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.selectedCaseTypeState;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.errorMessage;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.caseTypeStateReport;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.renderChart;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.doughnutChartLabels;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.doughnutChartData;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.doughnutChartType;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.chartColors;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.defaultColors;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.legendData;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.totalActiveCaseCount;
    /**
     * @type {?}
     * @private
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.getCaseCount;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.doughnutChartOptions;
    /**
     * @type {?}
     * @private
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.initReportDataToChart;
    /** @type {?} */
    LiveAppsActiveCasesForTypeReportComponent.prototype.refresh;
    /**
     * @type {?}
     * @private
     */
    LiveAppsActiveCasesForTypeReportComponent.prototype.reportingService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS1hcHBzLWFjdGl2ZS1jYXNlcy1mb3ItdHlwZS1yZXBvcnQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRpYmNvLXRjc3RrL3RjLWxpdmVhcHBzLWxpYi8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2xpdmUtYXBwcy1hY3RpdmUtY2FzZXMtZm9yLXR5cGUtcmVwb3J0L2xpdmUtYXBwcy1hY3RpdmUtY2FzZXMtZm9yLXR5cGUtcmVwb3J0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFxQixNQUFNLEVBQTJCLE1BQU0sZUFBZSxDQUFDO0FBR2xILE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLHNEQUFzRCxDQUFDO0FBQ3ZGLE9BQU8sRUFBQywwQkFBMEIsRUFBQyxNQUFNLCtDQUErQyxDQUFDO0FBRXpGLE9BQU8sRUFBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3BELE9BQU8sMkJBQTJCLENBQUM7QUFDbkMsT0FBTyxFQUFDLGNBQWMsRUFBRSxrQkFBa0IsRUFBQyxNQUFNLDRDQUE0QyxDQUFDOzs7Ozs7QUFhOUYsTUFBTSxPQUFPLHlDQUEwQyxTQUFRLGlCQUFpQjs7OztJQXFJOUUsWUFBb0IsZ0JBQTRDO1FBQzlELEtBQUssRUFBRSxDQUFDO1FBRFUscUJBQWdCLEdBQWhCLGdCQUFnQixDQUE0Qjs7OztRQTFHdkQsbUJBQWMsR0FBVyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Ozs7UUFLdkUsb0JBQWUsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7Ozs7O1FBTXJFLDBCQUFxQixHQUErQyxJQUFJLFlB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dmVudEVtaXR0ZXIsIElucHV0LCBPbkNoYW5nZXMsIE9uSW5pdCwgT3V0cHV0LCBTaW1wbGVDaGFuZ2VzLCBWaWV3Q2hpbGR9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtDaGFydFR5cGV9IGZyb20gJ2NoYXJ0LmpzJztcbmltcG9ydCB7TGFiZWwsIE11bHRpRGF0YVNldH0gZnJvbSAnbmcyLWNoYXJ0cyc7XG5pbXBvcnQge0xpdmVBcHBzQ29tcG9uZW50fSBmcm9tICcuLi9saXZlLWFwcHMtY29tcG9uZW50L2xpdmUtYXBwcy1jb21wb25lbnQuY29tcG9uZW50JztcbmltcG9ydCB7VGNMaXZlQXBwc1JlcG9ydGluZ1NlcnZpY2V9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3RjLWxpdmUtYXBwcy1yZXBvcnRpbmcuc2VydmljZSc7XG5pbXBvcnQge0Nhc2VUeXBlU3RhdGVSZXBvcnQsIENhc2VUeXBlU3RhdGVSZXBvcnRTdGF0ZUluZm99IGZyb20gJy4uLy4uL21vZGVscy90Yy1saXZlLWFwcHMtcmVwb3J0aW5nJztcbmltcG9ydCB7bWFwLCB0YWtlLCB0YWtlVW50aWx9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCAnY2hhcnRqcy1wbHVnaW4tZGF0YWxhYmVscyc7XG5pbXBvcnQge0RFRkFVTFRfQ09MT1JTLCBERUZBVUxUX1RZUEVfQ09MT1J9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3RjLWNhc2UtY2FyZC1jb25maWcuc2VydmljZSc7XG5cblxuLyoqXG4gKiBIb21lIHBhZ2UgYWN0aXZlIGNhc2VzIHdpZGdldCBzdWIgY29tcG9uZW50XG4gKlxuICpAZXhhbXBsZSA8dGNsYS1saXZlLWFwcHMtYWN0aXZlLWNhc2VzLWZvci10eXBlLXJlcG9ydD48L3RjbGEtbGl2ZS1hcHBzLWFjdGl2ZS1jYXNlcy1mb3ItdHlwZS1yZXBvcnQ+XG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3RjbGEtbGl2ZS1hcHBzLWFjdGl2ZS1jYXNlcy1mb3ItdHlwZS1yZXBvcnQnLFxuICB0ZW1wbGF0ZVVybDogJy4vbGl2ZS1hcHBzLWFjdGl2ZS1jYXNlcy1mb3ItdHlwZS1yZXBvcnQuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9saXZlLWFwcHMtYWN0aXZlLWNhc2VzLWZvci10eXBlLXJlcG9ydC5jb21wb25lbnQuY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgTGl2ZUFwcHNBY3RpdmVDYXNlc0ZvclR5cGVSZXBvcnRDb21wb25lbnQgZXh0ZW5kcyBMaXZlQXBwc0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcblxuXG5cbiAgLyoqXG4gICAqIHNhbmRib3hJZCAtIHRoaXMgY29tZXMgZnJvbSBjbGFpbXMgcmVzb2x2ZXJcbiAgICovXG4gIEBJbnB1dCgpIHNhbmRib3hJZDogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgTEEgQXBwbGljYXRpb24gSWRcbiAgICovXG4gIEBJbnB1dCgpIGFwcElkOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBMQSBBcHBsaWNhdGlvbiBUeXBlIElkIChnZW5lcmFsbHkgMSlcbiAgICovXG4gIEBJbnB1dCgpIHR5cGVJZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgQXBwbGljYXRpb24gSUQgb2YgdGhlIFVJIChzaG91bGQgaWRlYWxseSBiZSB1bmlxdWUgYXMgaXQgaXMgc2hhcmVkIHN0YXRlIGtleSlcbiAgICovXG4gIEBJbnB1dCgpIHVpQXBwSWQ6IHN0cmluZztcblxuICAvKipcbiAgICogTWF4aW11bSByb3dzIHRvIHNob3cgaW4gbGVnZW5kIGJlZm9yZSBpdCBpcyBoaWRkZW4gKG90aGVyd2lzZSB3b3VsZCB0YWtlIHdob2xlIHdpZGdldClcbiAgICovXG4gIEBJbnB1dCgpIG1heExlZ2VuZEl0ZW1zOiBudW1iZXIgPSB0aGlzLm1heExlZ2VuZEl0ZW1zID8gdGhpcy5tYXhMZWdlbmRJdGVtcyA6IDg7XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gc2hvdyBwZXJjZW50YWdlcyBvciByYXcgY2FzZSBudW1iZXJzIG9uIHRoZSBkb3VnaG51dCBjaGFydFxuICAgKi9cbiAgQElucHV0KCkgc2hvd1BlcmNlbnRhZ2VzID0gdGhpcy5zaG93UGVyY2VudGFnZXMgPyB0aGlzLnNob3dQZXJjZW50YWdlcyA6IGZhbHNlO1xuXG4gIC8qKlxuICAgKiB+ZXZlbnQgc2VsZWN0ZWRDYXNlVHlwZVN0YXRlIDogQ2FzZSBUeXBlIHN0YXRlIHNlbGVjdGVkIGluIHZpenVhbGl6YXRpb25cbiAgICogfnBheWxvYWQgQ2FzZVR5cGVTdGF0ZVJlcG9ydFN0YXRlSW5mbyA6IENhc2VUeXBlU3RhdGVSZXBvcnRTdGF0ZUluZm8gb2JqZWN0IHNlbGVjdGVkIGZyb20gY29tcG9uZW50ICh0byBkcml2ZSBjYWxsZXIgdG8gZGlzcGxheSBzb21ldGhpbmcgZGlmZmVyZW50IChkcmlsbCBkb3duKSlcbiAgICovXG4gIEBPdXRwdXQoKSBzZWxlY3RlZENhc2VUeXBlU3RhdGU6IEV2ZW50RW1pdHRlcjxDYXNlVHlwZVN0YXRlUmVwb3J0U3RhdGVJbmZvPiA9IG5ldyBFdmVudEVtaXR0ZXI8Q2FzZVR5cGVTdGF0ZVJlcG9ydFN0YXRlSW5mbz4oKTtcblxuICAvLyBAVmlld0NoaWxkKEJhc2VDaGFydERpcmVjdGl2ZSkgY2FzZVR5cGVTdGF0ZVJlcG9ydENoYXJ0OiBCYXNlQ2hhcnREaXJlY3RpdmU7XG5cbiAgcHVibGljIGVycm9yTWVzc2FnZTogc3RyaW5nO1xuICBwdWJsaWMgY2FzZVR5cGVTdGF0ZVJlcG9ydDogQ2FzZVR5cGVTdGF0ZVJlcG9ydDtcbiAgcHVibGljIHJlbmRlckNoYXJ0ID0gZmFsc2U7XG5cbiAgcHVibGljIGRvdWdobnV0Q2hhcnRMYWJlbHM6IExhYmVsW107XG4gIHB1YmxpYyBkb3VnaG51dENoYXJ0RGF0YTogTXVsdGlEYXRhU2V0ID0gW107XG4gIHB1YmxpYyBkb3VnaG51dENoYXJ0VHlwZTogQ2hhcnRUeXBlID0gJ2RvdWdobnV0JztcbiAgcHVibGljIGNoYXJ0Q29sb3JzOiBhbnlbXSA9IFtdO1xuICBwdWJsaWMgZGVmYXVsdENvbG9yczogc3RyaW5nW10gPSBERUZBVUxUX0NPTE9SUy5zbGljZSgpLnJldmVyc2UoKTtcblxuICBwdWJsaWMgbGVnZW5kRGF0YTogYW55O1xuICBwdWJsaWMgdG90YWxBY3RpdmVDYXNlQ291bnQ6IG51bWJlcjtcblxuICBwcml2YXRlIGdldENhc2VDb3VudCA9ICgpID0+IHtcbiAgICByZXR1cm4gdGhpcy50b3RhbEFjdGl2ZUNhc2VDb3VudDtcbiAgfVxuXG4gIHB1YmxpYyBkb3VnaG51dENoYXJ0T3B0aW9uczogYW55ID0ge1xuICAgIHJlc3BvbnNpdmU6IHRydWUsXG4gICAgbWFpbnRhaW5Bc3BlY3RSYXRpbzogZmFsc2UsXG4gICAgbGVnZW5kOiB7XG4gICAgICBwb3NpdGlvbjogJ2xlZnQnXG4gICAgfSxcbiAgICBsYXlvdXQ6IHtcbiAgICAgIHBhZGRpbmc6IHtcbiAgICAgICAgbGVmdDogMCxcbiAgICAgICAgcmlnaHQ6IDAsXG4gICAgICAgIHRvcDogMTAsXG4gICAgICAgIGJvdHRvbTogMTBcbiAgICAgIH1cbiAgICB9LFxuICAgIHBsdWdpbnM6IHtcbiAgICAgIGRvdWdobnV0bGFiZWw6IHtcbiAgICAgICAgbGFiZWxzOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgdGV4dDogdGhpcy5nZXRDYXNlQ291bnQsXG4gICAgICAgICAgICBmb250OiB7XG4gICAgICAgICAgICAgIHNpemU6ICcyMCcsXG4gICAgICAgICAgICAgIGZhbWlseTogJ1NvdXJjZSBTYW5zIFBybycsXG4gICAgICAgICAgICAgIHdlaWdodDogJ2JvbGQnXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY29sb3I6ICcjRkY3ODAwJ1xuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgdGV4dDogJ2Nhc2VzJyxcbiAgICAgICAgICAgIGZvbnQ6IHtcbiAgICAgICAgICAgICAgc2l6ZTogJzE2JyxcbiAgICAgICAgICAgICAgZmFtaWx5OiAnU291cmNlIFNhbnMgUHJvJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjb2xvcjogJyNGRjc4MDAnXG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9LFxuICAgICAgZGF0YWxhYmVsczoge1xuICAgICAgICBhbmNob3I6ICdlbmQnLFxuICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGZ1bmN0aW9uKGNvbnRleHQpIHtcbiAgICAgICAgICByZXR1cm4gY29udGV4dC5kYXRhc2V0LmJhY2tncm91bmRDb2xvcjtcbiAgICAgICAgfSxcbiAgICAgICAgYm9yZGVyQ29sb3I6ICd3aGl0ZScsXG4gICAgICAgIGJvcmRlclJhZGl1czogMjUsXG4gICAgICAgIGJvcmRlcldpZHRoOiAyLFxuICAgICAgICBjb2xvcjogJ3doaXRlJyxcbiAgICAgICAgZGlzcGxheTogZnVuY3Rpb24oY29udGV4dCkge1xuICAgICAgICAgIGNvbnN0IGRhdGFzZXQgPSBjb250ZXh0LmRhdGFzZXQ7XG4gICAgICAgICAgY29uc3QgdmFsdWUgPSBkYXRhc2V0LmRhdGFbY29udGV4dC5kYXRhSW5kZXhdO1xuICAgICAgICAgIHJldHVybiB2YWx1ZSA+IDA7XG4gICAgICAgIH0sXG4gICAgICAgIGZvbnQ6IHtcbiAgICAgICAgICB3ZWlnaHQ6ICdib2xkJ1xuICAgICAgICB9LFxuICAgICAgICBmb3JtYXR0ZXI6ICh2YWx1ZSwgY3R4KSA9PiB7XG5cbiAgICAgICAgICBjb25zdCBkYXRhc2V0cyA9IGN0eC5jaGFydC5kYXRhLmRhdGFzZXRzO1xuXG4gICAgICAgICAgaWYgKGRhdGFzZXRzLmluZGV4T2YoY3R4LmRhdGFzZXQpID09PSBkYXRhc2V0cy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5zaG93UGVyY2VudGFnZXMpIHtcbiAgICAgICAgICAgICAgY29uc3Qgc3VtID0gZGF0YXNldHNbMF0uZGF0YS5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTtcbiAgICAgICAgICAgICAgY29uc3QgcGVyY2VudGFnZSA9IE1hdGgucm91bmQoKHZhbHVlIC8gc3VtKSAqIDEwMCkgKyAnJSc7XG4gICAgICAgICAgICAgIHJldHVybiBwZXJjZW50YWdlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgIH1cbiAgfTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlcG9ydGluZ1NlcnZpY2U6IFRjTGl2ZUFwcHNSZXBvcnRpbmdTZXJ2aWNlKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdFJlcG9ydERhdGFUb0NoYXJ0ID0gKHJlcG9ydERhdGE6IENhc2VUeXBlU3RhdGVSZXBvcnQsIHN0YXR1czogc3RyaW5nKSA9PiB7XG4gICAgdGhpcy5kb3VnaG51dENoYXJ0RGF0YSA9IFtdO1xuICAgIHRoaXMudG90YWxBY3RpdmVDYXNlQ291bnQgPSAwO1xuICAgIGNvbnN0IGNhc2VzQnlTdGF0ZUFycmF5OiBudW1iZXJbXSA9IFtdO1xuICAgIGNvbnN0IGxhYmVsczogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCBjb2xvckFycmF5OiBzdHJpbmdbXSA9IFtdO1xuICAgIC8vIHJlbW92ZSBhbnkgdGFrZW4gY29sb3JzIGZyb20gdGhlIGRlZmF1bHRDb2xvcnNcbiAgICAvLyB3ZSBoYXZlIHRvIGRvIHRoaXMgYmVmb3JlIHBhcnNpbmcgdGhlIHJlY29yZCB0byBhdm9pZCBnZXR0aW5nIHNhbWUgY29sb3JzXG4gICAgcmVwb3J0RGF0YS5jYXNlU3RhdGVzLmZvckVhY2goY3MgPT4ge1xuICAgICAgLy8gcmVtb3ZlIGNvbG9yIGZyb20gZGVmYXVsdHNcbiAgICAgIGlmIChjcy5zdGF0ZUluZm8uY29sb3IpIHtcbiAgICAgICAgdGhpcy5kZWZhdWx0Q29sb3JzID0gdGhpcy5kZWZhdWx0Q29sb3JzLmZpbHRlcihpdGVtID0+IGl0ZW0gIT09IGNzLnN0YXRlSW5mby5jb2xvcik7XG4gICAgICB9XG4gICAgfSk7XG4gICAgLy8gcGFyc2UgcmVjb3JkXG4gICAgcmVwb3J0RGF0YS5jYXNlU3RhdGVzLmZvckVhY2goY2FzZVN0YXRlID0+IHtcbiAgICAgICAgdGhpcy50b3RhbEFjdGl2ZUNhc2VDb3VudCA9IHRoaXMudG90YWxBY3RpdmVDYXNlQ291bnQgKyBjYXNlU3RhdGUuY2FzZUNvdW50O1xuICAgICAgICBjYXNlc0J5U3RhdGVBcnJheS5wdXNoKGNhc2VTdGF0ZS5jYXNlQ291bnQpO1xuICAgICAgICBsYWJlbHMucHVzaChjYXNlU3RhdGUuc3RhdGVJbmZvLmxhYmVsKTtcbiAgICAgIC8vIHdlIHdpbGwgcmUtY29sb3IgYW55dGhpbmcgdGhhdCBoYXMgdGhlIGRlZmF1bHQgY29sb3JcbiAgICAgIGxldCBjb2w6IHN0cmluZztcbiAgICAgIGlmIChjYXNlU3RhdGUuc3RhdGVJbmZvLmNvbG9yICYmIGNhc2VTdGF0ZS5zdGF0ZUluZm8uY29sb3IgIT09IERFRkFVTFRfVFlQRV9DT0xPUikge1xuICAgICAgICAvLyB1c2UgdGhlIHNldCBjb2xvclxuICAgICAgICBjb2wgPSBjYXNlU3RhdGUuc3RhdGVJbmZvLmNvbG9yO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gdHJ5IGFuZCBnZXQgYSBjb2xvciBmcm9tIHRoZSBwYWxldHRlXG4gICAgICAgIGNvbnN0IHBhbENvbCA9IHRoaXMuZGVmYXVsdENvbG9ycy5wb3AoKTtcbiAgICAgICAgaWYgKHBhbENvbCkge1xuICAgICAgICAgIGNvbCA9IHBhbENvbDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBpZiBubyBtb3JlIGluIHBhbGV0dGUgdXNlIGEgcmFuZG9tIGNvbG9yIVxuICAgICAgICAgIGNvbnN0IGkgPSBNYXRoLnJhbmRvbSgpICogMHhmZmZmZmY7XG4gICAgICAgICAgY29uc3QgcCA9IHBhcnNlSW50KGkudG9TdHJpbmcoKSwgMCk7XG4gICAgICAgICAgY29sID0gJyMnICsgcC50b1N0cmluZygxNik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbG9yQXJyYXkucHVzaChjb2wpO1xuICAgIH0pO1xuICAgIHRoaXMuZG91Z2hudXRDaGFydERhdGEucHVzaChjYXNlc0J5U3RhdGVBcnJheSk7XG4gICAgdGhpcy5kb3VnaG51dENoYXJ0TGFiZWxzID0gbGFiZWxzO1xuICAgIHRoaXMuY2hhcnRDb2xvcnMucHVzaCggeyBiYWNrZ3JvdW5kQ29sb3I6IGNvbG9yQXJyYXl9KTtcbiAgICAvLyBzaG93aW5nIG1vcmUgdGhhbiA4IGluIHRoZSBsZWdlbmQgd2lsbCB0YWtlIHVwIHRvbyBtdWNoIHNwYWNlXG4gICAgdGhpcy5kb3VnaG51dENoYXJ0T3B0aW9ucy5sZWdlbmQuZGlzcGxheSA9IGxhYmVscy5sZW5ndGggPD0gODtcbiAgICB0aGlzLnJlbmRlckNoYXJ0ID0gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyByZWZyZXNoID0gKCkgPT4ge1xuICAgIHRoaXMucmVwb3J0aW5nU2VydmljZS5nZXRDYXNlVHlwZVN0YXRlUmVwb3J0KHRoaXMuc2FuZGJveElkLCB0aGlzLmFwcElkLCB0aGlzLnR5cGVJZCwgZmFsc2UsIHRoaXMudWlBcHBJZCkucGlwZShcbiAgICAgIHRha2UoMSksXG4gICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveWVkJCksXG4gICAgICBtYXAocmVwb3J0ID0+IHtcbiAgICAgICAgdGhpcy5jYXNlVHlwZVN0YXRlUmVwb3J0ID0gcmVwb3J0O1xuICAgICAgICB0aGlzLmluaXRSZXBvcnREYXRhVG9DaGFydChyZXBvcnQsIHN0YXR1cyk7XG4gICAgICAgIHJldHVybiByZXBvcnQ7XG4gICAgICB9KSlcbiAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgIG51bGwsIGVycm9yID0+IHsgdGhpcy5lcnJvck1lc3NhZ2UgPSAnRXJyb3IgcmV0cmlldmluZyBjYXNlIHR5cGVzIHJlcG9ydDogJyArIGVycm9yLmVycm9yLmVycm9yTXNnOyB9XG4gICAgICApO1xuICB9XG5cbiAgLy8gZXZlbnRzXG4gIHB1YmxpYyBjaGFydENsaWNrZWQoeyBldmVudCwgYWN0aXZlIH06IHsgZXZlbnQ6IE1vdXNlRXZlbnQsIGFjdGl2ZTogYW55IH0pOiB2b2lkIHtcbiAgICBpZiAoYWN0aXZlLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGNoYXJ0ID0gYWN0aXZlWzBdLl9jaGFydDtcbiAgICAgIGNvbnN0IGFjdGl2ZVBvaW50czogYW55ID0gY2hhcnQuZ2V0RWxlbWVudEF0RXZlbnQoZXZlbnQpO1xuICAgICAgaWYgKCBhY3RpdmVQb2ludHMubGVuZ3RoID4gMCkge1xuICAgICAgICAvLyBnZXQgdGhlIGludGVybmFsIGluZGV4IG9mIHNsaWNlIGluIHBpZSBjaGFydFxuICAgICAgICBjb25zdCBjbGlja2VkRWxlbWVudEluZGV4ID0gYWN0aXZlUG9pbnRzWzBdLl9pbmRleDtcbiAgICAgICAgY29uc3QgbGFiZWwgPSBjaGFydC5kYXRhLmxhYmVsc1tjbGlja2VkRWxlbWVudEluZGV4XTtcbiAgICAgICAgLy8gZ2V0IHZhbHVlIGJ5IGluZGV4XG4gICAgICAgIGNvbnN0IHZhbHVlID0gY2hhcnQuZGF0YS5kYXRhc2V0c1swXS5kYXRhW2NsaWNrZWRFbGVtZW50SW5kZXhdO1xuICAgICAgICBjb25zb2xlLmxvZyhjbGlja2VkRWxlbWVudEluZGV4LCBsYWJlbCwgdmFsdWUpO1xuICAgICAgICB0aGlzLnNlbGVjdGVkQ2FzZVR5cGVTdGF0ZS5lbWl0KHRoaXMuY2FzZVR5cGVTdGF0ZVJlcG9ydC5jYXNlU3RhdGVzW2NsaWNrZWRFbGVtZW50SW5kZXhdLnN0YXRlSW5mbyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNoYXJ0SG92ZXJlZCh7IGV2ZW50LCBhY3RpdmUgfTogeyBldmVudDogTW91c2VFdmVudCwgYWN0aXZlOiB7fVtdIH0pOiB2b2lkIHtcbiAgICAvLyBjb25zb2xlLmxvZyhldmVudCwgYWN0aXZlKTtcbiAgfVxuXG5cbiAgbmdPbkluaXQoKSB7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgaWYgKGNoYW5nZXMuYXBwSWQgJiYgKGNoYW5nZXMuZmlyc3RDaGFuZ2UgfHwgKGNoYW5nZXMuYXBwSWQuY3VycmVudFZhbHVlICE9PSBjaGFuZ2VzLmFwcElkLnByZXZpb3VzVmFsdWUpKSkge1xuICAgICAgdGhpcy5yZWZyZXNoKCk7XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==