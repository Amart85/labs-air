/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// This guard is to check whether the user has appropriate role to access a route based on config settings
import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { LiveAppsService } from '../services/live-apps.service';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { map } from 'rxjs/operators';
import { forkJoin } from 'rxjs';
import { TcCoreCommonFunctions, TcGeneralConfigService, TcSharedStateService } from '@tibco-tcstk/tc-core-lib';
import { Location } from '@angular/common';
import { RouteAccessControlConfig } from '../models/tc-groups-data';
import { RolesResolver } from '../resolvers/roles.resolver';
export class RoleGuard {
    /**
     * @param {?} liveapps
     * @param {?} router
     * @param {?} http
     * @param {?} location
     * @param {?} sharedStateService
     * @param {?} generalConfigService
     */
    constructor(liveapps, router, http, location, sharedStateService, generalConfigService) {
        this.liveapps = liveapps;
        this.router = router;
        this.http = http;
        this.location = location;
        this.sharedStateService = sharedStateService;
        this.generalConfigService = generalConfigService;
        this.DEFAULT_CONFIG_URL = TcCoreCommonFunctions.prepareUrlForStaticResource(this.location, 'assets/config/routeAccessControl.json');
        // can be used to load defaultAppConfig from a JSON config
        this.getRouteAccessControlConfig = (/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const headers = new HttpHeaders().set('cacheResponse', 'true');
            return this.http.get(this.DEFAULT_CONFIG_URL, { headers }).pipe(map((/**
             * @param {?} configContents
             * @return {?}
             */
            configContents => new RouteAccessControlConfig().deserialize(configContents))));
        });
        this.getRouteDef = (/**
         * @param {?} routeAccessConfig
         * @param {?} route
         * @return {?}
         */
        (routeAccessConfig, route) => {
            return routeAccessConfig.routes.find((/**
             * @param {?} routeRec
             * @return {?}
             */
            routeRec => {
                return (routeRec.routeUrl === route.routeConfig.path);
            }));
        });
        this.hasAccess = (/**
         * @param {?} config
         * @param {?} roles
         * @return {?}
         */
        (config, roles) => {
            /** @type {?} */
            const reqRole = roles.roles.find((/**
             * @param {?} role
             * @return {?}
             */
            role => {
                return (role.id === config.requiredRoleId);
            }));
            return reqRole ? true : false;
        });
    }
    /**
     * @param {?} route
     * @param {?} state
     * @return {?}
     */
    canActivate(route, state) {
        // get route config
        /** @type {?} */
        const routeConfig$ = this.getRouteAccessControlConfig();
        // we will need the roles we currently have
        /** @type {?} */
        const currentRolesRes = new RolesResolver(this.sharedStateService, this.generalConfigService, this.http, this.liveapps, this.location);
        /** @type {?} */
        const currentRoles$ = currentRolesRes.resolve();
        // run both in parallel then check access
        /** @type {?} */
        const decision$ = forkJoin(routeConfig$, currentRoles$).pipe(map((/**
         * @param {?} __0
         * @return {?}
         */
        ([routeConfig, currentRoles]) => {
            /** @type {?} */
            const routeConfigRec = this.getRouteDef(routeConfig, route);
            if (this.hasAccess(routeConfigRec, currentRoles)) {
                return true;
            }
            else {
                console.error('You do not have access to this page: ', route);
                this.router.navigate(['/errorHandler/' + 'NO_ROUTE_ACCESS/' + 'Route <' + route.url + '> requires role <' + routeConfigRec.requiredRoleId + '>']);
                return false;
            }
        })));
        return decision$;
    }
}
RoleGuard.decorators = [
    { type: Injectable }
];
/** @nocollapse */
RoleGuard.ctorParameters = () => [
    { type: LiveAppsService },
    { type: Router },
    { type: HttpClient },
    { type: Location },
    { type: TcSharedStateService },
    { type: TcGeneralConfigService }
];
if (false) {
    /** @type {?} */
    RoleGuard.prototype.DEFAULT_CONFIG_URL;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.getRouteAccessControlConfig;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.getRouteDef;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.hasAccess;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.liveapps;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.router;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.http;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.location;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.sharedStateService;
    /**
     * @type {?}
     * @private
     */
    RoleGuard.prototype.generalConfigService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm9sZS5ndWFyZC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0aWJjby10Y3N0ay90Yy1saXZlYXBwcy1saWIvIiwic291cmNlcyI6WyJsaWIvZ3VhcmRzL3JvbGUuZ3VhcmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQSxPQUFPLEVBQVMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ2pELE9BQU8sRUFBQyxNQUFNLEVBQTJELE1BQU0saUJBQWlCLENBQUM7QUFDakcsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLCtCQUErQixDQUFDO0FBQzlELE9BQU8sRUFBQyxVQUFVLEVBQWUsV0FBVyxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDMUUsT0FBTyxFQUFzQixHQUFHLEVBQVcsTUFBTSxnQkFBZ0IsQ0FBQztBQUNsRSxPQUFPLEVBQUMsUUFBUSxFQUE2QixNQUFNLE1BQU0sQ0FBQztBQUUxRCxPQUFPLEVBQStCLHFCQUFxQixFQUFFLHNCQUFzQixFQUFFLG9CQUFvQixFQUFDLE1BQU0sMEJBQTBCLENBQUM7QUFDM0ksT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBUSx3QkFBd0IsRUFBaUIsTUFBTSwwQkFBMEIsQ0FBQztBQUN6RixPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sNkJBQTZCLENBQUM7QUFHMUQsTUFBTSxPQUFPLFNBQVM7Ozs7Ozs7OztJQUlwQixZQUFvQixRQUF5QixFQUFVLE1BQWMsRUFBVSxJQUFnQixFQUFVLFFBQWtCLEVBQVUsa0JBQXdDLEVBQVUsb0JBQTRDO1FBQS9NLGFBQVEsR0FBUixRQUFRLENBQWlCO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUFVLFNBQUksR0FBSixJQUFJLENBQVk7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFzQjtRQUFVLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBd0I7UUFGbk8sdUJBQWtC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Ozs7O0lBRUQsOEJBS0M7Ozs7O0lBdEJXLDZCQUFpQzs7Ozs7SUFBRSwyQkFBc0I7Ozs7O0lBQUUseUJBQXdCOzs7OztJQUFFLDZCQUEwQjs7Ozs7SUFBRSx1Q0FBZ0Q7Ozs7O0lBQUUseUNBQW9EIiwic291cmNlc0NvbnRlbnQiOlsiLy8gVGhpcyBndWFyZCBpcyB0byBjaGVjayB3aGV0aGVyIHRoZSB1c2VyIGhhcyBhcHByb3ByaWF0ZSByb2xlIHRvIGFjY2VzcyBhIHJvdXRlIGJhc2VkIG9uIGNvbmZpZyBzZXR0aW5nc1xuXG5pbXBvcnQge0luamVjdCwgSW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1JvdXRlciwgQ2FuQWN0aXZhdGUsIEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIFJvdXRlclN0YXRlU25hcHNob3R9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQge0xpdmVBcHBzU2VydmljZX0gZnJvbSAnLi4vc2VydmljZXMvbGl2ZS1hcHBzLnNlcnZpY2UnO1xuaW1wb3J0IHtIdHRwQ2xpZW50LCBIdHRwSGFuZGxlciwgSHR0cEhlYWRlcnN9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7Y2F0Y2hFcnJvciwgZmxhdE1hcCwgbWFwLCBtZXJnZU1hcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtmb3JrSm9pbiwgT2JzZXJ2YWJsZSwgb2YsIHRocm93RXJyb3J9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtDbGFpbXNSZXNvbHZlcn0gZnJvbSAnLi4vcmVzb2x2ZXJzL2NsYWltcy5yZXNvbHZlcic7XG5pbXBvcnQge0NsYWltLCBHZW5lcmFsQ29uZmlnUmVzb2x2ZXIsIFRjQ29yZUNvbW1vbkZ1bmN0aW9ucywgVGNHZW5lcmFsQ29uZmlnU2VydmljZSwgVGNTaGFyZWRTdGF0ZVNlcnZpY2V9IGZyb20gJ0B0aWJjby10Y3N0ay90Yy1jb3JlLWxpYic7XG5pbXBvcnQge0xvY2F0aW9ufSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtSb2xlcywgUm91dGVBY2Nlc3NDb250cm9sQ29uZmlnLCBSb3V0ZUFjY2Vzc0RlZn0gZnJvbSAnLi4vbW9kZWxzL3RjLWdyb3Vwcy1kYXRhJztcbmltcG9ydCB7Um9sZXNSZXNvbHZlcn0gZnJvbSAnLi4vcmVzb2x2ZXJzL3JvbGVzLnJlc29sdmVyJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFJvbGVHdWFyZCBpbXBsZW1lbnRzIENhbkFjdGl2YXRlIHtcblxuICBERUZBVUxUX0NPTkZJR19VUkwgPSBUY0NvcmVDb21tb25GdW5jdGlvbnMucHJlcGFyZVVybEZvclN0YXRpY1Jlc291cmNlKHRoaXMubG9jYXRpb24sICdhc3NldHMvY29uZmlnL3JvdXRlQWNjZXNzQ29udHJvbC5qc29uJyk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBsaXZlYXBwczogTGl2ZUFwcHNTZXJ2aWNlLCBwcml2YXRlIHJvdXRlcjogUm91dGVyLCBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsIHByaXZhdGUgbG9jYXRpb246IExvY2F0aW9uLCBwcml2YXRlIHNoYXJlZFN0YXRlU2VydmljZTogVGNTaGFyZWRTdGF0ZVNlcnZpY2UsIHByaXZhdGUgZ2VuZXJhbENvbmZpZ1NlcnZpY2U6IFRjR2VuZXJhbENvbmZpZ1NlcnZpY2UpIHtcbiAgfVxuXG4gIC8vIGNhbiBiZSB1c2VkIHRvIGxvYWQgZGVmYXVsdEFwcENvbmZpZyBmcm9tIGEgSlNPTiBjb25maWdcbiAgcHJpdmF0ZSBnZXRSb3V0ZUFjY2Vzc0NvbnRyb2xDb25maWcgPSAoKTogT2JzZXJ2YWJsZTxSb3V0ZUFjY2Vzc0NvbnRyb2xDb25maWc+ID0+IHtcbiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKCkuc2V0KCdjYWNoZVJlc3BvbnNlJywgJ3RydWUnKTtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh0aGlzLkRFRkFVTFRfQ09ORklHX1VSTCwgeyBoZWFkZXJzIH0pLnBpcGUoXG4gICAgICBtYXAoY29uZmlnQ29udGVudHMgPT4gbmV3IFJvdXRlQWNjZXNzQ29udHJvbENvbmZpZygpLmRlc2VyaWFsaXplKGNvbmZpZ0NvbnRlbnRzKSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSb3V0ZURlZiA9IChyb3V0ZUFjY2Vzc0NvbmZpZzogUm91dGVBY2Nlc3NDb250cm9sQ29uZmlnLCByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IFJvdXRlQWNjZXNzRGVmID0+IHtcbiAgICByZXR1cm4gcm91dGVBY2Nlc3NDb25maWcucm91dGVzLmZpbmQocm91dGVSZWMgPT4ge1xuICAgICAgcmV0dXJuIChyb3V0ZVJlYy5yb3V0ZVVybCA9PT0gcm91dGUucm91dGVDb25maWcucGF0aCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGhhc0FjY2VzcyA9IChjb25maWc6IFJvdXRlQWNjZXNzRGVmLCByb2xlczogUm9sZXMpOiBib29sZWFuID0+IHtcbiAgICBjb25zdCByZXFSb2xlID0gcm9sZXMucm9sZXMuZmluZChyb2xlID0+IHtcbiAgICAgIHJldHVybiAocm9sZS5pZCA9PT0gY29uZmlnLnJlcXVpcmVkUm9sZUlkKTtcbiAgICB9KVxuICAgIHJldHVybiByZXFSb2xlID8gdHJ1ZSA6IGZhbHNlO1xuICB9XG5cbiAgY2FuQWN0aXZhdGUocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIHN0YXRlOiBSb3V0ZXJTdGF0ZVNuYXBzaG90KTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgLy8gZ2V0IHJvdXRlIGNvbmZpZ1xuICAgIGNvbnN0IHJvdXRlQ29uZmlnJCA9IHRoaXMuZ2V0Um91dGVBY2Nlc3NDb250cm9sQ29uZmlnKCk7XG5cbiAgICAvLyB3ZSB3aWxsIG5lZWQgdGhlIHJvbGVzIHdlIGN1cnJlbnRseSBoYXZlXG4gICAgY29uc3QgY3VycmVudFJvbGVzUmVzID0gbmV3IFJvbGVzUmVzb2x2ZXIodGhpcy5zaGFyZWRTdGF0ZVNlcnZpY2UsIHRoaXMuZ2VuZXJhbENvbmZpZ1NlcnZpY2UsIHRoaXMuaHR0cCwgdGhpcy5saXZlYXBwcywgdGhpcy5sb2NhdGlvbilcbiAgICBjb25zdCBjdXJyZW50Um9sZXMkID0gY3VycmVudFJvbGVzUmVzLnJlc29sdmUoKTtcblxuICAgIC8vIHJ1biBib3RoIGluIHBhcmFsbGVsIHRoZW4gY2hlY2sgYWNjZXNzXG4gICAgY29uc3QgZGVjaXNpb24kID0gZm9ya0pvaW4ocm91dGVDb25maWckLCBjdXJyZW50Um9sZXMkKS5waXBlKFxuICAgICAgbWFwKChbcm91dGVDb25maWcsIGN1cnJlbnRSb2xlc10pID0+IHtcbiAgICAgICAgY29uc3Qgcm91dGVDb25maWdSZWMgPSB0aGlzLmdldFJvdXRlRGVmKHJvdXRlQ29uZmlnLCByb3V0ZSk7XG4gICAgICAgIGlmICh0aGlzLmhhc0FjY2Vzcyhyb3V0ZUNvbmZpZ1JlYywgY3VycmVudFJvbGVzKSkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1lvdSBkbyBub3QgaGF2ZSBhY2Nlc3MgdG8gdGhpcyBwYWdlOiAnLCByb3V0ZSk7XG4gICAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWycvZXJyb3JIYW5kbGVyLycgKyAnTk9fUk9VVEVfQUNDRVNTLycgKyAnUm91dGUgPCcgKyByb3V0ZS51cmwgKyAnPiByZXF1aXJlcyByb2xlIDwnICsgcm91dGVDb25maWdSZWMucmVxdWlyZWRSb2xlSWQgKyAnPicgXSk7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9KSk7XG5cbiAgICByZXR1cm4gZGVjaXNpb24kO1xuICB9XG5cbn1cbiJdfQ==