/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { SharedStateContent, SharedStateEntry, SharedStateList, TcCoreCommonFunctions, TcSharedStateService } from '@tibco-tcstk/tc-core-lib';
import { forkJoin, of, throwError } from 'rxjs';
import { CardConfig, CaseInfo, IconMap, UserInfo } from '../models/liveappsdata';
import { LiveAppsService } from './live-apps.service';
import { CaseCardConfig, StateColorMap, StateColorMapRec } from '../models/tc-case-card-config';
import { catchError, map, mergeMap, tap } from 'rxjs/operators';
import { HttpClient } from '@angular/common/http';
import { Location } from '@angular/common';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./live-apps.service";
import * as i3 from "@tibco-tcstk/tc-core-lib";
import * as i4 from "@angular/common";
/** @type {?} */
export const DEFAULT_COLORS = [
    '#3E94C0', '#49B3D3', '#76C6CF', '#A9DACD', '#DCECC9',
    '#FFAB40', '#FFD180', '#FFE0B2', '#FFF3E0', '#81D4FA',
    '#B3E5FC', '#8AF2F2', '#91A3AE', '#CED8DD', '#EBEFF1',
    '#6A1B9A', '#AD1457', '#EC407A', '#C4469E', '#BA68C8',
    '#8C9EFF', '#FF8A80', '#546F7A', '#263237'
];
/** @type {?} */
export const DEFAULT_TYPE_COLOR = '#8197c0';
/** @type {?} */
export const DEFAULT_STATE_COLOR = '#8197c0';
/** @type {?} */
export const GENERIC_STATE_ICON_SVG = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14">\n' +
    '    <path fill="<DYNAMICFILL>" fill-rule="nonzero" d="M.045 1.154h13.91v2.133H.045V1.154zM.8 4.75h12.364v8.19c0 .596-.487 1.083-1.082 1.083h-10.2A1.085 1.085 0 0 1 .8 12.94V4.75zm7.978 2.447V5.776H5.222v1.421h3.556z"/>\n' +
    '</svg>\n';
/** @type {?} */
export const GENERIC_CASETYPE_ICON_SVG = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 48 48">\n' +
    '    <path fill="<DYNAMICFILL>" fill-rule="evenodd" d="M42 42H6c-1.103 0-2-.898-2-2V26.61c4.43 2.623 10.208 3.96 15.729 4.422v1.504c0 1.326.948 2.4 2.118 2.4h4.764c1.17 0 2.118-1.074 2.118-2.4V31.04c6.16-.503 11.505-2.008 15.271-4.264v13.223c0 1.103-.897 2-2 2zM6 15.995h36c1.103 0 2 .898 2 2v3.583c-2.798 2.727-8.447 4.664-15.271 5.268v-1.511c0-1.326-.948-2.4-2.117-2.4h-4.765c-1.17 0-2.118 1.074-2.118 2.4v1.51c-6.651-.6-12.41-2.518-15.729-5.348v-3.501c0-1.103.897-2 2-2zm10.655-8.89c0-.063.023-.098.016-.106l14.944-.011s.04.033.04.117v4.89h-15v-4.89zM42 11.996h-6.345v-4.89C35.655 4.842 33.861 3 31.657 3H16.653c-2.204 0-3.998 1.842-3.998 4.106v4.89H6c-3.308 0-6 2.692-6 6V40c0 3.31 2.692 6 6 6h36c3.309 0 6-2.69 6-6V17.997c0-3.31-2.691-6.001-6-6.001z"/>\n' +
    '</svg>\n';
export class TcCaseCardConfigService {
    /**
     * @param {?} http
     * @param {?} liveAppsService
     * @param {?} sharedStateService
     * @param {?} location
     */
    constructor(http, liveAppsService, sharedStateService, location) {
        this.http = http;
        this.liveAppsService = liveAppsService;
        this.sharedStateService = sharedStateService;
        this.location = location;
    }
    /**
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} uiAppId
     * @return {?}
     */
    createCardConfig(sandboxId, appId, uiAppId) {
        /** @type {?} */
        const ssName = uiAppId + '.' + appId + '.stateconfig.tibcolabs.client.context.PUBLIC';
        /** @type {?} */
        const content = new SharedStateContent();
        content.json = TcCoreCommonFunctions.escapeString(JSON.stringify({}));
        return this.sharedStateService.createSharedState(ssName, 'PUBLIC', '', sandboxId, undefined, undefined, undefined, content)
            .pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            return value;
        })));
    }
    /**
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} uiAppId
     * @param {?} config
     * @param {?} id
     * @return {?}
     */
    updateCardConfig(sandboxId, appId, uiAppId, config, id) {
        /** @type {?} */
        const ssName = uiAppId + '.' + appId + '.stateconfig.tibcolabs.client.context.PUBLIC';
        /** @type {?} */
        const content = new SharedStateContent();
        content.json = TcCoreCommonFunctions.escapeString(JSON.stringify(config));
        /** @type {?} */
        const entry = new SharedStateEntry();
        entry.content = content;
        entry.sandboxId = sandboxId;
        entry.name = ssName;
        entry.type = 'PUBLIC';
        entry.id = id;
        /** @type {?} */
        const ssList = new SharedStateList();
        ssList.sharedStateEntries = [];
        ssList.sharedStateEntries.push(entry);
        return this.sharedStateService.updateSharedState(ssList.sharedStateEntries)
            .pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            return new CardConfig().deserialize((JSON.parse(value.sharedStateEntries[0].content.json)));
        })));
    }
    /**
     * @param {?} states
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} uiAppId
     * @param {?} caseTypeId
     * @param {?} defaultCaseTypeColor
     * @param {?} defaultCaseTypeIcon
     * @param {?} defaultStateColor
     * @param {?} defaultStateIcon
     * @return {?}
     */
    createNewCardConfig(states, sandboxId, appId, uiAppId, caseTypeId, defaultCaseTypeColor, defaultCaseTypeIcon, defaultStateColor, defaultStateIcon) {
        // create new config and return it
        /** @type {?} */
        const newConfig$ = this.createCardConfig(sandboxId, appId, uiAppId);
        /** @type {?} */
        const updatedConfig$ = newConfig$.pipe(mergeMap((/**
         * @param {?} id
         * @return {?}
         */
        id => {
            /** @type {?} */
            const stateMap = [];
            // one record for the case type icon config
            stateMap.push(new IconMap(true, caseTypeId, defaultCaseTypeColor, defaultCaseTypeIcon));
            states.forEach((/**
             * @param {?} state
             * @return {?}
             */
            state => {
                stateMap.push(new IconMap(false, state.value, defaultStateColor, defaultStateIcon));
            }));
            /** @type {?} */
            const newCardConfig = new CardConfig().deserialize({ id: id, useCaseTypeColor: true, stateMap: stateMap });
            return this.updateCardConfig(sandboxId, appId, uiAppId, newCardConfig, id).pipe(tap((/**
             * @param {?} config
             * @return {?}
             */
            config => {
                // trigger update of the cache
                this.getCardConfig(uiAppId, appId, true, true);
            })), map((/**
             * @param {?} newcard
             * @return {?}
             */
            newcard => {
                return new CaseCardConfig().deserialize({ states: states, cardConfig: newcard });
            })));
        })));
        return updatedConfig$;
    }
    /**
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} uiAppId
     * @param {?} caseTypeId
     * @param {?} defaultCaseTypeColor
     * @param {?} defaultCaseTypeIcon
     * @param {?} defaultStateColor
     * @param {?} defaultStateIcon
     * @return {?}
     */
    getCaseCardConfig(sandboxId, appId, uiAppId, caseTypeId, defaultCaseTypeColor, defaultCaseTypeIcon, defaultStateColor, defaultStateIcon) {
        /** @type {?} */
        const states$ = this.liveAppsService.getCaseTypeStates(sandboxId, appId, 100);
        /** @type {?} */
        const cardConfig$ = this.getCardConfig(uiAppId, appId, true, false).pipe(map((/**
         * @param {?} config
         * @return {?}
         */
        config => {
            return config;
        })));
        return states$.pipe(mergeMap((/**
         * @param {?} states
         * @return {?}
         */
        states => {
            return cardConfig$.pipe(mergeMap((/**
             * @param {?} config
             * @return {?}
             */
            config => {
                if (config) {
                    /** @type {?} */
                    const cardConfig = new CaseCardConfig().deserialize({ states: states.states, cardConfig: config });
                    return of(cardConfig);
                }
                else {
                    return this.createNewCardConfig(states.states, sandboxId, appId, uiAppId, caseTypeId, defaultCaseTypeColor, defaultCaseTypeIcon, defaultStateColor, defaultStateIcon).pipe(map((/**
                     * @param {?} newCardConfig
                     * @return {?}
                     */
                    newCardConfig => {
                        return newCardConfig;
                    })));
                }
            })));
        })));
    }
    /**
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} uiAppId
     * @param {?} updatedConfig
     * @return {?}
     */
    updateCaseCardConfig(sandboxId, appId, uiAppId, updatedConfig) {
        return this.updateCardConfig(sandboxId, appId, uiAppId, updatedConfig.cardConfig, updatedConfig.cardConfig.id).pipe(map((/**
         * @param {?} cardconfig
         * @return {?}
         */
        cardconfig => {
            updatedConfig.cardConfig = cardconfig;
            // remember to flush cache
            this.getCardConfig(uiAppId, appId, true, true).subscribe();
            return updatedConfig;
        })));
    }
    /**
     * @param {?} uiAppId
     * @param {?} appId
     * @param {?} useCache
     * @param {?} flushCache
     * @return {?}
     */
    getCardConfig(uiAppId, appId, useCache, flushCache) {
        /** @type {?} */
        const ssName = uiAppId + '.' + appId + '.stateconfig.tibcolabs.client.context.PUBLIC';
        return this.sharedStateService.getSharedState(ssName, 'PUBLIC', useCache, flushCache).pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            if (value.sharedStateEntries.length > 0) {
                /** @type {?} */
                const ssresult = new CardConfig().deserialize(JSON.parse(value.sharedStateEntries[0].content.json));
                ssresult.id = value.sharedStateEntries[0].id;
                return ssresult;
            }
            else {
                return undefined;
            }
        })));
    }
    /**
     * @param {?} appId
     * @param {?} uiAppId
     * @return {?}
     */
    getStateColorInfo(appId, uiAppId) {
        return this.getCardConfig(uiAppId, appId, true, false).pipe(map((/**
         * @param {?} val
         * @return {?}
         */
        val => {
            if (val) {
                /** @type {?} */
                const config = val;
                /** @type {?} */
                const stateColorMap = new StateColorMap();
                stateColorMap.stateColorRecs = [];
                config.stateMap.forEach((/**
                 * @param {?} stateMapRec
                 * @return {?}
                 */
                (stateMapRec) => {
                    /** @type {?} */
                    const stateColorMapRec = new StateColorMapRec().deserialize({ state: stateMapRec.state, color: stateMapRec.fill });
                    if (stateMapRec.isCaseType) {
                        stateColorMap.caseTypeColor = stateMapRec.fill;
                    }
                    stateColorMap.stateColorRecs.push(stateColorMapRec);
                }));
                return stateColorMap;
            }
            else {
                return new StateColorMap();
            }
        })));
    }
    /**
     * @param {?} appId
     * @param {?} uiAppId
     * @param {?} state
     * @return {?}
     */
    getColorForState(appId, uiAppId, state) {
        return this.getCardConfig(uiAppId, appId, true, false).pipe(map((/**
         * @param {?} val
         * @return {?}
         */
        val => {
            /** @type {?} */
            const stateMap = val.stateMap.find((/**
             * @param {?} stateRec
             * @return {?}
             */
            (stateRec) => {
                return stateRec.state === state;
            }));
            return (stateMap ? stateMap.fill : undefined);
        })));
    }
    /**
     * @param {?} caseinfo
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} typeId
     * @param {?} uiAppId
     * @return {?}
     */
    parseCaseInfo(caseinfo, sandboxId, appId, typeId, uiAppId) {
        // in order to get all the info we need we actually need to call up to 4 observables in parallel
        /** @type {?} */
        const caseInfo$ = this.liveAppsService.getCaseTypeBasicInfo(sandboxId, appId, typeId, 100).pipe(map((/**
         * @param {?} val
         * @return {?}
         */
        val => caseinfo.metadata.applicationLabel = val.label)));
        /** @type {?} */
        const cardConfig$ = this.getCardConfig(uiAppId, appId, true, false).pipe(map((/**
         * @param {?} val
         * @return {?}
         */
        val => {
            /** @type {?} */
            const stateId = caseinfo.summaryObj.state;
            /** @type {?} */
            let stateConfig;
            if (val !== undefined && val.stateMap) {
                val.stateMap.forEach((/**
                 * @param {?} state
                 * @return {?}
                 */
                (state) => {
                    if (state.state === stateId) {
                        stateConfig = state;
                        caseinfo.metadata.stateColor = stateConfig.fill;
                        caseinfo.metadata.stateIcon = stateConfig.icon;
                    }
                    if (state.isCaseType) {
                        stateConfig = state;
                        caseinfo.metadata.caseTypeColor = stateConfig.fill;
                        caseinfo.metadata.caseTypeIcon = stateConfig.icon;
                    }
                    caseinfo.metadata.useCaseTypeColor = val.useCaseTypeColor ? val.useCaseTypeColor : false;
                }));
            }
            // defaults
            if (!caseinfo.metadata.stateColor) {
                caseinfo.metadata.stateColor = DEFAULT_STATE_COLOR;
            }
            if (!caseinfo.metadata.stateIcon) {
                caseinfo.metadata.stateIcon = 'assets/icons/ic-generic-state.svg';
            }
            if (!caseinfo.metadata.caseTypeColor) {
                caseinfo.metadata.caseTypeColor = DEFAULT_TYPE_COLOR;
            }
            if (!caseinfo.metadata.caseTypeIcon) {
                caseinfo.metadata.caseTypeIcon = 'assets/icons/ic-generic-casetype.svg';
            }
        })));
        /** @type {?} */
        const forkJoinArray = [caseInfo$, cardConfig$];
        /** @type {?} */
        let creatorInfo$;
        /** @type {?} */
        let modifiedInfo$;
        if (caseinfo.metadata.createdBy) {
            creatorInfo$ = this.liveAppsService.getUserInfo(caseinfo.metadata.createdBy).pipe(map((/**
             * @param {?} val
             * @return {?}
             */
            val => caseinfo.metadata.createdByDetails = val ? val : new UserInfo())));
            forkJoinArray.push(creatorInfo$);
        }
        else {
            caseinfo.metadata.createdByDetails = new UserInfo();
        }
        if (caseinfo.metadata.modifiedBy) {
            modifiedInfo$ = this.liveAppsService.getUserInfo(caseinfo.metadata.modifiedBy).pipe(map((/**
             * @param {?} val
             * @return {?}
             */
            val => caseinfo.metadata.modifiedByDetails = val ? val : new UserInfo())));
            forkJoinArray.push(modifiedInfo$);
        }
        else {
            caseinfo.metadata.modifiedByDetails = new UserInfo();
        }
        // call all the observables at once and return the Observable to the parsed CaseInfo
        return forkJoin(forkJoinArray).pipe(map((/**
         * @param {?} resultArr
         * @return {?}
         */
        resultArr => {
            return caseinfo;
        })));
    }
    /**
     * @param {?} caseRef
     * @param {?} sandboxId
     * @param {?} uiAppId
     * @return {?}
     */
    getCaseWithSummary(caseRef, sandboxId, uiAppId) {
        // get the base caseinfo from the API, then call parseCaseInfo to create an Observable with all the extra data we need
        /** @type {?} */
        const url = '/case/v1/cases/' + caseRef + '/' + '?$sandbox=' + sandboxId + '&$select=uc, m, s';
        return this.http.get(url).pipe(mergeMap((/**
         * @param {?} caseinfo
         * @return {?}
         */
        caseinfo => {
            /** @type {?} */
            const caseinf = new CaseInfo().deserialize(caseinfo);
            return this.parseCaseInfo(caseinf, sandboxId, caseinf.metadata.applicationId, caseinf.metadata.typeId, uiAppId);
        })), catchError((/**
         * @param {?} err
         * @return {?}
         */
        err => {
            if (err.error.errorCode === 'CM_CASEREF_NOTEXIST') {
                // case deleted
                return of(new CaseInfo().deserialize({ deleted: true }));
            }
            return throwError(err);
        })));
    }
}
TcCaseCardConfigService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
TcCaseCardConfigService.ctorParameters = () => [
    { type: HttpClient },
    { type: LiveAppsService },
    { type: TcSharedStateService },
    { type: Location }
];
/** @nocollapse */ TcCaseCardConfigService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function TcCaseCardConfigService_Factory() { return new TcCaseCardConfigService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.LiveAppsService), i0.ɵɵinject(i3.TcSharedStateService), i0.ɵɵinject(i4.Location)); }, token: TcCaseCardConfigService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    TcCaseCardConfigService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    TcCaseCardConfigService.prototype.liveAppsService;
    /**
     * @type {?}
     * @private
     */
    TcCaseCardConfigService.prototype.sharedStateService;
    /**
     * @type {?}
     * @private
     */
    TcCaseCardConfigService.prototype.location;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGMtY2FzZS1jYXJkLWNvbmZpZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRpYmNvLXRjc3RrL3RjLWxpdmVhcHBzLWxpYi8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy90Yy1jYXNlLWNhcmQtY29uZmlnLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxFQUFDLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLGVBQWUsRUFBRSxxQkFBcUIsRUFBRSxvQkFBb0IsRUFBYyxNQUFNLDBCQUEwQixDQUFDO0FBQ3pKLE9BQU8sRUFBQyxRQUFRLEVBQWMsRUFBRSxFQUFFLFVBQVUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUMxRCxPQUFPLEVBQW1CLFVBQVUsRUFBRSxRQUFRLEVBQXFDLE9BQU8sRUFBRSxRQUFRLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUNwSSxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0scUJBQXFCLENBQUM7QUFDcEQsT0FBTyxFQUFDLGNBQWMsRUFBRSxhQUFhLEVBQUUsZ0JBQWdCLEVBQUMsTUFBTSwrQkFBK0IsQ0FBQztBQUM5RixPQUFPLEVBQUMsVUFBVSxFQUFXLEdBQUcsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFFdkUsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ2hELE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQzs7Ozs7OztBQUV6QyxNQUFNLE9BQU8sY0FBYyxHQUFhO0lBQ3RDLFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxTQUFTO0lBQ3JELFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxTQUFTO0lBQ3JELFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFB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QUFFLENBQUMsSUFBSSxRQUFRLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUUsQ0FBQyxDQUFDO2FBQzNEO1lBQ0QsT0FBTyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDekIsQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7OztZQXBQRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7Ozs7WUF6Qk8sVUFBVTtZQUpWLGVBQWU7WUFIK0Qsb0JBQW9CO1lBUWxHLFFBQVE7Ozs7Ozs7O0lBMkJGLHVDQUF3Qjs7Ozs7SUFBRSxrREFBd0M7Ozs7O0lBQUUscURBQWdEOzs7OztJQUFFLDJDQUEwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1NoYXJlZFN0YXRlQ29udGVudCwgU2hhcmVkU3RhdGVFbnRyeSwgU2hhcmVkU3RhdGVMaXN0LCBUY0NvcmVDb21tb25GdW5jdGlvbnMsIFRjU2hhcmVkU3RhdGVTZXJ2aWNlLCBVaUFwcENvbmZpZ30gZnJvbSAnQHRpYmNvLXRjc3RrL3RjLWNvcmUtbGliJztcbmltcG9ydCB7Zm9ya0pvaW4sIE9ic2VydmFibGUsIG9mLCB0aHJvd0Vycm9yfSBmcm9tICdyeGpzJztcbmltcG9ydCB7QXBpUmVzcG9uc2VFcnJvciwgQ2FyZENvbmZpZywgQ2FzZUluZm8sIENhc2VUeXBlU3RhdGUsIENhc2VUeXBlU3RhdGVzTGlzdCwgSWNvbk1hcCwgVXNlckluZm99IGZyb20gJy4uL21vZGVscy9saXZlYXBwc2RhdGEnO1xuaW1wb3J0IHtMaXZlQXBwc1NlcnZpY2V9IGZyb20gJy4vbGl2ZS1hcHBzLnNlcnZpY2UnO1xuaW1wb3J0IHtDYXNlQ2FyZENvbmZpZywgU3RhdGVDb2xvck1hcCwgU3RhdGVDb2xvck1hcFJlY30gZnJvbSAnLi4vbW9kZWxzL3RjLWNhc2UtY2FyZC1jb25maWcnO1xuaW1wb3J0IHtjYXRjaEVycm9yLCBmbGF0TWFwLCBtYXAsIG1lcmdlTWFwLCB0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7Zmx1c2h9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvdGVzdGluZyc7XG5pbXBvcnQge0h0dHBDbGllbnR9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7TG9jYXRpb259IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX0NPTE9SUzogc3RyaW5nW10gPSBbXG4gICcjM0U5NEMwJywgJyM0OUIzRDMnLCAnIzc2QzZDRicsICcjQTlEQUNEJywgJyNEQ0VDQzknLFxuICAnI0ZGQUI0MCcsICcjRkZEMTgwJywgJyNGRkUwQjInLCAnI0ZGRjNFMCcsICcjODFENEZBJyxcbiAgJyNCM0U1RkMnLCAnIzhBRjJGMicsICcjOTFBM0FFJywgJyNDRUQ4REQnLCAnI0VCRUZGMScsXG4gICcjNkExQjlBJywgJyNBRDE0NTcnLCAnI0VDNDA3QScsICcjQzQ0NjlFJywgJyNCQTY4QzgnLFxuICAnIzhDOUVGRicsICcjRkY4QTgwJywgJyM1NDZGN0EnLCAnIzI2MzIzNydcbl07XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX1RZUEVfQ09MT1IgPSAnIzgxOTdjMCc7XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX1NUQVRFX0NPTE9SID0gJyM4MTk3YzAnO1xuXG5leHBvcnQgY29uc3QgR0VORVJJQ19TVEFURV9JQ09OX1NWRyA9ICc8c3ZnIHhtbG5zPVwiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmdcIiB3aWR0aD1cIjE0XCIgaGVpZ2h0PVwiMTRcIiB2aWV3Qm94PVwiMCAwIDE0IDE0XCI+XFxuJyArXG4gICcgICAgPHBhdGggZmlsbD1cIjxEWU5BTUlDRklMTD5cIiBmaWxsLXJ1bGU9XCJub256ZXJvXCIgZD1cIk0uMDQ1IDEuMTU0aDEzLjkxdjIuMTMzSC4wNDVWMS4xNTR6TS44IDQuNzVoMTIuMzY0djguMTljMCAuNTk2LS40ODcgMS4wODMtMS4wODIgMS4wODNoLTEwLjJBMS4wODUgMS4wODUgMCAwIDEgLjggMTIuOTRWNC43NXptNy45NzggMi40NDdWNS43NzZINS4yMjJ2MS40MjFoMy41NTZ6XCIvPlxcbicgK1xuICAnPC9zdmc+XFxuJztcblxuZXhwb3J0IGNvbnN0IEdFTkVSSUNfQ0FTRVRZUEVfSUNPTl9TVkcgPSAnPHN2ZyB4bWxucz1cImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnXCIgd2lkdGg9XCIxNFwiIGhlaWdodD1cIjE0XCIgdmlld0JveD1cIjAgMCA0OCA0OFwiPlxcbicgK1xuICAnICAgIDxwYXRoIGZpbGw9XCI8RFlOQU1JQ0ZJTEw+XCIgZmlsbC1ydWxlPVwiZXZlbm9kZFwiIGQ9XCJNNDIgNDJINmMtMS4xMDMgMC0yLS44OTgtMi0yVjI2LjYxYzQuNDMgMi42MjMgMTAuMjA4IDMuOTYgMTUuNzI5IDQuNDIydjEuNTA0YzAgMS4zMjYuOTQ4IDIuNCAyLjExOCAyLjRoNC43NjRjMS4xNyAwIDIuMTE4LTEuMDc0IDIuMTE4LTIuNFYzMS4wNGM2LjE2LS41MDMgMTEuNTA1LTIuMDA4IDE1LjI3MS00LjI2NHYxMy4yMjNjMCAxLjEwMy0uODk3IDItMiAyek02IDE1Ljk5NWgzNmMxLjEwMyAwIDIgLjg5OCAyIDJ2My41ODNjLTIuNzk4IDIuNzI3LTguNDQ3IDQuNjY0LTE1LjI3MSA1LjI2OHYtMS41MTFjMC0xLjMyNi0uOTQ4LTIuNC0yLjExNy0yLjRoLTQuNzY1Yy0xLjE3IDAtMi4xMTggMS4wNzQtMi4xMTggMi40djEuNTFjLTYuNjUxLS42LTEyLjQxLTIuNTE4LTE1LjcyOS01LjM0OHYtMy41MDFjMC0xLjEwMy44OTctMiAyLTJ6bTEwLjY1NS04Ljg5YzAtLjA2My4wMjMtLjA5OC4wMTYtLjEwNmwxNC45NDQtLjAxMXMuMDQuMDMzLjA0LjExN3Y0Ljg5aC0xNXYtNC44OXpNNDIgMTEuOTk2aC02LjM0NXYtNC44OUMzNS42NTUgNC44NDIgMzMuODYxIDMgMzEuNjU3IDNIMTYuNjUzYy0yLjIwNCAwLTMuOTk4IDEuODQyLTMuOTk4IDQuMTA2djQuODlINmMtMy4zMDggMC02IDIuNjkyLTYgNlY0MGMwIDMuMzEgMi42OTIgNiA2IDZoMzZjMy4zMDkgMCA2LTIuNjkgNi02VjE3Ljk5N2MwLTMuMzEtMi42OTEtNi4wMDEtNi02LjAwMXpcIi8+XFxuJyArXG4gICc8L3N2Zz5cXG4nO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBUY0Nhc2VDYXJkQ29uZmlnU2VydmljZSB7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LCBwcml2YXRlIGxpdmVBcHBzU2VydmljZTogTGl2ZUFwcHNTZXJ2aWNlLCBwcml2YXRlIHNoYXJlZFN0YXRlU2VydmljZTogVGNTaGFyZWRTdGF0ZVNlcnZpY2UsIHByaXZhdGUgbG9jYXRpb246IExvY2F0aW9uKSB7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlQ2FyZENvbmZpZyhzYW5kYm94SWQ6IG51bWJlciwgYXBwSWQ6IHN0cmluZywgdWlBcHBJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICBjb25zdCBzc05hbWUgPSB1aUFwcElkICsgJy4nICsgYXBwSWQgKyAnLnN0YXRlY29uZmlnLnRpYmNvbGFicy5jbGllbnQuY29udGV4dC5QVUJMSUMnO1xuICAgIGNvbnN0IGNvbnRlbnQ6IFNoYXJlZFN0YXRlQ29udGVudCA9IG5ldyBTaGFyZWRTdGF0ZUNvbnRlbnQoKTtcbiAgICBjb250ZW50Lmpzb24gPSBUY0NvcmVDb21tb25GdW5jdGlvbnMuZXNjYXBlU3RyaW5nKEpTT04uc3RyaW5naWZ5KHt9KSk7XG4gICAgcmV0dXJuIHRoaXMuc2hhcmVkU3RhdGVTZXJ2aWNlLmNyZWF0ZVNoYXJlZFN0YXRlKHNzTmFtZSwgJ1BVQkxJQycsICcnLCBzYW5kYm94SWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNvbnRlbnQpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKHZhbHVlID0+IHtcbiAgICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHVwZGF0ZUNhcmRDb25maWcoc2FuZGJveElkOiBudW1iZXIsIGFwcElkOiBzdHJpbmcsIHVpQXBwSWQ6IHN0cmluZywgY29uZmlnOiBDYXJkQ29uZmlnLCBpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxDYXJkQ29uZmlnPiB7XG4gICAgY29uc3Qgc3NOYW1lID0gdWlBcHBJZCArICcuJyArIGFwcElkICsgJy5zdGF0ZWNvbmZpZy50aWJjb2xhYnMuY2xpZW50LmNvbnRleHQuUFVCTElDJztcbiAgICBjb25zdCBjb250ZW50OiBTaGFyZWRTdGF0ZUNvbnRlbnQgPSBuZXcgU2hhcmVkU3RhdGVDb250ZW50KCk7XG4gICAgY29udGVudC5qc29uID0gVGNDb3JlQ29tbW9uRnVuY3Rpb25zLmVzY2FwZVN0cmluZyhKU09OLnN0cmluZ2lmeShjb25maWcpKTtcbiAgICBjb25zdCBlbnRyeTogU2hhcmVkU3RhdGVFbnRyeSA9IG5ldyBTaGFyZWRTdGF0ZUVudHJ5KCk7XG4gICAgZW50cnkuY29udGVudCA9IGNvbnRlbnQ7XG4gICAgZW50cnkuc2FuZGJveElkID0gc2FuZGJveElkO1xuICAgIGVudHJ5Lm5hbWUgPSBzc05hbWU7XG4gICAgZW50cnkudHlwZSA9ICdQVUJMSUMnO1xuICAgIGVudHJ5LmlkID0gaWQ7XG4gICAgY29uc3Qgc3NMaXN0OiBTaGFyZWRTdGF0ZUxpc3QgPSBuZXcgU2hhcmVkU3RhdGVMaXN0KCk7XG4gICAgc3NMaXN0LnNoYXJlZFN0YXRlRW50cmllcyA9IFtdO1xuICAgIHNzTGlzdC5zaGFyZWRTdGF0ZUVudHJpZXMucHVzaChlbnRyeSk7XG4gICAgcmV0dXJuIHRoaXMuc2hhcmVkU3RhdGVTZXJ2aWNlLnVwZGF0ZVNoYXJlZFN0YXRlKHNzTGlzdC5zaGFyZWRTdGF0ZUVudHJpZXMpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKHZhbHVlID0+IHtcbiAgICAgICAgICByZXR1cm4gbmV3IENhcmRDb25maWcoKS5kZXNlcmlhbGl6ZSgoSlNPTi5wYXJzZSh2YWx1ZS5zaGFyZWRTdGF0ZUVudHJpZXNbMF0uY29udGVudC5qc29uKSkpO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVOZXdDYXJkQ29uZmlnKHN0YXRlczogQ2FzZVR5cGVTdGF0ZVtdLCBzYW5kYm94SWQ6IG51bWJlciwgYXBwSWQ6IHN0cmluZywgdWlBcHBJZDogc3RyaW5nLCBjYXNlVHlwZUlkOiBzdHJpbmcsIGRlZmF1bHRDYXNlVHlwZUNvbG9yOiBzdHJpbmcsIGRlZmF1bHRDYXNlVHlwZUljb246IHN0cmluZywgZGVmYXVsdFN0YXRlQ29sb3I6IHN0cmluZywgZGVmYXVsdFN0YXRlSWNvbjogc3RyaW5nKTogT2JzZXJ2YWJsZTxDYXNlQ2FyZENvbmZpZz4ge1xuICAgIC8vIGNyZWF0ZSBuZXcgY29uZmlnIGFuZCByZXR1cm4gaXRcbiAgICBjb25zdCBuZXdDb25maWckID0gdGhpcy5jcmVhdGVDYXJkQ29uZmlnKHNhbmRib3hJZCwgYXBwSWQsIHVpQXBwSWQpO1xuICAgIGNvbnN0IHVwZGF0ZWRDb25maWckID0gbmV3Q29uZmlnJC5waXBlKFxuICAgICAgbWVyZ2VNYXAoaWQgPT4ge1xuICAgICAgICBjb25zdCBzdGF0ZU1hcDogSWNvbk1hcFtdID0gW107XG4gICAgICAgIC8vIG9uZSByZWNvcmQgZm9yIHRoZSBjYXNlIHR5cGUgaWNvbiBjb25maWdcbiAgICAgICAgc3RhdGVNYXAucHVzaChuZXcgSWNvbk1hcCh0cnVlLCBjYXNlVHlwZUlkLCBkZWZhdWx0Q2FzZVR5cGVDb2xvciwgZGVmYXVsdENhc2VUeXBlSWNvbikpO1xuICAgICAgICBzdGF0ZXMuZm9yRWFjaChzdGF0ZSA9PiB7XG4gICAgICAgICAgc3RhdGVNYXAucHVzaChuZXcgSWNvbk1hcChmYWxzZSwgc3RhdGUudmFsdWUsIGRlZmF1bHRTdGF0ZUNvbG9yLCBkZWZhdWx0U3RhdGVJY29uKSk7XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBuZXdDYXJkQ29uZmlnID0gbmV3IENhcmRDb25maWcoKS5kZXNlcmlhbGl6ZSh7IGlkOiBpZCwgdXNlQ2FzZVR5cGVDb2xvcjogdHJ1ZSwgc3RhdGVNYXA6IHN0YXRlTWFwIH0pO1xuICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVDYXJkQ29uZmlnKHNhbmRib3hJZCwgYXBwSWQsIHVpQXBwSWQsIG5ld0NhcmRDb25maWcsIGlkKS5waXBlKFxuICAgICAgICAgIHRhcChjb25maWcgPT4ge1xuICAgICAgICAgICAgLy8gdHJpZ2dlciB1cGRhdGUgb2YgdGhlIGNhY2hlXG4gICAgICAgICAgICB0aGlzLmdldENhcmRDb25maWcodWlBcHBJZCwgYXBwSWQsIHRydWUsIHRydWUpO1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIG1hcChuZXdjYXJkID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBDYXNlQ2FyZENvbmZpZygpLmRlc2VyaWFsaXplKFxuICAgICAgICAgICAgICAgIHsgc3RhdGVzOiBzdGF0ZXMsIGNhcmRDb25maWc6IG5ld2NhcmQgfVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gICAgcmV0dXJuIHVwZGF0ZWRDb25maWckO1xuICB9XG5cbiAgcHVibGljIGdldENhc2VDYXJkQ29uZmlnKHNhbmRib3hJZDogbnVtYmVyLCBhcHBJZDogc3RyaW5nLCB1aUFwcElkOiBzdHJpbmcsIGNhc2VUeXBlSWQ6IHN0cmluZywgZGVmYXVsdENhc2VUeXBlQ29sb3I6IHN0cmluZywgZGVmYXVsdENhc2VUeXBlSWNvbjogc3RyaW5nLCBkZWZhdWx0U3RhdGVDb2xvcjogc3RyaW5nLCBkZWZhdWx0U3RhdGVJY29uOiBzdHJpbmcpOiBPYnNlcnZhYmxlPENhc2VDYXJkQ29uZmlnPiB7XG4gICAgY29uc3Qgc3RhdGVzJCA9IHRoaXMubGl2ZUFwcHNTZXJ2aWNlLmdldENhc2VUeXBlU3RhdGVzKHNhbmRib3hJZCwgYXBwSWQsIDEwMCk7XG4gICAgY29uc3QgY2FyZENvbmZpZyQgPSB0aGlzLmdldENhcmRDb25maWcodWlBcHBJZCwgYXBwSWQsIHRydWUsIGZhbHNlKS5waXBlKFxuICAgICAgbWFwKGNvbmZpZyA9PiB7XG4gICAgICAgICAgcmV0dXJuIGNvbmZpZztcbiAgICAgIH0pXG4gICAgKTtcbiAgICByZXR1cm4gc3RhdGVzJC5waXBlKFxuICAgICAgbWVyZ2VNYXAoc3RhdGVzID0+IHtcbiAgICAgICAgcmV0dXJuIGNhcmRDb25maWckLnBpcGUoXG4gICAgICAgICAgbWVyZ2VNYXAoY29uZmlnID0+IHtcbiAgICAgICAgICAgIGlmIChjb25maWcpIHtcbiAgICAgICAgICAgICAgY29uc3QgY2FyZENvbmZpZyA9IG5ldyBDYXNlQ2FyZENvbmZpZygpLmRlc2VyaWFsaXplKFxuICAgICAgICAgICAgICAgIHtzdGF0ZXM6IHN0YXRlcy5zdGF0ZXMsIGNhcmRDb25maWc6IGNvbmZpZ31cbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgcmV0dXJuIG9mKGNhcmRDb25maWcpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlTmV3Q2FyZENvbmZpZyhzdGF0ZXMuc3RhdGVzLCBzYW5kYm94SWQsIGFwcElkLCB1aUFwcElkLCBjYXNlVHlwZUlkLCBkZWZhdWx0Q2FzZVR5cGVDb2xvciwgZGVmYXVsdENhc2VUeXBlSWNvbiwgZGVmYXVsdFN0YXRlQ29sb3IsIGRlZmF1bHRTdGF0ZUljb24pLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKG5ld0NhcmRDb25maWcgPT4ge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ld0NhcmRDb25maWc7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHVwZGF0ZUNhc2VDYXJkQ29uZmlnKHNhbmRib3hJZDogbnVtYmVyLCBhcHBJZDogc3RyaW5nLCB1aUFwcElkOiBzdHJpbmcsIHVwZGF0ZWRDb25maWc6IENhc2VDYXJkQ29uZmlnKTogT2JzZXJ2YWJsZSA8IENhc2VDYXJkQ29uZmlnID4ge1xuICAgIHJldHVybiB0aGlzLnVwZGF0ZUNhcmRDb25maWcoc2FuZGJveElkLCBhcHBJZCwgdWlBcHBJZCwgdXBkYXRlZENvbmZpZy5jYXJkQ29uZmlnLCB1cGRhdGVkQ29uZmlnLmNhcmRDb25maWcuaWQpLnBpcGUoXG4gICAgICBtYXAoY2FyZGNvbmZpZyA9PiB7XG4gICAgICAgIHVwZGF0ZWRDb25maWcuY2FyZENvbmZpZyA9IGNhcmRjb25maWc7XG4gICAgICAgIC8vIHJlbWVtYmVyIHRvIGZsdXNoIGNhY2hlXG4gICAgICAgIHRoaXMuZ2V0Q2FyZENvbmZpZyh1aUFwcElkLCBhcHBJZCwgdHJ1ZSwgdHJ1ZSkuc3Vic2NyaWJlKCk7XG4gICAgICAgIHJldHVybiB1cGRhdGVkQ29uZmlnO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGdldENhcmRDb25maWcodWlBcHBJZDogc3RyaW5nLCBhcHBJZDogc3RyaW5nLCB1c2VDYWNoZTogYm9vbGVhbiwgZmx1c2hDYWNoZTogYm9vbGVhbik6IE9ic2VydmFibGU8Q2FyZENvbmZpZz4ge1xuICAgIGNvbnN0IHNzTmFtZSA9IHVpQXBwSWQgKyAnLicgKyBhcHBJZCArICcuc3RhdGVjb25maWcudGliY29sYWJzLmNsaWVudC5jb250ZXh0LlBVQkxJQyc7XG4gICAgcmV0dXJuIHRoaXMuc2hhcmVkU3RhdGVTZXJ2aWNlLmdldFNoYXJlZFN0YXRlKHNzTmFtZSwgJ1BVQkxJQycsIHVzZUNhY2hlLCBmbHVzaENhY2hlKS5waXBlKFxuICAgICAgbWFwKHZhbHVlID0+IHtcbiAgICAgICAgICBpZiAodmFsdWUuc2hhcmVkU3RhdGVFbnRyaWVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHNzcmVzdWx0ID0gbmV3IENhcmRDb25maWcoKS5kZXNlcmlhbGl6ZShKU09OLnBhcnNlKHZhbHVlLnNoYXJlZFN0YXRlRW50cmllc1swXS5jb250ZW50Lmpzb24pKTtcbiAgICAgICAgICAgIHNzcmVzdWx0LmlkID0gdmFsdWUuc2hhcmVkU3RhdGVFbnRyaWVzWzBdLmlkO1xuICAgICAgICAgICAgcmV0dXJuIHNzcmVzdWx0O1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZ2V0U3RhdGVDb2xvckluZm8gKGFwcElkOiBzdHJpbmcsIHVpQXBwSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8U3RhdGVDb2xvck1hcD4ge1xuICAgIHJldHVybiB0aGlzLmdldENhcmRDb25maWcodWlBcHBJZCwgYXBwSWQsIHRydWUsIGZhbHNlKS5waXBlKFxuICAgICAgbWFwKHZhbCA9PiB7XG4gICAgICAgIGlmICh2YWwpIHtcbiAgICAgICAgICBjb25zdCBjb25maWc6IENhcmRDb25maWcgPSB2YWw7XG4gICAgICAgICAgY29uc3Qgc3RhdGVDb2xvck1hcCA9IG5ldyBTdGF0ZUNvbG9yTWFwKCk7XG4gICAgICAgICAgc3RhdGVDb2xvck1hcC5zdGF0ZUNvbG9yUmVjcyA9IFtdO1xuICAgICAgICAgIGNvbmZpZy5zdGF0ZU1hcC5mb3JFYWNoKChzdGF0ZU1hcFJlYykgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc3RhdGVDb2xvck1hcFJlYyA9IG5ldyBTdGF0ZUNvbG9yTWFwUmVjKCkuZGVzZXJpYWxpemUoIHsgc3RhdGU6IHN0YXRlTWFwUmVjLnN0YXRlLCBjb2xvcjogc3RhdGVNYXBSZWMuZmlsbH0gKTtcbiAgICAgICAgICAgIGlmIChzdGF0ZU1hcFJlYy5pc0Nhc2VUeXBlKSB7XG4gICAgICAgICAgICAgIHN0YXRlQ29sb3JNYXAuY2FzZVR5cGVDb2xvciA9IHN0YXRlTWFwUmVjLmZpbGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdGF0ZUNvbG9yTWFwLnN0YXRlQ29sb3JSZWNzLnB1c2goc3RhdGVDb2xvck1hcFJlYyk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmV0dXJuIHN0YXRlQ29sb3JNYXA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIG5ldyBTdGF0ZUNvbG9yTWFwKCk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb2xvckZvclN0YXRlIChhcHBJZDogc3RyaW5nLCB1aUFwcElkOiBzdHJpbmcsIHN0YXRlOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmdldENhcmRDb25maWcodWlBcHBJZCwgYXBwSWQsIHRydWUsIGZhbHNlKS5waXBlKFxuICAgICAgbWFwKHZhbCA9PiB7XG4gICAgICAgIGNvbnN0IHN0YXRlTWFwID0gdmFsLnN0YXRlTWFwLmZpbmQoKHN0YXRlUmVjKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHN0YXRlUmVjLnN0YXRlID09PSBzdGF0ZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiAoc3RhdGVNYXAgPyBzdGF0ZU1hcC5maWxsIDogdW5kZWZpbmVkKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBwYXJzZUNhc2VJbmZvKGNhc2VpbmZvOiBDYXNlSW5mbywgc2FuZGJveElkOiBudW1iZXIsIGFwcElkOiBzdHJpbmcsIHR5cGVJZDogc3RyaW5nLCB1aUFwcElkKTogT2JzZXJ2YWJsZTxDYXNlSW5mbz4ge1xuICAgIC8vIGluIG9yZGVyIHRvIGdldCBhbGwgdGhlIGluZm8gd2UgbmVlZCB3ZSBhY3R1YWxseSBuZWVkIHRvIGNhbGwgdXAgdG8gNCBvYnNlcnZhYmxlcyBpbiBwYXJhbGxlbFxuICAgIGNvbnN0IGNhc2VJbmZvJCA9IHRoaXMubGl2ZUFwcHNTZXJ2aWNlLmdldENhc2VUeXBlQmFzaWNJbmZvKHNhbmRib3hJZCwgYXBwSWQsIHR5cGVJZCwgMTAwKS5waXBlKFxuICAgICAgbWFwKHZhbCA9PiBjYXNlaW5mby5tZXRhZGF0YS5hcHBsaWNhdGlvbkxhYmVsID0gdmFsLmxhYmVsKVxuICAgICk7XG4gICAgY29uc3QgY2FyZENvbmZpZyQgPSB0aGlzLmdldENhcmRDb25maWcodWlBcHBJZCwgYXBwSWQsIHRydWUsIGZhbHNlKS5waXBlKFxuICAgICAgbWFwKHZhbCA9PiB7XG4gICAgICAgICAgY29uc3Qgc3RhdGVJZCA9IGNhc2VpbmZvLnN1bW1hcnlPYmouc3RhdGU7XG4gICAgICAgICAgbGV0IHN0YXRlQ29uZmlnOiBJY29uTWFwO1xuICAgICAgICAgIGlmICh2YWwgIT09IHVuZGVmaW5lZCAmJiB2YWwuc3RhdGVNYXApIHtcbiAgICAgICAgICAgIHZhbC5zdGF0ZU1hcC5mb3JFYWNoKChzdGF0ZSkgPT4ge1xuICAgICAgICAgICAgICBpZiAoc3RhdGUuc3RhdGUgPT09IHN0YXRlSWQpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZUNvbmZpZyA9IHN0YXRlO1xuICAgICAgICAgICAgICAgIGNhc2VpbmZvLm1ldGFkYXRhLnN0YXRlQ29sb3IgPSBzdGF0ZUNvbmZpZy5maWxsO1xuICAgICAgICAgICAgICAgIGNhc2VpbmZvLm1ldGFkYXRhLnN0YXRlSWNvbiA9IHN0YXRlQ29uZmlnLmljb247XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKHN0YXRlLmlzQ2FzZVR5cGUpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZUNvbmZpZyA9IHN0YXRlO1xuICAgICAgICAgICAgICAgIGNhc2VpbmZvLm1ldGFkYXRhLmNhc2VUeXBlQ29sb3IgPSBzdGF0ZUNvbmZpZy5maWxsO1xuICAgICAgICAgICAgICAgIGNhc2VpbmZvLm1ldGFkYXRhLmNhc2VUeXBlSWNvbiA9IHN0YXRlQ29uZmlnLmljb247XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgY2FzZWluZm8ubWV0YWRhdGEudXNlQ2FzZVR5cGVDb2xvciA9IHZhbC51c2VDYXNlVHlwZUNvbG9yID8gdmFsLnVzZUNhc2VUeXBlQ29sb3IgOiBmYWxzZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBkZWZhdWx0c1xuICAgICAgICAgIGlmICghY2FzZWluZm8ubWV0YWRhdGEuc3RhdGVDb2xvcikge1xuICAgICAgICAgICAgY2FzZWluZm8ubWV0YWRhdGEuc3RhdGVDb2xvciA9IERFRkFVTFRfU1RBVEVfQ09MT1I7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghY2FzZWluZm8ubWV0YWRhdGEuc3RhdGVJY29uKSB7XG4gICAgICAgICAgICBjYXNlaW5mby5tZXRhZGF0YS5zdGF0ZUljb24gPSAnYXNzZXRzL2ljb25zL2ljLWdlbmVyaWMtc3RhdGUuc3ZnJztcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCFjYXNlaW5mby5tZXRhZGF0YS5jYXNlVHlwZUNvbG9yKSB7XG4gICAgICAgICAgICBjYXNlaW5mby5tZXRhZGF0YS5jYXNlVHlwZUNvbG9yID0gREVGQVVMVF9UWVBFX0NPTE9SO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoIWNhc2VpbmZvLm1ldGFkYXRhLmNhc2VUeXBlSWNvbikge1xuICAgICAgICAgICAgY2FzZWluZm8ubWV0YWRhdGEuY2FzZVR5cGVJY29uID0gJ2Fzc2V0cy9pY29ucy9pYy1nZW5lcmljLWNhc2V0eXBlLnN2Zyc7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApKTtcbiAgICBjb25zdCBmb3JrSm9pbkFycmF5ID0gW2Nhc2VJbmZvJCwgY2FyZENvbmZpZyRdO1xuICAgIGxldCBjcmVhdG9ySW5mbyQ7XG4gICAgbGV0IG1vZGlmaWVkSW5mbyQ7XG4gICAgaWYgKGNhc2VpbmZvLm1ldGFkYXRhLmNyZWF0ZWRCeSkge1xuICAgICAgY3JlYXRvckluZm8kID0gdGhpcy5saXZlQXBwc1NlcnZpY2UuZ2V0VXNlckluZm8oY2FzZWluZm8ubWV0YWRhdGEuY3JlYXRlZEJ5KS5waXBlKFxuICAgICAgICBtYXAodmFsID0+IGNhc2VpbmZvLm1ldGFkYXRhLmNyZWF0ZWRCeURldGFpbHMgPSB2YWwgPyB2YWwgOiBuZXcgVXNlckluZm8oKSlcbiAgICAgICk7XG4gICAgICBmb3JrSm9pbkFycmF5LnB1c2goY3JlYXRvckluZm8kKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2FzZWluZm8ubWV0YWRhdGEuY3JlYXRlZEJ5RGV0YWlscyA9IG5ldyBVc2VySW5mbygpO1xuICAgIH1cbiAgICBpZiAoY2FzZWluZm8ubWV0YWRhdGEubW9kaWZpZWRCeSkge1xuICAgICAgbW9kaWZpZWRJbmZvJCA9IHRoaXMubGl2ZUFwcHNTZXJ2aWNlLmdldFVzZXJJbmZvKGNhc2VpbmZvLm1ldGFkYXRhLm1vZGlmaWVkQnkpLnBpcGUoXG4gICAgICAgIG1hcCh2YWwgPT4gY2FzZWluZm8ubWV0YWRhdGEubW9kaWZpZWRCeURldGFpbHMgPSB2YWwgPyB2YWwgOiBuZXcgVXNlckluZm8oKSlcbiAgICAgICk7XG4gICAgICBmb3JrSm9pbkFycmF5LnB1c2gobW9kaWZpZWRJbmZvJCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNhc2VpbmZvLm1ldGFkYXRhLm1vZGlmaWVkQnlEZXRhaWxzID0gbmV3IFVzZXJJbmZvKCk7XG4gICAgfVxuXG4gICAgLy8gY2FsbCBhbGwgdGhlIG9ic2VydmFibGVzIGF0IG9uY2UgYW5kIHJldHVybiB0aGUgT2JzZXJ2YWJsZSB0byB0aGUgcGFyc2VkIENhc2VJbmZvXG4gICAgcmV0dXJuIGZvcmtKb2luKGZvcmtKb2luQXJyYXkpLnBpcGUoXG4gICAgICBtYXAocmVzdWx0QXJyID0+IHtcbiAgICAgICAgcmV0dXJuIGNhc2VpbmZvO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGdldENhc2VXaXRoU3VtbWFyeShjYXNlUmVmOiBzdHJpbmcsIHNhbmRib3hJZDogbnVtYmVyLCB1aUFwcElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPENhc2VJbmZvPiB7XG4gICAgLy8gZ2V0IHRoZSBiYXNlIGNhc2VpbmZvIGZyb20gdGhlIEFQSSwgdGhlbiBjYWxsIHBhcnNlQ2FzZUluZm8gdG8gY3JlYXRlIGFuIE9ic2VydmFibGUgd2l0aCBhbGwgdGhlIGV4dHJhIGRhdGEgd2UgbmVlZFxuICAgIGNvbnN0IHVybCA9ICcvY2FzZS92MS9jYXNlcy8nICsgY2FzZVJlZiArICcvJyArICc/JHNhbmRib3g9JyArIHNhbmRib3hJZCArICcmJHNlbGVjdD11YywgbSwgcyc7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsKS5waXBlKFxuICAgICAgbWVyZ2VNYXAoY2FzZWluZm8gPT4ge1xuICAgICAgICAgIGNvbnN0IGNhc2VpbmYgPSBuZXcgQ2FzZUluZm8oKS5kZXNlcmlhbGl6ZShjYXNlaW5mbyk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VDYXNlSW5mbyhjYXNlaW5mLCBzYW5kYm94SWQsIGNhc2VpbmYubWV0YWRhdGEuYXBwbGljYXRpb25JZCwgY2FzZWluZi5tZXRhZGF0YS50eXBlSWQsIHVpQXBwSWQpO1xuICAgICAgICB9XG4gICAgICApLFxuICAgICAgY2F0Y2hFcnJvcihlcnIgPT4ge1xuICAgICAgICBpZiAoZXJyLmVycm9yLmVycm9yQ29kZSA9PT0gJ0NNX0NBU0VSRUZfTk9URVhJU1QnKSB7XG4gICAgICAgICAgLy8gY2FzZSBkZWxldGVkXG4gICAgICAgICAgcmV0dXJuIG9mKG5ldyBDYXNlSW5mbygpLmRlc2VyaWFsaXplKHsgZGVsZXRlZDogdHJ1ZSB9ICkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycik7XG4gICAgICB9KVxuICAgICk7XG4gIH1cbn1cbiJdfQ==