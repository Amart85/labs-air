/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { forkJoin } from 'rxjs';
import { flatMap, map, tap } from 'rxjs/operators';
import { CaseTypesReport, CaseTypeStateReport } from '../models/tc-live-apps-reporting';
import { TcCaseCardConfigService } from './tc-case-card-config.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./tc-case-card-config.service";
export class TcLiveAppsReportingService {
    /**
     * @param {?} http
     * @param {?} caseConfigService
     */
    constructor(http, caseConfigService) {
        this.http = http;
        this.caseConfigService = caseConfigService;
    }
    /**
     * @param {?} report
     * @param {?} uiAppId
     * @return {?}
     */
    parseCaseTypesReport(report, uiAppId) {
        // add state colors for the report entries
        /** @type {?} */
        const caseStateColorMaps$ = [];
        report.caseTypes.forEach((/**
         * @param {?} caseType
         * @return {?}
         */
        (caseType) => {
            caseStateColorMaps$.push(this.caseConfigService.getStateColorInfo(caseType.applicationId, uiAppId).pipe(map((/**
             * @param {?} stateColMap
             * @return {?}
             */
            stateColMap => {
                return stateColMap;
            }))));
        }));
        return forkJoin(caseStateColorMaps$).pipe(map((/**
         * @param {?} resultArr
         * @return {?}
         */
        resultArr => {
            for (let x = 0; x < report.caseTypes.length; x++) {
                report.caseTypes[x].caseTypeInfo.color = resultArr[x].caseTypeColor ? resultArr[x].caseTypeColor : undefined;
            }
            return report;
        })));
    }
    /**
     * @param {?} report
     * @param {?} applicationId
     * @param {?} uiAppId
     * @return {?}
     */
    parseCaseStateReport(report, applicationId, uiAppId) {
        // add state colors for the report entries
        return this.caseConfigService.getStateColorInfo(applicationId, uiAppId).pipe(map((/**
         * @param {?} stateColorInfo
         * @return {?}
         */
        stateColorInfo => {
            report.caseStates.forEach((/**
             * @param {?} caseState
             * @return {?}
             */
            caseState => {
                /** @type {?} */
                let stateRecord;
                if (stateColorInfo && stateColorInfo.stateColorRecs) {
                    stateRecord = stateColorInfo.stateColorRecs.find((/**
                     * @param {?} stateRec
                     * @return {?}
                     */
                    stateRec => {
                        return stateRec.state === caseState.stateInfo.value;
                    }));
                }
                caseState.stateInfo.color = (stateRecord && stateRecord.color) ? stateRecord.color : undefined;
            }));
            return report;
        })));
    }
    /**
     * @param {?} sandboxId
     * @param {?} appIds
     * @param {?} uiAppId
     * @return {?}
     */
    getCaseTypesReport(sandboxId, appIds, uiAppId) {
        /** @type {?} */
        const url = '/case/reports/v1/caseTypesReport?$sandbox=' + sandboxId;
        return this.http.get(url).pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        val => sessionStorage.setItem('tcsTimestamp', Date.now().toString()))), flatMap((/**
         * @param {?} response
         * @return {?}
         */
        response => {
            /** @type {?} */
            const originalResponse = new CaseTypesReport().deserialize(response);
            /**
             * @param {?} element
             * @param {?} index
             * @param {?} array
             * @return {?}
             */
            function includeCaseType(element, index, array) {
                return (appIds.indexOf(element.applicationId) !== -1);
            }
            /** @type {?} */
            const filteredResponse = new CaseTypesReport();
            if (appIds.length > 0) {
                filteredResponse.caseTypes = originalResponse.caseTypes.filter(includeCaseType);
            }
            else {
                filteredResponse.caseTypes = originalResponse.caseTypes;
            }
            return this.parseCaseTypesReport(filteredResponse, uiAppId);
        })));
    }
    /**
     * @param {?} sandboxId
     * @param {?} appId
     * @param {?} typeId
     * @param {?} incTerminal
     * @param {?} uiAppId
     * @return {?}
     */
    getCaseTypeStateReport(sandboxId, appId, typeId, incTerminal, uiAppId) {
        /** @type {?} */
        const url = '/case/reports/v1/caseStatesReport?$sandbox=' + sandboxId
            + '&$filter=applicationId eq ' + appId
            + ' and typeId eq ' + typeId
            + ' and includeTerminalStates eq ' + String(incTerminal).toUpperCase();
        return this.http.get(url).pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        val => sessionStorage.setItem('tcsTimestamp', Date.now().toString()))), flatMap((/**
         * @param {?} response
         * @return {?}
         */
        response => {
            /** @type {?} */
            const caseTypeStateReport = new CaseTypeStateReport().deserialize(response);
            return this.parseCaseStateReport(caseTypeStateReport, appId, uiAppId);
        })));
    }
}
TcLiveAppsReportingService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
TcLiveAppsReportingService.ctorParameters = () => [
    { type: HttpClient },
    { type: TcCaseCardConfigService }
];
/** @nocollapse */ TcLiveAppsReportingService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function TcLiveAppsReportingService_Factory() { return new TcLiveAppsReportingService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.TcCaseCardConfigService)); }, token: TcLiveAppsReportingService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    TcLiveAppsReportingService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    TcLiveAppsReportingService.prototype.caseConfigService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGMtbGl2ZS1hcHBzLXJlcG9ydGluZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRpYmNvLXRjc3RrL3RjLWxpdmVhcHBzLWxpYi8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy90Yy1saXZlLWFwcHMtcmVwb3J0aW5nLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFDLFVBQVUsRUFBYyxNQUFNLHNCQUFzQixDQUFDO0FBQzdELE9BQU8sRUFBQyxRQUFRLEVBQWEsTUFBTSxNQUFNLENBQUM7QUFDMUMsT0FBTyxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDakQsT0FBTyxFQUF1QixlQUFlLEVBQUUsbUJBQW1CLEVBQUMsTUFBTSxrQ0FBa0MsQ0FBQztBQUM1RyxPQUFPLEVBQUMsdUJBQXVCLEVBQUMsTUFBTSwrQkFBK0IsQ0FBQzs7OztBQU10RSxNQUFNLE9BQU8sMEJBQTBCOzs7OztJQUVyQyxZQUFvQixJQUFnQixFQUFVLGlCQUEwQztRQUFwRSxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQVUsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUF5QjtJQUFJLENBQUM7Ozs7OztJQUV0RixvQkFBb0IsQ0FBQyxNQUF1QixFQUFFLE9BQWU7OztjQUU1RCxtQkFBbUIsR0FBZ0MsRUFBRTtRQUMzRCxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU87Ozs7UUFBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO1lBQ3BDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQ3JHLEdBQUc7Ozs7WUFBQyxXQUFXLENBQUMsRUFBRTtnQkFDaEIsT0FBTyxXQUFXLENBQUM7WUFDckIsQ0FB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SUFBSSxDQUFDLG9CQUFvQixDQUFDLGdCQUFnQixFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzlELENBQUMsRUFBQyxDQUNILENBQUM7SUFDSixDQUFDOzs7Ozs7Ozs7SUFFTSxzQkFBc0IsQ0FBQyxTQUFpQixFQUFFLEtBQWEsRUFBRSxNQUFjLEVBQUUsV0FBb0IsRUFBRSxPQUFlOztjQUM3RyxHQUFHLEdBQUcsNkNBQTZDLEdBQUcsU0FBUztjQUNqRSw0QkFBNEIsR0FBRyxLQUFLO2NBQ3BDLGlCQUFpQixHQUFHLE1BQU07Y0FDMUIsZ0NBQWdDLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLFdBQVcsRUFBRTtRQUN4RSxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FDNUIsR0FBRzs7OztRQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUMsRUFDMUUsT0FBTzs7OztRQUFDLFFBQVEsQ0FBQyxFQUFFOztrQkFDWCxtQkFBbUIsR0FBRyxJQUFJLG1CQUFtQixFQUFFLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQztZQUMzRSxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxtQkFBbUIsRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDeEUsQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7OztZQTdFRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7Ozs7WUFUTyxVQUFVO1lBSVYsdUJBQXVCOzs7Ozs7OztJQVFqQiwwQ0FBd0I7Ozs7O0lBQUUsdURBQWtEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtIdHRwQ2xpZW50LCBIdHRwSGVhZGVyc30gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtmb3JrSm9pbiwgT2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XG5pbXBvcnQge2ZsYXRNYXAsIG1hcCwgdGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge0Nhc2VUeXBlUmVwb3J0UmVjb3JkLCBDYXNlVHlwZXNSZXBvcnQsIENhc2VUeXBlU3RhdGVSZXBvcnR9IGZyb20gJy4uL21vZGVscy90Yy1saXZlLWFwcHMtcmVwb3J0aW5nJztcbmltcG9ydCB7VGNDYXNlQ2FyZENvbmZpZ1NlcnZpY2V9IGZyb20gJy4vdGMtY2FzZS1jYXJkLWNvbmZpZy5zZXJ2aWNlJztcbmltcG9ydCB7U3RhdGVDb2xvck1hcCwgU3RhdGVDb2xvck1hcFJlY30gZnJvbSAnLi4vbW9kZWxzL3RjLWNhc2UtY2FyZC1jb25maWcnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBUY0xpdmVBcHBzUmVwb3J0aW5nU2VydmljZSB7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LCBwcml2YXRlIGNhc2VDb25maWdTZXJ2aWNlOiBUY0Nhc2VDYXJkQ29uZmlnU2VydmljZSkgeyB9XG5cbiAgcHVibGljIHBhcnNlQ2FzZVR5cGVzUmVwb3J0KHJlcG9ydDogQ2FzZVR5cGVzUmVwb3J0LCB1aUFwcElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPENhc2VUeXBlc1JlcG9ydD4ge1xuICAgIC8vIGFkZCBzdGF0ZSBjb2xvcnMgZm9yIHRoZSByZXBvcnQgZW50cmllc1xuICAgIGNvbnN0IGNhc2VTdGF0ZUNvbG9yTWFwcyQ6IE9ic2VydmFibGU8U3RhdGVDb2xvck1hcD5bXSA9IFtdO1xuICAgIHJlcG9ydC5jYXNlVHlwZXMuZm9yRWFjaCgoY2FzZVR5cGUpID0+IHtcbiAgICAgIGNhc2VTdGF0ZUNvbG9yTWFwcyQucHVzaCh0aGlzLmNhc2VDb25maWdTZXJ2aWNlLmdldFN0YXRlQ29sb3JJbmZvKGNhc2VUeXBlLmFwcGxpY2F0aW9uSWQsIHVpQXBwSWQpLnBpcGUoXG4gICAgICAgIG1hcChzdGF0ZUNvbE1hcCA9PiB7XG4gICAgICAgICAgcmV0dXJuIHN0YXRlQ29sTWFwO1xuICAgICAgICB9KVxuICAgICAgKSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGZvcmtKb2luKGNhc2VTdGF0ZUNvbG9yTWFwcyQpLnBpcGUoXG4gICAgICBtYXAocmVzdWx0QXJyID0+IHtcbiAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCByZXBvcnQuY2FzZVR5cGVzLmxlbmd0aDsgeCsrKSB7XG4gICAgICAgICAgcmVwb3J0LmNhc2VUeXBlc1t4XS5jYXNlVHlwZUluZm8uY29sb3IgPSByZXN1bHRBcnJbeF0uY2FzZVR5cGVDb2xvciA/IHJlc3VsdEFyclt4XS5jYXNlVHlwZUNvbG9yIDogdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXBvcnQ7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgcGFyc2VDYXNlU3RhdGVSZXBvcnQocmVwb3J0OiBDYXNlVHlwZVN0YXRlUmVwb3J0LCBhcHBsaWNhdGlvbklkOiBzdHJpbmcsIHVpQXBwSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8Q2FzZVR5cGVTdGF0ZVJlcG9ydD4ge1xuICAgIC8vIGFkZCBzdGF0ZSBjb2xvcnMgZm9yIHRoZSByZXBvcnQgZW50cmllc1xuICAgIHJldHVybiB0aGlzLmNhc2VDb25maWdTZXJ2aWNlLmdldFN0YXRlQ29sb3JJbmZvKGFwcGxpY2F0aW9uSWQsIHVpQXBwSWQpLnBpcGUoXG4gICAgICBtYXAoc3RhdGVDb2xvckluZm8gPT4ge1xuICAgICAgICByZXBvcnQuY2FzZVN0YXRlcy5mb3JFYWNoKGNhc2VTdGF0ZSA9PiB7XG4gICAgICAgICAgbGV0IHN0YXRlUmVjb3JkOiBTdGF0ZUNvbG9yTWFwUmVjO1xuICAgICAgICAgIGlmIChzdGF0ZUNvbG9ySW5mbyAmJiBzdGF0ZUNvbG9ySW5mby5zdGF0ZUNvbG9yUmVjcykge1xuICAgICAgICAgICAgIHN0YXRlUmVjb3JkID0gc3RhdGVDb2xvckluZm8uc3RhdGVDb2xvclJlY3MuZmluZChzdGF0ZVJlYyA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiBzdGF0ZVJlYy5zdGF0ZSA9PT0gY2FzZVN0YXRlLnN0YXRlSW5mby52YWx1ZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjYXNlU3RhdGUuc3RhdGVJbmZvLmNvbG9yID0gKHN0YXRlUmVjb3JkICYmIHN0YXRlUmVjb3JkLmNvbG9yKSA/IHN0YXRlUmVjb3JkLmNvbG9yIDogdW5kZWZpbmVkO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHJlcG9ydDtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDYXNlVHlwZXNSZXBvcnQoc2FuZGJveElkOiBudW1iZXIsIGFwcElkczogc3RyaW5nW10sIHVpQXBwSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8Q2FzZVR5cGVzUmVwb3J0PiB7XG4gICAgY29uc3QgdXJsID0gJy9jYXNlL3JlcG9ydHMvdjEvY2FzZVR5cGVzUmVwb3J0PyRzYW5kYm94PScgKyBzYW5kYm94SWQ7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsKS5waXBlKFxuICAgICAgdGFwKCB2YWwgPT4gc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgndGNzVGltZXN0YW1wJywgRGF0ZS5ub3coKS50b1N0cmluZygpKSksXG4gICAgICBmbGF0TWFwKHJlc3BvbnNlID0+IHtcbiAgICAgICAgY29uc3Qgb3JpZ2luYWxSZXNwb25zZSA9IG5ldyBDYXNlVHlwZXNSZXBvcnQoKS5kZXNlcmlhbGl6ZShyZXNwb25zZSk7XG4gICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVDYXNlVHlwZShlbGVtZW50OiBDYXNlVHlwZVJlcG9ydFJlY29yZCwgaW5kZXgsIGFycmF5ICkge1xuICAgICAgICAgIHJldHVybiAoYXBwSWRzLmluZGV4T2YoZWxlbWVudC5hcHBsaWNhdGlvbklkKSAhPT0gLTEpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGZpbHRlcmVkUmVzcG9uc2UgPSBuZXcgQ2FzZVR5cGVzUmVwb3J0KCk7XG4gICAgICAgIGlmIChhcHBJZHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGZpbHRlcmVkUmVzcG9uc2UuY2FzZVR5cGVzID0gb3JpZ2luYWxSZXNwb25zZS5jYXNlVHlwZXMuZmlsdGVyKGluY2x1ZGVDYXNlVHlwZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZmlsdGVyZWRSZXNwb25zZS5jYXNlVHlwZXMgPSBvcmlnaW5hbFJlc3BvbnNlLmNhc2VUeXBlcztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5wYXJzZUNhc2VUeXBlc1JlcG9ydChmaWx0ZXJlZFJlc3BvbnNlLCB1aUFwcElkKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDYXNlVHlwZVN0YXRlUmVwb3J0KHNhbmRib3hJZDogbnVtYmVyLCBhcHBJZDogc3RyaW5nLCB0eXBlSWQ6IHN0cmluZywgaW5jVGVybWluYWw6IGJvb2xlYW4sIHVpQXBwSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8Q2FzZVR5cGVTdGF0ZVJlcG9ydD4ge1xuICAgIGNvbnN0IHVybCA9ICcvY2FzZS9yZXBvcnRzL3YxL2Nhc2VTdGF0ZXNSZXBvcnQ/JHNhbmRib3g9JyArIHNhbmRib3hJZFxuICAgICAgKyAnJiRmaWx0ZXI9YXBwbGljYXRpb25JZCBlcSAnICsgYXBwSWRcbiAgICAgICsgJyBhbmQgdHlwZUlkIGVxICcgKyB0eXBlSWRcbiAgICAgICsgJyBhbmQgaW5jbHVkZVRlcm1pbmFsU3RhdGVzIGVxICcgKyBTdHJpbmcoaW5jVGVybWluYWwpLnRvVXBwZXJDYXNlKCk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsKS5waXBlKFxuICAgICAgdGFwKCB2YWwgPT4gc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgndGNzVGltZXN0YW1wJywgRGF0ZS5ub3coKS50b1N0cmluZygpKSksXG4gICAgICBmbGF0TWFwKHJlc3BvbnNlID0+IHtcbiAgICAgICAgY29uc3QgY2FzZVR5cGVTdGF0ZVJlcG9ydCA9IG5ldyBDYXNlVHlwZVN0YXRlUmVwb3J0KCkuZGVzZXJpYWxpemUocmVzcG9uc2UpO1xuICAgICAgICByZXR1cm4gdGhpcy5wYXJzZUNhc2VTdGF0ZVJlcG9ydChjYXNlVHlwZVN0YXRlUmVwb3J0LCBhcHBJZCwgdWlBcHBJZCk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxufVxuIl19