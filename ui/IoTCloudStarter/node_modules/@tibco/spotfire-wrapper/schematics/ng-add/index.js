"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const config_1 = require("@schematics/angular/utility/config");
const schematics_1 = require("@angular/cdk/schematics");
const ng_ast_utils_1 = require("@schematics/angular/utility/ng-ast-utils");
const tasks_1 = require("@angular-devkit/schematics/tasks");
function addPackageToPackageJson(host, pkg, version, dev = false) {
    function sortObjectByKeys(obj) {
        return Object.keys(obj).sort().reduce((result, key) => (result[key] = obj ? obj[key] : null) && result, {});
    }
    const depName = dev ? 'devDependencies' : 'dependencies';
    if (host.exists('package.json')) {
        const sourceText = host.read('package.json').toString('utf-8');
        const json = JSON.parse(sourceText);
        if (!json[depName]) {
            json[depName] = {};
        }
        if (!json[depName][pkg]) {
            json[depName][pkg] = version;
            json[depName] = sortObjectByKeys(json[depName]);
        }
        host.overwrite('package.json', JSON.stringify(json, null, 2));
    }
    return host;
}
function ngAdd(_options) {
    return (_host, context) => {
        context.logger.log('info', `Installing @tibco/spotfire-wrapper`);
        addPackageToPackageJson(_host, '@angular/material', '~8.0.2');
        addPackageToPackageJson(_host, '@angular/cdk', '~8.0.2');
        addPackageToPackageJson(_host, '@angular/flex-layout', '~8.0.0-beta');
        const installTaskId = context.addTask(new tasks_1.NodePackageInstallTask());
        context.addTask(new tasks_1.RunSchematicTask('ng-add-setup-project', _options), [installTaskId]);
    };
}
exports.ngAdd = ngAdd;
function ngAddSetup(_options) {
    return (tree, context) => {
        const workspace = config_1.getWorkspace(tree);
        const project = schematics_1.getProjectFromWorkspace(workspace, _options.project);
        const appModulePath = ng_ast_utils_1.getAppModulePath(tree, schematics_1.getProjectMainFile(project));
        const moduleName = 'SpotfireViewerModule';
        if (!schematics_1.hasNgModuleImport(tree, appModulePath, moduleName)) {
            context.logger.log('info', `Import  ${moduleName}`);
            schematics_1.addModuleImportToRootModule(tree, moduleName, '@tibco/spotfire-wrapper', project);
        }
        return tree;
    };
}
exports.ngAddSetup = ngAddSetup;
//# sourceMappingURL=index.js.map