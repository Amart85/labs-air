/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// Copyright (c) 2018-2018. TIBCO Software Inc. All Rights Reserved. Confidential & Proprietary.
import { Injectable } from '@angular/core';
import { delay, map, mergeMap, tap } from 'rxjs/operators';
import { Observable, forkJoin } from 'rxjs';
import { LazyLoadingLibraryService } from './lazy-loading-library.service';
import { Application } from './spotfire-webplayer';
import * as i0 from "@angular/core";
import * as i1 from "./lazy-loading-library.service";
export class DocumentService {
    /**
     * @param {?} lazySvc
     */
    constructor(lazySvc) {
        this.lazySvc = lazySvc;
        this.doConsole = (/**
         * @param {...?} args
         * @return {?}
         */
        (...args) => console.log('[DOCUMENT-SERVICE]', ...args));
        // %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        //
        this.getMetadata$ = (/**
         * @param {?} params
         * @return {?}
         */
        (params) => this.openWebPlayer$(params).pipe(mergeMap((/**
         * @param {?} doc
         * @return {?}
         */
        doc => forkJoin([
            doc.getDocumentMetadata$(),
            doc.getData().getTables$(),
            doc.getMarking().getMarkingNames$()
        ]))), map((/**
         * @param {?} __0
         * @return {?}
         */
        ([metadata, tables, markings]) => ({ metadata, tables, markings })))));
        /**
         * \@description
         * Callback played if Spotfire requires some login
         *
         */
        this.onCreateLoginElement = (/**
         * @return {?}
         */
        () => {
            this.doConsole('Creating the login element');
            // Optionally create and return a div to host the login button
            console.warn(`Cannot login`);
            return null;
        });
    }
    // %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //
    /**
     * @param {?} params
     * @return {?}
     */
    openWebPlayer$(params) {
        this.doConsole(`openWebPlayer(${params.domid}, ${params.url})`, params);
        // lazy load the spotfire js API
        //
        /** @type {?} */
        const sfLoaderUrl = `${params.url}/spotfire/js-api/loader.js`;
        return this.lazySvc.loadJs(sfLoaderUrl).pipe(delay(1000), tap((/**
         * @param {?} f
         * @return {?}
         */
        f => this.doConsole(`Spotfire ${sfLoaderUrl} is LOADED !!!`, params.domid, f, spotfire, params.page, params.customization))), mergeMap((/**
         * @param {?} _
         * @return {?}
         */
        _ => this.openPath$(params))));
    }
    // %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //
    /**
     * @param {?} params
     * @return {?}
     */
    openPath$(params) {
        this.doConsole(`openPath(${params.path})`, params);
        if (params.document) {
            params.document.close();
        }
        // FIXTHIS, we might need to wait for onClosed callback
        params.document = null;
        // Prepare Spotfire app with path/page/customization
        //
        params.app = new Application(params.url, params.customization, params.path, params._parameters, params.reloadAnalysisInstance, params.version, this.onCreateLoginElement);
        /**
         * Callback played once Spotfire API responds to Application creation
         *
         * Will open the target page
         */
        return params.app.onApplicationReady$.pipe(tap((/**
         * @param {?} f
         * @return {?}
         */
        f => this.doConsole('onApplicationReady$ is done'))), mergeMap((/**
         * @param {?} _
         * @return {?}
         */
        _ => this.openPage$(params))));
    }
    // %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //
    /**
     * @param {?} params
     * @return {?}
     */
    openPage$(params) {
        this.doConsole(`openPage(${params.page})`, params);
        // Ask Spotfire library to display this path/page (with optional customization)
        //
        if (!params.app || !(params.app instanceof Application)) {
            throw new Error('Spotfire webapp is not created yet');
        }
        //    const idDom = `is${new Date().getTime()}`;
        this.doConsole('getDocument', params.domid, `cnf=${params.page}`, params.app, params.document, params.customization);
        // Here is the call to 'spotfire.webPlayer.createApplication'
        //
        if (params.document) {
            this.doConsole(`SpotfireViewerComponent setActivePage(${params.page})`);
            params.document.setActivePage(params.page);
            return new Observable((/**
             * @param {?} o
             * @return {?}
             */
            o => {
                o.next((/** @type {?} */ (params.document)));
                o.complete();
            }));
        }
        else {
            params.document = params.app.getDocument(params.domid, params.page, (/** @type {?} */ (params.customization)));
            return params.document.onDocumentReady$().pipe(map((/**
             * @param {?} f
             * @return {?}
             */
            f => (/** @type {?} */ (params.document)))), tap((/**
             * @param {?} f
             * @return {?}
             */
            f => this.doConsole('onDocumentReady$ is done', f))));
        }
    }
}
DocumentService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
/** @nocollapse */
DocumentService.ctorParameters = () => [
    { type: LazyLoadingLibraryService }
];
/** @nocollapse */ DocumentService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function DocumentService_Factory() { return new DocumentService(i0.ɵɵinject(i1.LazyLoadingLibraryService)); }, token: DocumentService, providedIn: "root" });
if (false) {
    /** @type {?} */
    DocumentService.prototype.doConsole;
    /** @type {?} */
    DocumentService.prototype.getMetadata$;
    /**
     * \@description
     * Callback played if Spotfire requires some login
     *
     * @type {?}
     * @private
     */
    DocumentService.prototype.onCreateLoginElement;
    /** @type {?} */
    DocumentService.prototype.lazySvc;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jdW1lbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0aWJjby9zcG90ZmlyZS13cmFwcGVyLyIsInNvdXJjZXMiOlsibGliL2RvY3VtZW50LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUU1QyxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUMzRSxPQUFPLEVBQUUsV0FBVyxFQUFnQyxNQUFNLHNCQUFzQixDQUFDOzs7QUFLakYsTUFBTSxPQUFPLGVBQWU7Ozs7SUFFMUIsWUFBbUIsT0FBa0M7UUFBbEMsWUFBTyxHQUFQLE9BQU8sQ0FBMkI7UUFFckQsY0FBUzs7OztRQUFHLENBQUMsR0FBRyxJQUFXLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxJQUFJLENBQUMsRUFBQzs7O1FBSXBFLGlCQUFZOzs7O1FBQUcsQ0FBQyxNQUEwQixFQUFrQixFQUFFLENBQ25FLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUM5QixRQUFROzs7O1FBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUM7WUFDdkIsR0FBRyxDQUFDLG9CQUFvQixFQUFFO1lBQzFCLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxVQUFVLEVBQUU7WUFDMUIsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDLGdCQUFnQixFQUFFO1NBQUMsQ0FBQyxFQUFDLEVBQ3hDLEdBQUc7Ozs7UUFBQyxDQUFDLENBQUMsUUFBUSxFQUFFLE1BQU0sRUFBRSxRQUFRLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBQyxDQUFDLEVBQUE7Ozs7OztRQW1EcEUseUJBQW9COzs7UUFBRyxHQUFHLEVBQUU7WUFDbEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO1lBQzdDLDhEQUE4RDtZQUM5RCxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQzdCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQyxFQUFBO0lBcEV3RCxDQUFDOzs7Ozs7O0lBZ0JuRCxjQUFjLENBQUMsTUFBMEI7UUFDOUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsTUFBTSxDQUFDLEtBQUssS0FBSyxNQUFNLENBQUMsR0FBRyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7Ozs7Y0FJbEUsV0FBVyxHQUFHLEdBQUcsTUFBTSxDQUFDLEdBQUcsNEJBQTRCO1FBQzdELE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUMxQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQ1gsR0FBRzs7OztRQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLFdBQVcsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLE1BQU0sQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLGFBQWEsQ0FBQyxFQUFDLEVBQy9ILFFBQVE7Ozs7UUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUMsQ0FBQyxDQUFDO0lBQzNDLENBQUM7Ozs7Ozs7SUFJTSxTQUFTLENBQUMsTUFBMEI7UUFDekMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLE1BQU0sQ0FBQyxJQUFJLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNuRCxJQUFJLE1BQU0sQ0FBQyxRQUFRLEVBQUU7WUFDbkIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUN6QjtRQUNELHVEQUF1RDtRQUN2RCxNQUFNLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUV2QixvREFBb0Q7UUFDcEQsRUFBRTtRQUNGLE1BQU0sQ0FBQyxHQUFHLEdBQUcsSUFBSSxXQUFXLENBQzFCLE1BQU0sQ0FBQyxHQUFHLEVBQ1YsTUFBTSxDQUFDLGFBQWEsRUFDcEIsTUFBTSxDQUFDLElBQUksRUFDWCxNQUFNLENBQUMsV0FBVyxFQUNsQixNQUFNLENBQUMsc0JBQXNCLEVBQzdCLE1BQU0sQ0FBQyxPQUFPLEVBQ2QsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDN0I7Ozs7V0FJRztRQUNILE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQ3hDLEdBQUc7Ozs7UUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsNkJBQTZCLENBQUMsRUFBQyxFQUN2RCxRQUFROzs7O1FBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFDLENBQUMsQ0FBQztJQUMzQyxDQUFDOzs7Ozs7O0lBZ0JNLFNBQVMsQ0FBQyxNQUEwQjtRQUV6QyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksTUFBTSxDQUFDLElBQUksR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRW5ELCtFQUErRTtRQUMvRSxFQUFFO1FBQ0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLFlBQVksV0FBVyxDQUFDLEVBQUU7WUFDdkQsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO1NBQ3ZEO1FBQ0QsZ0RBQWdEO1FBR2hELElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxFQUFFLE1BQU0sQ0FBQyxLQUFLLEVBQUUsT0FBTyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUUsTUFBTSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNySCw2REFBNkQ7UUFDN0QsRUFBRTtRQUNGLElBQUksTUFBTSxDQUFDLFFBQVEsRUFBRTtZQUNuQixJQUFJLENBQUMsU0FBUyxDQUFDLHlDQUF5QyxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztZQUN4RSxNQUFNLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0MsT0FBTyxJQUFJLFVBQVU7Ozs7WUFBVyxDQUFDLENBQUMsRUFBRTtnQkFDbEMsQ0FBQyxDQUFDLElBQUksQ0FBQyxtQkFBQSxNQUFNLENBQUMsUUFBUSxFQUFZLENBQUMsQ0FBQztnQkFDcEMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2YsQ0FBQyxFQUFDLENBQUM7U0FDSjthQUFNO1lBQ0wsTUFBTSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxJQUFJLEVBQUUsbUJBQUEsTUFBTSxDQUFDLGFBQWEsRUFBeUIsQ0FBQyxDQUFDO1lBQ25ILE9BQU8sTUFBTSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLElBQUksQ0FDNUMsR0FBRzs7OztZQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsbUJBQUEsTUFBTSxDQUFDLFFBQVEsRUFBWSxFQUFDLEVBQ3JDLEdBQUc7Ozs7WUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsMEJBQTBCLEVBQUUsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDO1NBQzVEO0lBQ0gsQ0FBQzs7O1lBdkdGLFVBQVUsU0FBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUU7Ozs7WUFMekIseUJBQXlCOzs7OztJQVVoQyxvQ0FBMkU7O0lBSTNFLHVDQU00RTs7Ozs7Ozs7SUFtRDVFLCtDQUtDOztJQXBFVyxrQ0FBeUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIDIwMTgtMjAxOC4gVElCQ08gU29mdHdhcmUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLiBDb25maWRlbnRpYWwgJiBQcm9wcmlldGFyeS5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgZGVsYXksIG1hcCwgbWVyZ2VNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZvcmtKb2luIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBTcG90ZmlyZUN1c3RvbWl6YXRpb24gfSBmcm9tICcuL3Nwb3RmaXJlLWN1c3RvbWl6YXRpb24nO1xuaW1wb3J0IHsgTGF6eUxvYWRpbmdMaWJyYXJ5U2VydmljZSB9IGZyb20gJy4vbGF6eS1sb2FkaW5nLWxpYnJhcnkuc2VydmljZSc7XG5pbXBvcnQgeyBBcHBsaWNhdGlvbiwgRG9jdW1lbnQsIFNwb3RmaXJlUGFyYW1ldGVycyB9IGZyb20gJy4vc3BvdGZpcmUtd2VicGxheWVyJztcblxuZGVjbGFyZSBsZXQgc3BvdGZpcmU6IGFueTtcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBEb2N1bWVudFNlcnZpY2Uge1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBsYXp5U3ZjOiBMYXp5TG9hZGluZ0xpYnJhcnlTZXJ2aWNlKSB7IH1cblxuICBkb0NvbnNvbGUgPSAoLi4uYXJnczogYW55W10pID0+IGNvbnNvbGUubG9nKCdbRE9DVU1FTlQtU0VSVklDRV0nLCAuLi5hcmdzKTtcblxuICAvLyAlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJVxuICAvL1xuICBwdWJsaWMgZ2V0TWV0YWRhdGEkID0gKHBhcmFtczogU3BvdGZpcmVQYXJhbWV0ZXJzKTogT2JzZXJ2YWJsZTx7fT4gPT5cbiAgICB0aGlzLm9wZW5XZWJQbGF5ZXIkKHBhcmFtcykucGlwZShcbiAgICAgIG1lcmdlTWFwKGRvYyA9PiBmb3JrSm9pbihbXG4gICAgICAgIGRvYy5nZXREb2N1bWVudE1ldGFkYXRhJCgpLFxuICAgICAgICBkb2MuZ2V0RGF0YSgpLmdldFRhYmxlcyQoKSxcbiAgICAgICAgZG9jLmdldE1hcmtpbmcoKS5nZXRNYXJraW5nTmFtZXMkKCldKSksXG4gICAgICBtYXAoKFttZXRhZGF0YSwgdGFibGVzLCBtYXJraW5nc10pID0+ICh7IG1ldGFkYXRhLCB0YWJsZXMsIG1hcmtpbmdzIH0pKSlcblxuICAvLyAlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJVxuICAvL1xuICBwdWJsaWMgb3BlbldlYlBsYXllciQocGFyYW1zOiBTcG90ZmlyZVBhcmFtZXRlcnMpOiBPYnNlcnZhYmxlPERvY3VtZW50PiB7XG4gICAgdGhpcy5kb0NvbnNvbGUoYG9wZW5XZWJQbGF5ZXIoJHtwYXJhbXMuZG9taWR9LCAke3BhcmFtcy51cmx9KWAsIHBhcmFtcyk7XG5cbiAgICAvLyBsYXp5IGxvYWQgdGhlIHNwb3RmaXJlIGpzIEFQSVxuICAgIC8vXG4gICAgY29uc3Qgc2ZMb2FkZXJVcmwgPSBgJHtwYXJhbXMudXJsfS9zcG90ZmlyZS9qcy1hcGkvbG9hZGVyLmpzYDtcbiAgICByZXR1cm4gdGhpcy5sYXp5U3ZjLmxvYWRKcyhzZkxvYWRlclVybCkucGlwZShcbiAgICAgIGRlbGF5KDEwMDApLFxuICAgICAgdGFwKGYgPT4gdGhpcy5kb0NvbnNvbGUoYFNwb3RmaXJlICR7c2ZMb2FkZXJVcmx9IGlzIExPQURFRCAhISFgLCBwYXJhbXMuZG9taWQsIGYsIHNwb3RmaXJlLCBwYXJhbXMucGFnZSwgcGFyYW1zLmN1c3RvbWl6YXRpb24pKSxcbiAgICAgIG1lcmdlTWFwKF8gPT4gdGhpcy5vcGVuUGF0aCQocGFyYW1zKSkpO1xuICB9XG5cbiAgLy8gJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSVcbiAgLy9cbiAgcHVibGljIG9wZW5QYXRoJChwYXJhbXM6IFNwb3RmaXJlUGFyYW1ldGVycyk6IE9ic2VydmFibGU8RG9jdW1lbnQ+IHtcbiAgICB0aGlzLmRvQ29uc29sZShgb3BlblBhdGgoJHtwYXJhbXMucGF0aH0pYCwgcGFyYW1zKTtcbiAgICBpZiAocGFyYW1zLmRvY3VtZW50KSB7XG4gICAgICBwYXJhbXMuZG9jdW1lbnQuY2xvc2UoKTtcbiAgICB9XG4gICAgLy8gRklYVEhJUywgd2UgbWlnaHQgbmVlZCB0byB3YWl0IGZvciBvbkNsb3NlZCBjYWxsYmFja1xuICAgIHBhcmFtcy5kb2N1bWVudCA9IG51bGw7XG5cbiAgICAvLyBQcmVwYXJlIFNwb3RmaXJlIGFwcCB3aXRoIHBhdGgvcGFnZS9jdXN0b21pemF0aW9uXG4gICAgLy9cbiAgICBwYXJhbXMuYXBwID0gbmV3IEFwcGxpY2F0aW9uKFxuICAgICAgcGFyYW1zLnVybCxcbiAgICAgIHBhcmFtcy5jdXN0b21pemF0aW9uLFxuICAgICAgcGFyYW1zLnBhdGgsXG4gICAgICBwYXJhbXMuX3BhcmFtZXRlcnMsXG4gICAgICBwYXJhbXMucmVsb2FkQW5hbHlzaXNJbnN0YW5jZSxcbiAgICAgIHBhcmFtcy52ZXJzaW9uLFxuICAgICAgdGhpcy5vbkNyZWF0ZUxvZ2luRWxlbWVudCk7XG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgcGxheWVkIG9uY2UgU3BvdGZpcmUgQVBJIHJlc3BvbmRzIHRvIEFwcGxpY2F0aW9uIGNyZWF0aW9uXG4gICAgICpcbiAgICAgKiBXaWxsIG9wZW4gdGhlIHRhcmdldCBwYWdlXG4gICAgICovXG4gICAgcmV0dXJuIHBhcmFtcy5hcHAub25BcHBsaWNhdGlvblJlYWR5JC5waXBlKFxuICAgICAgdGFwKGYgPT4gdGhpcy5kb0NvbnNvbGUoJ29uQXBwbGljYXRpb25SZWFkeSQgaXMgZG9uZScpKSxcbiAgICAgIG1lcmdlTWFwKF8gPT4gdGhpcy5vcGVuUGFnZSQocGFyYW1zKSkpO1xuICB9XG4gIC8qKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIENhbGxiYWNrIHBsYXllZCBpZiBTcG90ZmlyZSByZXF1aXJlcyBzb21lIGxvZ2luXG4gICAgICpcbiAgICAgKi9cblxuICBwcml2YXRlIG9uQ3JlYXRlTG9naW5FbGVtZW50ID0gKCkgPT4ge1xuICAgIHRoaXMuZG9Db25zb2xlKCdDcmVhdGluZyB0aGUgbG9naW4gZWxlbWVudCcpO1xuICAgIC8vIE9wdGlvbmFsbHkgY3JlYXRlIGFuZCByZXR1cm4gYSBkaXYgdG8gaG9zdCB0aGUgbG9naW4gYnV0dG9uXG4gICAgY29uc29sZS53YXJuKGBDYW5ub3QgbG9naW5gKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIC8vICUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlXG4gIC8vXG4gIHB1YmxpYyBvcGVuUGFnZSQocGFyYW1zOiBTcG90ZmlyZVBhcmFtZXRlcnMpOiBPYnNlcnZhYmxlPERvY3VtZW50PiB7XG5cbiAgICB0aGlzLmRvQ29uc29sZShgb3BlblBhZ2UoJHtwYXJhbXMucGFnZX0pYCwgcGFyYW1zKTtcblxuICAgIC8vIEFzayBTcG90ZmlyZSBsaWJyYXJ5IHRvIGRpc3BsYXkgdGhpcyBwYXRoL3BhZ2UgKHdpdGggb3B0aW9uYWwgY3VzdG9taXphdGlvbilcbiAgICAvL1xuICAgIGlmICghcGFyYW1zLmFwcCB8fCAhKHBhcmFtcy5hcHAgaW5zdGFuY2VvZiBBcHBsaWNhdGlvbikpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignU3BvdGZpcmUgd2ViYXBwIGlzIG5vdCBjcmVhdGVkIHlldCcpO1xuICAgIH1cbiAgICAvLyAgICBjb25zdCBpZERvbSA9IGBpcyR7bmV3IERhdGUoKS5nZXRUaW1lKCl9YDtcblxuXG4gICAgdGhpcy5kb0NvbnNvbGUoJ2dldERvY3VtZW50JywgcGFyYW1zLmRvbWlkLCBgY25mPSR7cGFyYW1zLnBhZ2V9YCwgcGFyYW1zLmFwcCwgcGFyYW1zLmRvY3VtZW50LCBwYXJhbXMuY3VzdG9taXphdGlvbik7XG4gICAgLy8gSGVyZSBpcyB0aGUgY2FsbCB0byAnc3BvdGZpcmUud2ViUGxheWVyLmNyZWF0ZUFwcGxpY2F0aW9uJ1xuICAgIC8vXG4gICAgaWYgKHBhcmFtcy5kb2N1bWVudCkge1xuICAgICAgdGhpcy5kb0NvbnNvbGUoYFNwb3RmaXJlVmlld2VyQ29tcG9uZW50IHNldEFjdGl2ZVBhZ2UoJHtwYXJhbXMucGFnZX0pYCk7XG4gICAgICBwYXJhbXMuZG9jdW1lbnQuc2V0QWN0aXZlUGFnZShwYXJhbXMucGFnZSk7XG4gICAgICByZXR1cm4gbmV3IE9ic2VydmFibGU8RG9jdW1lbnQ+KG8gPT4ge1xuICAgICAgICBvLm5leHQocGFyYW1zLmRvY3VtZW50IGFzIERvY3VtZW50KTtcbiAgICAgICAgby5jb21wbGV0ZSgpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtcy5kb2N1bWVudCA9IHBhcmFtcy5hcHAuZ2V0RG9jdW1lbnQocGFyYW1zLmRvbWlkLCBwYXJhbXMucGFnZSwgcGFyYW1zLmN1c3RvbWl6YXRpb24gYXMgU3BvdGZpcmVDdXN0b21pemF0aW9uKTtcbiAgICAgIHJldHVybiBwYXJhbXMuZG9jdW1lbnQub25Eb2N1bWVudFJlYWR5JCgpLnBpcGUoXG4gICAgICAgIG1hcChmID0+IHBhcmFtcy5kb2N1bWVudCBhcyBEb2N1bWVudCksXG4gICAgICAgIHRhcChmID0+IHRoaXMuZG9Db25zb2xlKCdvbkRvY3VtZW50UmVhZHkkIGlzIGRvbmUnLCBmKSkpO1xuICAgIH1cbiAgfVxuXG4gIC8vICUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlXG59XG4iXX0=